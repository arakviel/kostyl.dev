---
title: '–ë—É–¥—É—î–º–æ –≤–ª–∞—Å–Ω–∏–π Service Container'
description: '–ü–æ–∫—Ä–æ–∫–æ–≤–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è IoC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑ –Ω—É–ª—è –Ω–∞ C# —ñ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º —Ä–µ—Ñ–ª–µ–∫—Å—ñ—ó. –ó—Ä–æ–∑—É–º—ñ–π—Ç–µ —Å–ø—Ä–∞–≤–∂–Ω—é –º–µ—Ö–∞–Ω—ñ–∫—É Service Container —Ç–∞ Service Provider –ø–µ—Ä—à –Ω—ñ–∂ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≥–æ—Ç–æ–≤–∏–π –≤—ñ–¥ Microsoft.'
---

# –ë—É–¥—É—î–º–æ –≤–ª–∞—Å–Ω–∏–π Service Container

## –í—Å—Ç—É–ø: "–ú–∞–≥—ñ—è" ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ —Ä–µ—Ñ–ª–µ–∫—Å—ñ—è

–ö–æ–ª–∏ –ø–æ—á–∏–Ω–∞—é—á–∏–π —Ä–æ–∑—Ä–æ–±–Ω–∏–∫ –≤–ø–µ—Ä—à–µ –±–∞—á–∏—Ç—å –∫–æ–¥ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```csharp
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddScoped<IOrderRepository, SqlOrderRepository>();
builder.Services.AddScoped<OrderService>();

var app = builder.Build();
// ... —ñ OrderService —è–∫–∏–º–æ—Å—å —á–∏–Ω–æ–º –°–ê–ú –æ—Ç—Ä–∏–º–∞–≤ –≤—Å—ñ —Å–≤–æ—ó –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ!
```

...–≤ –Ω—å–æ–≥–æ –≤–∏–Ω–∏–∫–∞—î —Ü—ñ–ª–∫–æ–º –ø—Ä–∏—Ä–æ–¥–Ω–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è: **"–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?"** –í—ñ–¥—á—É—Ç—Ç—è –º–∞–≥—ñ—ó. –ê–ª–µ —è–∫ —ñ –±—É–¥—å-—è–∫–∞ "–º–∞–≥—ñ—è" —É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—ñ ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ –¥–æ–±—Ä–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–π –∫–æ–¥.

–£ —Ü—ñ–π —Å—Ç–∞—Ç—Ç—ñ –º–∏ **–ø–æ–±—É–¥—É—î–º–æ –≤–ª–∞—Å–Ω–∏–π IoC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ –Ω—É–ª—è**, –∫—Ä–æ–∫ –∑–∞ –∫—Ä–æ–∫–æ–º, —Ä–æ–∑–±–∏—Ä–∞—é—á–∏ –∫–æ–∂–µ–Ω –º–µ—Ö–∞–Ω—ñ–∑–º. –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –≤–∏ –ø–æ–¥–∏–≤–∏—Ç–µ—Å—å –Ω–∞ `IServiceCollection` —Ç–∞ `IServiceProvider` –∑–æ–≤—Å—ñ–º —ñ–Ω—à–∏–º–∏ –æ—á–∏–º–∞ ‚Äî –æ—á–∏–º–∞ –ª—é–¥–∏–Ω–∏, —è–∫–∞ —Ä–æ–∑—É–º—ñ—î, —â–æ —ñ —á–æ–º—É –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è.

::note
**–ù–∞–≤—ñ—â–æ –±—É–¥—É–≤–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π, —è–∫—â–æ —î –≥–æ—Ç–æ–≤–∏–π?**

–¶–µ –∫–ª–∞—Å–∏—á–Ω–∏–π –ø–µ–¥–∞–≥–æ–≥—ñ—á–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥: –ø–µ—Ä—à –Ω—ñ–∂ —ó–∑–¥–∏—Ç–∏ –Ω–∞ –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ, –º–µ—Ö–∞–Ω—ñ–∫ –ø–æ–≤–∏–Ω–µ–Ω —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏ –¥–≤–∏–≥—É–Ω. –í–ª–∞—Å–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—É–¥–µ —Å–ø—Ä–æ—â–µ–Ω–∏–º –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ Microsoft DI (–≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –¥–µ—è–∫–∏—Ö –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ–π, –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ —Ç–æ—â–æ), –∞–ª–µ –≤—ñ–Ω –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏–º–µ **—Ç—É –∂ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω—É —ñ–¥–µ—é**.
::

### –©–æ –º–∏ –ø–æ–±—É–¥—É—î–º–æ?

–î–æ –∫—ñ–Ω—Ü—è —Ü—ñ—î—ó —Å—Ç–∞—Ç—Ç—ñ —É –Ω–∞—Å –±—É–¥–µ `SimpleContainer` ‚Äî –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π, –∞–ª–µ –ø–æ–≤–Ω—ñ—Å—Ç—é —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π IoC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —è–∫–∏–π –ø—ñ–¥—Ç—Ä–∏–º—É—î:

- ‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é —Ç–∏–ø—ñ–≤ (Interface ‚Üí Implementation)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π Resolve –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–µ—Ñ–ª–µ–∫—Å—ñ—é
- ‚úÖ Transient lifestyle (–Ω–æ–≤–∏–π –æ–±'—î–∫—Ç –Ω–∞ –∫–æ–∂–µ–Ω –∑–∞–ø–∏—Ç)
- ‚úÖ Singleton lifestyle (—î–¥–∏–Ω–∏–π –æ–±'—î–∫—Ç –Ω–∞ –≤–µ—Å—å —á–∞—Å —Ä–æ–±–æ—Ç–∏)
- ‚úÖ Scoped lifestyle (—î–¥–∏–Ω–∏–π –æ–±'—î–∫—Ç —É –º–µ–∂–∞—Ö scope)
- ‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é —á–µ—Ä–µ–∑ factory-—Ñ—É–Ω–∫—Ü—ñ—é
- ‚úÖ –ë–∞–∑–æ–≤–∏–π `IDisposable` support

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞—à–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

::plant-uml

```plantuml
@startuml
skinparam style plain
skinparam defaultFontName Segoe UI

title –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ SimpleContainer

enum Lifetime {
  Transient
  Singleton
  Scoped
}

class ServiceDescriptor {
  + ServiceType: Type
  + ImplementationType: Type?
  + Factory: Func<IServiceProvider, object>?
  + Lifetime: Lifetime
  + Instance: object? (singleton cache)
}

interface IServiceProvider {
  + GetService(type: Type): object?
}

interface IServiceScope {
  + ServiceProvider: IServiceProvider
  + Dispose()
}

interface IServiceScopeFactory {
  + CreateScope(): IServiceScope
}

class SimpleContainer {
  - _descriptors: List<ServiceDescriptor>
  - _singletonInstances: Dictionary<Type, object>
  + Register<TService, TImpl>(lifetime)
  + Register<TService>(factory, lifetime)
  + BuildServiceProvider(): SimpleServiceProvider
}

class SimpleServiceProvider {
  - _descriptors: List<ServiceDescriptor>
  - _singletonInstances: Dictionary<Type, object>
  - _scopedInstances: Dictionary<Type, object>?
  + GetService(type: Type): object?
  + GetRequiredService(type: Type): object
  - Resolve(descriptor): object
  - CreateInstance(implType): object
}

class SimpleServiceScope {
  + ServiceProvider: SimpleServiceProvider
  + Dispose()
}

SimpleContainer --> ServiceDescriptor : contains
SimpleContainer --> SimpleServiceProvider : creates
SimpleServiceProvider ..|> IServiceProvider
SimpleServiceProvider --> ServiceDescriptor : reads
SimpleServiceScope ..|> IServiceScope
SimpleServiceScope --> SimpleServiceProvider : has
SimpleServiceProvider ..|> IServiceScopeFactory
ServiceDescriptor --> Lifetime : has

@enduml
```

::

---

## –ö—Ä–æ–∫ 1: –ë–∞–∑–æ–≤—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö

### 1.1. Enum Lifetime

–ü–µ—Ä—à –∑–∞ –≤—Å–µ, –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –ø–µ—Ä–µ–ª—ñ–∫ –º–æ–∂–ª–∏–≤–∏—Ö "—Ç–µ—Ä–º—ñ–Ω—ñ–≤ —Å–ª—É–∂–±–∏" –æ–±'—î–∫—Ç—ñ–≤:

```csharp showLineNumbers
// Lifetime.cs
namespace SimpleIoC;

/// <summary>
/// –í–∏–∑–Ω–∞—á–∞—î, —è–∫ –¥–æ–≤–≥–æ –∂–∏–≤–µ –µ–∫–∑–µ–º–ø–ª—è—Ä –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É.
/// </summary>
public enum Lifetime
{
    /// <summary>
    /// –ù–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ.
    /// –ê–Ω–∞–ª–æ–≥—ñ—è: –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∏–π —Å—Ç–∞–∫–∞–Ω—á–∏–∫ ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ —Ç–∞ –≤–∏–∫–∏–Ω—É–≤.
    /// </summary>
    Transient,

    /// <summary>
    /// –Ñ–¥–∏–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –≤–µ—Å—å —á–∞—Å —Ä–æ–±–æ—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
    /// –ê–Ω–∞–ª–æ–≥—ñ—è: –ø—Ä–∏–Ω—Ç–µ—Ä –≤ –æ—Ñ—ñ—Å—ñ ‚Äî –æ–¥–∏–Ω –Ω–∞ –≤—Å—ñ—Ö.
    /// </summary>
    Singleton,

    /// <summary>
    /// –Ñ–¥–∏–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä —É –º–µ–∂–∞—Ö –ø–æ—Ç–æ—á–Ω–æ–≥–æ scope.
    /// –ê–Ω–∞–ª–æ–≥—ñ—è: –≤–∞—à –æ—Å–æ–±–∏—Å—Ç–∏–π —Å—Ç—ñ–ª–µ—Ü—å –Ω–∞ —Ä–æ–±–æ—Ç—ñ ‚Äî –≤–∞—à –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å,
    /// –∞–ª–µ –Ω–æ–≤–∏–π –¥–µ–Ω—å ‚Äî —Ü–µ –Ω–æ–≤–∏–π "scope" —ñ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ —ñ–Ω—à–∏–π —Å—Ç—ñ–ª–µ—Ü—å.
    /// </summary>
    Scoped
}
```

### 1.2. ServiceDescriptor ‚Äî —Å–µ—Ä—Ü–µ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó

**`ServiceDescriptor`** ‚Äî —Ü–µ –∑–∞–ø–∏—Å —É "–∫–Ω–∏–∑—ñ —Ä–µ—Ü–µ–ø—Ç—ñ–≤" –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –í—ñ–Ω –∑–±–µ—Ä—ñ–≥–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è "–∫–æ–ª–∏ —Ö—Ç–æ—Å—å –ø—Ä–æ—Å–∏—Ç—å `IEmailService` ‚Äî —â–æ —Å–∞–º–µ –¥–∞—Ç–∏ —ñ —è–∫ —Ü–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏?":

```csharp showLineNumbers
// ServiceDescriptor.cs
namespace SimpleIoC;

/// <summary>
/// –û–ø–∏—Å –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É ‚Äî "—Ä–µ—Ü–µ–ø—Ç" –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
/// </summary>
public class ServiceDescriptor
{
    /// <summary>
    /// –¢–∏–ø, —è–∫–∏–π "–∑–∞–ø–∏—Ç—É—é—Ç—å" (–∑–∞–∑–≤–∏—á–∞–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å).
    /// –ù–∞–ø—Ä–∏–∫–ª–∞–¥: IEmailService
    /// </summary>
    public Type ServiceType { get; }

    /// <summary>
    /// –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ç–∏–ø, —â–æ —Ä–µ–∞–ª—ñ–∑—É—î ServiceType.
    /// –ù–∞–ø—Ä–∏–∫–ª–∞–¥: SmtpEmailService
    /// –ú–æ–∂–µ –±—É—Ç–∏ null, —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è Factory.
    /// </summary>
    public Type? ImplementationType { get; }

    /// <summary>
    /// –§–∞–±—Ä–∏—á–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–∫–∑–µ–º–ø–ª—è—Ä–∞.
    /// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ImplementationType ‚Äî –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Å–∫–ª–∞–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
    /// </summary>
    public Func<IServiceProvider, object>? Factory { get; }

    /// <summary>
    /// –¢–µ—Ä–º—ñ–Ω —Å–ª—É–∂–±–∏ —Å–µ—Ä–≤—ñ—Å—É.
    /// </summary>
    public Lifetime Lifetime { get; }

    /// <summary>
    /// –ö–µ—à–æ–≤–∞–Ω–∏–π Singleton-–µ–∫–∑–µ–º–ø–ª—è—Ä (–∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É resolve).
    /// </summary>
    internal object? SingletonInstance { get; set; }

    // --- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏ ---

    /// <summary>
    /// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ —Ç–∏–ø–∏ (Interface + Implementation).
    /// </summary>
    public ServiceDescriptor(Type serviceType, Type implementationType, Lifetime lifetime)
    {
        ServiceType = serviceType;
        ImplementationType = implementationType;
        Lifetime = lifetime;
    }

    /// <summary>
    /// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ factory-—Ñ—É–Ω–∫—Ü—ñ—é.
    /// </summary>
    public ServiceDescriptor(Type serviceType, Func<IServiceProvider, object> factory, Lifetime lifetime)
    {
        ServiceType = serviceType;
        Factory = factory;
        Lifetime = lifetime;
    }

    /// <summary>
    /// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≥–æ—Ç–æ–≤–æ–≥–æ Singleton-–µ–∫–∑–µ–º–ø–ª—è—Ä–∞.
    /// </summary>
    public ServiceDescriptor(Type serviceType, object instance)
    {
        ServiceType = serviceType;
        SingletonInstance = instance;
        Lifetime = Lifetime.Singleton;
    }

    public override string ToString()
        => $"{Lifetime}: {ServiceType.Name} ‚Üí {ImplementationType?.Name ?? "Factory"}";
}
```

**–†–æ–∑–±—ñ—Ä –∫–ª—é—á–æ–≤–∏—Ö —á–∞—Å—Ç–∏–Ω:**

- `ServiceType` ‚Äî —Ü–µ "–∫–ª—é—á" —É –Ω–∞—à–æ–º—É —Ä–µ—î—Å—Ç—Ä—ñ. –ó–∞ —Ü–∏–º —Ç–∏–ø–æ–º –±—É–¥—É—Ç—å —à—É–∫–∞—Ç–∏ —Å–µ—Ä–≤—ñ—Å.
- `ImplementationType` ‚Äî "–∑–Ω–∞—á–µ–Ω–Ω—è" ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –∫–ª–∞—Å, —è–∫–∏–π —Ç—Ä–µ–±–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —á–µ—Ä–µ–∑ `new` (–∞–ª–µ —á–µ—Ä–µ–∑ Reflection).
- `Factory` ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ImplementationType. –ö–æ–ª–∏ –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –∫–∞—Å—Ç–æ–º–Ω–∏–π –∫–æ–¥ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
- `SingletonInstance` ‚Äî –∫–µ—à –¥–ª—è Singleton: –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—É—Ç.

---

## –ö—Ä–æ–∫ 2: SimpleContainer ‚Äî –∑–±–∏—Ä–∞—á —Ä–µ—Ü–µ–ø—Ç—ñ–≤

**`SimpleContainer`** ‚Äî —Ü–µ –º—ñ—Å—Ü–µ, –¥–µ –≤–∏ "—Ä–µ—î—Å—Ç—Ä—É—î—Ç–µ —Ä–µ—Ü–µ–ø—Ç–∏". –í—ñ–Ω –Ω–µ —Å—Ç–≤–æ—Ä—é—î –æ–±'—î–∫—Ç—ñ–≤ —Å–∞–º ‚Äî –≤—ñ–Ω –ª–∏—à–µ –∑–±–µ—Ä—ñ–≥–∞—î `ServiceDescriptor`-–∏ —Ç–∞ –≤–º—ñ—î –∑ –Ω–∏—Ö –±—É–¥—É–≤–∞—Ç–∏ `ServiceProvider`.

```csharp showLineNumbers
// SimpleContainer.cs
namespace SimpleIoC;

/// <summary>
/// –ë—É–¥—ñ–≤–Ω–∏–∫ IoC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ê–Ω–∞–ª–æ–≥ IServiceCollection –∑ Microsoft DI.
/// –ó–±–∏—Ä–∞—î —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞ –±—É–¥—É—î IServiceProvider.
/// </summary>
public class SimpleContainer
{
    // –°–ø–∏—Å–æ–∫ —É—Å—ñ—Ö –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö "—Ä–µ—Ü–µ–ø—Ç—ñ–≤"
    private readonly List<ServiceDescriptor> _descriptors = new();

    // -------------------------------------------------------------------------
    // –ú–µ—Ç–æ–¥–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
    // -------------------------------------------------------------------------

    /// <summary>
    /// –†–µ—î—Å—Ç—Ä—É—î —Å–µ—Ä–≤—ñ—Å —á–µ—Ä–µ–∑ —Ç–∏–ø–∏: "–∫–æ–ª–∏ —Ö—Ç–æ—Å—å —Ö–æ—á–µ TService ‚Äî –¥–∞–π TImplementation"
    /// </summary>
    public SimpleContainer Register<TService, TImplementation>(Lifetime lifetime = Lifetime.Transient)
        where TImplementation : TService
    {
        _descriptors.Add(new ServiceDescriptor(
            typeof(TService),
            typeof(TImplementation),
            lifetime
        ));
        return this; // Fluent API
    }

    /// <summary>
    /// –†–µ—î—Å—Ç—Ä—É—î —Å–µ—Ä–≤—ñ—Å —á–µ—Ä–µ–∑ factory-—Ñ—É–Ω–∫—Ü—ñ—é.
    /// –ö–æ—Ä–∏—Å–Ω–æ, –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Å–∫–ª–∞–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
    /// </summary>
    public SimpleContainer Register<TService>(
        Func<IServiceProvider, TService> factory,
        Lifetime lifetime = Lifetime.Transient)
        where TService : class
    {
        _descriptors.Add(new ServiceDescriptor(
            typeof(TService),
            sp => factory(sp)!,
            lifetime
        ));
        return this;
    }

    /// <summary>
    /// –†–µ—î—Å—Ç—Ä—É—î –≥–æ—Ç–æ–≤–∏–π Singleton-–µ–∫–∑–µ–º–ø–ª—è—Ä.
    /// </summary>
    public SimpleContainer RegisterSingleton<TService>(TService instance)
        where TService : class
    {
        var descriptor = new ServiceDescriptor(typeof(TService), instance);
        _descriptors.Add(descriptor);
        return this;
    }

    // -------------------------------------------------------------------------
    // Shortcut –º–µ—Ç–æ–¥–∏ (—è–∫ AddTransient, AddScoped, AddSingleton —É Microsoft DI)
    // -------------------------------------------------------------------------

    public SimpleContainer AddTransient<TService, TImplementation>()
        where TImplementation : TService
        => Register<TService, TImplementation>(Lifetime.Transient);

    public SimpleContainer AddScoped<TService, TImplementation>()
        where TImplementation : TService
        => Register<TService, TImplementation>(Lifetime.Scoped);

    public SimpleContainer AddSingleton<TService, TImplementation>()
        where TImplementation : TService
        => Register<TService, TImplementation>(Lifetime.Singleton);

    // -------------------------------------------------------------------------
    // –ü–æ–±—É–¥–æ–≤–∞ ServiceProvider
    // -------------------------------------------------------------------------

    /// <summary>
    /// –§—ñ–Ω–∞–ª—ñ–∑—É—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —ñ –±—É–¥—É—î ServiceProvider.
    /// –ü—ñ—Å–ª—è –≤–∏–∫–ª–∏–∫—É —Ü—å–æ–≥–æ –º–µ—Ç–æ–¥—É —Å–ø–∏—Å–æ–∫ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ–π —Å—Ç–∞—î –Ω–µ–∑–º—ñ–Ω–Ω–∏–º.
    /// </summary>
    public SimpleServiceProvider BuildServiceProvider()
    {
        // –ü–µ—Ä–µ–¥–∞—î–º–æ –∫–æ–ø—ñ—é —Å–ø–∏—Å–∫—É, —â–æ–± –ø–æ–¥–∞–ª—å—à—ñ –∑–º—ñ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ –≤–ø–ª–∏–≤–∞–ª–∏ –Ω–∞ provider
        return new SimpleServiceProvider(_descriptors.AsReadOnly());
    }
}
```

**–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ Fluent API** ‚Äî –∫–æ–∂–µ–Ω –º–µ—Ç–æ–¥ –ø–æ–≤–µ—Ä—Ç–∞—î `this`, —â–æ –¥–æ–∑–≤–æ–ª—è—î –ª–∞–Ω—Ü—é–∂–∫–æ–≤—ñ –≤–∏–∫–ª–∏–∫–∏:

```csharp
var container = new SimpleContainer()
    .AddSingleton<ILogger, ConsoleLogger>()
    .AddScoped<IOrderRepository, SqlOrderRepository>()
    .AddTransient<IEmailService, SmtpEmailService>()
    .AddScoped<OrderService, OrderService>();

var provider = container.BuildServiceProvider();
```

---

## –ö—Ä–æ–∫ 3: SimpleServiceProvider ‚Äî —Å–µ—Ä—Ü–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

–¶–µ –Ω–∞–π—Ü—ñ–∫–∞–≤—ñ—à–∞ —Ç–∞ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∞ —á–∞—Å—Ç–∏–Ω–∞. **`SimpleServiceProvider`** ‚Äî —Ü–µ —Ç–∞ —Å–∞–º–∞ "–º–∞–≥—ñ—è", —è–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Ç–∞ —Å—Ç–≤–æ—Ä—É—î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ.

### 3.1. –ë–∞–∑–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```csharp showLineNumbers
// SimpleServiceProvider.cs
namespace SimpleIoC;

using System.Collections.ObjectModel;
using System.Reflection;

/// <summary>
/// –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Å–µ—Ä–≤—ñ—Å—ñ–≤ ‚Äî –æ–±'—î–∫—Ç, —â–æ –≤–∏—Ä—ñ—à—É—î (resolve) –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ.
/// –ê–Ω–∞–ª–æ–≥ IServiceProvider –∑ Microsoft DI.
/// </summary>
public class SimpleServiceProvider : IServiceProvider, IServiceScopeFactory, IDisposable
{
    private readonly ReadOnlyCollection<ServiceDescriptor> _descriptors;

    // –ö–µ—à Singleton-–µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ (SHARED –º—ñ–∂ —É—Å—ñ–º–∞ scope*!)
    // (*–£ –Ω–∞—à–æ–º—É —Å–ø—Ä–æ—â–µ–Ω–æ–º—É –≤–∞—Ä—ñ–∞–Ω—Ç—ñ singleton –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É root provider)
    private readonly Dictionary<Type, object> _singletonCache = new();

    // –ö–µ—à Scoped-–µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ (–£–ù–Ü–ö–ê–õ–¨–ù–ò–ô –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ scope)
    // null = —Ü–µ root provider (–Ω–µ scope)
    private readonly Dictionary<Type, object>? _scopedCache;

    // –ü—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ –≤–∫–∞–∑—É—î —á–∏ —Ü–µ "scoped" –ø—Ä–æ–≤–∞–π–¥–µ—Ä (–¥–æ—á—ñ—Ä–Ω—ñ–π scope)
    private readonly bool _isScope;

    // –°–ø–∏—Å–æ–∫ IDisposable –æ–±'—î–∫—Ç—ñ–≤, —è–∫—ñ —Ü–µ–π provider –ø–æ–≤–∏–Ω–µ–Ω –∑–Ω–∏—â–∏—Ç–∏ –ø—Ä–∏ dispose
    private readonly List<IDisposable> _disposables = new();

    private bool _disposed;

    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è root provider
    public SimpleServiceProvider(ReadOnlyCollection<ServiceDescriptor> descriptors)
    {
        _descriptors = descriptors;
        _isScope = false;
    }

    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è –¥–æ—á—ñ—Ä–Ω—å–æ–≥–æ scope
    private SimpleServiceProvider(
        ReadOnlyCollection<ServiceDescriptor> descriptors,
        Dictionary<Type, object> singletonCache)
    {
        _descriptors = descriptors;
        _singletonCache = singletonCache;
        _scopedCache = new Dictionary<Type, object>(); // –û–∫—Ä–µ–º–∏–π –∫–µ—à –¥–ª—è scoped
        _isScope = true;
    }

    // --- IServiceScopeFactory ---
    public IServiceScope CreateScope()
    {
        var scopedProvider = new SimpleServiceProvider(_descriptors, _singletonCache);
        return new SimpleServiceScope(scopedProvider);
    }
}
```

### 3.2. GetService ‚Äî –≥–æ–ª–æ–≤–Ω–∏–π –º–µ—Ç–æ–¥

–û—Å—å –¥–µ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è —Å–ø—Ä–∞–≤–∂–Ω—è "–º–∞–≥—ñ—è":

```csharp showLineNumbers
// (–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è SimpleServiceProvider.cs)

/// <summary>
/// –í–∏—Ä—ñ—à—É—î (resolve) –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –¥–ª—è –∑–∞–¥–∞–Ω–æ–≥–æ —Ç–∏–ø—É.
/// –Ø–∫—â–æ —Ç–∏–ø –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î null.
/// </summary>
public object? GetService(Type serviceType)
{
    if (_disposed)
        throw new ObjectDisposedException(nameof(SimpleServiceProvider));

    // –û—Å–æ–±–ª–∏–≤–∏–π –≤–∏–ø–∞–¥–æ–∫: —Ö—Ç–æ—Å—å —Ö–æ—á–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–∞–º IServiceProvider –∞–±–æ IServiceScopeFactory
    if (serviceType == typeof(IServiceProvider))
        return this;
    if (serviceType == typeof(IServiceScopeFactory))
        return this;

    // –®—É–∫–∞—î–º–æ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –¥–ª—è –∑–∞–ø–∏—Ç—É–≤–∞–Ω–æ–≥–æ —Ç–∏–ø—É
    // –Ø–∫—â–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ –∫—ñ–ª—å–∫–∞ ‚Äî –±–µ—Ä–µ–º–æ –û–°–¢–ê–ù–ù–Ü–ô (—è–∫ —É Microsoft DI)
    var descriptor = _descriptors.LastOrDefault(d => d.ServiceType == serviceType);

    if (descriptor == null)
        return null; // –°–µ—Ä–≤—ñ—Å –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π

    return Resolve(descriptor);
}

/// <summary>
/// –ê–Ω–∞–ª–æ–≥ GetRequiredService ‚Äî –∫–∏–¥–∞—î exception —è–∫—â–æ —Å–µ—Ä–≤—ñ—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.
/// </summary>
public object GetRequiredService(Type serviceType)
{
    var service = GetService(serviceType);
    if (service == null)
        throw new InvalidOperationException(
            $"‚ùå –°–µ—Ä–≤—ñ—Å —Ç–∏–ø—É '{serviceType.FullName}' –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ. " +
            $"–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤–∏ –¥–æ–¥–∞–ª–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é: container.Register<{serviceType.Name}, ...>()");

    return service;
}

// Generic –≤–µ—Ä—Å—ñ—è –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ
public T GetRequiredService<T>() => (T)GetRequiredService(typeof(T));
public T? GetService<T>() => (T?)GetService(typeof(T));
```

### 3.3. Resolve ‚Äî –ª–æ–≥—ñ–∫–∞ lifecycle

```csharp showLineNumbers
// (–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è SimpleServiceProvider.cs)

/// <summary>
/// –§–∞–∫—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î –∞–±–æ –ø–æ–≤–µ—Ä—Ç–∞—î –∫–µ—à–æ–≤–∞–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤—ñ—Å—É,
/// –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –π–æ–≥–æ Lifetime.
/// </summary>
private object Resolve(ServiceDescriptor descriptor)
{
    switch (descriptor.Lifetime)
    {
        case Lifetime.Singleton:
            return ResolveSingleton(descriptor);

        case Lifetime.Scoped:
            return ResolveScoped(descriptor);

        case Lifetime.Transient:
        default:
            // Transient: –∑–∞–≤–∂–¥–∏ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä ‚Äî –±–µ–∑ –∫–µ—à—É–≤–∞–Ω–Ω—è
            var instance = CreateInstance(descriptor);
            TrackDisposable(instance); // –í—ñ–¥—Å—Ç–µ–∂—É—î–º–æ –¥–ª—è Dispose
            return instance;
    }
}

private object ResolveSingleton(ServiceDescriptor descriptor)
{
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–µ—à Singleton (–≤—ñ–Ω —Å–ø—ñ–ª—å–Ω–∏–π –¥–ª—è –≤—Å—ñ—Ö scope)
    if (_singletonCache.TryGetValue(descriptor.ServiceType, out var cached))
        return cached;

    // –Ø–∫—â–æ –≤ –∫–µ—à—ñ –Ω–µ–º–∞—î ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–æ–ª–µ SingletonInstance (pre-created instance)
    if (descriptor.SingletonInstance != null)
    {
        _singletonCache[descriptor.ServiceType] = descriptor.SingletonInstance;
        return descriptor.SingletonInstance;
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π —Ç–∞ –∫–µ—à—É—î–º–æ
    var instance = CreateInstance(descriptor);
    _singletonCache[descriptor.ServiceType] = instance;

    // –í–ê–ñ–õ–ò–í–û: Singleton Disposables –∑–Ω–∏—â—É—é—Ç—å—Å—è –¢–Ü–õ–¨–ö–ò –ø—Ä–∏ –∑–Ω–∏—â–µ–Ω–Ω—ñ root provider!
    if (instance is IDisposable disposable)
        _disposables.Add(disposable);

    return instance;
}

private object ResolveScoped(ServiceDescriptor descriptor)
{
    // –Ø–∫—â–æ —Ü–µ root provider (–Ω–µ scope) ‚Äî —Å—Ç–≤–æ—Ä—é—î–º–æ —è–∫ Transient
    // (–∞–±–æ –∫–∏–¥–∞—î–º–æ exception ‚Äî –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó)
    if (_scopedCache == null)
    {
        // –í Microsoft DI —î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ ValidateScopes, —è–∫–∞ –∫–∏–¥–∞—î exception —Ç—É—Ç
        // –ú–∏ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ —Ç–∞–∫–æ–∂ –∫–∏–Ω–µ–º–æ:
        throw new InvalidOperationException(
            $"‚ö†Ô∏è –°–ø—Ä–æ–±–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ Scoped-—Å–µ—Ä–≤—ñ—Å '{descriptor.ServiceType.Name}' " +
            $"–ø–æ–∑–∞ –º–µ–∂–∞–º–∏ Scope. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ IServiceScopeFactory.CreateScope().");
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ scoped –∫–µ—à
    if (_scopedCache.TryGetValue(descriptor.ServiceType, out var cached))
        return cached;

    // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∞ –∫–µ—à—É—î–º–æ –≤ scoped –∫–µ—à
    var instance = CreateInstance(descriptor);
    _scopedCache[descriptor.ServiceType] = instance;
    TrackDisposable(instance);

    return instance;
}

private void TrackDisposable(object instance)
{
    if (instance is IDisposable disposable)
        _disposables.Add(disposable);
}
```

### 3.4. CreateInstance ‚Äî —Ä–µ—Ñ–ª–µ–∫—Å—ñ—è –≤ –¥—ñ—ó

**–¶–µ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∞ —á–∞—Å—Ç–∏–Ω–∞!** –°–∞–º–µ —Ç—É—Ç –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Å–ø—Ä–∞–≤–∂–Ω—è –º–∞–≥—ñ—è ‚Äî —Ä–µ—Ñ–ª–µ–∫—Å—ñ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏—Ä—ñ—à—É—î –≥—Ä–∞—Ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π:

```csharp showLineNumbers
// (–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è SimpleServiceProvider.cs)

/// <summary>
/// –°—Ç–≤–æ—Ä—é—î –µ–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤—ñ—Å—É:
/// - –ß–µ—Ä–µ–∑ Factory (—è–∫—â–æ –∑–∞–¥–∞–Ω–æ)
/// - –ß–µ—Ä–µ–∑ —Ä–µ—Ñ–ª–µ–∫—Å—ñ—é (—ñ–Ω–∞–∫—à–µ)
/// </summary>
private object CreateInstance(ServiceDescriptor descriptor)
{
    // –Ø–∫—â–æ –∑–∞–¥–∞–Ω–æ factory ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ó—ó
    if (descriptor.Factory != null)
        return descriptor.Factory(this);

    // –Ü–Ω–∞–∫—à–µ ‚Äî —á–µ—Ä–µ–∑ —Ä–µ—Ñ–ª–µ–∫—Å—ñ—é
    if (descriptor.ImplementationType == null)
        throw new InvalidOperationException(
            $"–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è '{descriptor.ServiceType.Name}': " +
            "–Ω–µ –∑–∞–¥–∞–Ω–æ –Ω—ñ ImplementationType, –Ω—ñ Factory.");

    return CreateInstanceViaReflection(descriptor.ImplementationType);
}

/// <summary>
/// –ú–∞–≥—ñ—è —Ä–µ—Ñ–ª–µ–∫—Å—ñ—ó: –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —ñ –ø–µ—Ä–µ–¥–∞—î –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
/// —É –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –Ω–∞—à–æ–≥–æ –∫–ª–∞—Å—É.
///
/// –ê–ª–≥–æ—Ä–∏—Ç–º:
/// 1. –ë–µ—Ä–µ–º–æ –ø–µ—Ä—à–∏–π (–Ω–∞–π–±—ñ–ª—å—à–∏–π) –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
/// 2. –î–∏–≤–∏–º–æ—Å—å –Ω–∞ –≤—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
/// 3. –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ‚Äî —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ resolve –π–æ–≥–æ —Ç–∏–ø
/// 4. –í–∏–∫–ª–∏–∫–∞—î–º–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑ –æ—Ç—Ä–∏–º–∞–Ω–∏–º–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏
/// </summary>
private object CreateInstanceViaReflection(Type implementationType)
{
    // –ù–∞ —Å—Ç–µ–∫—É –º–æ–∂–µ –±—É—Ç–∏ circular dependency ‚Äî –¥–æ–±—Ä–µ –± —Ü–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏,
    // –∞–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –º–∏ —Ü—å–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ —Ç—É—Ç (Microsoft DI –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ü–µ)

    // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –ø—É–±–ª—ñ—á–Ω—ñ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏
    var constructors = implementationType.GetConstructors(BindingFlags.Public | BindingFlags.Instance);

    if (constructors.Length == 0)
        throw new InvalidOperationException(
            $"–ö–ª–∞—Å '{implementationType.Name}' –Ω–µ –º–∞—î –ø—É–±–ª—ñ—á–Ω–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ñ–≤. " +
            "IoC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –π–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä.");

    // –í–∏–±–∏—Ä–∞—î–º–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑ –Ω–∞–π–±—ñ–ª—å—à–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
    // (Microsoft DI –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç—É —Å–∞–º—É —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é)
    var constructor = constructors.OrderByDescending(c => c.GetParameters().Length).First();

    // –û—Ç—Ä–∏–º—É—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
    var parameters = constructor.GetParameters();

    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ resolve –∫–æ–∂–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä
    var arguments = new object[parameters.Length];
    for (int i = 0; i < parameters.Length; i++)
    {
        var paramType = parameters[i].ParameterType;

        // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ —Å–µ—Ä–≤—ñ—Å –¥–ª—è —Ü—å–æ–≥–æ —Ç–∏–ø—É –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        var service = GetService(paramType);

        if (service == null)
        {
            // –Ø–∫—â–æ –ø–∞—Ä–∞–º–µ—Ç—Ä –º–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –π–æ–≥–æ
            if (parameters[i].HasDefaultValue)
            {
                arguments[i] = parameters[i].DefaultValue!;
            }
            else
            {
                throw new InvalidOperationException(
                    $"‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è resolve –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ '{paramType.Name}' " +
                    $"–¥–ª—è –∫–ª–∞—Å—É '{implementationType.Name}'. " +
                    $"–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ '{paramType.Name}' –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ.");
            }
        }
        else
        {
            arguments[i] = service;
        }
    }

    // –í–∏–∫–ª–∏–∫–∞—î–º–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑ —É—Å—ñ–º–∞ –∑–Ω–∞–π–¥–µ–Ω–∏–º–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏
    return constructor.Invoke(arguments);
}
```

**–û—Å—å —è–∫ —Ü–µ –ø—Ä–∞—Ü—é—î –∫—Ä–æ–∫ –∑–∞ –∫—Ä–æ–∫–æ–º:**

–£—è–≤—ñ–º–æ —Ç–∞–∫–∏–π –≥—Ä–∞—Ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π:

```
OrderService(IOrderRepository repo, IEmailService email, ILogger logger)
                ‚Üï                        ‚Üï                  ‚Üï
     SqlOrderRepository            SmtpEmailService    ConsoleLogger
     (IDbContext context)           (ISmtpConfig cfg)    (no deps)
                ‚Üï                        ‚Üï
          AppDbContext              SmtpConfig
          (no deps)                 (no deps)
```

–ü—Ä–∏ –≤–∏–∫–ª–∏–∫—É `provider.GetRequiredService<OrderService>()`:

::steps

### 1. –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä OrderService

–ó–Ω–∞—Ö–æ–¥–∏–º–æ: `OrderService(IOrderRepository, IEmailService, ILogger)`

### 2. Resolve –ø–µ—Ä—à–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: IOrderRepository

–ó–Ω–∞—Ö–æ–¥–∏–º–æ `SqlOrderRepository`. –í—ñ–Ω –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ `IDbContext`.

### 3. –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ resolve IDbContext

–ó–Ω–∞—Ö–æ–¥–∏–º–æ `AppDbContext`. –í—ñ–Ω –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –Ω–µ –º–∞—î. **–°—Ç–≤–æ—Ä—é—î–º–æ!**

### 4. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –≤–≥–æ—Ä—É: —Å—Ç–≤–æ—Ä—é—î–º–æ SqlOrderRepository

–ú–∞—î–º–æ `AppDbContext` ‚Äî –ø–µ—Ä–µ–¥–∞—î–º–æ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä. **–°—Ç–≤–æ—Ä—é—î–º–æ SqlOrderRepository!**

### 5. Resolve –¥—Ä—É–≥–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: IEmailService

–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –∑–Ω–∞—Ö–æ–¥–∏–º–æ SmtpEmailService(ISmtpConfig) ‚Üí SmtpConfig(no deps). –†–µ–∫—É—Ä—Å—ñ—è!

### 6. Resolve —Ç—Ä–µ—Ç—å–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: ILogger

ConsoleLogger –Ω–µ –º–∞—î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π. **–°—Ç–≤–æ—Ä—é—î–º–æ!**

### 7. –°—Ç–≤–æ—Ä—é—î–º–æ OrderService

–ú–∞—î–º–æ –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ. **–í–∏–∫–ª–∏–∫–∞—î–º–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä!**

::

---

## –ö—Ä–æ–∫ 4: Scope ‚Äî —ñ–∑–æ–ª—å–æ–≤–∞–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä

Scoped lifetime –≤–∏–º–∞–≥–∞—î –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó **Scope** ‚Äî —ñ–∑–æ–ª—å–æ–≤–∞–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É, –≤ —è–∫–æ–º—É scoped —Å–µ—Ä–≤—ñ—Å–∏ –∂–∏–≤—É—Ç—å —ñ –ø–æ–º–∏—Ä–∞—é—Ç—å —Ä–∞–∑–æ–º.

```csharp showLineNumbers
// SimpleServiceScope.cs
namespace SimpleIoC;

/// <summary>
/// Scope ‚Äî —ñ–∑–æ–ª—å–æ–≤–∞–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.
/// –í ASP.NET Core –æ–¥–∏–Ω HTTP-–∑–∞–ø–∏—Ç = –æ–¥–∏–Ω scope.
/// –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ scope –∑–Ω–∏—â—É—é—Ç—å—Å—è –≤—Å—ñ Scoped-—Å–µ—Ä–≤—ñ—Å–∏.
/// </summary>
public class SimpleServiceScope : IServiceScope, IDisposable
{
    public IServiceProvider ServiceProvider { get; }

    private bool _disposed;

    public SimpleServiceScope(SimpleServiceProvider scopedProvider)
    {
        ServiceProvider = scopedProvider;
    }

    public void Dispose()
    {
        if (_disposed) return;
        _disposed = true;

        // –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ scope ‚Äî –∑–Ω–∏—â—É—î–º–æ scoped provider,
        // —â–æ –≤ —Å–≤–æ—é —á–µ—Ä–≥—É –∑–Ω–∏—â–∏—Ç—å –≤—Å—ñ Scoped —Ç–∞ Transient IDisposable —Å–µ—Ä–≤—ñ—Å–∏
        if (ServiceProvider is IDisposable disposable)
            disposable.Dispose();
    }
}
```

### IDispose —É SimpleServiceProvider

```csharp showLineNumbers
// (–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è SimpleServiceProvider.cs)

public void Dispose()
{
    if (_disposed) return;
    _disposed = true;

    // –ó–Ω–∏—â—É—î–º–æ –≤—Å—ñ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω—ñ IDisposable –æ–±'—î–∫—Ç–∏ —É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É
    // (–∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –¥–æ –ø–æ—Ä—è–¥–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è ‚Äî —è–∫ —ñ –≤ Microsoft DI)
    for (int i = _disposables.Count - 1; i >= 0; i--)
    {
        _disposables[i].Dispose();
    }

    _disposables.Clear();

    // –Ø–∫—â–æ —Ü–µ root provider ‚Äî —Ç–∞–∫–æ–∂ –æ—á–∏—â–∞—î–º–æ singleton –∫–µ—à
    if (!_isScope)
    {
        foreach (var singleton in _singletonCache.Values)
        {
            if (singleton is IDisposable d)
                d.Dispose();
        }
        _singletonCache.Clear();
    }
}
```

---

## –ö—Ä–æ–∫ 5: –ó–±–∏—Ä–∞—î–º–æ –≤—Å–µ —Ä–∞–∑–æ–º

–ü–æ–¥–∏–≤–∏–º–æ—Å—å –Ω–∞ –ø–æ–≤–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –Ω–∞—à–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```csharp showLineNumbers
// –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è SimpleContainer

// --- –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ–≤ —Ç–∞ –∫–ª–∞—Å—ñ–≤ ---

public interface ILogger
{
    void Log(string message);
}

public interface IOrderRepository
{
    void Save(string order);
}

public interface IEmailService
{
    void Send(string to, string body);
}

// –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó
public class ConsoleLogger : ILogger, IDisposable
{
    private readonly string _prefix;

    public ConsoleLogger()
    {
        _prefix = "[LOG]";
        Console.WriteLine("ConsoleLogger created");
    }

    public void Log(string message) => Console.WriteLine($"{_prefix} {message}");

    public void Dispose()
    {
        Console.WriteLine("ConsoleLogger disposed");
    }
}

public class InMemoryOrderRepository : IOrderRepository
{
    private readonly ILogger _logger;
    private readonly List<string> _orders = new();

    public InMemoryOrderRepository(ILogger logger)
    {
        _logger = logger;
        _logger.Log("InMemoryOrderRepository created");
    }

    public void Save(string order)
    {
        _orders.Add(order);
        _logger.Log($"Order saved: {order}. Total orders: {_orders.Count}");
    }
}

public class SmtpEmailService : IEmailService
{
    private readonly ILogger _logger;

    public SmtpEmailService(ILogger logger)
    {
        _logger = logger;
        _logger.Log("SmtpEmailService created");
    }

    public void Send(string to, string body)
    {
        _logger.Log($"Email sent to {to}: {body}");
    }
}

public class OrderService
{
    private readonly IOrderRepository _repository;
    private readonly IEmailService _emailService;
    private readonly ILogger _logger;

    public OrderService(IOrderRepository repository, IEmailService emailService, ILogger logger)
    {
        _repository = repository;
        _emailService = emailService;
        _logger = logger;
        _logger.Log("OrderService created");
    }

    public void PlaceOrder(string customerEmail, string orderDetails)
    {
        _repository.Save(orderDetails);
        _emailService.Send(customerEmail, $"–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ: {orderDetails}");
        _logger.Log($"Order placed for {customerEmail}");
    }
}

// --- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ---

Console.WriteLine("=== –ë—É–¥—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ===");
var container = new SimpleContainer()
    .AddSingleton<ILogger, ConsoleLogger>()      // –û–¥–∏–Ω –¥–ª—è –≤—Å—ñ—Ö!
    .AddScoped<IOrderRepository, InMemoryOrderRepository>()
    .AddScoped<IEmailService, SmtpEmailService>()
    .AddScoped<OrderService, OrderService>();

var rootProvider = container.BuildServiceProvider();

Console.WriteLine("\n=== Scope 1 (HTTP Request 1) ===");
using (var scope1 = rootProvider.CreateScope())
{
    var orderService1 = scope1.ServiceProvider.GetRequiredService<OrderService>();
    orderService1.PlaceOrder("alice@example.com", "MacBook Pro");

    // –û—Ç—Ä–∏–º—É—î–º–æ —â–µ —Ä–∞–∑ ‚Äî —Ç–æ–π —Å–∞–º–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä (Scoped!)
    var orderService1Again = scope1.ServiceProvider.GetRequiredService<OrderService>();
    Console.WriteLine($"–¢–æ–π —Å–∞–º–∏–π OrderService? {ReferenceEquals(orderService1, orderService1Again)}"); // True!
} // Scope –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è ‚Äî Scoped —Å–µ—Ä–≤—ñ—Å–∏ –∑–Ω–∏—â—É—é—Ç—å—Å—è

Console.WriteLine("\n=== Scope 2 (HTTP Request 2) ===");
using (var scope2 = rootProvider.CreateScope())
{
    var orderService2 = scope2.ServiceProvider.GetRequiredService<OrderService>();
    orderService2.PlaceOrder("bob@example.com", "iPhone 16");
    // –ù–æ–≤–∏–π OrderService! –ê–ª–µ Logger ‚Äî —Ç–æ–π —Å–∞–º–∏–π Singleton
}

Console.WriteLine("\n=== –ó–Ω–∏—â—É—î–º–æ root provider ===");
rootProvider.Dispose(); // ConsoleLogger (singleton) –∑–Ω–∏—â—É—î—Ç—å—Å—è —Ç—É—Ç
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π –≤–∏–≤—ñ–¥:**

```
=== –ë—É–¥—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ===

=== Scope 1 (HTTP Request 1) ===
ConsoleLogger created          ‚Üê Singleton: —Å—Ç–≤–æ—Ä–µ–Ω–æ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –≤–∏–∫–ª–∏–∫—É
InMemoryOrderRepository created
SmtpEmailService created
OrderService created
Order saved: MacBook Pro. Total orders: 1
Email sent to alice@example.com: –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ: MacBook Pro
Order placed for alice@example.com
–¢–æ–π —Å–∞–º–∏–π OrderService? True

=== Scope 2 (HTTP Request 2) ===
InMemoryOrderRepository created  ‚Üê –ù–æ–≤–∏–π scope! –ù–æ–≤—ñ Scoped —Å–µ—Ä–≤—ñ—Å–∏
SmtpEmailService created
OrderService created
Order saved: iPhone 16. Total orders: 1   ‚Üê –ù–æ–≤–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π = –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∑ 0!
Email sent to bob@example.com: –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ: iPhone 16
Order placed for bob@example.com

=== –ó–Ω–∏—â—É—î–º–æ root provider ===
ConsoleLogger disposed             ‚Üê Singleton –∑–Ω–∏—â—É—î—Ç—å—Å—è –∑ root provider
```

---

## –ö—Ä–æ–∫ 6: –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ Microsoft DI

–¢–µ–ø–µ—Ä –ø–æ–¥–∏–≤–∏–º–æ—Å—å, —è–∫ –Ω–∞—à –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ä–µ–∞–ª—å–Ω–æ–º—É `Microsoft.Extensions.DependencyInjection`:

| –ù–∞—à –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä | Microsoft DI | –ü–æ—è—Å–Ω–µ–Ω–Ω—è |
|---|---|---|
| `SimpleContainer` | `IServiceCollection` | –†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä (–∫–æ–ª–µ–∫—Ü—ñ—è ServiceDescriptor) |
| `SimpleServiceProvider` | `ServiceProvider` | Provider (resolver) |
| `SimpleServiceScope` | `IServiceScope` | Scope |
| `.Register<TS, TI>()` | `.AddScoped<TS, TI>()` | –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—É |
| `.BuildServiceProvider()` | `.BuildServiceProvider()` | –¢–æ–π –∂–µ –º–µ—Ç–æ–¥! |
| `GetService<T>()` | `GetService<T>()` | –¢–æ–π –∂–µ –º–µ—Ç–æ–¥! |
| `GetRequiredService<T>()` | `GetRequiredService<T>()` | –¢–æ–π –∂–µ –º–µ—Ç–æ–¥! |
| `CreateScope()` | `CreateScope()` | –¢–æ–π –∂–µ –º–µ—Ç–æ–¥! |

**–©–æ —î –≤ Microsoft DI, —á–æ–≥–æ –Ω–µ–º–∞—î –≤ –Ω–∞—à–æ–º—É:**

- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ñ—Å—Ç—å**: Microsoft –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω—ñ expression trees –∑–∞–º—ñ—Å—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å—ñ—ó (—É 10-50x —à–≤–∏–¥—à–µ)
- **ValidateOnBuild**: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü–∏–∫–ª—ñ—á–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π —Ç–∞ Captive Dependency –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
- **ValidateScopes**: –í–∏—è–≤–ª–µ–Ω–Ω—è —Å–ø—Ä–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ Scoped-—Å–µ—Ä–≤—ñ—Å –∑ Singleton
- **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä–∏**: –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ —á–µ—Ä–µ–∑ Scrutor —Ç–∞ —ñ–Ω—à—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è
- **–£–º–æ–≤–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è**: `TryAdd*` –º–µ—Ç–æ–¥–∏
- **–ú–Ω–æ–∂–∏–Ω–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è**: `GetServices<T>()` –ø–æ–≤–µ—Ä—Ç–∞—î –≤—Å—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

::tip
–ü–æ–≤–Ω—É –≤–µ—Ä—Å—ñ—é –∫–æ–¥—É –Ω–∞—à–æ–≥–æ `SimpleContainer` –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –Ω–∞ GitHub [—Ç—É—Ç](https://github.com/example/simple-ioc-container). –†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–∞ –ø–æ–≥—Ä–∞—Ç–∏—Å—è –∑ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏!
::

---

## –ö—Ä–æ–∫ 7: –†–æ–∑—à–∏—Ä—é—î–º–æ ‚Äî Factory —Ç–∞ Open Generics

### 7.1. Factory-—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤

```csharp showLineNumbers
// –Ü–Ω–æ–¥—ñ –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–∫–ª–∞–¥–Ω—ñ—à–µ –Ω—ñ–∂ –ø—Ä–æ—Å—Ç–æ "new"
var container = new SimpleContainer()
    .AddSingleton<ILogger, ConsoleLogger>()

    // Factory: –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ—Å—Ç—É–ø –¥–æ —ñ–Ω—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤ –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    .Register<IEmailService>(sp =>
    {
        var logger = sp.GetRequiredService<ILogger>();
        var smtpHost = Environment.GetEnvironmentVariable("SMTP_HOST") ?? "localhost";
        var smtpPort = int.Parse(Environment.GetEnvironmentVariable("SMTP_PORT") ?? "587");

        logger.Log($"Creating SmtpEmailService with host: {smtpHost}:{smtpPort}");
        return new SmtpEmailService(smtpHost, smtpPort, logger);
    }, Lifetime.Scoped);
```

### 7.2. Open Generics (—Å–ø—Ä–æ—â–µ–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è)

Microsoft DI –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é open generic types:

```csharp
// Microsoft DI
services.AddScoped(typeof(IRepository<>), typeof(EfRepository<>));
// –¢–µ–ø–µ—Ä IRepository<User>, IRepository<Order>, —Ç–æ—â–æ ‚Äî –≤—Å—ñ –≤–∏—Ä—ñ—à—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!
```

–ù–∞—à —Å–ø—Ä–æ—â–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ open generics:

```csharp showLineNumbers
// –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è GetService –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ open generics
public object? GetService(Type serviceType)
{
    // ... –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–¥ ...

    // –°–ø—Ä–æ–±–∞ –∑–Ω–∞–π—Ç–∏ open generic —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
    if (serviceType.IsGenericType)
    {
        var genericDef = serviceType.GetGenericTypeDefinition();
        var openGenericDescriptor = _descriptors
            .LastOrDefault(d => d.ServiceType == genericDef);

        if (openGenericDescriptor != null)
        {
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ç–∏–ø –∑ generic –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤
            var typeArgs = serviceType.GetGenericArguments();
            var concreteType = openGenericDescriptor.ImplementationType!
                .MakeGenericType(typeArgs);

            var closedDescriptor = new ServiceDescriptor(
                serviceType,
                concreteType,
                openGenericDescriptor.Lifetime);

            return Resolve(closedDescriptor);
        }
    }

    return null;
}
```

---

## –ü–æ–≤–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤ –ø—Ä–æ—î–∫—Ç—É

::code-tree

```csharp [SimpleIoC/Lifetime.cs]
namespace SimpleIoC;

public enum Lifetime { Transient, Singleton, Scoped }
```

```csharp [SimpleIoC/ServiceDescriptor.cs]
namespace SimpleIoC;

public class ServiceDescriptor
{
    public Type ServiceType { get; }
    public Type? ImplementationType { get; }
    public Func<IServiceProvider, object>? Factory { get; }
    public Lifetime Lifetime { get; }
    internal object? SingletonInstance { get; set; }

    public ServiceDescriptor(Type svcType, Type implType, Lifetime lifetime)
    {
        ServiceType = svcType;
        ImplementationType = implType;
        Lifetime = lifetime;
    }

    public ServiceDescriptor(Type svcType, Func<IServiceProvider, object> factory, Lifetime lifetime)
    {
        ServiceType = svcType;
        Factory = factory;
        Lifetime = lifetime;
    }

    public ServiceDescriptor(Type svcType, object instance)
    {
        ServiceType = svcType;
        SingletonInstance = instance;
        Lifetime = Lifetime.Singleton;
    }
}
```

```csharp [SimpleIoC/SimpleContainer.cs]
namespace SimpleIoC;

public class SimpleContainer
{
    private readonly List<ServiceDescriptor> _descriptors = new();

    public SimpleContainer Register<TService, TImpl>(Lifetime lifetime = Lifetime.Transient)
        where TImpl : TService
    {
        _descriptors.Add(new ServiceDescriptor(typeof(TService), typeof(TImpl), lifetime));
        return this;
    }

    public SimpleContainer AddTransient<TS, TI>() where TI : TS
        => Register<TS, TI>(Lifetime.Transient);

    public SimpleContainer AddScoped<TS, TI>() where TI : TS
        => Register<TS, TI>(Lifetime.Scoped);

    public SimpleContainer AddSingleton<TS, TI>() where TI : TS
        => Register<TS, TI>(Lifetime.Singleton);

    public SimpleServiceProvider BuildServiceProvider()
        => new SimpleServiceProvider(_descriptors.AsReadOnly());
}
```

```csharp [SimpleIoC/SimpleServiceScope.cs]
namespace SimpleIoC;

public class SimpleServiceScope : IServiceScope, IDisposable
{
    public IServiceProvider ServiceProvider { get; }
    private bool _disposed;

    public SimpleServiceScope(SimpleServiceProvider provider)
    {
        ServiceProvider = provider;
    }

    public void Dispose()
    {
        if (_disposed) return;
        _disposed = true;
        (ServiceProvider as IDisposable)?.Dispose();
    }
}
```

::

---

## –ü—ñ–¥—Å—É–º–æ–∫

–ú–∏ –ø–æ–±—É–¥—É–≤–∞–ª–∏ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π IoC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä! –ö–ª—é—á–æ–≤—ñ —Ä–µ—á—ñ, —è–∫—ñ –≤–∏ —Ç–µ–ø–µ—Ä –∑–Ω–∞—î—Ç–µ:

1. **ServiceDescriptor** ‚Äî —Ü–µ –∑–∞–ø–∏—Å —É —Ä–µ—î—Å—Ç—Ä—ñ. –í—ñ–Ω –æ–ø–∏—Å—É—î "—Ä–µ—Ü–µ–ø—Ç" –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–∏–ø—É.
2. **–†–µ—Ñ–ª–µ–∫—Å—ñ—è** –¥–æ–∑–≤–æ–ª—è—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏ —Ç–∞ —ó—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ ‚Äî —Ü–µ —ñ —î "–º–∞–≥—ñ—è" resolve.
3. **Lifetime** –≤–∏–∑–Ω–∞—á–∞—î —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é –∫–µ—à—É–≤–∞–Ω–Ω—è: Transient = –±–µ–∑ –∫–µ—à—É, Singleton = –≥–ª–æ–±–∞–ª—å–Ω–∏–π –∫–µ—à, Scoped = –∫–µ—à —É –º–µ–∂–∞—Ö scope.
4. **Scope** ‚Äî —Ü–µ —ñ–∑–æ–ª—å–æ–≤–∞–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ–∑ –≤–ª–∞—Å–Ω–∏–º –∫–µ—à–µ–º scoped-—Å–µ—Ä–≤—ñ—Å—ñ–≤.
5. **Composition Root** ‚Äî —î–¥–∏–Ω–µ –º—ñ—Å—Ü–µ, –¥–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Ç–∞ `BuildServiceProvider()`.

–¢–µ–ø–µ—Ä –≤–∏ –≥–æ—Ç–æ–≤—ñ –≥–ª–∏–±–æ–∫–æ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ —Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω–∏–π Microsoft DI!

::card-group

::card{title="Service Locator –ø–∞—Ç—Ç–µ—Ä–Ω ‚Üí" icon="i-heroicons-magnifying-glass" to="./03.service-locator-pattern"}
–î—ñ–∑–Ω–∞–π—Ç–µ—Å—è –ø—Ä–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ ‚Äî –∫–æ–ª–∏ –≤—ñ–Ω –≤–∏–ø—Ä–∞–≤–¥–∞–Ω–∏–π —ñ —á–æ–º—É –≤—ñ–Ω –≤–≤–∞–∂–∞—î—Ç—å—Å—è –∞–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω–æ–º.
::

::card{title="DI –ø–∞—Ç—Ç–µ—Ä–Ω–∏ –≤–≤–µ–¥–µ–Ω–Ω—è ‚Üí" icon="i-heroicons-arrow-down-tray" to="./04.dependency-injection-patterns"}
–¢—Ä–∏ —Å–ø–æ—Å–æ–±–∏ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π: Constructor, Property —Ç–∞ Method Injection.
::

::

---

## üìù –ó–∞–≤–¥–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è (Medium)

–î–æ–¥–∞–π—Ç–µ –¥–æ `SimpleContainer` –Ω–∞—Å—Ç—É–ø–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:

1. **`TryAddSingleton<TS, TI>()`** ‚Äî —Ä–µ—î—Å—Ç—Ä—É—î —Å–µ—Ä–≤—ñ—Å, –ª–∏—à–µ —è–∫—â–æ –≤—ñ–Ω —â–µ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π (–∞–Ω–∞–ª–æ–≥ `services.TryAddSingleton<>()` —É Microsoft DI).
2. **`GetServices<T>()`** ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î –≤—Å—ñ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–ª—è —Ç–∏–ø—É `T` (–∞–Ω–∞–ª–æ–≥ `GetServices<>()` —É Microsoft DI).

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –í–∏—è–≤–ª–µ–Ω–Ω—è —Ü–∏–∫–ª—ñ—á–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π (Hard)

–ú–æ–¥–∏—Ñ—ñ–∫—É–π—Ç–µ `CreateInstanceViaReflection`, —â–æ–± –≤—ñ–Ω –≤–∏—è–≤–ª—è–≤ **—Ü–∏–∫–ª—ñ—á–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ** (A‚ÜíB‚ÜíA) —ñ –∫–∏–¥–∞–≤ –∑—Ä–æ–∑—É–º—ñ–ª–∏–π –≤–∏–Ω—è—Ç–æ–∫, –∞ –Ω–µ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è —Å—Ç–µ–∫–∞ (`StackOverflowException`).

**–ü—ñ–¥–∫–∞–∑–∫–∞**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `HashSet<Type>` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Ç–∏–ø—ñ–≤ —É –ø–æ—Ç–æ—á–Ω–æ–º—É —Å—Ç–µ–∫—É resolve.

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (Hard)

–ù–∞–ø–∏—à—ñ—Ç—å benchmark –∑ **BenchmarkDotNet**, —â–æ –ø–æ—Ä—ñ–≤–Ω—é—î:

1. –†—É—á–Ω–µ `new OrderService(new SqlOrderRepository(new AppDbContext()), new SmtpEmailService(new ConsoleLogger()), new ConsoleLogger())`
2. –í–∞—à `SimpleContainer` –∑ —Ä–µ—Ñ–ª–µ–∫—Å—ñ—î—é
3. `Microsoft.Extensions.DependencyInjection`

–ó—Ä–æ–±—ñ—Ç—å –≤–∏—Å–Ω–æ–≤–æ–∫: –Ω–∞—Å–∫—ñ–ª—å–∫–∏ —Ä–µ—Ñ–ª–µ–∫—Å—ñ—è –ø–æ–≤—ñ–ª—å–Ω—ñ—à–∞ –∑–∞ `new`?
