---
title: 'Microsoft DI: IServiceCollection —Ç–∞ IServiceProvider'
description: '–ì–ª–∏–±–æ–∫–∏–π —Ä–æ–∑–±—ñ—Ä Microsoft.Extensions.DependencyInjection: IServiceCollection, IServiceProvider, —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—ñ–≤, Extension Methods, ValidateOnBuild, –∞ —Ç–∞–∫–æ–∂ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ ASP.NET Core —Ç–∞ Worker Services.'
---

# Microsoft DI: IServiceCollection —Ç–∞ IServiceProvider

## –í—Å—Ç—É–ø: –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–µ-—Ñ–∞–∫—Ç–æ —É .NET

–£ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Å—Ç–∞—Ç—Ç—ñ –º–∏ –ø–æ–±—É–¥—É–≤–∞–ª–∏ –≤–ª–∞—Å–Ω–∏–π IoC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ –∑—Ä–æ–∑—É–º—ñ–ª–∏ –º–µ—Ö–∞–Ω—ñ–∫—É —Ä–æ–±–æ—Ç–∏. –¢–µ–ø–µ—Ä —Ä–æ–∑–≥–ª—è–Ω–µ–º–æ **–æ—Ñ—ñ—Ü—ñ–π–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è Microsoft** ‚Äî `Microsoft.Extensions.DependencyInjection`. –¶–µ —Ç–æ–π —Å–∞–º–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É:

- ASP.NET Core
- Worker Services
- Console Apps –∑ GenericHost
- .NET MAUI
- Blazor
- Azure Functions

–ü–∞–∫–µ—Ç: `Microsoft.Extensions.DependencyInjection` (–≤–±—É–¥–æ–≤–∞–Ω–∏–π —É .NET 6+).

::note
–Ø–∫—â–æ –≤–∏ –≤–∂–µ —á–∏—Ç–∞–ª–∏ —Å—Ç–∞—Ç—Ç—é [¬´–°—É—á–∞—Å–Ω–∏–π .NET Host¬ª](/csharp/architecture-best-practices/modern-dotnet-host), –≤–∏ –∑–Ω–∞–π–æ–º—ñ –∑ –±–∞–∑–æ–≤–∏–º –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º DI. –¶—è —Å—Ç–∞—Ç—Ç—è ‚Äî **–≥–ª–∏–±–æ–∫–∏–π —Ä–æ–∑–±—ñ—Ä** –≤—Å—ñ—Ö –¥–µ—Ç–∞–ª–µ–π.
::

---

## –ß–∞—Å—Ç–∏–Ω–∞ 1: IServiceCollection ‚Äî –∫–æ–ª–µ–∫—Ü—ñ—è –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ñ–≤

### 1.1. –©–æ —Ç–∞–∫–µ IServiceCollection?

`IServiceCollection` ‚Äî —Ü–µ **–∑–≤–∏—á–∞–π–Ω–∏–π —Å–ø–∏—Å–æ–∫** (`IList<ServiceDescriptor>`). –í—ñ–Ω –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –∂–æ–¥–Ω–æ—ó –ª–æ–≥—ñ–∫–∏ –∑ resolve —á–∏ lifecycle. –í—ñ–Ω –ø—Ä–æ—Å—Ç–æ –Ω–∞–∫–æ–ø–∏—á—É—î –æ–ø–∏—Å–∏ —Å–µ—Ä–≤—ñ—Å—ñ–≤ (ServiceDescriptor).

```csharp showLineNumbers
// IServiceCollection –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ –¥—É–∂–µ –ø—Ä–æ—Å—Ç–∏–π
public interface IServiceCollection : IList<ServiceDescriptor>, ICollection<ServiceDescriptor>, 
                                      IEnumerable<ServiceDescriptor>, IEnumerable
{
    // –°–∞–º–µ —Ç–∞–∫: —Ü–µ –ø—Ä–æ—Å—Ç–æ List<ServiceDescriptor> –∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º!
}

// ServiceDescriptor ‚Äî —Ü–µ —Ç–∞ —Å–∞–º–∞ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—è —â–æ –≤ –Ω–∞—à–æ–º—É SimpleContainer
public class ServiceDescriptor
{
    public Type ServiceType { get; }
    public Type? ImplementationType { get; }
    public Func<IServiceProvider, object>? ImplementationFactory { get; }
    public object? ImplementationInstance { get; }
    public ServiceLifetime Lifetime { get; }
    // ...
}
```

### 1.2. –¢—Ä–∏ –º–µ—Ç–æ–¥–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó

Microsoft DI –º–∞—î —Ç—Ä–∏ –±–∞–∑–æ–≤–∏—Ö –º–µ—Ç–æ–¥–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ Lifetime):

```csharp showLineNumbers
var services = new ServiceCollection();

// Transient: –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä –∫–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É
services.AddTransient<IEmailService, SmtpEmailService>();
services.AddTransient<IEmailService>(sp =>
{
    var config = sp.GetRequiredService<EmailConfig>();
    return new SmtpEmailService(config.Host, config.Port);
});

// Scoped: –æ–¥–∏–Ω –Ω–∞ scope (–≤ ASP.NET Core = –æ–¥–∏–Ω –Ω–∞ HTTP-–∑–∞–ø–∏—Ç)
services.AddScoped<IOrderRepository, SqlOrderRepository>();
services.AddScoped<AppDbContext>();

// Singleton: –æ–¥–∏–Ω –Ω–∞ –≤–µ—Å—å —á–∞—Å —Ä–æ–±–æ—Ç–∏ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É
services.AddSingleton<ILogger, ConsoleLogger>();
services.AddSingleton<SmtpConfig>(new SmtpConfig { Host = "smtp.gmail.com" });

// Singleton —á–µ—Ä–µ–∑ –≥–æ—Ç–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä
var config = new AppConfiguration { Theme = "dark" };
services.AddSingleton(config);  // –¢–∏–ø –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
```

### 1.3. –í–∞—Ä—ñ–∞–Ω—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó

```csharp showLineNumbers
// –í–∞—Ä—ñ–∞–Ω—Ç 1: Interface ‚Üí Implementation (–Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏–π)
services.AddScoped<IOrderRepository, SqlOrderRepository>();

// –í–∞—Ä—ñ–∞–Ω—Ç 2: Concrete type —Ç—ñ–ª—å–∫–∏ (–±–µ–∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É)
services.AddScoped<OrderService>();  // –ú–æ–∂–Ω–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ OrderService

// –í–∞—Ä—ñ–∞–Ω—Ç 3: Factory —Ñ—É–Ω–∫—Ü—ñ—è
services.AddScoped<IEmailService>(serviceProvider =>
{
    // –ú–∞—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤!
    var logger = serviceProvider.GetRequiredService<ILogger<SmtpEmailService>>();
    var config = serviceProvider.GetRequiredService<IConfiguration>();
    return new SmtpEmailService(config["Smtp:Host"]!, logger);
});

// –í–∞—Ä—ñ–∞–Ω—Ç 4: –ì–æ—Ç–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä (—Ç—ñ–ª—å–∫–∏ Singleton)
services.AddSingleton<ILogger>(new ConsoleLogger(LogLevel.Debug));

// –í–∞—Ä—ñ–∞–Ω—Ç 5: Open Generic types
services.AddScoped(typeof(IRepository<>), typeof(EfRepository<>));
// –¢–µ–ø–µ—Ä IRepository<User>, IRepository<Order> —ñ —Ç.–¥. ‚Äî –≤—Å—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏—Ä—ñ—à—É—é—Ç—å—Å—è!
```

### 1.4. TryAdd –º–µ—Ç–æ–¥–∏ ‚Äî —É–º–æ–≤–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è

```csharp showLineNumbers
// TryAdd: –¥–æ–¥–∞—î —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ç–∏–ø —â–µ –ù–ï –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ
services.AddScoped<IEmailService, SmtpEmailService>();
services.TryAddScoped<IEmailService, FakeEmailService>(); // ‚Üê –ù–ï –∑–∞–º—ñ–Ω–∏—Ç—å! –í–∂–µ —î.

// TryAddEnumerable: –¥–æ–¥–∞—î —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ç–∞–∫–∏–π ServiceDescriptor —â–µ –Ω–µ–º–∞—î
services.TryAddEnumerable(ServiceDescriptor.Scoped<IEventHandler, OrderCreatedHandler>());
services.TryAddEnumerable(ServiceDescriptor.Scoped<IEventHandler, OrderCreatedHandler>()); // ‚Üê Dup! –ù–µ –¥–æ–¥–∞—Å—Ç—å.

// –ü—Ä–∞–∫—Ç–∏—á–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥: —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
public static IServiceCollection AddMyFrameworkServices(this IServiceCollection services)
{
    services.TryAddScoped<IEmailService, DefaultEmailService>(); // Default
    services.TryAddSingleton<ICacheService, MemoryCacheService>(); // Default
    return services;
}

// –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –ø–µ—Ä–µ–≤–∏–∑–Ω–∞—á–∏—Ç–∏ –¥–æ –∞–±–æ –ø—ñ—Å–ª—è:
services.AddMyFrameworkServices();
services.AddScoped<IEmailService, CustomEmailService>(); // ‚Üê –ü–µ—Ä–µ–∑–∞–ø–∏—à–µ!
// –ê–ë–û:
services.AddScoped<IEmailService, CustomEmailService>(); // –°–ø–æ—á–∞—Ç–∫—É
services.AddMyFrameworkServices(); // TryAdd –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ!
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 2: Extension Methods ‚Äî —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó

–ö—Ä–∞—â–æ—é –ø—Ä–∞–∫—Ç–∏–∫–æ—é —î –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ–π —á–µ—Ä–µ–∑ **Extension Methods**. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≥—Ä—É–ø—É–≤–∞—Ç–∏ –ø–æ–≤'—è–∑–∞–Ω—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞ –ø–æ–∫—Ä–∞—â—É—î —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å:

```csharp showLineNumbers
// OrderingModule.cs ‚Äî —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–ª—è –º–æ–¥—É–ª—è –∑–∞–º–æ–≤–ª–µ–Ω—å
public static class OrderingServiceExtensions
{
    public static IServiceCollection AddOrderingModule(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
        services.Configure<OrderingOptions>(configuration.GetSection("Ordering"));

        // Repositories
        services.AddScoped<IOrderRepository, SqlOrderRepository>();
        services.AddScoped<IOrderItemRepository, SqlOrderItemRepository>();

        // Domain Services
        services.AddScoped<IOrderPricingService, OrderPricingService>();
        services.AddScoped<IOrderValidationService, OrderValidationService>();

        // Application Services
        services.AddScoped<OrderService>();
        services.AddScoped<OrderCommandHandler>();

        // Infrastructure
        services.AddScoped<IOrderEventPublisher, RabbitMqOrderEventPublisher>();

        return services; // Fluent API
    }
}

// EmailModule.cs
public static class EmailServiceExtensions
{
    public static IServiceCollection AddEmailModule(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        var smtpConfig = configuration.GetSection("Smtp").Get<SmtpConfig>()!;
        services.AddSingleton(smtpConfig);
        services.AddTransient<IEmailService, SmtpEmailService>();
        services.AddTransient<IEmailTemplateEngine, RazorEmailTemplateEngine>();
        return services;
    }
}

// Program.cs ‚Äî —á–∏—Å—Ç–∏–π —ñ —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–π!
var builder = WebApplication.CreateBuilder(args);

builder.Services
    .AddOrderingModule(builder.Configuration)
    .AddEmailModule(builder.Configuration)
    .AddInventoryModule(builder.Configuration)
    .AddAuthenticationModule(builder.Configuration);

var app = builder.Build();
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 3: IServiceProvider ‚Äî –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å–µ—Ä–≤—ñ—Å—ñ–≤

### 3.1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—ñ–≤

`IServiceProvider` ‚Äî —Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `BuildServiceProvider()`. –í—ñ–Ω –≤–∏—Ä—ñ—à—É—î (resolve) –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:

```csharp showLineNumbers
var services = new ServiceCollection();
services.AddScoped<IOrderRepository, SqlOrderRepository>();
services.AddScoped<IEmailService, SmtpEmailService>();
services.AddScoped<OrderService>();

// –ë—É–¥—É—î–º–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä
IServiceProvider provider = services.BuildServiceProvider();

// GetService<T>: –ø–æ–≤–µ—Ä—Ç–∞—î null —è–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
var emailService = provider.GetService<IEmailService>(); // IEmailService? ‚Äî –º–æ–∂–µ –±—É—Ç–∏ null

// GetRequiredService<T>: –∫–∏–¥–∞—î exception —è–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ‚Äî –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–ò–ô!
var orderService = provider.GetRequiredService<OrderService>();

// GetServices<T>: –ø–æ–≤–µ—Ä—Ç–∞—î –í–°–Ü —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó
services.AddTransient<IEventHandler, EmailEventHandler>();
services.AddTransient<IEventHandler, SmsEventHandler>();
services.AddTransient<IEventHandler, PushEventHandler>();

IEnumerable<IEventHandler> handlers = provider.GetServices<IEventHandler>();
// = [ EmailEventHandler, SmsEventHandler, PushEventHandler ]
```

### 3.2. GetServices ‚Äî –º–Ω–æ–∂–∏–Ω–Ω—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

–¶–µ –ø–æ—Ç—É–∂–Ω–∞ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å: –æ–¥–∏–Ω —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî **–∫—ñ–ª—å–∫–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ–π**:

```csharp showLineNumbers
// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫—ñ–ª—å–∫–æ—Ö —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ–π –æ–¥–Ω–æ–≥–æ —Ç–∏–ø—É
services.AddTransient<IValidator<Order>, OrderAmountValidator>();
services.AddTransient<IValidator<Order>, OrderItemCountValidator>();
services.AddTransient<IValidator<Order>, ShippingAddressValidator>();

// –°–µ—Ä–≤—ñ—Å, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤—Å—ñ –≤–∞–ª—ñ–¥–∞—Ç–æ—Ä–∏
public class OrderValidationService
{
    // IEnumerable<IValidator<Order>> ‚Äî –æ—Ç—Ä–∏–º—É—î–º–æ –í–°–Ü –≤–∞–ª—ñ–¥–∞—Ç–æ—Ä–∏!
    private readonly IEnumerable<IValidator<Order>> _validators;

    public OrderValidationService(IEnumerable<IValidator<Order>> validators)
    {
        _validators = validators;
    }

    public ValidationResult Validate(Order order)
    {
        var errors = _validators
            .SelectMany(v => v.Validate(order).Errors)
            .ToList();

        return new ValidationResult(errors);
    }
}
```

### 3.3. ValidateOnBuild ‚Äî –≤–∏—è–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ

–û–¥–Ω–∞ –∑ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∏—Ö –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π Microsoft DI ‚Äî **–≤–∞–ª—ñ–¥–∞—Ü—ñ—è** –≥—Ä–∞—Ñ—É –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É:

```csharp showLineNumbers
// –ë–µ–∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó: –ø–æ–º–∏–ª–∫–∏ –≤–∏—è–≤–ª—è—é—Ç—å—Å—è –≤ runtime –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–≤–µ—Ä–Ω–µ–Ω–Ω—ñ
var provider = services.BuildServiceProvider();

// –ó –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é: –ø–æ–º–∏–ª–∫–∏ –≤–∏—è–≤–ª—è—é—Ç—å—Å—è –í–Ü–î–†–ê–ó–£ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
var provider = services.BuildServiceProvider(new ServiceProviderOptions
{
    ValidateOnBuild = true,      // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≥—Ä–∞—Ñ –ø—Ä–∏ –ø–æ–±—É–¥–æ–≤—ñ
    ValidateScopes = true,       // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Captive Dependency (–ø—Ä–æ —Ü–µ –≤ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–∞—Ç—Ç—ñ!)
});

// –£ ASP.NET Core Development —Ä–µ–∂–∏–º ‚Äî —Ü–µ –≤–º–∏–∫–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!
// WebApplication.CreateBuilder –≤–∂–µ –Ω–∞–ª–∞—à—Ç–æ–≤—É—î ValidateOnBuild —Ç–∞ ValidateScopes
// —É —Ä–µ–∂–∏–º—ñ Development.
```

–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î `ValidateOnBuild`?

```csharp
services.AddScoped<OrderService>();
// OrderService –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ IOrderRepository, –∞–ª–µ –º–∏ –ó–ê–ë–£–õ–ò –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –π–æ–≥–æ!

var provider = services.BuildServiceProvider(new ServiceProviderOptions
{
    ValidateOnBuild = true
});
// BOOM! –ü—Ä–∏ BuildServiceProvider():
// InvalidOperationException: "Cannot resolve service 'IOrderRepository'
// while attempting to activate 'OrderService'."
// ‚Üê –í–∏—è–≤–ª–µ–Ω–æ –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ, –∞ –Ω–µ –≤ runtime!
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 4: –†–æ–±–æ—Ç–∞ –≤ ASP.NET Core

### 4.1. WebApplication.CreateBuilder —Ç–∞ WebApplicationBuilder

```csharp showLineNumbers
// Program.cs –≤ ASP.NET Core
var builder = WebApplication.CreateBuilder(args);

// builder.Services ‚Äî —Ü–µ IServiceCollection
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// –ù–∞—à—ñ —Å–µ—Ä–≤—ñ—Å–∏
builder.Services.AddScoped<IOrderRepository, SqlOrderRepository>();
builder.Services.AddScoped<OrderService>();

// builder.Configuration ‚Äî IConfiguration (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ appsettings.json)
var connectionString = builder.Configuration.GetConnectionString("Default");
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(connectionString));

// builder.Build() ‚Äî —Ñ—ñ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è, –±—É–¥—É—î IServiceProvider
var app = builder.Build();

// app.Services ‚Äî —Ü–µ IServiceProvider (root provider)
// –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –π–æ–≥–æ –¥–ª—è Scoped —Å–µ—Ä–≤—ñ—Å—ñ–≤ –Ω–∞–ø—Ä—è–º—É!

app.UseHttpsRedirection();
app.MapControllers();

app.Run();
```

### 4.2. Scope —É ASP.NET Core

–í ASP.NET Core **–∫–æ–∂–µ–Ω HTTP-–∑–∞–ø–∏—Ç = –æ–∫—Ä–µ–º–∏–π Scope**. –§—Ä–µ–π–º–≤–æ—Ä–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
1. –°—Ç–≤–æ—Ä—é—î –Ω–æ–≤–∏–π scope –Ω–∞ –ø–æ—á–∞—Ç–∫—É –∑–∞–ø–∏—Ç—É
2. Resolve-–∏—Ç—å –≤—Å—ñ Scoped-—Å–µ—Ä–≤—ñ—Å–∏ –≤ —Ü—å–æ–º—É scope
3. –ó–Ω–∏—â—É—î scope –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É (–≤–∏–∫–ª–∏–∫–∞—î `Dispose()` —É –∑–≤–æ—Ä–æ—Ç–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É)

```csharp showLineNumbers
// Controller –æ—Ç—Ä–∏–º—É—î —Å–µ—Ä–≤—ñ—Å–∏ —á–µ—Ä–µ–∑ DI –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!
[ApiController]
[Route("api/[controller]")]
public class OrdersController : ControllerBase
{
    private readonly OrderService _orderService;
    private readonly ILogger<OrdersController> _logger;

    // Constructor Injection ‚Äî ASP.NET Core –≤–∏–∫–ª–∏—á–µ —Ü–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!
    public OrdersController(OrderService orderService, ILogger<OrdersController> logger)
    {
        _orderService = orderService;
        _logger = logger;
    }

    [HttpPost]
    public IActionResult CreateOrder([FromBody] CreateOrderRequest request)
    {
        _logger.LogInformation("Creating order for {Email}", request.CustomerEmail);
        var orderId = _orderService.PlaceOrder(request);
        return Ok(new { orderId });
    }
}
// –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç –¥–æ POST /api/orders:
// 1. –ù–æ–≤–∏–π scope
// 2. –ù–æ–≤–∏–π OrdersController
// 3. –ù–æ–≤–∏–π OrderService (—è–∫—â–æ Scoped)
// 4. –ù–æ–≤–∏–π IOrderRepository (—è–∫—â–æ Scoped)
// 5. ... –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: Dispose() —É –∑–≤–æ—Ä–æ—Ç–Ω—å–æ–º—É –ø–æ—Ä—è–¥–∫—É
```

### 4.3. Middleware —Ç–∞ DI

```csharp showLineNumbers
// Middleware –∑ Constructor Injection (–¥–ª—è Singleton –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π)
public class RequestLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<RequestLoggingMiddleware> _logger; // Singleton OK –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ñ

    public RequestLoggingMiddleware(RequestDelegate next, ILogger<RequestLoggingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    // Scoped –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ ‚Äî —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä –º–µ—Ç–æ–¥—É InvokeAsync!
    public async Task InvokeAsync(HttpContext context, ICurrentUserService currentUser)
    {
        _logger.LogInformation("Request: {Method} {Path} by {User}",
            context.Request.Method,
            context.Request.Path,
            currentUser.UserId);

        await _next(context);
    }
}

// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
app.UseMiddleware<RequestLoggingMiddleware>();
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 5: Worker Services —Ç–∞ Generic Host

```csharp showLineNumbers
// Worker Service: DI –±–µ–∑ ASP.NET Core
var host = Host.CreateDefaultBuilder(args)
    .ConfigureServices((context, services) =>
    {
        // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –ø—Ä–æ—á–∏—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑ appsettings.json
        services.Configure<BackgroundJobOptions>(
            context.Configuration.GetSection("BackgroundJob"));

        // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–∞—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
        services.AddScoped<IOrderRepository, SqlOrderRepository>();
        services.AddTransient<IEmailService, SmtpEmailService>();

        // BackgroundService ‚Äî Hosted Service, —â–æ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
        services.AddHostedService<OrderProcessingWorker>();
    })
    .Build();

await host.RunAsync();

// OrderProcessingWorker.cs
public class OrderProcessingWorker : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory; // –ù–ï IServiceProvider!
    private readonly ILogger<OrderProcessingWorker> _logger;

    // –í–ê–ñ–õ–ò–í–û: BackgroundService ‚Äî —Ü–µ Singleton!
    // Scoped —Å–µ—Ä–≤—ñ—Å–∏ –ù–ï –º–æ–∂–Ω–∞ inject-–∏—Ç–∏ –Ω–∞–ø—Ä—è–º—É ‚Äî —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ IServiceScopeFactory
    public OrderProcessingWorker(
        IServiceScopeFactory scopeFactory,
        ILogger<OrderProcessingWorker> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            // –ö–æ–∂–Ω–∞ —ñ—Ç–µ—Ä–∞—Ü—ñ—è ‚Äî –Ω–æ–≤–∏–π scope!
            using var scope = _scopeFactory.CreateScope();

            // –û—Ç—Ä–∏–º—É—î–º–æ Scoped —Å–µ—Ä–≤—ñ—Å–∏ —ñ–∑ scope
            var repository = scope.ServiceProvider.GetRequiredService<IOrderRepository>();
            var emailService = scope.ServiceProvider.GetRequiredService<IEmailService>();

            var pendingOrders = repository.GetPending();
            foreach (var order in pendingOrders)
            {
                emailService.Send(order.CustomerEmail, "–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è!");
                _logger.LogInformation("Processed order {Id}", order.Id);
            }

            await Task.Delay(TimeSpan.FromSeconds(30), stoppingToken);
            // Scope –∑–Ω–∏—â—É—î—Ç—å—Å—è —Ç—É—Ç ‚Üê
        }
    }
}
```

::caution
**–¢–∏–ø–æ–≤–∞ –ø–æ–º–∏–ª–∫–∞**: Inject-–∏—Ç–∏ Scoped —Å–µ—Ä–≤—ñ—Å –Ω–∞–ø—Ä—è–º—É —É Singleton (–≤–∫–ª—é—á–∞—é—á–∏ BackgroundService). –¶–µ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ "Captive Dependency" ‚Äî Scoped —Å–µ—Ä–≤—ñ—Å –∂–∏–≤–µ —Å—Ç—ñ–ª—å–∫–∏ –∂, —Å–∫—ñ–ª—å–∫–∏ Singleton, —â–æ –ø–æ—Ä—É—à—É—î –≤–µ—Å—å lifecycle. –î–µ—Ç–∞–ª—å–Ω–æ ‚Äî —É –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–∞—Ç—Ç—ñ!
::

---

## –ü—ñ–¥—Å—É–º–æ–∫

::card-group

::card{title="IServiceCollection" icon="i-heroicons-list-bullet"}
–ü—Ä–æ—Å—Ç–∏–π —Å–ø–∏—Å–æ–∫ ServiceDescriptor. –†–µ—î—Å—Ç—Ä—É—î–º–æ —Å–µ—Ä–≤—ñ—Å–∏ —á–µ—Ä–µ–∑ `Add*`, `TryAdd*` –º–µ—Ç–æ–¥–∏. –û—Ä–≥–∞–Ω—ñ–∑–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ Extension Methods –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏ –∫–æ–¥—É.
::

::card{title="IServiceProvider" icon="i-heroicons-cpu-chip"}
Resolve –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π. `GetRequiredService<T>()` ‚Äî –æ—Å–Ω–æ–≤–Ω–∏–π –º–µ—Ç–æ–¥. `GetServices<T>()` ‚Äî –¥–ª—è –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ–π. `ValidateOnBuild` ‚Äî –≤–∏—è–≤–ª—è—î –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ.
::

::card{title="Scope –≤ ASP.NET Core" icon="i-heroicons-arrow-path"}
–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π scope = HTTP-–∑–∞–ø–∏—Ç. Middleware InvokeAsync –æ—Ç—Ä–∏–º—É—î Scoped —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä. BackgroundService –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î IServiceScopeFactory.
::

::

---

## üìù –ó–∞–≤–¥–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ–π (Easy)

–ü–µ—Ä–µ–ø–∏—à—ñ—Ç—å —Ç–∞–∫–∏–π –∫–æ–¥ Program.cs –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ Extension Methods:

```csharp
// –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É:
builder.Services.AddScoped<IUserRepository, SqlUserRepository>();
builder.Services.AddScoped<IUserService, UserService>();
builder.Services.AddScoped<IEmailService, SmtpEmailService>();
builder.Services.AddScoped<IOrderRepository, SqlOrderRepository>();
builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddSingleton<ILogger, ConsoleLogger>();
builder.Services.AddSingleton<IConfiguration>(builder.Configuration);
```

–†–æ–∑–±–∏–π—Ç–µ –Ω–∞ `AddUserModule()`, `AddOrderModule()`, `AddInfrastructure()`.

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –ö–æ–Ω–≤–µ—î—Ä –≤–∞–ª—ñ–¥–∞—Ç–æ—Ä—ñ–≤ (Medium)

–†–µ–∞–ª—ñ–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ `IEnumerable<IValidator<Order>>`:
1. `MinimumOrderAmountValidator` ‚Äî –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—É–º–∞ 100 –≥—Ä–Ω
2. `MaximumItemCountValidator` ‚Äî –Ω–µ –±—ñ–ª—å—à–µ 50 —Ç–æ–≤–∞—Ä—ñ–≤  
3. `ShippingAddressValidator` ‚Äî –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∏

–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: `services.AddTransient<IValidator<Order>, ...>()` –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ. `OrderValidationService` –æ—Ç—Ä–∏–º—É—î –≤—Å—ñ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —ñ –≤–∏–∫–æ–Ω—É—î –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ.

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: Worker –∑ Scope (Hard)

–†–µ–∞–ª—ñ–∑—É–π—Ç–µ BackgroundService `DatabaseCleanupWorker` —â–æ:
- –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –∫–æ–∂–Ω—É –≥–æ–¥–∏–Ω—É
- –í–∏–¥–∞–ª—è—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä—à—ñ 30 –¥–Ω—ñ–≤ —á–µ—Ä–µ–∑ `IOrderRepository`
- –õ–æ–≥—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏–¥–∞–ª–µ–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `IServiceScopeFactory` –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è Scoped `IOrderRepository`
- –ö–æ—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–æ–±–ª—è—î `CancellationToken`
