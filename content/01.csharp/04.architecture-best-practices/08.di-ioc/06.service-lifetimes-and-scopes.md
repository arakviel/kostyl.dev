---
title: 'Service Lifetimes —Ç–∞ Scopes'
description: '–ì–ª–∏–±–æ–∫–∏–π —Ä–æ–∑–±—ñ—Ä —Ç—Ä—å–æ—Ö —á–∞—Å—ñ–≤ –∂–∏—Ç—Ç—è —Å–µ—Ä–≤—ñ—Å—ñ–≤ —É DI: Transient, Scoped —Ç–∞ Singleton. –Ø–∫ —Ä–æ–∑—É–º—ñ—Ç–∏ Scope, IDisposable —ñ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è –∑–∞ —Å–µ—Ä–≤—ñ—Å–∞–º–∏. –ö—Ä–∏—Ç–∏—á–Ω–∏–π –∞–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω Captive Dependency.'
---

# Service Lifetimes —Ç–∞ Scopes

## –í—Å—Ç—É–ø: –ß–æ–º—É Lifetime ‚Äî —Ü–µ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è

–í–∏–±—ñ—Ä lifetime –¥–ª—è —Å–µ—Ä–≤—ñ—Å—É ‚Äî —Ü–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –¥–µ—Ç–∞–ª—å. –¶–µ **–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è**, —â–æ –≤–ø–ª–∏–≤–∞—î –Ω–∞:

- –ö–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ (—á–∏ –ø–æ–¥—ñ–ª—è—î–º–æ –º–∏ —Å—Ç–∞–Ω –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏?)
- –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (—á–∏ –≤–∏—Ç—Ä–∞—á–∞—î–º–æ —Ä–µ—Å—É—Ä—Å–∏ –Ω–∞ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω—ñ new?)
- –ë–µ–∑–ø–µ–∫—É (—á–∏ –Ω–µ "–ø—Ä–æ—Ç—ñ–∫–∞—é—Ç—å" –¥–∞–Ω—ñ –º—ñ–∂ HTTP-–∑–∞–ø–∏—Ç–∞–º–∏?)
- –£—Ç–∏–ª—ñ–∑–∞—Ü—ñ—é —Ä–µ—Å—É—Ä—Å—ñ–≤ (IDisposable –æ–±'—î–∫—Ç–∏ ‚Äî ch–∏ –∑–Ω–∏—â—É—î–º–æ —ó—Ö –≤—á–∞—Å–Ω–æ?)

**–ê–Ω–∞–ª–æ–≥—ñ—è –∑ –≥–æ—Ç–µ–ª–µ–º:**

- **Transient** ‚Äî –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ñ —Ä—É—à–Ω–∏–∫–∏. –ö–æ–∂–µ–Ω –≥—ñ—Å—Ç—å –æ—Ç—Ä–∏–º—É—î –Ω–æ–≤–∏–π —ñ –≤–∏–∫–∏–¥–∞—î –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.
- **Scoped** ‚Äî –ø–æ—Å—Ç—ñ–ª—å–Ω–∞ –±—ñ–ª–∏–∑–Ω–∞. –í–∞—à–∞ –Ω–∞ –≤–µ—Å—å —á–∞—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è (scope = –ø–µ—Ä–µ–±—É–≤–∞–Ω–Ω—è), –∞–ª–µ –ø—ñ—Å–ª—è –≤–∏–ø–∏—Å–∫–∏ ‚Äî –ø—Ä–∞–Ω–Ω—è –∞–±–æ –∑–∞–º—ñ–Ω–∞.
- **Singleton** ‚Äî –ª—ñ—Ñ—Ç –∞–±–æ —Å—Ç—ñ–π–∫–∞ —Ä–µ—Ü–µ–ø—Ü—ñ—ó. –û–¥–∏–Ω –Ω–∞ –≤–µ—Å—å –≥–æ—Ç–µ–ª—å, –¥–æ—Å—Ç—É–ø–Ω–∏–π –±—É–¥—å-–∫–æ–º—É —ñ –±—É–¥—å-–∫–æ–ª–∏.

---

## –ß–∞—Å—Ç–∏–Ω–∞ 1: Transient Lifetime

### 1.1. –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

**Transient** ‚Äî –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä **–ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–≤–µ—Ä–Ω–µ–Ω–Ω—ñ** –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ñ–æ–¥–Ω–æ–≥–æ –∫–µ—à—É–≤–∞–Ω–Ω—è, –∂–æ–¥–Ω–æ–≥–æ —Å–ø—ñ–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É.

```csharp showLineNumbers
services.AddTransient<IEmailService, SmtpEmailService>();

// –ö–æ–∂–µ–Ω GetService ‚Üí –Ω–æ–≤–∏–π –æ–±'—î–∫—Ç!
var email1 = provider.GetService<IEmailService>();
var email2 = provider.GetService<IEmailService>();

Console.WriteLine(ReferenceEquals(email1, email2)); // False ‚Äî —Ä—ñ–∑–Ω—ñ –æ–±'—î–∫—Ç–∏!
```

### 1.2. –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏

Transient –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è:
- **Lightweight, stateless —Å–µ—Ä–≤—ñ—Å—ñ–≤** ‚Äî –¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–µ—à–µ–≤–µ —ñ —Å—Ç–∞–Ω –Ω–µ –≤–∞–∂–ª–∏–≤–∏–π.
- **Email/SMS –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∏** ‚Äî –∫–æ–∂–µ–Ω –≤–∏–∫–ª–∏–∫ –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–π.
- **Helpers —Ç–∞ Utilities** ‚Äî –±–µ–∑ —Å—Ç–∞–Ω—É, –±–µ–∑ —Ä–µ—Å—É—Ä—Å—ñ–≤.
- **Formatter, Mapper** ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –±–µ–∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É.

```csharp
// ‚úÖ Transient ‚Äî –¥–æ–±—Ä–µ –¥–ª—è stateless —Å–µ—Ä–≤—ñ—Å—ñ–≤
services.AddTransient<IPasswordHasher, BcryptPasswordHasher>();
services.AddTransient<IEmailValidator, EmailValidator>();
services.AddTransient<IJsonSerializer, NewtonsoftJsonSerializer>();

// ‚ùå Transient ‚Äî –ø–æ–≥–∞–Ω–æ –¥–ª—è expensive-to-create —Å–µ—Ä–≤—ñ—Å—ñ–≤
// services.AddTransient<AppDbContext>(); // DbContext ‚Äî expensive! –ö—Ä–∞—â–µ Scoped.
// services.AddTransient<HttpClient>();   // HttpClient ‚Äî –¥—É–∂–µ expensive! Singleton –∞–±–æ IHttpClientFactory.
```

### 1.3. Transient —Ç–∞ IDisposable

–í–∞–∂–ª–∏–≤–∞ –¥–µ—Ç–∞–ª—å: Transient-—Å–µ—Ä–≤—ñ—Å–∏ –∑ `IDisposable` **–≤—ñ–¥—Å—Ç–µ–∂—É—é—Ç—å—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º** —ñ –∑–Ω–∏—â—É—é—Ç—å—Å—è —Ä–∞–∑–æ–º —ñ–∑ scope (–∞–±–æ root provider):

```csharp showLineNumbers
public class ExpensiveTransientService : IDisposable
{
    private readonly Guid _id = Guid.NewGuid();

    public ExpensiveTransientService()
        => Console.WriteLine($"Created: {_id}");

    public void DoWork() => Console.WriteLine($"Working: {_id}");

    public void Dispose()
        => Console.WriteLine($"Disposed: {_id}");
}

services.AddTransient<ExpensiveTransientService>();

using (var scope = provider.CreateScope())
{
    var s1 = scope.ServiceProvider.GetRequiredService<ExpensiveTransientService>();
    var s2 = scope.ServiceProvider.GetRequiredService<ExpensiveTransientService>();
    s1.DoWork();
    s2.DoWork();
    // Created: abc...
    // Created: def...
    // Working: abc...
    // Working: def...
} // ‚Üê Scope –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è: Dispose –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –¥–ª—è s1 —ñ s2!
// Disposed: def...
// Disposed: abc...  (–∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –ø–æ—Ä—è–¥–æ–∫!)
```

::note
**–í–∏—Å–Ω–æ–≤–æ–∫**: –ù–∞–≤—ñ—Ç—å Transient IDisposable-—Å–µ—Ä–≤—ñ—Å–∏ **–ù–ï –∑–Ω–∏—â—É—é—Ç—å—Å—è –≤—ñ–¥—Ä–∞–∑—É** –ø—ñ—Å–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è. –í–æ–Ω–∏ –∂–∏–≤—É—Ç—å –¥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è scope. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —è–∫—â–æ —É –≤–∞—Å –¥—É–∂–µ –∫–æ—Ä–æ—Ç–∫–∏–π –º–µ—Ç–æ–¥ —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `IDisposable` Transient ‚Äî —Ä–µ—Å—É—Ä—Å —Ç—Ä–∏–º–∞—î—Ç—å—Å—è –¥–æ–≤—à–µ –Ω—ñ–∂ –ø–æ—Ç—Ä—ñ–±–Ω–æ. –í—Ä–∞—Ö—É–π—Ç–µ —Ü–µ –ø—Ä–∏ –ø—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—ñ.
::

---

## –ß–∞—Å—Ç–∏–Ω–∞ 2: Scoped Lifetime

### 2.1. –©–æ —Ç–∞–∫–µ Scope?

**Scope** ‚Äî —Ü–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑ —ñ–∑–æ–ª—å–æ–≤–∞–Ω–∏–º –∫–µ—à–µ–º. –£ –º–µ–∂–∞—Ö –æ–¥–Ω–æ–≥–æ scope –≤—Å—ñ –∑–∞–ø–∏—Ç–∏ –æ–¥–Ω–æ–≥–æ Scoped-—Å–µ—Ä–≤—ñ—Å—É –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å **—Ç–æ–π —Å–∞–º–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä**. –í —ñ–Ω—à–æ–º—É scope ‚Äî –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä.

```csharp showLineNumbers
services.AddScoped<IOrderRepository, SqlOrderRepository>();

using var scope1 = provider.CreateScope();
using var scope2 = provider.CreateScope();

var repo1a = scope1.ServiceProvider.GetRequiredService<IOrderRepository>();
var repo1b = scope1.ServiceProvider.GetRequiredService<IOrderRepository>();
var repo2  = scope2.ServiceProvider.GetRequiredService<IOrderRepository>();

Console.WriteLine(ReferenceEquals(repo1a, repo1b)); // True  ‚Äî —Ç–æ–π —Å–∞–º–∏–π —É scope1!
Console.WriteLine(ReferenceEquals(repo1a, repo2));  // False ‚Äî —Ä—ñ–∑–Ω–∏–π —É scope2!
```

### 2.2. Scope –≤ ASP.NET Core = HTTP-–∑–∞–ø–∏—Ç

ASP.NET Core –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î scope –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ HTTP-–∑–∞–ø–∏—Ç—É:

```
HTTP Request 1 ‚îÄ‚Üí [Scope A] ‚îÄ‚Üí DbContext_A, Repository_A, OrderService_A
HTTP Request 2 ‚îÄ‚Üí [Scope B] ‚îÄ‚Üí DbContext_B, Repository_B, OrderService_B
HTTP Request 3 ‚îÄ‚Üí [Scope C] ‚îÄ‚Üí DbContext_C, Repository_C, OrderService_C
```

–¶–µ –æ–∑–Ω–∞—á–∞—î:
- –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç –º–∞—î **—Å–≤—ñ–π** DbContext (—ñ–∑–æ–ª—å–æ–≤–∞–Ω–∞ Unit of Work!)
- –ó–º—ñ–Ω–∏ –≤ –æ–¥–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ –Ω–µ "–ø—Ä–æ—Ç—ñ–∫–∞—é—Ç—å" –≤ —ñ–Ω—à–∏–π
- DbContext –∑–Ω–∏—â—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ‚Üí –∑'—î–¥–Ω–∞–Ω–Ω—è –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤ –ø—É–ª

```csharp showLineNumbers
// DbContext ‚Äî –∫–ª–∞—Å–∏—á–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥ –¥–ª—è Scoped
services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(connectionString));
// AddDbContext –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ—î—Å—Ç—Ä—É—î —è–∫ Scoped!

// OrderService –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–æ–π —Å–∞–º–∏–π DbContext —â–æ —ñ Repository —É —Ü—å–æ–º—É –∑–∞–ø–∏—Ç—ñ
public class OrderService
{
    private readonly AppDbContext _dbContext;
    private readonly IOrderRepository _repository;

    public OrderService(AppDbContext dbContext, IOrderRepository repository)
    {
        _dbContext = dbContext;  // ‚Üê —Ç–æ–π —Å–∞–º–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä —â–æ —ñ –≤ repository!
        _repository = repository;
    }

    public async Task<bool> PlaceOrderAsync(CreateOrderRequest request)
    {
        using var transaction = await _dbContext.BeginTransactionAsync();
        try
        {
            var order = new Order(request);
            _repository.Add(order);  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–æ–π —Å–∞–º–∏–π _dbContext!
            await _dbContext.SaveChangesAsync();
            await transaction.CommitAsync();
            return true;
        }
        catch
        {
            await transaction.RollbackAsync();
            return false;
        }
    }
}
```

### 2.3. –†—É—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Scope (Worker Services)

–£ BackgroundService –∞–±–æ Console App scope —Ç—Ä–µ–±–∞ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –≤—Ä—É—á–Ω—É —á–µ—Ä–µ–∑ `IServiceScopeFactory`:

```csharp showLineNumbers
public class DataSyncWorker : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<DataSyncWorker> _logger;

    // BackgroundService —î Singleton ‚Äî —Ç–æ–º—É inject IServiceScopeFactory –∞ –Ω–µ Scoped —Å–µ—Ä–≤—ñ—Å–∏!
    public DataSyncWorker(IServiceScopeFactory scopeFactory, ILogger<DataSyncWorker> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            _logger.LogInformation("Starting sync cycle at {Time}", DateTimeOffset.UtcNow);

            // –ö–æ–∂–Ω–∞ —ñ—Ç–µ—Ä–∞—Ü—ñ—è ‚Äî –Ω–æ–≤–∏–π scope!
            // –¶–µ –∞–Ω–∞–ª–æ–≥ "–Ω–æ–≤–æ–≥–æ HTTP-–∑–∞–ø–∏—Ç—É" —É Worker Services.
            await using var scope = _scopeFactory.CreateAsyncScope();

            var syncService = scope.ServiceProvider.GetRequiredService<IDataSyncService>();
            await syncService.SyncAsync(stoppingToken);

            // Scope –∑–Ω–∏—â—É—î—Ç—å—Å—è —Ç—É—Ç ‚Üê syncService —Ç–∞ –π–æ–≥–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ Dispose'd

            await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
        }
    }
}
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 3: Singleton Lifetime

### 3.1. –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

**Singleton** ‚Äî —î–¥–∏–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ **–≤–µ—Å—å —á–∞—Å —Ä–æ–±–æ—Ç–∏** –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–≤–µ—Ä–Ω–µ–Ω–Ω—ñ —ñ –∑–Ω–∏—â—É—î—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ shutdown.

```csharp showLineNumbers
services.AddSingleton<ICacheService, MemoryCacheService>();

// –ó–∞–≤–∂–¥–∏ —Ç–æ–π —Å–∞–º–∏–π –æ–±'—î–∫—Ç –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ scope!
using var scope1 = provider.CreateScope();
using var scope2 = provider.CreateScope();

var cache1 = scope1.ServiceProvider.GetRequiredService<ICacheService>();
var cache2 = scope2.ServiceProvider.GetRequiredService<ICacheService>();

Console.WriteLine(ReferenceEquals(cache1, cache2)); // True ‚Äî –æ–¥–∏–Ω –æ–±'—î–∫—Ç –Ω–∞ –≤—Å—ñ—Ö!
```

### 3.2. –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏

```csharp
// ‚úÖ Singleton ‚Äî –¥–æ–±—Ä–µ –¥–ª—è:
services.AddSingleton<IConfiguration>(configuration);      // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
services.AddSingleton<ICacheService, MemoryCacheService>(); // In-memory –∫–µ—à
services.AddSingleton<IHttpClientFactory>();                // HTTP-–∫–ª—ñ—î–Ω—Ç–∏
services.AddSingleton<ILogger<T>>();                       // Logger (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
services.AddSingleton<SmtpConfig>(smtpConfig);             // Immutable –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ –æ–±'—î–∫—Ç–∏

// ‚ùå Singleton ‚Äî –ù–ï –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è:
// services.AddSingleton<AppDbContext>(); // DbContext –Ω–µ thread-safe!
// services.AddSingleton<IOrderRepository>(); // –Ø–∫—â–æ —Ç—Ä–∏–º–∞—î DbContext ‚Äî –ø—Ä–æ–±–ª–µ–º–∞!
```

### 3.3. Thread Safety —É Singleton

–û—Å–∫—ñ–ª—å–∫–∏ Singleton –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑ –∫—ñ–ª—å–∫–æ—Ö –ø–æ—Ç–æ–∫—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ ‚Äî –≤—ñ–Ω **–ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ thread-safe**:

```csharp showLineNumbers
// ‚ùå –ù–ï thread-safe Singleton ‚Äî –ù–ï–ë–ï–ó–ü–ï–ß–ù–û!
public class UnsafeCacheService : ICacheService
{
    // Dictionary –≤ C# –ù–ï thread-safe!
    private readonly Dictionary<string, object> _cache = new();

    public void Set(string key, object value)
        => _cache[key] = value; // Race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Ç–∞—Ö!

    public object? Get(string key)
        => _cache.TryGetValue(key, out var v) ? v : null;
}

// ‚úÖ Thread-safe Singleton ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
public class SafeCacheService : ICacheService
{
    // ConcurrentDictionary ‚Äî thread-safe!
    private readonly ConcurrentDictionary<string, object> _cache = new();

    public void Set(string key, object value)
        => _cache[key] = value; // –ë–µ–∑–ø–µ—á–Ω–æ!

    public object? Get(string key)
        => _cache.TryGetValue(key, out var v) ? v : null;
}
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 4: Captive Dependency ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–∏–π –∞–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω

### 4.1. –©–æ —Ç–∞–∫–µ Captive Dependency?

**Captive Dependency** (–∑–∞–ª–µ–∂—å-–±—Ä–∞–Ω–µ—Ü—å) ‚Äî —Å–∏—Ç—É–∞—Ü—ñ—è, –∫–æ–ª–∏ **—Å–µ—Ä–≤—ñ—Å –∑ –±—ñ–ª—å—à–∏–º lifetime –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å–µ—Ä–≤—ñ—Å –∑ –º–µ–Ω—à–∏–º lifetime**. –†–µ–∑—É–ª—å—Ç–∞—Ç: "–±—Ä–∞–Ω–µ—Ü—å" (—Ç–æ–π –∑ –º–µ–Ω—à–∏–º lifetime) –∂–∏–≤–µ **–¥–æ–≤—à–µ, –Ω—ñ–∂ –ø–æ–≤–∏–Ω–µ–Ω**.

```
Singleton ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ôæÔ∏è (–≤–µ—Å—å —á–∞—Å —Ä–æ–±–æ—Ç–∏)
  ‚îî‚îÄ> Scoped ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ trapped! ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ôæÔ∏è –∑–∞–º—ñ—Å—Ç—å –æ–¥–Ω–æ–≥–æ scope
         ‚îî‚îÄ> Transient ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  —Ç–µ–∂ trapped!
```

**–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥:**

```csharp showLineNumbers
// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
services.AddSingleton<OrderProcessingService>(); // Singleton!
services.AddScoped<IOrderRepository, SqlOrderRepository>(); // Scoped
services.AddScoped<AppDbContext>(); // Scoped DbContext

// –ö–ª–∞—Å –∑ Captive Dependency
public class OrderProcessingService  // Singleton!
{
    private readonly IOrderRepository _repository; // Scoped ‚Äî –ü–†–û–ë–õ–ï–ú–ê!

    public OrderProcessingService(IOrderRepository repository)
    {
        // –¶–µ–π repository –±—É–¥–µ –∑–∞—Ö–æ–ø–ª–µ–Ω–∏–π –ù–ê–ó–ê–í–ñ–î–ò!
        // –í—ñ–Ω –Ω—ñ–∫–æ–ª–∏ –Ω–µ –±—É–¥–µ –∑–Ω–∏—â–µ–Ω–∏–π –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ scope.
        _repository = repository;
    }

    public void ProcessPending()
    {
        // –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ–π —Å–∞–º–∏–π repository –∑ –ø–µ—Ä—à–æ–≥–æ scope!
        // DbContext –≤–∂–µ –∑–∞–∫—Ä–∏—Ç–∏–π –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–ø–∏—Ç—É, –∞–ª–µ –º–∏ –≤—Åe –æ–¥–Ω–æ —Ç—Ä–∏–º–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è.
        var orders = _repository.GetPending(); // –ú–æ–∂–µ –∫–∏–Ω—É—Ç–∏ exception!
    }
}
```

::caution
**–ù–∞—Å–ª—ñ–¥–∫–∏ Captive Dependency:**
1. **DbContext –ø—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è scope** ‚Äî `ObjectDisposedException` –ø—Ä–∏ —Å–ø—Ä–æ–±—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏
2. **–í–∏—Ç—ñ–∫ –ø–∞–º'—è—Ç—ñ** ‚Äî Scoped –æ–±'—î–∫—Ç–∏ –Ω–µ –∑–Ω–∏—â—É—é—Ç—å—Å—è –±–æ Singleton —Ç—Ä–∏–º–∞—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è
3. **–°–ø—ñ–ª—å–Ω–∏–π —Å—Ç–∞–Ω –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏** ‚Äî –æ–¥–∏–Ω DbContext –¥–ª—è –≤—Å—ñ—Ö HTTP-–∑–∞–ø–∏—Ç—ñ–≤ ‚Üí –¥–∞–Ω—ñ "–ø—Ä–æ—Ç—ñ–∫–∞—é—Ç—å"
4. **–í–∞–∂–∫–æ –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω—ñ –±–∞–≥–∏** ‚Äî –ø—Ä–æ—è–≤–ª—è—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ã–¥ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º
::

### 4.2. ValidateScopes ‚Äî –≤–∏—è–≤–ª–µ–Ω–Ω—è Captive Dependency

Microsoft DI –º–æ–∂–µ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏—è–≤–ª—è—Ç–∏** Captive Dependency –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ:

```csharp showLineNumbers
var provider = services.BuildServiceProvider(new ServiceProviderOptions
{
    ValidateScopes = true,  // –£–≤—ñ–º–∫–Ω—É—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É!
    ValidateOnBuild = true
});

// –ü—Ä–∏ —Å–ø—Ä–æ–±—ñ resolve OrderProcessingService:
// InvalidOperationException:
// "Cannot consume scoped service 'IOrderRepository'
// from singleton 'OrderProcessingService'."
// ‚Üê –ß—É–¥–æ–≤–æ! –ü–æ–º–∏–ª–∫—É –≤–∏—è–≤–ª–µ–Ω–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ!
```

–£ ASP.NET Core —É —Ä–µ–∂–∏–º—ñ `Development` ‚Äî `ValidateScopes` **—É–≤—ñ–º–∫–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ**.

### 4.3. –Ø–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∏—Ä—ñ—à–∏—Ç–∏ Captive Dependency

**–í–∞—Ä—ñ–∞–Ω—Ç 1: –ó–º—ñ–Ω–∏—Ç–∏ lifetime Singleton –Ω–∞ Scoped**

```csharp
// –Ø–∫—â–æ OrderProcessingService –Ω–µ –º–∞—î —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ —Å—Ç–∞–Ω—É –¥–ª—è Singleton
services.AddScoped<OrderProcessingService>(); // Scoped ‚Äî –ø—ñ–¥—Ö–æ–¥–∏—Ç—å!
```

**–í–∞—Ä—ñ–∞–Ω—Ç 2: –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ IServiceScopeFactory —É Singleton**

```csharp showLineNumbers
// OrderProcessingService –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è Singleton, –∞–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ä–∏–º—É—î Scoped
public class OrderProcessingService  // Singleton
{
    private readonly IServiceScopeFactory _scopeFactory;

    public OrderProcessingService(IServiceScopeFactory scopeFactory)
    {
        // IServiceScopeFactory ‚Äî —Ü–µ Singleton, —Ç–æ–º—É inject –º–æ–∂–Ω–∞!
        _scopeFactory = scopeFactory;
    }

    public void ProcessPending()
    {
        // –ö–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É ‚Äî –Ω–æ–≤–∏–π scope!
        using var scope = _scopeFactory.CreateScope();
        var repository = scope.ServiceProvider.GetRequiredService<IOrderRepository>();
        var orders = repository.GetPending();
        // ...
        // –ü—Ä–∏ –≤–∏—Ö–æ–¥—ñ –∑—ñ scope ‚Äî repository —Ç–∞ DbContext –∑–Ω–∏—â—É—é—Ç—å—Å—è!
    }
}
```

**–í–∞—Ä—ñ–∞–Ω—Ç 3: –ó—Ä–æ–±–∏—Ç–∏ Singleton –ø–æ-—Å–ø—Ä–∞–≤–∂–Ω—å–æ–º—É Singleton**

```csharp showLineNumbers
// –Ø–∫—â–æ OrderProcessingService —Å–ø—Ä–∞–≤–¥—ñ –ø–æ—Ç—Ä–µ–±—É—î –±—É—Ç–∏ Singleton ‚Äî
// –º–æ–∂–ª–∏–≤–æ, –≤–æ–Ω–æ –Ω–µ –ø–æ–≤–∏–Ω–Ω–æ —Ç—Ä–∏–º–∞—Ç–∏ IOrderRepository –Ω–∞–ø—Ä—è–º—É.
// –í–∏–¥—ñ–ª—ñ—Ç—å –æ–±—Ä–æ–±–∫—É –≤ –æ–∫—Ä–µ–º–∏–π Scoped UseCase.

public class OrderProcessingOrchestrator // Singleton ‚Äî orchestrates only
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger _logger;

    public OrderProcessingOrchestrator(IServiceScopeFactory scopeFactory, ILogger<OrderProcessingOrchestrator> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
    }

    public async Task RunAsync()
    {
        await using var scope = _scopeFactory.CreateAsyncScope();
        var handler = scope.ServiceProvider.GetRequiredService<ProcessPendingOrdersHandler>();
        await handler.HandleAsync();
    }
}

public class ProcessPendingOrdersHandler // Scoped ‚Äî –º–∞—î –¥–æ—Å—Ç—É–ø –¥–æ Scoped —Å–µ—Ä–≤—ñ—Å—ñ–≤
{
    private readonly IOrderRepository _repository;
    private readonly IEmailService _emailService;

    public ProcessPendingOrdersHandler(IOrderRepository repository, IEmailService emailService)
    {
        _repository = repository;
        _emailService = emailService;
    }

    public async Task HandleAsync()
    {
        var orders = await _repository.GetPendingAsync();
        foreach (var order in orders)
            await _emailService.SendAsync(order.CustomerEmail, "...");
    }
}
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 5: Lifecycle Diagrams

::mermaid

```mermaid
gantt
    title –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è Lifetimes –ø—ñ–¥ —á–∞—Å —Ä–æ–±–æ—Ç–∏ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É
    dateFormat X
    axisFormat %s

    section Singleton
    ConsoleLogger (Singleton)    : 0, 100

    section HTTP Request 1
    DbContext (Scoped)          : 10, 30
    OrderRepository (Scoped)    : 10, 30
    EmailSvc (Transient #1)     : 15, 25
    EmailSvc (Transient #2)     : 20, 30

    section HTTP Request 2
    DbContext (Scoped)          : 40, 60
    OrderRepository (Scoped)    : 40, 60
    EmailSvc (Transient #3)     : 45, 55

    section HTTP Request 3
    DbContext (Scoped)          : 70, 90
    OrderRepository (Scoped)    : 70, 90
```

::

---

## –ü—ñ–¥—Å—É–º–æ–∫: –Ø–∫ –≤–∏–±–∏—Ä–∞—Ç–∏ Lifetime?

::steps

### –ü–∏—Ç–∞–Ω–Ω—è 1: –ß–∏ –º–∞—î —Å–µ—Ä–≤—ñ—Å —Å—Ç–∞–Ω?

–Ø–∫—â–æ **—Ç–∞–∫ —ñ —Å—Ç–∞–Ω –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —Å–ø—ñ–ª—å–Ω–∏–º** ‚Üí Singleton.  
–Ø–∫—â–æ **—Ç–∞–∫ –∞–ª–µ —Å—Ç–∞–Ω —ñ–∑–æ–ª—å–æ–≤–∞–Ω–∏–π –¥–æ –∑–∞–ø–∏—Ç—É** ‚Üí Scoped.  
–Ø–∫—â–æ **–Ω—ñ (stateless)** ‚Üí Transient.

### –ü–∏—Ç–∞–Ω–Ω—è 2: –ß–∏ –¥–æ—Ä–æ–≥–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Å–µ—Ä–≤—ñ—Å?

–Ø–∫—â–æ **–¥–æ—Ä–æ–≥–æ —ñ thread-safe** ‚Üí Singleton.  
–Ø–∫—â–æ **–¥–æ—Ä–æ–≥–æ —ñ –Ω–µ thread-safe** ‚Üí Scoped.  
–Ø–∫—â–æ **–¥–µ—à–µ–≤–æ** ‚Üí Transient.

### –ü–∏—Ç–∞–Ω–Ω—è 3: –ß–∏ —Ä–µ–∞–ª—ñ–∑—É—î IDisposable?

–Ø–∫—â–æ **—Ç–∞–∫** ‚Üí –∫—Ä–∞—â–µ Scoped –∞–±–æ Transient —ñ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º scope. Singleton Disposable –∑–Ω–∏—â—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ shutdown.

### –ü–∏—Ç–∞–Ω–Ω—è 4: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Captive Dependency

Singleton ‚Üí –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ Singleton.  
Scoped ‚Üí –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Singleton —Ç–∞ Scoped.  
Transient ‚Üí –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—É–¥—å-—â–æ.

::

---

## üìù –ó–∞–≤–¥–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è Lifetime (Easy)

–í–∏–∑–Ω–∞—á—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π lifetime –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É —Ç–∞ –ø–æ—è—Å–Ω—ñ—Ç—å —á–æ–º—É:

| –°–µ—Ä–≤—ñ—Å | –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | Lifetime? |
|---|---|---|
| `IConfiguration` | –ß–∏—Ç–∞—î appsettings.json, immutable | ? |
| `AppDbContext` | Entity Framework, Unit of Work | ? |
| `IPasswordHasher` | Stateless, –∞–ª–≥–æ—Ä–∏—Ç–º bcrypt | ? |
| `IMemoryCache` | In-memory –∫–µ—à, —Å–ø—ñ–ª—å–Ω–∏–π –¥–ª—è –≤—Å—ñ—Ö | ? |
| `IHttpContextAccessor` | –î–æ—Å—Ç—É–ø –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ HTTP-–∫–æ–Ω—Ç–µ–∫—Å—Ç—É | ? |
| `IEmailSender` | –í—ñ–¥–ø—Ä–∞–≤–ª—è—î email, –Ω–µ–º–∞—î —Å—Ç–∞–Ω—É | ? |
| `IShoppingCart` | –ö–æ—à–∏–∫ –ø–æ–∫—É–ø–æ–∫ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ | ? |

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –ó–Ω–∞–π–¥–∏ Captive Dependency (Medium)

```csharp
services.AddSingleton<INotificationService, NotificationService>();
services.AddScoped<IEmailService, SmtpEmailService>();
services.AddScoped<ISmsService, TwilioSmsService>();
services.AddTransient<ILogger, ConsoleLogger>();

public class NotificationService : INotificationService
{
    private readonly IEmailService _email;
    private readonly ISmsService _sms;
    private readonly ILogger _logger;

    public NotificationService(IEmailService email, ISmsService sms, ILogger logger)
    {
        _email = email;
        _sms = sms;
        _logger = logger;
    }
}
```

–ó–Ω–∞–π–¥—ñ—Ç—å Captive Dependency. –ó–∞–ø—Ä–æ–ø–æ–Ω—É–π—Ç–µ 2 –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è.

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: Scope Simulation (Hard)

–ù–∞–ø–∏—à—ñ—Ç—å Unit —Ç–µ—Å—Ç, —â–æ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –ø–æ–≤–µ–¥—ñ–Ω–∫—É –≤—Å—ñ—Ö —Ç—Ä—å–æ—Ö lifetimes:

1. Transient: –¥–≤–∞ –≤–∏–∫–ª–∏–∫–∏ `GetRequiredService<T>()` –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å **—Ä—ñ–∑–Ω—ñ** –µ–∫–∑–µ–º–ø–ª—è—Ä–∏
2. Scoped: –¥–≤–∞ –≤–∏–∫–ª–∏–∫–∏ –≤ –æ–¥–Ω–æ–º—É scope –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å **—Ç–æ–π —Å–∞–º–∏–π**, —É —Ä—ñ–∑–Ω–∏—Ö scope ‚Äî **—Ä—ñ–∑–Ω—ñ**
3. Singleton: –≤–∏–∫–ª–∏–∫–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö scope –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å **—Ç–æ–π —Å–∞–º–∏–π**

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ `ServiceCollection`, `BuildServiceProvider()` —Ç–∞ `CreateScope()`.
