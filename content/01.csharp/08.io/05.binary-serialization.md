# 8.2.3. Binary Serialization: MessagePack —Ç–∞ Protocol Buffers

## –í—Å—Ç—É–ø: –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤

**JSON —Ç–∞ XML** ‚Äî —Ü–µ —Ç–µ–∫—Å—Ç–æ–≤—ñ —Ñ–æ—Ä–º–∞—Ç–∏, —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ –ª—é–¥–∏–Ω–æ—é. –ê–ª–µ —É –≤–∏—Å–æ–∫–æ–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (–º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏, IoT, —ñ–≥—Ä–∏, —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ —Å–∏—Å—Ç–µ–º–∏) –∫–æ–∂–µ–Ω –±–∞–π—Ç —Ç–∞ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∞ –º–∞—é—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è. **–ë—ñ–Ω–∞—Ä–Ω–∞ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è** –≤–∏—Ä—ñ—à—É—î —Ü—ñ –ø—Ä–æ–±–ª–µ–º–∏:

::card-group
  ::card{title="üì¶ –ö–æ–º–ø–∞–∫—Ç–Ω—ñ—Å—Ç—å"}
  –†–æ–∑–º—ñ—Ä —É 2-10 —Ä–∞–∑—ñ–≤ –º–µ–Ω—à–∏–π –∑–∞ JSON (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –¥–æ–¥–∞—Ç–∫—ñ–≤, low-bandwidth –º–µ—Ä–µ–∂).
  ::
  
  ::card{title="‚ö° –®–≤–∏–¥–∫—ñ—Å—Ç—å"}
  –ü–∞—Ä—Å–∏–Ω–≥ —É 3-5 —Ä–∞–∑—ñ–≤ —à–≤–∏–¥—à–∏–π (–º–µ–Ω—à–µ CPU –¥–ª—è —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó/–¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó).
  ::
  
  ::card{title="üíæ –ú–µ–Ω—à–µ –ø–∞–º'—è—Ç—ñ"}
  Fewer allocations –ø—ñ–¥ —á–∞—Å —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó (–≤–∞–∂–ª–∏–≤–æ –¥–ª—è GC pressure —É .NET).
  ::
  
  ::card{title="üîí –í–µ—Ä—Å—ñ–π–Ω—ñ—Å—Ç—å"}
  Protocol Buffers –º–∞—î –≤–±—É–¥–æ–≤–∞–Ω—É –ø—ñ–¥—Ç—Ä–∏–º–∫—É –µ–≤–æ–ª—é—Ü—ñ—ó —Å—Ö–µ–º –±–µ–∑ breaking changes.
  ::
::

**–ü—Ä–æ–±–ª–µ–º–∞ BinaryFormatter:**

–î–æ .NET 5 —ñ—Å–Ω—É–≤–∞–≤ `BinaryFormatter`, –∞–ª–µ –≤—ñ–Ω –±—É–≤ **deprecated** —á–µ—Ä–µ–∑ —Å–µ—Ä–π–æ–∑–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –±–µ–∑–ø–µ–∫–∏ (deserializing untrusted data –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–¥). Microsoft —Ä–µ–∫–æ–º–µ–Ω–¥—É—î —Å—É—á–∞—Å–Ω—ñ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∏:

- **MessagePack** ‚Äî —à–≤–∏–¥–∫–∏–π, –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π, —Å—Ö–æ–∂–∏–π –Ω–∞ JSON
- **Protocol Buffers (Protobuf)** ‚Äî —Å—Ö–µ–º–Ω–∏–π, —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø—ñ–∑–æ–≤–∞–Ω–∏–π, –≤—ñ–¥ Google

::warning  
**BinaryFormatter –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π!** –ü–æ—á–∏–Ω–∞—é—á–∏ –∑ .NET 5, `BinaryFormatter` –≤–∏–¥–∞—î –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, –∞ —É .NET 8+ ‚Äî –≤–∏–∫–∏–¥–∞—î `PlatformNotSupportedException`. –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –π–æ–≥–æ —É –Ω–æ–≤–æ–º—É –∫–æ–¥—ñ!
::

::note
**–ü–µ—Ä–µ–¥—É–º–æ–≤–∏**: –†–æ–∑—É–º—ñ–Ω–Ω—è JSON —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó, NuGet –ø–∞–∫–µ—Ç—ñ–≤, –±—ñ–Ω–∞—Ä–Ω–∏—Ö –¥–∞–Ω–∏—Ö (`byte[]`), async/await.
::

---

## –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ñ–æ—Ä–º–∞—Ç—ñ–≤: JSON vs MessagePack vs Protobuf

–†–æ–∑–≥–ª—è–Ω–µ–º–æ –ø—Ä–∏–∫–ª–∞–¥ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –æ–±'—î–∫—Ç–∞:

```csharp
class Person
{
    public int Id { get; set; } = 12345;
    public string Name { get; set; } = "–û–ª–µ–∫—Å–∞–Ω–¥—Ä";
    public int Age { get; set; } = 30;
    public bool IsActive { get; set; } = true;
}
```

| –§–æ—Ä–º–∞—Ç | –†–æ–∑–º—ñ—Ä (–±–∞–π—Ç) | –®–≤–∏–¥–∫—ñ—Å—Ç—å (–≤—ñ–¥–Ω–æ—Å–Ω–∞) | –ß–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å |
| :--- | :---: | :---: | :---: |
| **JSON** | ~65 | 1x | ‚úÖ –í–∏—Å–æ–∫–∞ |
| **MessagePack** | ~25 | 3-4x —à–≤–∏–¥—à–µ | ‚ùå –ë—ñ–Ω–∞—Ä–Ω–∏–π |
| **Protobuf** | ~18 | 4-5x —à–≤–∏–¥—à–µ | ‚ùå –ë—ñ–Ω–∞—Ä–Ω–∏–π (–∞–ª–µ —î .proto file) |
| **XML** | ~120 | 0.7x (–ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ) | ‚úÖ –í–∏—Å–æ–∫–∞ |

**–í–∏–≤—ñ–¥:** –ë—ñ–Ω–∞—Ä–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ —É 2-3 —Ä–∞–∑–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à—ñ —Ç–∞ —É 3-5 —Ä–∞–∑—ñ–≤ —à–≤–∏–¥—à—ñ!

::mermaid
```mermaid
graph LR
    A[–î–æ–¥–∞—Ç–æ–∫ C#] -->|Serialize| B{–§–æ—Ä–º–∞—Ç?}
    B -->|JSON| C[–¢–µ–∫—Å—Ç: 65 bytes]
    B -->|MessagePack| D[–ë—ñ–Ω–∞—Ä: 25 bytes]
    B -->|Protobuf| E[–ë—ñ–Ω–∞—Ä: 18 bytes]
    
    C -->|HTTP/REST API| F[–ö–ª—ñ—î–Ω—Ç]
    D -->|gRPC/WebSocket| F
    E -->|gRPC| F
    
    style C fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style D fill:#10b981,stroke:#047857,color:#ffffff
    style E fill:#f59e0b,stroke:#b45309,color:#ffffff
```
::

---

## MessagePack: –®–≤–∏–¥–∫–∏–π —Ç–∞ –ø—Ä–æ—Å—Ç–∏–π

**MessagePack** ‚Äî —Ü–µ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ —Å—Ö–æ–∂–∏–π –Ω–∞ JSON (–ø—ñ–¥—Ç—Ä–∏–º—É—î –æ–±'—î–∫—Ç–∏, –º–∞—Å–∏–≤–∏, –ø—Ä–∏–º—ñ—Ç–∏–≤–∏), –∞–ª–µ —É –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º—É binary –≤–∏–≥–ª—è–¥—ñ.

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
dotnet add package MessagePack
dotnet add package MessagePack.Annotations
```

### –ë–∞–∑–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```csharp showLineNumbers
using System;
using MessagePack;

[MessagePackObject]  // –û–±–æ–≤'—è–∑–∫–æ–≤–∏–π –∞—Ç—Ä–∏–±—É—Ç!
public class User
{
    [Key(0)]
    public int UserId { get; set; }
    
    [Key(1)]
    public string Username { get; set; }
    
    [Key(2)]
    public string Email { get; set; }
    
    [Key(3)]
    public bool IsVerified { get; set; }
}

class MessagePackBasics
{
    static void Main()
    {
        var user = new User
        {
            UserId = 42,
            Username = "vasyl_ua",
            Email = "vasyl@example.com",
            IsVerified = true
        };
        
        // –°–ï–†–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
        byte[] bytes = MessagePackSerializer.Serialize(user);
        Console.WriteLine($"MessagePack size: {bytes.Length} bytes");
        
        // –î–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è ‚Äî JSON
        string json = System.Text.Json.JsonSerializer.Serialize(user);
        Console.WriteLine($"JSON size: {System.Text.Encoding.UTF8.GetByteCount(json)} bytes");
        
        // –î–ï–°–ï–†–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
        User deserialized = MessagePackSerializer.Deserialize<User>(bytes);
        Console.WriteLine($"\nUserId: {deserialized.UserId}");
        Console.WriteLine($"Username: {deserialized.Username}");
        Console.WriteLine($"Email: {deserialized.Email}");
        Console.WriteLine($"IsVerified: {deserialized.IsVerified}");
    }
}
```

**–í–∏–≤—ñ–¥:**

```
MessagePack size: 52 bytes
JSON size: 86 bytes

UserId: 42
Username: vasyl_ua
Email: vasyl@example.com
IsVerified: True
```

**–†–æ–∑–±—ñ—Ä –∫–æ–¥—É:**

- **–†—è–¥–æ–∫ 4**: `[MessagePackObject]` –ø–æ–∑–Ω–∞—á–∞—î –∫–ª–∞—Å –¥–ª—è —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
- **–†—è–¥–∫–∏ 7, 10, 13, 16**: `[Key(N)]` –≤–∫–∞–∑—É—î –ø–æ—Ä—è–¥–∫–æ–≤–∏–π –Ω–æ–º–µ—Ä –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ (–ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ).
- **–†—è–¥–æ–∫ 33**: `MessagePackSerializer.Serialize()` –ø–æ–≤–µ—Ä—Ç–∞—î `byte[]`.
- **–†—è–¥–æ–∫ 42**: `MessagePackSerializer.Deserialize<T>()` –≤—ñ–¥–Ω–æ–≤–ª—é—î –æ–±'—î–∫—Ç –∑ –±–∞–π—Ç—ñ–≤.

::warning
**–û–±–æ–≤'—è–∑–∫–æ–≤—ñ –∞—Ç—Ä–∏–±—É—Ç–∏!** –ë–µ–∑ `[Key(N)]` MessagePack –≤–∏–∫–∏–Ω–µ –≤–∏–Ω—è—Ç–æ–∫. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `[MessagePackObject(keyAsPropertyName: true)]` (–ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ, –±—ñ–ª—å—à–∏–π —Ä–æ–∑–º—ñ—Ä).
::

### Key-as-PropertyName —Ä–µ–∂–∏–º (–±–µ–∑ [Key])

```csharp showLineNumbers
[MessagePackObject(keyAsPropertyName: true)]
public class Product
{
    public int ProductId { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ê–ù–ê–õ–û–ì–Ü–ß–ù–ï
byte[] bytes = MessagePackSerializer.Serialize(product);
Product restored = MessagePackSerializer.Deserialize<Product>(bytes);
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- ‚úÖ –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑—É–≤–∞—Ç–∏ `[Key(N)]`
- ‚úÖ –ó—Ä—É—á–Ω—ñ—à–µ –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–∏—Ö —Å—Ö–µ–º

**–ù–µ–¥–æ–ª—ñ–∫–∏:**
- ‚ùå –ë—ñ–ª—å—à–∏–π —Ä–æ–∑–º—ñ—Ä (–∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –Ω–∞–∑–≤–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π)
- ‚ùå –ü–æ–≤—ñ–ª—å–Ω—ñ—à–µ (~10-15%)

::tip
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è**: –î–ª—è production –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `[Key(N)]` —Ä–µ–∂–∏–º. `keyAsPropertyName: true` ‚Äî –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É–≤–∞–Ω–Ω—è.
::

---

## MessagePack: Advanced —Å—Ü–µ–Ω–∞—Ä—ñ—ó

### –Ü–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π

```csharp showLineNumbers
[MessagePackObject]
public class Account
{
    [Key(0)]
    public string Username { get; set; }
    
    [IgnoreMember]  // –ù–ï —Å–µ—Ä—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è
    public string PasswordHash { get; set; }
    
    [Key(1)]
    public string Email { get; set; }
}
```

### Custom DateTime —Ñ–æ—Ä–º–∞—Ç

```csharp showLineNumbers
using System;
using MessagePack;
using MessagePack.Formatters;

// Custom formatter –¥–ª—è DateTime
public class CustomDateTimeFormatter : IMessagePackFormatter<DateTime>
{
    public void Serialize(ref MessagePackWriter writer, DateTime value, MessagePackSerializerOptions options)
    {
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —è–∫ Unix timestamp (—Å–µ–∫—É–Ω–¥–∏ –∑ 1970-01-01)
        long unixTime = new DateTimeOffset(value).ToUnixTimeSeconds();
        writer.Write(unixTime);
    }
    
    public DateTime Deserialize(ref MessagePackReader reader, MessagePackSerializerOptions options)
    {
        long unixTime = reader.ReadInt64();
        return DateTimeOffset.FromUnixTimeSeconds(unixTime).DateTime;
    }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
var options = MessagePackSerializerOptions.Standard
    .WithResolver(MessagePack.Resolvers.CompositeResolver.Create(
        new IMessagePackFormatter[] { new CustomDateTimeFormatter() },
        new[] { MessagePack.Resolvers.StandardResolver.Instance }
    ));

byte[] bytes = MessagePackSerializer.Serialize(myObject, options);
```

### –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É —Ñ–∞–π–ª

```csharp showLineNumbers
using System;
using System.IO;
using MessagePack;

class SaveToFileDemo
{
    static void Main()
    {
        var data = new UserList
        {
            Users = new[]
            {
                new User { UserId = 1, Username = "user1", Email = "user1@example.com", IsVerified = true },
                new User { UserId = 2, Username = "user2", Email = "user2@example.com", IsVerified = false }
            }
        };
        
        // Async —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —É —Ñ–∞–π–ª
        await using (var file = File.Create("users.msgpack"))
        {
            await MessagePackSerializer.SerializeAsync(file, data);
        }
        
        // Async –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ —Ñ–∞–π–ª—É
        await using (var file = File.OpenRead("users.msgpack"))
        {
            var loaded = await MessagePackSerializer.DeserializeAsync<UserList>(file);
            Console.WriteLine($"–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ {loaded.Users.Length} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤");
        }
    }
}

[MessagePackObject]
public class UserList
{
    [Key(0)]
    public User[] Users { get; set; }
}
```

---

## Protocol Buffers (Protobuf): –°—Ö–µ–º–Ω–∞ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è

**Protocol Buffers** ‚Äî —Ü–µ binary —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥ Google, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É gRPC. –ì–æ–ª–æ–≤–Ω–∞ –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –≤—ñ–¥ MessagePack ‚Äî **–æ–±–æ–≤'—è–∑–∫–æ–≤–∞ —Å—Ö–µ–º–∞ (.proto —Ñ–∞–π–ª)**.

### –ß–æ–º—É Protobuf?

::card-group
  ::card{title="üìã –°—Ç—Ä–æ–≥–∞ —Å—Ö–µ–º–∞"}
  `.proto` —Ñ–∞–π–ª –≤–∏–∑–Ω–∞—á–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–∏—Ö ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–æ–º —Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–º.
  ::
  
  ::card{title="üîÑ Backward/Forward compatibility"}
  –ú–æ–∂–Ω–∞ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ –ø–æ–ª—è –±–µ–∑ breaking changes (versioning).
  ::
  
  ::card{title="üåê –ö—Ä–æ—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ñ—Å—Ç—å"}
  `.proto` ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É –¥–ª—è C#, Java, Python, Go, Rust —Ç–æ—â–æ.
  ::
  
  ::card{title="üöÄ gRPC"}
  Protobuf ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è gRPC (–≤–∏—Å–æ–∫–æ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ RPC –≤–∏–∫–ª–∏–∫–∏).
  ::
::

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
dotnet add package Google.Protobuf
dotnet add package Grpc.Tools  # –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó C# –∫–æ–¥—É –∑ .proto
```

### –ü—Ä–∏–∫–ª–∞–¥: .proto —Å—Ö–µ–º–∞

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `person.proto`:

```protobuf
syntax = "proto3";

option csharp_namespace = "MyApp.Models";

message Person {
  int32 id = 1;
  string name = 2;
  int32 age = 3;
  bool is_active = 4;
  repeated string tags = 5;  // –ú–∞—Å–∏–≤ —Ä—è–¥–∫—ñ–≤
}
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è:**

- `syntax = "proto3"` ‚Äî –≤–µ—Ä—Å—ñ—è Protobuf
- `csharp_namespace` ‚Äî C# namespace –¥–ª—è –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤
- `message Person` ‚Äî –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—É (–∞–Ω–∞–ª–æ–≥ `class` —É C#)
- `int32 id = 1` ‚Äî –ø–æ–ª–µ —Ç–∏–ø—É int32 –∑ –Ω–æ–º–µ—Ä–æ–º 1 (–Ω–æ–º–µ—Ä–∏ –≤–∞–∂–ª–∏–≤—ñ –¥–ª—è backward compatibility!)
- `repeated string tags` ‚Äî –º–∞—Å–∏–≤/–∫–æ–ª–µ–∫—Ü—ñ—è

### –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è C# –∫–æ–¥—É

–î–æ–¥–∞–π—Ç–µ —É `.csproj`:

```xml
<ItemGroup>
  <Protobuf Include="Protos\person.proto" GrpcServices="None" />
</ItemGroup>
```

–ü—ñ–¥ —á–∞—Å build –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∫–ª–∞—Å `Person` —É `obj/Debug/.../Person.cs`.

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```csharp showLineNumbers
using System;
using System.IO;
using Google.Protobuf;
using MyApp.Models;  // –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π namespace

class ProtobufBasics
{
    static void Main()
    {
        // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç (–∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–ª–∞—Å)
        var person = new Person
        {
            Id = 12345,
            Name = "–ê–Ω–¥—Ä—ñ–π –ö–æ–≤–∞–ª–µ–Ω–∫–æ",
            Age = 28,
            IsActive = true
        };
        person.Tags.Add("developer");
        person.Tags.Add("csharp");
        
        // –°–ï–†–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø —É byte[]
        byte[] bytes = person.ToByteArray();
        Console.WriteLine($"Protobuf size: {bytes.Length} bytes");
        
        // –î–ï–°–ï–†–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –∑ byte[]
        var deserialized = Person.Parser.ParseFrom(bytes);
        Console.WriteLine($"\nID: {deserialized.Id}");
        Console.WriteLine($"Name: {deserialized.Name}");
        Console.WriteLine($"Age: {deserialized.Age}");
        Console.WriteLine($"Tags: {string.Join(", ", deserialized.Tags)}");
        
        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É —Ñ–∞–π–ª
        using (var output = File.Create("person.pb"))
        {
            person.WriteTo(output);
        }
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ —Ñ–∞–π–ª—É
        using (var input = File.OpenRead("person.pb"))
        {
            var loaded = Person.Parser.ParseFrom(input);
            Console.WriteLine($"\n–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: {loaded.Name}");
        }
    }
}
```

**–í–∏–≤—ñ–¥:**

```
Protobuf size: 38 bytes

ID: 12345
Name: –ê–Ω–¥—Ä—ñ–π –ö–æ–≤–∞–ª–µ–Ω–∫–æ
Age: 28
Tags: developer, csharp

–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: –ê–Ω–¥—Ä—ñ–π –ö–æ–≤–∞–ª–µ–Ω–∫–æ
```

**–†–æ–∑–±—ñ—Ä –∫–æ–¥—É:**

- **–†—è–¥–æ–∫ 11**: –°—Ç–≤–æ—Ä—é—î–º–æ –µ–∫–∑–µ–º–ø–ª—è—Ä –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ–≥–æ –∫–ª–∞—Å—É `Person`.
- **–†—è–¥–æ–∫ 22**: `ToByteArray()` ‚Äî –º–µ—Ç–æ–¥ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó (–∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ).
- **–†—è–¥–æ–∫ 26**: `Person.Parser.ParseFrom()` ‚Äî —Å—Ç–∞—Ç–∏—á–Ω–∏–π parser –¥–ª—è –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
- **–†—è–¥–æ–∫ 33**: `WriteTo(Stream)` ‚Äî –∑–∞–ø–∏—Å —É –ø–æ—Ç—ñ–∫.

---

## Versioning —É Protobuf

–ì–æ–ª–æ–≤–Ω–∞ –ø–µ—Ä–µ–≤–∞–≥–∞ Protobuf ‚Äî **–µ–≤–æ–ª—é—Ü—ñ—è —Å—Ö–µ–º–∏ –±–µ–∑ breaking changes**.

### –ü–æ—á–∞—Ç–∫–æ–≤–∞ –≤–µ—Ä—Å—ñ—è (v1)

```protobuf
message User {
  int32 id = 1;
  string name = 2;
}
```

### –ù–æ–≤–∞ –≤–µ—Ä—Å—ñ—è (v2) ‚Äî –¥–æ–¥–∞—î–º–æ –ø–æ–ª–µ

```protobuf
message User {
  int32 id = 1;
  string name = 2;
  string email = 3;  // –ù–û–í–ï –ü–û–õ–ï
}
```

**–©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è?**

- **–°—Ç–∞—Ä–∏–π –∫–ª—ñ—î–Ω—Ç** (v1) –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑—É—î v2 –¥–∞–Ω—ñ: –≤—ñ–Ω **—ñ–≥–Ω–æ—Ä—É—î** –ø–æ–ª–µ `email` (–±–∞—á–∏—Ç—å —Ç—ñ–ª—å–∫–∏ `id` —Ç–∞ `name`).
- **–ù–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç** (v2) –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑—É—î v1 –¥–∞–Ω—ñ: –ø–æ–ª–µ `email` –±—É–¥–µ –ø–æ—Ä–æ–∂–Ω—ñ–º —Ä—è–¥–∫–æ–º (–¥–µ—Ñ–æ–ª—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è).

**–ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–ø–µ—á–Ω–æ—ó –µ–≤–æ–ª—é—Ü—ñ—ó:**

1. ‚úÖ **–î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –ø–æ–ª—ñ–≤** ‚Äî –∑–∞–≤–∂–¥–∏ –±–µ–∑–ø–µ—á–Ω–æ
2. ‚úÖ **–í–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–ª—ñ–≤** ‚Äî –ø–æ–∑–Ω–∞—á—Ç–µ —è–∫ `reserved` —â–æ–± –Ω–æ–º–µ—Ä –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è –∑–Ω–æ–≤—É
3. ‚ùå **–ó–º—ñ–Ω–∞ —Ç–∏–ø—É –ø–æ–ª—è** ‚Äî breaking change!
4. ‚ùå **–ó–º—ñ–Ω–∞ –Ω–æ–º–µ—Ä–∞ –ø–æ–ª—è** ‚Äî breaking change!

**–ü—Ä–∏–∫–ª–∞–¥ reserved:**

```protobuf
message User {
  reserved 4, 5;  // –ù–æ–º–µ—Ä–∏ –±—ñ–ª—å—à–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è
  reserved "old_field_name";  // –ù–∞–∑–≤–∞ –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω–∞
  
  int32 id = 1;
  string name = 2;
  string email = 3;
}
```

---

## MessagePack vs Protobuf: –©–æ –≤–∏–±—Ä–∞—Ç–∏?

| –ö—Ä–∏—Ç–µ—Ä—ñ–π | MessagePack | Protocol Buffers |
| :--- | :--- | :--- |
| **–°—Ö–µ–º–∞** | –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞ (.cs –∫–ª–∞—Å–∏) | –û–±–æ–≤'—è–∑–∫–æ–≤–∞ (.proto —Ñ–∞–π–ª–∏) |
| **–†–æ–∑–º—ñ—Ä** | –¢—Ä–æ—Ö–∏ –±—ñ–ª—å—à–∏–π | –ù–∞–π–º–µ–Ω—à–∏–π |
| **–®–≤–∏–¥–∫—ñ—Å—Ç—å** | –î—É–∂–µ —à–≤–∏–¥–∫–æ | –ù–∞–π—à–≤–∏–¥—à–µ |
| **Versioning** | –†—É—á–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å | –í–±—É–¥–æ–≤–∞–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ |
| **–ö—Ä–æ—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ñ—Å—Ç—å** | C#, JavaScript, Ruby, etc | –£—Å—ñ –ø–æ–ø—É–ª—è—Ä–Ω—ñ –º–æ–≤–∏ |
| **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å** | –ù–∏–∑—å–∫–∞ | –°–µ—Ä–µ–¥–Ω—è (—Ç—Ä–µ–±–∞ –≤—á–∏—Ç–∏ .proto) |
| **gRPC** | –ù–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è | ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç |
| **Best for** | –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏, cache | Public APIs, gRPC, IoT |

::tip
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
- **MessagePack**: –®–≤–∏–¥–∫–∏–π –∫–µ—à, –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏ .NET, —ñ–≥—Ä–æ–≤—ñ —Å–µ—Ä–≤–µ—Ä–∏.
- **Protobuf**: gRPC APIs, –∫—Ä–æ—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è, —Å–∏—Å—Ç–µ–º–∏ –∑ —Å—Ç—Ä–æ–≥–æ—é –≤–µ—Ä—Å—ñ–π–Ω—ñ—Å—Ç—é.
::

---

## –ü—Ä–∏–∫–ª–∞–¥ –∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–≤—ñ—Ç—É: –ö–µ—à—É–≤–∞–Ω–Ω—è

```csharp showLineNumbers
using System;
using System.IO;
using System.Threading.Tasks;
using MessagePack;

[MessagePackObject]
public class CacheEntry<T>
{
    [Key(0)]
    public T Data { get; set; }
    
    [Key(1)]
    public DateTime ExpiresAt { get; set; }
    
    [Key(2)]
    public string Version { get; set; }
}

public class MessagePackCache
{
    private readonly string _cacheDir = "cache";
    
    public MessagePackCache()
    {
        Directory.CreateDirectory(_cacheDir);
    }
    
    public async Task SetAsync<T>(string key, T value, TimeSpan ttl)
    {
        var entry = new CacheEntry<T>
        {
            Data = value,
            ExpiresAt = DateTime.UtcNow.Add(ttl),
            Version = "1.0"
        };
        
        string filePath = Path.Combine(_cacheDir, $"{key}.msgpack");
        await using var file = File.Create(filePath);
        await MessagePackSerializer.SerializeAsync(file, entry);
    }
    
    public async Task<T> GetAsync<T>(string key)
    {
        string filePath = Path.Combine(_cacheDir, $"{key}.msgpack");
        
        if (!File.Exists(filePath))
            return default;
        
        await using var file = File.OpenRead(filePath);
        var entry = await MessagePackSerializer.DeserializeAsync<CacheEntry<T>>(file);
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ TTL
        if (entry.ExpiresAt < DateTime.UtcNow)
        {
            File.Delete(filePath);  // –í–∏–¥–∞–ª—è—î–º–æ –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π –∫–µ—à
            return default;
        }
        
        return entry.Data;
    }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
class CacheDemo
{
    static async Task Main()
    {
        var cache = new MessagePackCache();
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ
        var userData = new { UserId = 123, Name = "–û–ª–µ–Ω–∞", Role = "Admin" };
        await cache.SetAsync("user_123", userData, TimeSpan.FromMinutes(5));
        
        Console.WriteLine("–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É –∫–µ—à");
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        await Task.Delay(1000);
        var cached = await cache.GetAsync<dynamic>("user_123");
        
        if (cached != null)
        {
            Console.WriteLine($"–ó –∫–µ—à—É: {cached.Name}, Role: {cached.Role}");
        }
    }
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ MessagePack –¥–ª—è –∫–µ—à—É:**

- üöÄ –®–≤–∏–¥–∫–∞ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è/–¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è high-throughput)
- üíæ –ú–∞–ª–∏–π —Ä–æ–∑–º—ñ—Ä (–µ–∫–æ–Ω–æ–º—ñ—è –¥–∏—Å–∫—É/–ø–∞–º'—è—Ç—ñ)
- üîß –ü—Ä–æ—Å—Ç–æ —É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ (–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ .proto —Ñ–∞–π–ª–∏)

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

::steps

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: Performance Benchmark

–°—Ç–≤–æ—Ä—ñ—Ç—å benchmark –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è:
1. JSON (System.Text.Json)
2. MessagePack
3. Protobuf

–í–∏–º—ñ—Ä—è–π—Ç–µ –¥–ª—è 10,000 –æ–±'—î–∫—Ç—ñ–≤:
- –ß–∞—Å —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
- –ß–∞—Å –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
- –†–æ–∑–º—ñ—Ä —É –±–∞–π—Ç–∞—Ö

–ü–æ–±—É–¥—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—é –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: gRPC Service –∑ Protobuf

–°—Ç–≤–æ—Ä—ñ—Ç—å –ø—Ä–æ—Å—Ç–∏–π gRPC —Å–µ—Ä–≤—ñ—Å:
1. –í–∏–∑–Ω–∞—á—Ç–µ `.proto` —Å—Ö–µ–º—É –¥–ª—è `UserService` –∑ –º–µ—Ç–æ–¥–æ–º `GetUser(id)`.
2. –ó–≥–µ–Ω–µ—Ä—É–π—Ç–µ C# –∫–æ–¥.
3. –†–µ–∞–ª—ñ–∑—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä —Ç–∞ –∫–ª—ñ—î–Ω—Ç.
4. –ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ Protobuf.

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: Distributed Cache –∑ MessagePack

–†–µ–∞–ª—ñ–∑—É–π—Ç–µ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏–π –∫–µ—à:
1. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ Redis –∞–±–æ –≤–ª–∞—Å–Ω—É in-memory —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é.
2. –°–µ—Ä—ñ–∞–ª—ñ–∑—É–π—Ç–µ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ MessagePack –ø–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º.
3. –î–æ–¥–∞–π—Ç–µ TTL (Time-To-Live).
4. –ù–∞–ø–∏—à—ñ—Ç—å —Ç–µ—Å—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —à–≤–∏–¥–∫–æ—Å—Ç—ñ.

::

---

## –†–µ–∑—é–º–µ

::card-group
  ::card{title="MessagePack"}
  –®–≤–∏–¥–∫–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ—ó —Å—Ö–µ–º–∏. –Ü–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö —Å–∏—Å—Ç–µ–º .NET.
  ::
  
  ::card{title="Protocol Buffers"}
  –°—Ö–µ–º–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∑ –≤–±—É–¥–æ–≤–∞–Ω–æ—é –≤–µ—Ä—Å—ñ–π–Ω—ñ—Å—Ç—é. –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è gRPC —Ç–∞ –∫—Ä–æ—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∏—Ö APIs.
  ::
  
  ::card{title="–ü–µ—Ä–µ–≤–∞–≥–∏"}
  2-10x –º–µ–Ω—à–∏–π —Ä–æ–∑–º—ñ—Ä, 3-5x —à–≤–∏–¥—à–∞ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ JSON.
  ::
  
  ::card{title="Use Cases"}
  –ú—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏, gRPC, IoT, —ñ–≥—Ä–æ–≤—ñ —Å–µ—Ä–≤–µ—Ä–∏, high-performance –∫–µ—à—ñ.
  ::
::

::mermaid
```mermaid
graph TD
    A[–ü–æ—Ç—Ä–µ–±–∞ —É —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó] --> B{–ß–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å –≤–∞–∂–ª–∏–≤–∞?}
    B -->|–¢–∞–∫| C[JSON/XML]
    B -->|–ù—ñ, –≤–∞–∂–ª–∏–≤–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å| D{–ü–æ—Ç—Ä—ñ–±–Ω–∞ —Å—Ö–µ–º–∞?}
    D -->|–¢–∞–∫, gRPC| E[Protobuf]
    D -->|–ù—ñ, –ø—Ä–æ—Å—Ç–∞| F[MessagePack]
    
    C --> G[System.Text.Json]
    E --> H[Google.Protobuf + .proto]
    F --> I[MessagePack-CSharp]
    
    style G fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style H fill:#f59e0b,stroke:#b45309,color:#ffffff
    style I fill:#10b981,stroke:#047857,color:#ffffff
```
::

---

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

- [MessagePack for C#](https://github.com/MessagePack-CSharp/MessagePack-CSharp)
- [Protocol Buffers - Google](https://protobuf.dev/)
- [Google.Protobuf NuGet](https://www.nuget.org/packages/Google.Protobuf/)
- [gRPC for .NET](https://learn.microsoft.com/en-us/aspnet/core/grpc/)
- [BinaryFormatter Security Guide](https://learn.microsoft.com/en-us/dotnet/standard/serialization/binaryformatter-security-guide)
