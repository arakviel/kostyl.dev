# –û—Å–Ω–æ–≤–∏ –ó–∞–ø–∏—Ç—ñ–≤ —Ç–∞ –ú–∞–≥—ñ—è –ö–ª—é—á—ñ–≤

–¢–µ–ø–µ—Ä, –∫–æ–ª–∏ –º–∏ –º–∞—î–º–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —á–∞—Å –Ω–∞–≤—á–∏—Ç–∏—Å—è –Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è. –£ —Ü—ñ–π –≥–ª–∞–≤—ñ –º–∏ —Ä–æ–∑–±–µ—Ä–µ–º–æ `useQuery` ‚Äî –æ—Å–Ω–æ–≤–Ω–∏–π —Ö—É–∫, —è–∫–∏–π –≤–∏ –±—É–¥–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —É 90% –≤–∏–ø–∞–¥–∫—ñ–≤.

–ú–∏ —Ç–∞–∫–æ–∂ –∑–∞–≥–ª–∏–±–∏–º–æ—Å—è –≤ **Query Keys** ‚Äî –∫–æ–Ω—Ü–µ–ø—Ü—ñ—é, –≤—ñ–¥ —è–∫–æ—ó –∑–∞–ª–µ–∂–∏—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ –≤–∞—à–æ–≥–æ –∫–µ—à—É. –Ø–∫—â–æ –≤–∏ –∑—Ä–æ–∑—É–º—ñ—î—Ç–µ –∫–ª—é—á—ñ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –±–∞–≥–∏ –∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º.

## –ê–Ω–∞—Ç–æ–º—ñ—è `useQuery`

–£ –≤–µ—Ä—Å—ñ—ó 5 `useQuery` –ø—Ä–∏–π–º–∞—î **—Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω –∞—Ä–≥—É–º–µ–Ω—Ç** ‚Äî –æ–±'—î–∫—Ç –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏. (–°—Ç–∞—Ä–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å `useQuery(key, fn)` –±—ñ–ª—å—à–µ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è).

```tsx [BasicQuery.tsx]
import { useQuery } from '@tanstack/react-query';

function UserProfile({ userId }) {
  const result = useQuery({
    queryKey: ['user', userId], // üîë –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á
    queryFn: () => fetchUser(userId), // üì° –§—É–Ω–∫—Ü—ñ—è –∑–∞–ø–∏—Ç—É
  });
  
  // ...
}
```

### –©–æ –ø–æ–≤–µ—Ä—Ç–∞—î `useQuery`?

–û–±'—î–∫—Ç `result` –º—ñ—Å—Ç–∏—Ç—å –≤—Å–µ, —â–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏ –ø—Ä–æ —Å—Ç–∞–Ω –∑–∞–ø–∏—Ç—É. –û—Å—å –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à—ñ –ø–æ–ª—è:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å |
| :--- | :--- | :--- |
| `data` | `TData` | –î–∞–Ω—ñ, –æ—Ç—Ä–∏–º–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞. `undefined`, —è–∫—â–æ –∑–∞–ø–∏—Ç —â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è. |
| `error` | `Error` | –û–±'—î–∫—Ç –ø–æ–º–∏–ª–∫–∏, —è–∫—â–æ –∑–∞–ø–∏—Ç –≤–ø–∞–≤. |
| `isPending` | `boolean` | **v5**: –ó–∞–ø–∏—Ç –π–¥–µ, —ñ **–¥–∞–Ω–∏—Ö –≤ –∫–µ—à—ñ –Ω–µ–º–∞—î**. –¶–µ —Å—Ç–∞–Ω "–ø–µ—Ä—à–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è". |
| `isLoading` | `boolean` | –¢–µ —Å–∞–º–µ, —â–æ `isPending`. (–í v4 —Ü–µ –±—É–ª–æ —ñ–Ω–∞–∫—à–µ, –≤ v5 —Ü–µ –∞–ª—ñ–∞—Å). |
| `isError` | `boolean` | –ß–∏ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. |
| `isFetching` | `boolean` | –ó–∞–ø–∏—Ç –π–¥–µ **–ø—Ä—è–º–æ –∑–∞—Ä–∞–∑** (–≤ —Ç–æ–º—É —á–∏—Å–ª—ñ —Ñ–æ–Ω–æ–≤–∏–π). |

::warning
**–†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ `isPending` —Ç–∞ `isFetching`**:
- `isPending`: "–£ –º–µ–Ω–µ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö, –ø–æ–∫–∞–∂–∏ —Å–∫–µ–ª–µ—Ç–æ–Ω".
- `isFetching`: "–Ø –æ–Ω–æ–≤–ª—é—é –¥–∞–Ω—ñ, –ø–æ–∫–∞–∂–∏ –º–∞–ª–µ–Ω—å–∫–∏–π —Å–ø—ñ–Ω–Ω–µ—Ä –∑–±–æ–∫—É".
–Ø–∫—â–æ —É –≤–∞—Å —î —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ (Stale), `isPending` –±—É–¥–µ `false`, –∞ `isFetching` ‚Äî `true`.
::

### –¢–∏–ø–æ–≤–∏–π –ø–∞—Ç–µ—Ä–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```tsx
const { data, isPending, isError, error } = useQuery({ ... });

if (isPending) {
  return <span>Loading...</span>;
}

if (isError) {
  return <span>Error: {error.message}</span>;
}

// –¢—É—Ç TypeScript –≤–∂–µ –∑–Ω–∞—î, —â–æ data –≤–∏–∑–Ω–∞—á–µ–Ω–∞
return <div>{data.title}</div>;
```

## Query Keys: –í–∞—à—ñ –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

`queryKey` ‚Äî —Ü–µ –º–∞—Å–∏–≤, —è–∫–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î –∑–∞–ø–∏—Ç. TanStack Query –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –π–æ–≥–æ –¥–ª—è:
1.  –ö–µ—à—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö (—Ü–µ –∫–ª—é—á –≤ Map).
2.  –î–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—ó (—è–∫—â–æ –∫–ª—é—á –æ–¥–Ω–∞–∫–æ–≤–∏–π, –∑–∞–ø–∏—Ç –Ω–µ –¥—É–±–ª—é—î—Ç—å—Å—è).
3.  –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É (—è–∫—â–æ –∫–ª—é—á –∑–º—ñ–Ω–∏–≤—Å—è, –∑–∞–ø–∏—Ç –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –∑–Ω–æ–≤—É).

::tip
–î—É–º–∞–π—Ç–µ –ø—Ä–æ `queryKey` —è–∫ –ø—Ä–æ –º–∞—Å–∏–≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π `useEffect`. –í—Å–µ, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `queryFn`, –º–∞—î –±—É—Ç–∏ –≤ –∫–ª—é—á—ñ.
::

### –ü—Ä–æ—Å—Ç—ñ –∫–ª—é—á—ñ
```javascript
// –°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö —Ç—É–¥—É—à–æ–∫
['todos']
```

### –ö–ª—é—á—ñ –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
```javascript
// –¢—É–¥—É—à–∫–∞ –∑ ID 5
['todos', 5]

// –°–ø–∏—Å–æ–∫ —Ç—É–¥—É—à–æ–∫, –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–∏–π –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º 'done'
['todos', { status: 'done' }]
```

### –Ü—î—Ä–∞—Ä—Ö—ñ—è –∫–ª—é—á—ñ–≤ (Best Practice)

–ö–ª—é—á—ñ –º–∞—é—Ç—å –±—É—Ç–∏ —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–∏–º–∏, –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ. –¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å –≤–∞–º –ª–µ–≥–∫–æ –∫–µ—Ä—É–≤–∞—Ç–∏ –≥—Ä—É–ø–∞–º–∏ –∑–∞–ø–∏—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —ñ–Ω–≤–∞–ª—ñ–¥—É–≤–∞—Ç–∏ –≤—Å—ñ —Ç—É–¥—É—à–∫–∏ –æ–¥—Ä–∞–∑—É).

–°—Ç—Ä—É–∫—Ç—É—Ä–∞: `['resouce', 'related-id', 'params']`

```javascript
// ‚úÖ –î–æ–±—Ä–µ
['todos']                 // –í—Å—ñ
['todos', 1]              // –î–µ—Ç–∞–ª—ñ ID 1
['todos', 'list', { page: 1 }] // –°–ø–∏—Å–æ–∫ –∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é

// ‚ùå –ü–æ–≥–∞–Ω–æ
['todos-1']               // –†—è–¥–æ–∫ –≤–∞–∂–∫–æ –ø–∞—Ä—Å–∏—Ç–∏
[1, 'todos']              // –ù–µ–ª–æ–≥—ñ—á–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫
```

### Query Key Factories

–©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ —Ö–∞–æ—Å—É —ñ –¥—Ä—É–∫–∞—Ä—Å—å–∫–∏—Ö –ø–æ–º–∏–ª–æ–∫ ("users" vs "user"), –ø—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å **Key Factories**.

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `queries/keys.ts`:

```typescript [queries/keys.ts]
export const todoKeys = {
  all: ['todos'] as const,
  lists: () => [...todoKeys.all, 'list'] as const,
  list: (filters: string) => [...todoKeys.lists(), { filters }] as const,
  details: () => [...todoKeys.all, 'detail'] as const,
  detail: (id: number) => [...todoKeys.details(), id] as const,
};
```

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:

```typescript
useQuery({
  queryKey: todoKeys.list('done'),
  queryFn: ...
})

useQuery({
  queryKey: todoKeys.detail(1),
  queryFn: ...
})
```

–¶–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∞–º –±–µ–∑–ø–µ—á–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç–∏ –∫–ª—é—á—ñ —ñ –º–∞—Ç–∏ –∞–≤—Ç–æ–¥–æ–ø–æ–≤–Ω–µ–Ω–Ω—è.

## Query Function (`queryFn`)

–§—É–Ω–∫—Ü—ñ—è, —è–∫—É –≤–∏ –ø–µ—Ä–µ–¥–∞—î—Ç–µ –≤ `queryFn`, –º–æ–∂–µ –±—É—Ç–∏ –±—É–¥—å-—è–∫–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é, —â–æ –ø–æ–≤–µ—Ä—Ç–∞—î **Promise**.

–í–∏–º–æ–≥–∏ –¥–æ `queryFn`:
1.  –ü–æ–≤–∏–Ω–Ω–∞ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ Promise, —è–∫–∏–π —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è –∑ –¥–∞–Ω–∏–º–∏.
2.  **–ü–æ–≤–∏–Ω–Ω–∞ –∫–∏–¥–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É (reject)**, —è–∫—â–æ —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫.

::caution
`fetch` –Ω–µ –∫–∏–¥–∞—î –ø–æ–º–∏–ª–∫—É –Ω–∞ 4xx/5xx —Å—Ç–∞—Ç—É—Å–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 404). –í—ñ–Ω –∫–∏–¥–∞—î –ø–æ–º–∏–ª–∫—É —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∑ –º–µ—Ä–µ–∂–µ—é.
–í–∏ –º—É—Å–∏—Ç–µ —Å–∞–º—ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ `response.ok`.
::

```typescript
const fetchTodo = async (id: number) => {
  const res = await fetch(`/api/todos/${id}`);
  
  if (!res.ok) {
    throw new Error('Network response was not ok');
  }
  
  return res.json();
};
```

Axios —Ä–æ–±–∏—Ç—å —Ü–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, —Ç–æ–º—É –≤—ñ–Ω —á–∞—Å—Ç–æ –∑—Ä—É—á–Ω—ñ—à–∏–π.

## –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —É `queryFn`

–£ v5 –æ–±'—î–∫—Ç `context` –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è —É `queryFn` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –í—ñ–Ω –º—ñ—Å—Ç–∏—Ç—å `queryKey`. –¶–µ –∑—Ä—É—á–Ω–æ –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–Ω—è —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π.

```typescript
const fetchTodoByContext = async ({ queryKey }) => {
  // queryKey[1] ‚Äî —Ü–µ –Ω–∞—à ID
  const [_key, id] = queryKey;
  const res = await fetch(`/api/todos/${id}`);
  return res.json();
};

useQuery({
  queryKey: ['todos', 5],
  queryFn: fetchTodoByContext, 
});
```

–ê–ª–µ —á–∞—Å—Ç—ñ—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –∑–∞–º–∏–∫–∞–Ω–Ω—è (inline functions):

```typescript
useQuery({
  queryKey: ['todos', 5],
  queryFn: () => fetchTodo(5), // –ü—Ä–æ—Å—Ç—ñ—à–µ —ñ —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—à–µ
});
```

[–î–∞–ª—ñ: –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö (staleTime, gcTime)](./04.data-synchronization.md)
