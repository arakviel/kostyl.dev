# –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω—ñ –û–Ω–æ–≤–ª–µ–Ω–Ω—è: –®–≤–∏–¥—à–µ –∑–∞ –°–≤—ñ—Ç–ª–æ

–í–∏ –∫–æ–ª–∏-–Ω–µ–±—É–¥—å –ø–æ–º—ñ—á–∞–ª–∏, —è–∫ –ø—Ä–∞—Ü—é—î –ª–∞–π–∫ –≤ Instagram –∞–±–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram? –í–∏ –Ω–∞—Ç–∏—Å–∫–∞—î—Ç–µ –∫–Ω–æ–ø–∫—É, —ñ —Å–µ—Ä—Ü–µ —Å—Ç–∞—î —á–µ—Ä–≤–æ–Ω–∏–º **–º–∏—Ç—Ç—î–≤–æ**. –î–æ–¥–∞—Ç–æ–∫ –Ω–µ —á–µ–∫–∞—î, –ø–æ–∫–∏ —Å–µ—Ä–≤–µ—Ä —Å–∫–∞–∂–µ "–û–ö". –í—ñ–Ω *–æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–æ* –ø—Ä–∏–ø—É—Å–∫–∞—î, —â–æ –≤—Å–µ –±—É–¥–µ –¥–æ–±—Ä–µ.

–Ø–∫—â–æ –∂ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–Ω–∏–∫–Ω–µ –∞–±–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω–µ –ø–æ–º–∏–ª–∫—É, —Å–µ—Ä—Ü–µ "–≤—ñ–¥—ñ–∂–º–µ—Ç—å—Å—è" –Ω–∞–∑–∞–¥ –∞–±–æ –∑'—è–≤–∏—Ç—å—Å—è –∑–Ω–∞—á–æ–∫ –ø–æ–º–∏–ª–∫–∏.

–¶–µ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è **Optimistic UI**. –Ü TanStack Query —Ä–æ–±–∏—Ç—å –π–æ–≥–æ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω–æ—é.

## –ê–ª–≥–æ—Ä–∏—Ç–º –û–ø—Ç–∏–º—ñ–∑–º—É

–©–æ–± —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ü–µ –±–µ–∑–ø–µ—á–Ω–æ, –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ 4 –∫—Ä–æ–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É:

1.  **Cancel**: –°–∫–∞—Å—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ –≤–∏—Ö—ñ–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏ (refetch), —è–∫—ñ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –Ω–∞—à–µ –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.
2.  **Snapshot**: –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –¥–∞–Ω–∏—Ö (–¥–ª—è –º–æ–∂–ª–∏–≤–æ–≥–æ –≤—ñ–¥–∫–∞—Ç—É).
3.  **Update**: –í—Ä—É—á–Ω—É –æ–Ω–æ–≤–∏—Ç–∏ –∫–µ—à –Ω–æ–≤–∏–º–∏ (—Ñ–µ–π–∫–æ–≤–∏–º–∏) –¥–∞–Ω–∏–º–∏.
4.  **Rollback / Confirm**:
    -   –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞: –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π Snapshot.
    -   –Ø–∫—â–æ —É—Å–ø—ñ—Ö: –Ü–Ω–≤–∞–ª—ñ–¥—É–≤–∞—Ç–∏ –∫–µ—à, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ "—Å–ø—Ä–∞–≤–∂–Ω—ñ" –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫).

–í—Å–µ —Ü–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ –æ–ø—Ü—ñ—è—Ö `useMutation`.

## –ü—Ä–∏–∫–ª–∞–¥: –ö–Ω–æ–ø–∫–∞ –õ–∞–π–∫–∞

–£—è–≤—ñ–º–æ, —â–æ –º–∏ –º–∞—î–º–æ –ø–æ—Å—Ç.

```typescript
interface Post {
  id: number;
  title: string;
  likes: number;
  isLiked: boolean;
}
```

–û—Å—å –ø–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –º—É—Ç–∞—Ü—ñ—ó –∑ –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–∏–º –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º.

```tsx [LikeButton.tsx]
import { useMutation, useQueryClient } from '@tanstack/react-query';

function LikeButton({ post }: { post: Post }) {
  const queryClient = useQueryClient();
  const queryKey = ['posts', post.id];

  const { mutate } = useMutation({
    // 1. –§—É–Ω–∫—Ü—ñ—è –º—É—Ç–∞—Ü—ñ—ó (Server Side)
    mutationFn: (newIsLiked: boolean) => {
      return axios.post(`/api/posts/${post.id}/like`, { isLiked: newIsLiked });
    },

    // 2. –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –î–û —Ç–æ–≥–æ, —è–∫ –∑–∞–ø–∏—Ç –ø–æ–ª–µ—Ç–∏—Ç—å (Client Side)
    onMutate: async (newIsLiked) => {
      // A. –°–∫–∞—Å–æ–≤—É—î–º–æ –≤—Å—ñ –∑–∞–ø–∏—Ç–∏ –¥–æ —Ü—å–æ–≥–æ –ø–æ—Å—Ç–∞, —â–æ–± –≤–æ–Ω–∏ –Ω–µ –ø–µ—Ä–µ–±–∏–ª–∏ –Ω–∞—à –∞–ø–¥–µ–π—Ç
      await queryClient.cancelQueries({ queryKey });

      // B. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ (Snapshot)
      const previousPost = queryClient.getQueryData<Post>(queryKey);

      // C. –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ –∫–µ—à
      queryClient.setQueryData<Post>(queryKey, (old) => {
        if (!old) return old;
        return {
          ...old,
          likes: newIsLiked ? old.likes + 1 : old.likes - 1,
          isLiked: newIsLiked,
        };
      });

      // D. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ç–µ, —â–æ –Ω–∞–º –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –≤ onError)
      return { previousPost };
    },

    // 3. –Ø–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞
    onError: (err, newIsLiked, context) => {
      // –í—ñ–¥–∫–æ—á—É—î–º–æ—Å—è –¥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
      if (context?.previousPost) {
        queryClient.setQueryData(queryKey, context.previousPost);
      }
      alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –ª–∞–π–∫ :(');
    },

    // 4. –ó–∞–≤–∂–¥–∏ (—É—Å–ø—ñ—Ö —á–∏ –ø–æ–º–∏–ª–∫–∞)
    onSettled: () => {
      // –Ü–Ω–≤–∞–ª—ñ–¥—É—î–º–æ, —â–æ–± —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏—Å—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º
      // –¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –º–∏ –º–∞—î–º–æ "—á–µ—Å–Ω—ñ" –¥–∞–Ω—ñ –≤ –∫—ñ–Ω—Ü—ñ
      queryClient.invalidateQueries({ queryKey });
    },
  });

  return (
    <button onClick={() => mutate(!post.isLiked)}>
      {post.isLiked ? '‚ù§Ô∏è' : 'ü§ç'} {post.likes}
    </button>
  );
}
```

### –†–æ–∑–±—ñ—Ä –ö–ª—é—á–æ–≤–∏—Ö –ú–æ–º–µ–Ω—Ç—ñ–≤

#### `queryClient.cancelQueries`
–¶–µ –∫—Ä–∏—Ç–∏—á–Ω–æ. –£—è–≤—ñ—Ç—å —Å—Ü–µ–Ω–∞—Ä—ñ–π:
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ –ª–∞–π–∫ (–æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–æ +1).
2. –û–¥–Ω–æ—á–∞—Å–Ω–æ —Å–ø—Ä–∞—Ü—é–≤–∞–≤ `refetchOnWindowFocus` (—Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ –ª–µ—Ç—è—Ç—å –∑ —Å–µ—Ä–≤–µ—Ä–∞).
3. –Ø–∫—â–æ –Ω–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ refetch, —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ –ø—Ä–∏–π–¥—É—Ç—å –∑ —Å–µ—Ä–≤–µ—Ä–∞ —ñ –ø–µ—Ä–µ–∑–∞–ø–∏—à—É—Ç—å –Ω–∞—à –ª–∞–π–∫ –Ω–∞ -1, –ø–æ–∫–∏ –º—É—Ç–∞—Ü—ñ—è —â–µ –π–¥–µ. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–±–∞—á–∏—Ç—å "–±–ª–∏–º–∞–Ω–Ω—è".

#### `queryClient.setQueryData`
–ú–∏ –Ω–µ —á–µ–∫–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞. –ú–∏ –ø—Ä—è–º–æ –ª—ñ–∑–µ–º–æ –≤ –º–æ–∑–æ–∫ TanStack Query —ñ –∫–∞–∂–µ–º–æ: "–í–≤–∞–∂–∞–π, —â–æ –¥–∞–Ω—ñ —Ç–µ–ø–µ—Ä —Ç–∞–∫—ñ".
–§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∞—Ü—é—î —è–∫ –≤ `useState`: `(oldData) => newData`.

::warning
`setQueryData` –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î –Ω–æ–≤–∏–π –∑–∞–ø–∏—Ç. –í–æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ –∑–º—ñ–Ω—é—î –¥–∞–Ω—ñ –≤ –ø–∞–º'—è—Ç—ñ.
::

## –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ —Å–ø–∏—Å–æ–∫

–°–∫–ª–∞–¥–Ω—ñ—à–∏–π –ø—Ä–∏–∫–ª–∞–¥: –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ Todo –≤ —Å–ø–∏—Å–æ–∫.
–¢—É—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º—É, —â–æ —É –Ω–∞—Å —â–µ –Ω–µ–º–∞—î —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ `id` –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ (–≤—ñ–Ω –∑–≥–µ–Ω–µ—Ä–∏—Ç—å—Å—è –≤ –ë–î).

–ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π ID.

```javascript
onMutate: async (newTodo) => {
  await queryClient.cancelQueries({ queryKey: ['todos'] });
  const previousTodos = queryClient.getQueryData(['todos']);

  queryClient.setQueryData(['todos'], (old) => [
    ...old,
    { ...newTodo, id: Math.random(), isOptimistic: true }, // –¢–∏–º—á–∞—Å–æ–≤–∏–π ID
  ]);

  return { previousTodos };
},
```

–ö–æ–ª–∏ –ø—Ä–∏–π–¥–µ —É—Å–ø—ñ—à–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (`onSuccess`), `invalidateQueries` –∑—Ä–æ–±–∏—Ç—å –Ω–æ–≤–∏–π –∑–∞–ø–∏—Ç, —ñ –Ω–∞—à —Ç–∏–º—á–∞—Å–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç –∑–∞–º—ñ–Ω–∏—Ç—å—Å—è –Ω–∞ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –∑ —Å–µ—Ä–≤–µ—Ä–∞ (–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º ID).

::note
–Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ —ñ–¥–µ–∞–ª—å–Ω–æ–≥–æ UX, –≤–∏ –º–æ–∂–µ—Ç–µ –≤ `onSuccess` –∑–∞–º—ñ–Ω–∏—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç –Ω–∞ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≤—Ä—É—á–Ω—É (—á–µ—Ä–µ–∑ `setQueryData`), —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∑–∞–π–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É `invalidate`. –ê–ª–µ —Ü–µ —Å–∫–ª–∞–¥–Ω—ñ—à–µ –≤ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
::

[–î–∞–ª—ñ: –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è —Ç–∞ Infinite Scroll](./07.pagination-and-load-more.md)
