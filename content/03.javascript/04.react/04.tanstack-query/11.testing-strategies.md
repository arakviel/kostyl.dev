# –°—Ç—Ä–∞—Ç–µ–≥—ñ—ó –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥—É ‚Äî —Ü–µ –±—ñ–ª—å. "Flaky tests" (—Ç–µ—Å—Ç–∏, —â–æ –ø–∞–¥–∞—é—Ç—å —á–µ—Ä–µ–∑ —Ä–∞–∑), —Ç–∞–π–º-–∞—É—Ç–∏, –ø—Ä–æ–±–ª–µ–º–∏ –∑ API...

TanStack Query —Ä–æ–±–∏—Ç—å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞–±–∞–≥–∞—Ç–æ –ø—Ä–æ—Å—Ç—ñ—à–∏–º, –∞–ª–µ –ø–æ—Ç—Ä–µ–±—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.

## –ó–æ–ª–æ—Ç–∏–π –°—Ç–∞–Ω–¥–∞—Ä—Ç: MSW (Mock Service Worker)

–ù–µ –Ω–∞–º–∞–≥–∞–π—Ç–µ—Å—è –º–æ–∫–∞—Ç–∏ —Å–∞–º `useQuery` –∞–±–æ `axios`. –¶–µ –ø–æ–≥–∞–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞, –±–æ –≤–∏ —Ç–µ—Å—Ç—É—î—Ç–µ –¥–µ—Ç–∞–ª—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
–¢–µ—Å—Ç—É–π—Ç–µ **–ø–æ–≤–µ–¥—ñ–Ω–∫—É**: "–ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É, –≤—ñ–Ω –±–∞—á–∏—Ç—å –¥–∞–Ω—ñ".

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ [MSW](https://mswjs.io/), —â–æ–± –ø–µ—Ä–µ—Ö–æ–ø–ª—é–≤–∞—Ç–∏ –º–µ—Ä–µ–∂–µ–≤—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞ —Ä—ñ–≤–Ω—ñ Node.js (—É —Ç–µ—Å—Ç–∞—Ö).

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Test Wrapper

–£ –∫–æ–∂–Ω–æ–º—É —Ç–µ—Å—Ç—ñ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω `QueryClientProvider`. –ê–ª–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ç–æ–π —Å–∞–º–∏–π –∫–ª—ñ—î–Ω—Ç, —â–æ –π –≤ `App.tsx`.

1.  **Retry**: –í–∏–º–∫–Ω—ñ—Ç—å retry. –í —Ç–µ—Å—Ç–∞—Ö –≤–∏ –Ω–µ —Ö–æ—á–µ—Ç–µ —á–µ–∫–∞—Ç–∏ 3 —Ä–∞–∑–∏ –ø–æ 5 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∏ —Ç–µ—Å—Ç –≤–ø–∞–¥–µ.
2.  **Cache**: –û—á–∏—â–∞–π—Ç–µ –∫–µ—à –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–∏–º —Ç–µ—Å—Ç–æ–º (–∞ –∫—Ä–∞—â–µ —Å—Ç–≤–æ—Ä—é–π—Ç–µ –Ω–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç).

```tsx [test-utils.tsx]
import { render } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const createTestQueryClient = () => new QueryClient({
  defaultOptions: {
    queries: {
      retry: false, // üõë –ù–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç–∏
      gcTime: Infinity,
    },
  },
});

export function renderWithClient(ui: React.ReactElement) {
  const testQueryClient = createTestQueryClient();
  const { rerender, ...result } = render(
    <QueryClientProvider client={testQueryClient}>{ui}</QueryClientProvider>
  );
  
  return {
    ...result,
    rerender: (rerenderUi: React.ReactElement) =>
      rerender(
        <QueryClientProvider client={testQueryClient}>{rerenderUi}</QueryClientProvider>
      ),
  };
}
```

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤

–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —É –Ω–∞—Å —î –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `UserList`.

```tsx [UserList.test.tsx]
import { screen } from '@testing-library/react';
import { renderWithClient } from './test-utils';
import { UserList } from './UserList';
import { server } from './mocks/server';
import { http, HttpResponse } from 'msw';

test('–ø–æ–∫–∞–∑—É—î —Å–∫–µ–ª–µ—Ç–æ–Ω –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ', () => {
  // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –º–æ–∫ —Ç–∞–∫, —â–æ–± –≤—ñ–Ω "–≤–∏—Å—ñ–≤" (delay: infinite)
  server.use(
    http.get('/api/users', async () => {
      await delay('infinite');
      return HttpResponse.json([]);
    })
  );

  renderWithClient(<UserList />);
  expect(screen.getByText(/loading/i)).toBeInTheDocument();
});

test('–ø–æ–∫–∞–∑—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è', async () => {
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —É—Å–ø—ñ—à–Ω–∏–π –º–æ–∫
  server.use(
    http.get('/api/users', () => {
      return HttpResponse.json([{ id: 1, name: 'John Doe' }]);
    })
  );

  renderWithClient(<UserList />);

  // waitFor —á–µ–∫–∞—î, –ø–æ–∫–∏ –µ–ª–µ–º–µ–Ω—Ç –∑'—è–≤–∏—Ç—å—Å—è (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
  expect(await screen.findByText('John Doe')).toBeInTheDocument();
});

test('–ø–æ–∫–∞–∑—É—î –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –≤–ø–∞–≤', async () => {
  server.use(
    http.get('/api/users', () => {
      return new HttpResponse(null, { status: 500 });
    })
  );

  renderWithClient(<UserList />);

  expect(await screen.findByText(/error/i)).toBeInTheDocument();
});
```

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ö–∞—Å—Ç–æ–º–Ω–∏—Ö –•—É–∫—ñ–≤ (`renderHook`)

–Ø–∫—â–æ —É –≤–∞—Å —î —Å–∫–ª–∞–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞ –≤ —Ö—É–∫—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –∞–±–æ side-effects), —Ç–µ—Å—Ç—É–π—Ç–µ —Ö—É–∫ —ñ–∑–æ–ª—å–æ–≤–∞–Ω–æ.

```tsx [useUser.test.tsx]
import { renderHook, waitFor } from '@testing-library/react';
import { createWrapper } from './test-utils'; // Wrapper –∑ Provider
import { useUser } from './useUser';

test('–ø–æ–≤–µ—Ä—Ç–∞—î –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', async () => {
  const { result } = renderHook(() => useUser(), {
    wrapper: createWrapper(),
  });

  // 1. –°–ø–æ—á–∞—Ç–∫—É loading
  expect(result.current.isPending).toBe(true);

  // 2. –ß–µ–∫–∞—î–º–æ —É—Å–ø—ñ—Ö—É
  await waitFor(() => expect(result.current.isSuccess).toBe(true));

  // 3. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–∞–Ω—ñ
  expect(result.current.data).toEqual({ name: 'John Doe' });
});
```

## "I wait for something but it never happens"

–¢–∏–ø–æ–≤–∞ –ø–æ–º–∏–ª–∫–∞:
Jest/Vitest –∑–∞–≤–µ—Ä—à—É—î —Ç–µ—Å—Ç, –∞–ª–µ `QueryClient` –≤—Å–µ —â–µ –º–∞—î –∞–∫—Ç–∏–≤–Ω—ñ —Ç–∞–π–º–µ—Ä–∏ –∞–±–æ –ø—Ä–æ–º—ñ—Å–∏.
–í–∏ –ø–æ–±–∞—á–∏—Ç–µ –ø–æ–º–∏–ª–∫—É: `Jest did not exit one second after the test run has completed`.

–†—ñ—à–µ–Ω–Ω—è: –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏ –æ—á–∏—â–∞—î—Ç–µ –∫–ª—ñ—î–Ω—Ç –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ `await` –¥–ª—è –≤—Å—ñ—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –¥—ñ–π.

::tip
–Ø–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ **Vitest**, –≤—ñ–Ω —á—É–¥–æ–≤–æ –ø—Ä–∞—Ü—é—î –∑ TanStack Query "–∑ –∫–æ—Ä–æ–±–∫–∏". –ñ–æ–¥–Ω–∏—Ö –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –¥–ª—è —Ç–∞–π–º–µ—Ä—ñ–≤ –∑–∞–∑–≤–∏—á–∞–π –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ.
::
