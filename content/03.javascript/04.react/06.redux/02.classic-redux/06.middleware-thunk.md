# Middleware —Ç–∞ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ—Å—Ç—å (Redux Thunk)

## –í—Å—Ç—É–ø: –í—ñ–¥ –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—ñ –¥–æ –†–µ–∞–ª—å–Ω–æ–≥–æ –°–≤—ñ—Ç—É

–£—è–≤—ñ—Ç—å, —â–æ –≤–∏ —Å—Ç–≤–æ—Ä—é—î—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î –∫–Ω–æ–ø–∫—É "–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫" ‚Äî —ñ —Ç–æ–≤–∞—Ä –º–∏—Ç—Ç—î–≤–æ –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫—É. –¶–µ **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞** –æ–ø–µ—Ä–∞—Ü—ñ—è: –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ ‚Üí –∑–º—ñ–Ω–∏–≤—Å—è —Å—Ç–∞–Ω ‚Üí –æ–Ω–æ–≤–∏–≤—Å—è UI. –ê–ª–µ —â–æ, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î "–ö—É–ø–∏—Ç–∏ –∑–∞—Ä–∞–∑"?

–¢–µ–ø–µ—Ä –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ:

1. –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (spinner)
2. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –¥–∞–Ω—ñ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
3. –ü–æ—á–µ–∫–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (—Ü–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ —Å–µ–∫—É–Ω–¥–∏!)
4. –û–±—Ä–æ–±–∏—Ç–∏ —É—Å–ø—ñ—Ö –∞–±–æ –ø–æ–º–∏–ª–∫—É
5. –û–Ω–æ–≤–∏—Ç–∏ UI –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É

–¶–µ –≤–∂–µ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞** –æ–ø–µ—Ä–∞—Ü—ñ—è. –Ü –æ—Å—å —Ç—É—Ç –∫–ª–∞—Å–∏—á–Ω–∏–π Redux –Ω–∞—Ç–∏–∫–∞—î—Ç—å—Å—è –Ω–∞ —Å—Ç—ñ–Ω—É: **actions —Ç–∞ reducers –Ω–µ –≤–º—ñ—é—Ç—å —á–µ–∫–∞—Ç–∏**.

–î–æ—Å—ñ –Ω–∞—à—ñ actions –±—É–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–º–∏ –æ–±'—î–∫—Ç–∞–º–∏: `{ type: 'ADD_TODO', payload: 'Buy milk' }`. –ê–ª–µ —è–∫ –æ–ø–∏—Å–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å, —Ä–æ–∑—Ç—è–≥–Ω—É—Ç–∏–π —É —á–∞—Å—ñ? –¢—É—Ç –Ω–∞ —Å—Ü–µ–Ω—É –≤–∏—Ö–æ–¥–∏—Ç—å **Middleware**.

::note
**–©–æ –≤–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—å —É —Ü—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ:**

- –ß–æ–º—É —Ä–µ–¥—é—Å–µ—Ä–∏ –Ω–µ –º–æ–∂—É—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
- –©–æ —Ç–∞–∫–µ middleware —ñ —è–∫ –≤–æ–Ω–æ –ø—Ä–∞—Ü—é—î "–ø—ñ–¥ –∫–∞–ø–æ—Ç–æ–º"
- –Ø–∫ Redux Thunk –¥–æ–∑–≤–æ–ª—è—î –¥–∏—Å–ø–∞—Ç—á–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó –∑–∞–º—ñ—Å—Ç—å –æ–±'—î–∫—Ç—ñ–≤
- –ü—Ä–æ—Å—É–Ω—É—Ç—ñ –ø–∞—Ç–µ—Ä–Ω–∏ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫, –≤—ñ–¥–º—ñ–Ω–∏ –∑–∞–ø–∏—Ç—ñ–≤ —Ç–∞ retry logic
- –Ø–∫ –Ω–∞–ª–∞–≥–æ–¥–∂—É–≤–∞—Ç–∏ —Ç–∞ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –∫–æ–¥
  ::

### Prerequisites (–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏)

–ü–µ—Ä–µ–¥ –≤–∏–≤—á–µ–Ω–Ω—è–º —Ü—å–æ–≥–æ —Ä–æ–∑–¥—ñ–ª—É –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ä–æ–∑—É–º—ñ—î—Ç–µ:

- [Basics Redux: Actions, Reducers, Store](./01.basics.md)
- [Pure Functions](./02.pure-functions.md) ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ!
- JavaScript Promises —Ç–∞ async/await
- –ö–æ–Ω—Ü–µ–ø—Ü—ñ—é –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ (side effects)

### –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –µ–≤–æ–ª—é—Ü—ñ—è

–ù–∞ –∑–æ—Ä—ñ Redux (2015 —Ä—ñ–∫) —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∏ —à–≤–∏–¥–∫–æ –∑—ñ—Ç–∫–Ω—É–ª–∏—Å—è –∑ –ø—Ä–æ–±–ª–µ–º–æ—é: **—è–∫ —Ä–æ–±–∏—Ç–∏ AJAX-–∑–∞–ø–∏—Ç–∏?** –ü–µ—Ä—à—ñ —Å–ø—Ä–æ–±–∏ –≤–∏–≥–ª—è–¥–∞–ª–∏ —Ç–∞–∫:

```javascript
// ‚ùå –ê–ù–¢–ò–ü–ê–¢–ï–†–ù: Fetch —É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ, –ø–æ—Ç—ñ–º dispatch
function TodoList() {
    const dispatch = useDispatch()

    useEffect(() => {
        fetch('/api/todos')
            .then((res) => res.json())
            .then((data) => dispatch({ type: 'TODOS_LOADED', payload: data }))
    }, [])
}
```

**–ü—Ä–æ–±–ª–µ–º–∏ —Ü—å–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É:**

- –õ–æ–≥—ñ–∫–∞ —Ä–æ–∑–º–∞–∑–∞–Ω–∞ –º—ñ–∂ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- –ù–µ–º–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤ Redux DevTools
- –í–∞–∂–∫–æ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏
- –ü–æ—Ä—É—à—É—î –ø—Ä–∏–Ω—Ü–∏–ø —î–¥–∏–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ

–¢–æ–¥—ñ –∑'—è–≤–∏–ª–∞—Å—è —ñ–¥–µ—è: **–∞ —â–æ, —è–∫—â–æ –≤–∏–Ω–µ—Å—Ç–∏ —Ü—é –ª–æ–≥—ñ–∫—É –≤ —Å–∞–º–µ Redux?** –¢–∞–∫ –Ω–∞—Ä–æ–¥–∏–ª–∞—Å—è –∫–æ–Ω—Ü–µ–ø—Ü—ñ—è middleware.

## –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ñ –ö–æ–Ω—Ü–µ–ø—Ü—ñ—ó

### –ß–æ–º—É –†–µ–¥—é—Å–µ—Ä–∏ –ú–∞—é—Ç—å –ë—É—Ç–∏ –ß–∏—Å—Ç–∏–º–∏ –§—É–Ω–∫—Ü—ñ—è–º–∏?

–ó–≥–∞–¥–∞—î–º–æ **–∑–æ–ª–æ—Ç–µ –ø—Ä–∞–≤–∏–ª–æ Redux**:

::warning
**–†–µ–¥—é—Å–µ—Ä–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ —á–∏—Å—Ç–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏**

- **–í—Ö—ñ–¥:** –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω + action
- **–í–∏—Ö—ñ–¥:** –ù–æ–≤–∏–π —Å—Ç–∞–Ω (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ –Ω–æ–≤–∏–π –æ–±'—î–∫—Ç!)
- **–ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ:** –ú—É—Ç–∞—Ü—ñ—ó, –∑–∞–ø–∏—Ç–∏, –≤–∏–ø–∞–¥–∫–æ–≤—ñ —á–∏—Å–ª–∞, `Date.now()`, —Ç–æ—â–æ
  ::

–ß–æ–º—É —Ü–µ —Ç–∞–∫ –≤–∞–∂–ª–∏–≤–æ?

```javascript
// ‚ùå –ü–û–ì–ê–ù–û: –†–µ–¥—é—Å–µ—Ä –∑ –ø–æ–±—ñ—á–Ω–∏–º –µ—Ñ–µ–∫—Ç–æ–º
function userReducer(state, action) {
  if (action.type === 'FETCH_USER') {
    // –¶–µ –ù–ï –ü–†–ê–¶–Æ–í–ê–¢–ò–ú–ï!
    fetch('/api/user')
      .then(res => res.json())
      .then(data => ??? ); // –Ø–∫ —Ç—É—Ç –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω?

    return state; // –ü–æ–≤–µ—Ä–Ω—É–ª–∏ —Å—Ç–∞—Ä–∏–π —Å—Ç–∞–Ω, –∞–ª–µ fetch —â–µ –ª–µ—Ç–∏—Ç—å!
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∏:**

1. **–†–µ–¥—é—Å–µ—Ä –º–∞—î –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —Å—Ç–∞–Ω –º–∏—Ç—Ç—î–≤–æ**, –∞–ª–µ `fetch` ‚Äî —Ü–µ Promise, —è–∫–∞ —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ
2. **–†–µ–¥—é—Å–µ—Ä –Ω–µ –º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ `dispatch`**, —Ç–æ–º—É –Ω–µ –º–æ–∂–µ —Å–∞–º –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω–æ–≤–∏–π action –∑ –¥–∞–Ω–∏–º–∏
3. **Time-travel debugging** (–ø–µ—Ä–µ–º–æ—Ç–∫–∞ —á–∞—Å—É –≤ DevTools) –ª–∞–º–∞—î—Ç—å—Å—è, –±–æ –ø–æ–±—ñ—á–Ω—ñ –µ—Ñ–µ–∫—Ç–∏ –≤–∏–∫–æ–Ω–∞—é—Ç—å—Å—è –∑–Ω–æ–≤—É

### –©–æ –¢–∞–∫–µ Side Effects (–ü–æ–±—ñ—á–Ω—ñ –ï—Ñ–µ–∫—Ç–∏)?

**Side Effect** ‚Äî —Ü–µ –±—É–¥—å-—è–∫–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è, —è–∫–∞ –≤–∏—Ö–æ–¥–∏—Ç—å –∑–∞ –º–µ–∂—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ –≤–∑–∞—î–º–æ–¥—ñ—î —ñ–∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ–º —Å–≤—ñ—Ç–æ–º.

::code-group

```javascript [‚úÖ –ß–∏—Å—Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—è (Pure)]
function add(a, b) {
    return a + b // –ó–∞–≤–∂–¥–∏ –æ–¥–Ω–∞–∫–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –æ–¥–Ω–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤
}
```

```javascript [‚ùå –ü–æ–±—ñ—á–Ω—ñ –µ—Ñ–µ–∫—Ç–∏ (Impure)]
let counter = 0

function addAndLog(a, b) {
    counter++ // –ú—É—Ç–∞—Ü—ñ—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó –∑–º—ñ–Ω–Ω–æ—ó
    console.log('Adding...') // –õ–æ–≥—É–≤–∞–Ω–Ω—è (I/O)
    fetch('/api/log', { body: a + b }) // –ú–µ—Ä–µ–∂–µ–≤–∏–π –∑–∞–ø–∏—Ç
    return a + b + Math.random() // –í–∏–ø–∞–¥–∫–æ–≤—ñ—Å—Ç—å
}
```

::

**–ü—Ä–∏–∫–ª–∞–¥–∏ –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ —É –≤–µ–±-–¥–æ–¥–∞—Ç–∫–∞—Ö:**

- HTTP-–∑–∞–ø–∏—Ç–∏ (fetch, axios)
- –ó–∞–ø–∏—Å —É localStorage
- –ó–º—ñ–Ω–∞ DOM –Ω–∞–ø—Ä—è–º—É
- –¢–∞–π–º–µ—Ä–∏ (setTimeout, setInterval)
- WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è
- –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤ –∫–æ–Ω—Å–æ–ª—å

### Middleware: –û—Ñ—ñ—Ü—ñ–π–Ω–µ –ú—ñ—Å—Ü–µ –¥–ª—è Side Effects

Redux –≤–∏—Ä—ñ—à—É—î —Ü—é –ø—Ä–æ–±–ª–µ–º—É –µ–ª–µ–≥–∞–Ω—Ç–Ω–æ: **–≤–∏–Ω–µ—Å—Ç–∏ –ø–æ–±—ñ—á–Ω—ñ –µ—Ñ–µ–∫—Ç–∏ –∑–∞ –º–µ–∂—ñ —Ä–µ–¥—é—Å–µ—Ä—ñ–≤**, –∞–ª–µ –∑–∞–ª–∏—à–∏—Ç–∏ —ó—Ö —É—Å–µ—Ä–µ–¥–∏–Ω—ñ –µ–∫–æ—Å–∏—Å—Ç–µ–º–∏ Redux.

::mermaid

```mermaid
graph LR
    A[UI Component] -->|dispatch action| B[Middleware Layer]
    B -->|modified action| C[Reducer]
    C -->|new state| D[Store]
    D -->|re-render| A

    B -.->|side effects| E[API Server]
    B -.->|logging| F[Console]
    B -.->|analytics| G[Analytics]

    style B fill:#ffd700,stroke:#333,stroke-width:3px
```

::

**Middleware** ‚Äî —Ü–µ –ø—Ä–æ—à–∞—Ä–æ–∫ –º—ñ–∂ `dispatch(action)` —Ç–∞ –º–æ–º–µ–Ω—Ç–æ–º, –∫–æ–ª–∏ action –¥–æ—Å—è–≥–∞—î —Ä–µ–¥—é—Å–µ—Ä–∞. –¢—É—Ç –º–æ–∂–Ω–∞:

- –õ–æ–≥—É–≤–∞—Ç–∏ actions (Redux Logger)
- –û–±—Ä–æ–±–ª—è—Ç–∏ crashes (Error Reporter)
- –†–æ–±–∏—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –∑–∞–ø–∏—Ç–∏ (Redux Thunk)
- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ actions –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é –¥–æ —Ä–µ–¥—é—Å–µ—Ä–∞

### –ê–Ω–∞–ª–æ–≥—ñ—è: Middleware —è–∫ –û—Ö–æ—Ä–æ–Ω–µ—Ü—å

–£—è–≤—ñ—Ç—å Redux Store —è–∫ –æ—Ö–æ—Ä–æ–Ω—è—î–º—É –±—É–¥—ñ–≤–ª—é:

- **UI** ‚Äî –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á, —è–∫–∏–π —Ö–æ—á–µ –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—É
- **Action** ‚Äî –ø—Ä–æ–ø—É—Å–∫ –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á–∞
- **Middleware** ‚Äî –æ—Ö–æ—Ä–æ–Ω–µ—Ü—å –Ω–∞ –≤—Ö–æ–¥—ñ
- **Reducer** ‚Äî –∫–∞–±—ñ–Ω–µ—Ç, –∫—É–¥–∏ –ø—É—Å–∫–∞—é—Ç—å —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- **State** ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–∞–±—ñ–Ω–µ—Ç—É

–û—Ö–æ—Ä–æ–Ω–µ—Ü—å (middleware) –º–æ–∂–µ:

- –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ –∂—É—Ä–Ω–∞–ª, —Ö—Ç–æ –ø—Ä–∏–π—à–æ–≤ (logging)
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–æ–ø—É—Å–∫ –Ω–∞ –¥—ñ–π—Å–Ω—ñ—Å—Ç—å
- –í–∏–∫–ª–∏–∫–∞—Ç–∏ –Ω–∞—á–∞–ª—å—Å—Ç–≤–æ, —è–∫—â–æ —â–æ—Å—å –ø—ñ–¥–æ–∑—Ä—ñ–ª–µ (crash reporting)
- –ü–æ–ø—Ä–æ—Å–∏—Ç–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á–∞ –∑–∞—á–µ–∫–∞—Ç–∏, –ø–æ–∫–∏ –ø—Ä–∏–Ω–µ—Å—É—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (async calls)
- –ù–∞–≤—ñ—Ç—å **–≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–≥–æ—Å—å —ñ–Ω—à–æ–≥–æ –∑–∞–º—ñ—Å—Ç—å –Ω—å–æ–≥–æ** (—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è actions)

## –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Ç–∞ –ú–µ—Ö–∞–Ω—ñ–∫–∞ Middleware

### –ü–æ—Ç—ñ–∫ –î–∞–Ω–∏—Ö –∑ Middleware

–†–æ–∑–±–µ—Ä–µ–º–æ –¥–µ—Ç–∞–ª—å–Ω–æ, —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—Ä–∏ `dispatch(action)` —É Redux –∑—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–º middleware:

::mermaid

```mermaid
sequenceDiagram
    participant UI as React Component
    participant Dispatch as store.dispatch()
    participant MW1 as Logger Middleware
    participant MW2 as Thunk Middleware
    participant Reducer as Reducer
    participant Store as Redux Store

    UI->>Dispatch: dispatch(fetchTodos())
    Dispatch->>MW1: action (function)
    MW1->>MW1: console.log("Dispatching:", action)
    MW1->>MW2: next(action)
    MW2->>MW2: typeof action === 'function' ‚úì
    MW2->>MW2: action(dispatch, getState)
    Note over MW2: Thunk —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —Ç—É—Ç!
    MW2->>Dispatch: dispatch({ type: 'FETCH_START' })
    Dispatch->>MW1: { type: 'FETCH_START' }
    MW1->>Reducer: next({ type: 'FETCH_START' })
    Reducer->>Store: –Ω–æ–≤–∏–π —Å—Ç–∞–Ω { loading: true }
    Store->>UI: re-render
```

::

**–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏:**

1. Middleware –≤–∏–∫–ª–∏–∫–∞—é—Ç—å—Å—è **–ø–æ —á–µ—Ä–∑—ñ** (–≤ –ø–æ—Ä—è–¥–∫—É, —è–∫ —ó—Ö –ø–µ—Ä–µ–¥–∞–ª–∏ –≤ `applyMiddleware`)
2. –ö–æ–∂–µ–Ω middleware –º–æ–∂–µ **–∑—É–ø–∏–Ω–∏—Ç–∏ –ª–∞–Ω—Ü—é–∂–æ–∫**, –Ω–µ –≤–∏–∫–ª–∏–∫–∞—é—á–∏ `next(action)`
3. –ö–æ–∂–µ–Ω middleware –º–æ–∂–µ **–≤–∏–∫–ª–∏–∫–∞—Ç–∏ `dispatch` –ø–æ–≤—Ç–æ—Ä–Ω–æ**, —Å—Ç–≤–æ—Ä—é—é—á–∏ –Ω–æ–≤—ñ actions

### Under the Hood: –Ø–∫ –ü—Ä–∞—Ü—é—î applyMiddleware

`applyMiddleware` ‚Äî —Ü–µ **store enhancer** (–ø–æ–∫—Ä–∞—â—É–≤–∞—á —Å—Ç–æ—Ä—É). –í—ñ–Ω –æ–±–≥–æ—Ä—Ç–∞—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π `dispatch` —É –ª–∞–Ω—Ü—é–∂–æ–∫ —Ñ—É–Ω–∫—Ü—ñ–π.

–°–ø—Ä–æ—â–µ–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è:

```javascript
// –¢–∞–∫ –≤–∏–≥–ª—è–¥–∞—î applyMiddleware –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ (—Å–ø—Ä–æ—â–µ–Ω–æ)
function applyMiddleware(...middlewares) {
    return (createStore) => (reducer, preloadedState) => {
        const store = createStore(reducer, preloadedState)
        let dispatch = store.dispatch

        // –î–∞—î–º–æ –∫–æ–∂–Ω–æ–º—É middleware –¥–æ—Å—Ç—É–ø –¥–æ getState —Ç–∞ dispatch
        const middlewareAPI = {
            getState: store.getState,
            dispatch: (action) => dispatch(action), // –í–∞–∂–ª–∏–≤–æ: closure!
        }

        // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–∂–µ–Ω middleware –∑ —Ñ–æ—Ä–º–∞—Ç—É:
        // storeAPI => next => action => result
        // –£ —Ñ–æ—Ä–º–∞—Ç: next => action => result
        const chain = middlewares.map((middleware) => middleware(middlewareAPI))

        // –°–∫–ª–∞–¥–∞—î–º–æ —ó—Ö —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª—ñ–≤–æ: MW1(MW2(MW3(originalDispatch)))
        dispatch = compose(...chain)(store.dispatch)

        return { ...store, dispatch }
    }
}
```

**–©–æ —Ç—É—Ç –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è:**

1. **–°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π store** –∑—ñ –∑–≤–∏—á–∞–π–Ω–∏–º `dispatch`
2. **–ö–æ–∂–µ–Ω middleware –æ—Ç—Ä–∏–º—É—î API** –∑ `getState` —Ç–∞ `dispatch`
3. **Middleware —Å–∫–ª–∞–¥–∞—é—Ç—å—Å—è –≤ –ª–∞–Ω—Ü—é–∂–æ–∫** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `compose`
4. **`dispatch` –∑–∞–º—ñ–Ω—é—î—Ç—å—Å—è** –Ω–∞ –æ–±–≥–æ—Ä–Ω—É—Ç—É –≤–µ—Ä—Å—ñ—é

### Currying Pattern: –¢—Ä–∏ –†—ñ–≤–Ω—ñ –§—É–Ω–∫—Ü—ñ–π

–°–∏–≥–Ω–∞—Ç—É—Ä–∞ middleware –≤–∏–≥–ª—è–¥–∞—î —Å—Ç—Ä–∞—à–Ω–æ –¥–ª—è –Ω–æ–≤–∞—á–∫—ñ–≤:

```javascript
const middleware = (storeAPI) => (next) => (action) => {
    // ...
}
```

**–ß–æ–º—É –¢–†–ò —Ä—ñ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ–π?** –†–æ–∑–±–µ—Ä–µ–º–æ –ø–æ–∫—Ä–æ–∫–æ–≤–æ:

::steps

### –†—ñ–≤–µ–Ω—å 1: storeAPI => ...

**–ú–µ—Ç–∞:** –û—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ `getState` —Ç–∞ `dispatch`

```javascript
const loggerMiddleware = (storeAPI) => {
    // –¢—É—Ç —î –¥–æ—Å—Ç—É–ø –¥–æ storeAPI.getState() —Ç–∞ storeAPI.dispatch()
    // –¶–µ–π —Ä—ñ–≤–µ–Ω—å –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –û–î–ò–ù –†–ê–ó –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó store

    return (next) => {
        // ...
    }
}
```

### –†—ñ–≤–µ–Ω—å 2: next => ...

**–ú–µ—Ç–∞:** –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π middleware (–∞–±–æ —Ä–µ–¥—é—Å–µ—Ä)

```javascript
const loggerMiddleware = (storeAPI) => (next) => {
    // next ‚Äî —Ü–µ –∞–±–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π middleware, –∞–±–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π dispatch
    // –¶–µ–π —Ä—ñ–≤–µ–Ω—å –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—Ä–∏ setup middleware chain

    return (action) => {
        // ...
    }
}
```

### –†—ñ–≤–µ–Ω—å 3: action => ...

**–ú–µ—Ç–∞:** –û–±—Ä–æ–±–∏—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π action

```javascript
const loggerMiddleware = (storeAPI) => (next) => (action) => {
    // –¶–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ö–û–ñ–ù–û–ì–û –†–ê–ó–£ –ø—Ä–∏ dispatch(action)
    console.log('Dispatching:', action)
    const result = next(action) // –ü–µ—Ä–µ–¥–∞—î–º–æ –¥–∞–ª—ñ
    console.log('Next state:', storeAPI.getState())
    return result
}
```

::

**–ü–æ–≤–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∞:**

```javascript
// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è currying –¥–ª—è –≥–Ω—É—á–∫–æ—Å—Ç—ñ
const createLoggerMiddleware = (options) => (storeAPI) => (next) => (action) => {
    if (options.enabled) {
        console.log('[Logger]', action.type)
    }
    return next(action)
}

// –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏ middleware
const logger = createLoggerMiddleware({ enabled: true })
const store = createStore(reducer, applyMiddleware(logger))
```

### –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è Redux Thunk –ü—ñ–¥ –ö–∞–ø–æ—Ç–æ–º

Redux Thunk ‚Äî —Ü–µ –≤—Å—å–æ–≥–æ **10 —Ä—è–¥–∫—ñ–≤ –∫–æ–¥—É**! –û—Å—å –ø–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è:

```javascript
// –û—Ñ—ñ—Ü—ñ–π–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è redux-thunk (—Å–ø—Ä–æ—â–µ–Ω–æ)
function createThunkMiddleware(extraArgument) {
    return ({ dispatch, getState }) =>
        (next) =>
        (action) => {
            // –Ø–∫—â–æ action ‚Äî —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è, –≤–∏–∫–ª–∏–∫–∞—î–º–æ —ó—ó
            if (typeof action === 'function') {
                return action(dispatch, getState, extraArgument)
            }

            // –Ü–Ω–∞–∫—à–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—î–º–æ –¥–∞–ª—ñ
            return next(action)
        }
}

const thunk = createThunkMiddleware()
export default thunk
```

**–†–æ–∑–±—ñ—Ä –ø–æ —Ä—è–¥–∫–∞—Ö:**

1. **`typeof action === 'function'`**: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ action ‚Äî —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è (—Ç–æ–±—Ç–æ thunk)
2. **`action(dispatch, getState, extraArgument)`**: –Ø–∫—â–æ —Ç–∞–∫ ‚Äî –≤–∏–∫–ª–∏–∫–∞—î–º–æ —ó—ó, –ø–µ—Ä–µ–¥–∞—é—á–∏:
    - `dispatch` ‚Äî —â–æ–± thunk –º—ñ–≥ –¥–∏—Å–ø–∞—Ç—á–∏—Ç–∏ —ñ–Ω—à—ñ actions
    - `getState` ‚Äî —â–æ–± thunk –º—ñ–≥ —á–∏—Ç–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω
    - `extraArgument` ‚Äî –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, API client)
3. **`return next(action)`**: –Ø–∫—â–æ —Ü–µ –∑–≤–∏—á–∞–π–Ω–∏–π –æ–±'—î–∫—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –¥–∞–ª—ñ

**–û—Å—å —ñ –≤—Å—è –º–∞–≥—ñ—è!** Thunk middleware –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞—î —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ –≤–∏–∫–æ–Ω—É—î —ó—Ö, –¥–∞—é—á–∏ —ó–º –¥–æ—Å—Ç—É–ø –¥–æ `dispatch`.

## Redux Thunk: –§—É–Ω–∫—Ü—ñ—ó –ó–∞–º—ñ—Å—Ç—å –û–±'—î–∫—Ç—ñ–≤

### –©–æ –¢–∞–∫–µ Thunk?

**Thunk** (–≤—ñ–¥ –∞–Ω–≥–ª. "–¥—É–º–∫–∞ –ø—Ä–æ —â–æ—Å—å") ‚Äî —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –ø–æ–≤–µ—Ä—Ç–∞—î —ñ–Ω—à—É —Ñ—É–Ω–∫—Ü—ñ—é.

```javascript
// –ó–≤–∏—á–∞–π–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è
function getValue() {
    return 42
}

// Thunk —Ñ—É–Ω–∫—Ü—ñ—è
function getValueLater() {
    return function () {
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é!
        return 42
    }
}

const thunk = getValueLater() // –û—Ç—Ä–∏–º–∞–ª–∏ —Ñ—É–Ω–∫—Ü—ñ—é
const value = thunk() // –¢–µ–ø–µ—Ä –≤–∏–∫–ª–∏–∫–∞–ª–∏ —ñ –æ—Ç—Ä–∏–º–∞–ª–∏ 42
```

**–ù–∞–≤—ñ—â–æ —Ü–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ?** –í—ñ–¥–∫–ª–∞–¥–∞–Ω–Ω—è –æ–±—á–∏—Å–ª–µ–Ω—å! –§—É–Ω–∫—Ü—ñ—è, –∑–∞–≥–æ—Ä–Ω—É—Ç–∞ –≤ —ñ–Ω—à—É —Ñ—É–Ω–∫—Ü—ñ—é, –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏—Å—è –ø—ñ–∑–Ω—ñ—à–µ.

### Action Creator vs Thunk Action Creator

::code-group

```javascript [–ó–≤–∏—á–∞–π–Ω–∏–π Action Creator]
// –ü–æ–≤–µ—Ä—Ç–∞—î –ø—Ä–æ—Å—Ç–∏–π –æ–±'—î–∫—Ç
function addTodo(text) {
    return {
        type: 'ADD_TODO',
        payload: text,
    }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
dispatch(addTodo('Buy milk'))
// –í—ñ–¥—Ä–∞–∑—É –ø–æ—Ç—Ä–∞–ø–∏—Ç—å –¥–æ —Ä–µ–¥—é—Å–µ—Ä–∞
```

```javascript [Thunk Action Creator]
// –ü–æ–≤–µ—Ä—Ç–∞—î –§–£–ù–ö–¶–Ü–Æ!
function fetchTodos() {
    return async (dispatch, getState) => {
        // –¢—É—Ç –º–æ–∂–µ –±—É—Ç–∏ –±—É–¥—å-—è–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –ª–æ–≥—ñ–∫–∞
        const response = await fetch('/api/todos')
        const data = await response.json()
        dispatch({ type: 'TODOS_LOADED', payload: data })
    }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è (–¢–û–ß–ù–û –¢–ê–ö –°–ê–ú–û!)
dispatch(fetchTodos())
// Thunk middleware –ø–µ—Ä–µ—Ö–æ–ø–∏—Ç—å —Ç–∞ –≤–∏–∫–æ–Ω–∞—î —Ñ—É–Ω–∫—Ü—ñ—é
```

::

**–ö–ª—é—á–æ–≤–∞ —Ä—ñ–∑–Ω–∏—Ü—è:**

- **Action creator** –ø–æ–≤–µ—Ä—Ç–∞—î `{ type, payload }` ‚Üí –≤—ñ–¥—Ä–∞–∑—É –¥–æ reducer
- **Thunk action creator** –ø–æ–≤–µ—Ä—Ç–∞—î `(dispatch, getState) => { ... }` ‚Üí –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è middleware

## –ü—Ä–∞–∫—Ç–∏—á–Ω–∞ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

### –ö—Ä–æ–∫ 1: –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

::steps

### –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å redux-thunk

```bash
npm install redux-thunk
```

–ê–±–æ –∑ yarn:

```bash
yarn add redux-thunk
```

### –Ü–º–ø–æ—Ä—Ç—É–π—Ç–µ —Ç–∞ –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å –¥–æ store

```javascript
import { createStore, applyMiddleware } from 'redux'
import thunk from 'redux-thunk'
import rootReducer from './reducers'

const store = createStore(
    rootReducer,
    applyMiddleware(thunk), // –î–æ–¥–∞—î–º–æ middleware
)

export default store
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è —Ä—è–¥–∫—ñ–≤:**

- **`applyMiddleware(thunk)`**: –°—Ç–≤–æ—Ä—é—î store enhancer, —â–æ –æ–±–≥–æ—Ä—Ç–∞—î dispatch
- –¢–µ–ø–µ—Ä `dispatch` –º–æ–∂–µ –ø—Ä–∏–π–º–∞—Ç–∏ —è–∫ –æ–±'—î–∫—Ç–∏, —Ç–∞–∫ —ñ —Ñ—É–Ω–∫—Ü—ñ—ó!

::

### –ö—Ä–æ–∫ 2: –ù–∞–ø–∏—Å–∞–Ω–Ω—è Thunk Actions

#### –ë–∞–∑–æ–≤–∏–π –ø—Ä–∏–∫–ª–∞–¥

```javascript
// actions/todoActions.js

// 1. –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø—Ä–æ—Å—Ç—ñ action creators
const fetchTodosStart = () => ({ type: 'FETCH_TODOS_START' })
const fetchTodosSuccess = (todos) => ({
    type: 'FETCH_TODOS_SUCCESS',
    payload: todos,
})
const fetchTodosError = (error) => ({
    type: 'FETCH_TODOS_ERROR',
    payload: error,
})

// 2. –í–∏–∑–Ω–∞—á–∞—î–º–æ thunk action creator
export const fetchTodos = () => {
    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é (thunk)!
    return async (dispatch, getState) => {
        // dispatch ‚Äî —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ actions
        // getState ‚Äî —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É

        // –ö—Ä–æ–∫ 1: –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ, —â–æ –ø–æ—á–∞–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        dispatch(fetchTodosStart())

        try {
            // –ö—Ä–æ–∫ 2: –†–æ–±–∏–º–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –∑–∞–ø–∏—Ç
            const response = await fetch('https://jsonplaceholder.typicode.com/todos')

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`)
            }

            const data = await response.json()

            // –ö—Ä–æ–∫ 3: –£—Å–ø—ñ—Ö! –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ
            dispatch(fetchTodosSuccess(data))
        } catch (error) {
            // –ö—Ä–æ–∫ 4: –ü–æ–º–∏–ª–∫–∞! –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ error
            dispatch(fetchTodosError(error.message))
        }
    }
}
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è –∫–ª—é—á–æ–≤–∏—Ö –º–æ–º–µ–Ω—Ç—ñ–≤:**

1. **–¢—Ä–∏ –æ–∫—Ä–µ–º—ñ action creators** (`Start`, `Success`, `Error`) ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ø–∞—Ç–µ—Ä–Ω –¥–ª—è async –æ–ø–µ—Ä–∞—Ü—ñ–π
2. **`async (dispatch, getState) => { ... }`** ‚Äî —Ü–µ thunk —Ñ—É–Ω–∫—Ü—ñ—è. Redux Thunk –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–¥–∞—Å—Ç—å —ó–π —Ü—ñ –∞—Ä–≥—É–º–µ–Ω—Ç–∏
3. **`dispatch(fetchTodosStart())`** ‚Äî –º–∏ –º–æ–∂–µ–º–æ –¥–∏—Å–ø–∞—Ç—á–∏—Ç–∏ —ñ–Ω—à—ñ actions –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ thunk
4. **`await fetch(...)`** ‚Äî –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ async/await, –±–æ —Ü–µ –∑–≤–∏—á–∞–π–Ω–∞ JS —Ñ—É–Ω–∫—Ü—ñ—è!

#### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è getState –¥–ª—è —É–º–æ–≤–Ω–æ—ó –ª–æ–≥—ñ–∫–∏

```javascript
// –ü—Ä–∏–∫–ª–∞–¥: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ todos —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —ó—Ö —â–µ –Ω–µ–º–∞—î
export const fetchTodosIfNeeded = () => {
    return (dispatch, getState) => {
        const state = getState()

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ
        if (state.todos.items.length > 0) {
            console.log('Todos –≤–∂–µ —î, –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ')
            return Promise.resolve() // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ resolved Promise
        }

        // –Ø–∫—â–æ –Ω–µ–º–∞—î ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ
        return dispatch(fetchTodos())
    }
}
```

::tip
**Best Practice:** Thunk –º–æ–∂–µ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ Promise! –¶–µ –¥–æ–∑–≤–æ–ª—è—î —á–µ–∫–∞—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ:

```javascript
dispatch(fetchTodos()).then(() => {
    console.log('Todos –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ!')
})
```

::

### –ö—Ä–æ–∫ 3: –û–±—Ä–æ–±–∫–∞ –≤ Reducer

```javascript
// reducers/todosReducer.js

const initialState = {
    items: [],
    loading: false,
    error: null,
}

function todosReducer(state = initialState, action) {
    switch (action.type) {
        case 'FETCH_TODOS_START':
            return {
                ...state,
                loading: true,
                error: null, // –°–∫–∏–¥–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –ø–æ–º–∏–ª–∫—É
            }

        case 'FETCH_TODOS_SUCCESS':
            return {
                ...state,
                loading: false,
                items: action.payload,
                error: null,
            }

        case 'FETCH_TODOS_ERROR':
            return {
                ...state,
                loading: false,
                error: action.payload,
            }

        default:
            return state
    }
}

export default todosReducer
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è Loading States State Machine:**

::mermaid

```mermaid
stateDiagram-v2
    [*] --> Idle: –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω
    Idle --> Loading: FETCH_TODOS_START
    Loading --> Success: FETCH_TODOS_SUCCESS
    Loading --> Error: FETCH_TODOS_ERROR
    Success --> Loading: FETCH_TODOS_START (refresh)
    Error --> Loading: FETCH_TODOS_START (retry)
    Success --> Idle: CLEAR_TODOS
    Error --> Idle: CLEAR_TODOS
```

::

### –ö—Ä–æ–∫ 4: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ

```jsx
// components/TodoList.jsx

import { useEffect } from 'react'
import { useDispatch, useSelector } from 'react-redux'
import { fetchTodos } from '../actions/todoActions'

function TodoList() {
    const dispatch = useDispatch()

    // –ü—ñ–¥–ø–∏—Å—É—î–º–æ—Å—è –Ω–∞ —Å—Ç–∞–Ω
    const { items, loading, error } = useSelector((state) => state.todos)

    useEffect(() => {
        // –î–∏—Å–ø–∞—Ç—á–∏–º–æ thunk —Ç–∞–∫ —Å–∞–º–æ, —è–∫ –∑–≤–∏—á–∞–π–Ω–∏–π action!
        dispatch(fetchTodos())
    }, [dispatch])

    if (loading) {
        return <div className="spinner">Loading...</div>
    }

    if (error) {
        return <div className="error">Error: {error}</div>
    }

    return (
        <ul>
            {items.map((todo) => (
                <li key={todo.id}>{todo.title}</li>
            ))}
        </ul>
    )
}

export default TodoList
```

**–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É:** –ö–æ–º–ø–æ–Ω–µ–Ω—Ç **–Ω–µ –∑–Ω–∞—î**, —â–æ `fetchTodos()` ‚Äî —Ü–µ thunk! –î–ª—è –Ω—å–æ–≥–æ —Ü–µ –ø—Ä–æ—Å—Ç–æ action.

## –û–±—Ä–æ–±–∫–∞ –ü–æ–º–∏–ª–æ–∫ —Ç–∞ Error Handling

### –ê–Ω—Ç–∏–ø–∞—Ç–µ—Ä–Ω: .then().catch()

::warning
**–¢–∏–ø–æ–≤–∞ –ø–æ–º–∏–ª–∫–∞:** –õ–∞–Ω—Ü—é–∂–æ–∫ `.then().catch()` –º–æ–∂–µ —Å–ø—ñ–π–º–∞—Ç–∏ –ø–æ–º–∏–ª–∫–∏ –Ω–µ –∑ –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É!

```javascript
// ‚ùå –ü–û–ì–ê–ù–û
export const fetchTodos = () => {
    return (dispatch) => {
        dispatch(fetchStart())

        fetch('/api/todos')
            .then((res) => res.json())
            .then((data) => {
                dispatch(fetchSuccess(data)) // –ê —è–∫—â–æ —Ç—É—Ç –≤–∏–ª–µ—Ç–∏—Ç—å –ø–æ–º–∏–ª–∫–∞?
                processData(data) // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —Ç—É—Ç!
            })
            .catch((error) => {
                // –°—é–¥–∏ –ø–æ—Ç—Ä–∞–ø–ª—è—Ç—å –ø–æ–º–∏–ª–∫–∏ –Ü –∑ fetch, –Ü –∑ processData!
                dispatch(fetchError(error.message))
            })
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `.catch()` —Å–ø—ñ–π–º–∞—î –ø–æ–º–∏–ª–∫–∏ –∑ `processData`, —Ö–æ—á–∞ —Ü–µ –Ω–µ –ø–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ!
::

### –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥: –î—Ä—É–≥–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç .then()

```javascript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
export const fetchTodos = () => {
    return (dispatch) => {
        dispatch(fetchStart())

        fetch('/api/todos')
            .then(
                // Success handler
                (response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`)
                    }
                    return response.json()
                },
                // Error handler (—Ç—ñ–ª—å–∫–∏ –º–µ—Ä–µ–∂–µ–≤—ñ –ø–æ–º–∏–ª–∫–∏!)
                (networkError) => {
                    dispatch(fetchError(networkError.message))
                },
            )
            .then((data) => {
                if (data) {
                    // data –±—É–¥–µ undefined —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏
                    dispatch(fetchSuccess(data))
                    processData(data) // –ü–æ–º–∏–ª–∫–∞ —Ç—É—Ç –ù–ï —Å–ø—ñ–π–º–∞—î—Ç—å—Å—è —è–∫ fetch error
                }
            })
    }
}
```

### Try-Catch –∑ async/await (–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

```javascript
// ‚úÖ –ù–ê–ô–ö–†–ê–©–ï: –Ø–≤–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
export const fetchTodos = () => {
    return async (dispatch) => {
        dispatch(fetchStart())

        try {
            const response = await fetch('/api/todos')

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ HTTP —Å—Ç–∞—Ç—É—Å
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`)
            }

            const data = await response.json()

            // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –ø–µ—Ä–µ–¥ dispatch
            if (!Array.isArray(data)) {
                throw new Error('Invalid data format')
            }

            dispatch(fetchSuccess(data))

            // –ü–æ–±—ñ—á–Ω—ñ –µ—Ñ–µ–∫—Ç–∏ –ü–Ü–°–õ–Ø —É—Å–ø—ñ—à–Ω–æ–≥–æ dispatch
            processData(data)
        } catch (error) {
            // –¢—É—Ç —Å–ø—ñ–π–º–∞—î–º–æ:
            // 1. –ú–µ—Ä–µ–∂–µ–≤—ñ –ø–æ–º–∏–ª–∫–∏ (no internet, timeout)
            // 2. HTTP –ø–æ–º–∏–ª–∫–∏ (404, 500)
            // 3. JSON parsing –ø–æ–º–∏–ª–∫–∏
            // 4. –ü–æ–º–∏–ª–∫–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
            dispatch(fetchError(error.message))

            // –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ Sentry
            console.error('Fetch todos failed:', error)
        }
    }
}
```

## –ü—Ä–æ—Å—É–Ω—É—Ç—ñ –ü–∞—Ç–µ—Ä–Ω–∏

### 1. –£–º–æ–≤–Ω–µ –î–∏—Å–ø–∞—Ç—á—É–≤–∞–Ω–Ω—è (Conditional Dispatching)

–ù–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ, —è–∫—â–æ –≤–æ–Ω–∏ –≤–∂–µ —î:

```javascript
export const fetchUserIfNeeded = (userId) => {
    return (dispatch, getState) => {
        const { users } = getState()

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ cache
        const existingUser = users.byId[userId]
        if (existingUser && !existingUser.isStale) {
            console.log('User –≤–∂–µ —î –≤ –∫–µ—à—ñ')
            return Promise.resolve(existingUser)
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        return dispatch(fetchUser(userId))
    }
}
```

### 2. –õ–∞–Ω—Ü—é–∂–∫–∏ Thunks (Chaining)

–í–∏–∫–æ–Ω–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –∑–∞–ø–∏—Ç—ñ–≤ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ:

```javascript
export const fetchUserWithPosts = (userId) => {
    return async (dispatch) => {
        // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        await dispatch(fetchUser(userId))

        // 2. –ü–æ—Ç—ñ–º –π–æ–≥–æ –ø–æ—Å—Ç–∏
        await dispatch(fetchUserPosts(userId))

        // 3. –Ü –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –¥–æ –ø–æ—Å—Ç—ñ–≤
        await dispatch(fetchPostComments(userId))
    }
}
```

–ü–∞—Ä–∞–ª–µ–ª—å–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:

```javascript
export const fetchDashboardData = () => {
    return async (dispatch) => {
        dispatch({ type: 'DASHBOARD_LOAD_START' })

        try {
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å–µ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ
            await Promise.all([dispatch(fetchUser()), dispatch(fetchPosts()), dispatch(fetchNotifications())])

            dispatch({ type: 'DASHBOARD_LOAD_SUCCESS' })
        } catch (error) {
            dispatch({ type: 'DASHBOARD_LOAD_ERROR', payload: error.message })
        }
    }
}
```

### 3. –í—ñ–¥–º—ñ–Ω–∞ –ó–∞–ø–∏—Ç—ñ–≤ (Cancellation)

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è AbortController:

```javascript
// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ AbortController —É –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –∑–º—ñ–Ω–Ω—ñ–π
let abortController = null

export const fetchTodos = () => {
    return async (dispatch) => {
        // –°–∫–∞—Å–æ–≤—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∑–∞–ø–∏—Ç, —è–∫—â–æ –≤—ñ–Ω —â–µ –π–¥–µ
        if (abortController) {
            abortController.abort()
        }

        // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π controller
        abortController = new AbortController()
        const { signal } = abortController

        dispatch(fetchStart())

        try {
            const response = await fetch('/api/todos', { signal })
            const data = await response.json()
            dispatch(fetchSuccess(data))
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Fetch cancelled')
                // –ù–µ –¥–∏—Å–ø–∞—Ç—á–∏–º–æ –ø–æ–º–∏–ª–∫—É –¥–ª—è cancelled –∑–∞–ø–∏—Ç—ñ–≤
            } else {
                dispatch(fetchError(error.message))
            }
        }
    }
}
```

### 4. Retry Logic (–ü–æ–≤—Ç–æ—Ä–Ω—ñ –°–ø—Ä–æ–±–∏)

```javascript
function delay(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms))
}

export const fetchTodosWithRetry = (maxRetries = 3) => {
    return async (dispatch) => {
        dispatch(fetchStart())

        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch('/api/todos')
                const data = await response.json()
                dispatch(fetchSuccess(data))
                return // –£—Å–ø—ñ—Ö! –í–∏—Ö–æ–¥–∏–º–æ
            } catch (error) {
                if (attempt === maxRetries) {
                    // –û—Å—Ç–∞–Ω—è —Å–ø—Ä–æ–±–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å
                    dispatch(fetchError(`Failed after ${maxRetries} attempts`))
                } else {
                    // –ß–µ–∫–∞—î–º–æ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–ø—Ä–æ–±–æ—é (exponential backoff)
                    console.log(`Attempt ${attempt} failed, retrying...`)
                    await delay(1000 * Math.pow(2, attempt)) // 2s, 4s, 8s...
                }
            }
        }
    }
}
```

### 5. Optimistic Updates

–û–Ω–æ–≤–ª—é—î–º–æ UI _–¥–æ_ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞:

```javascript
export const toggleTodo = (todoId) => {
    return async (dispatch, getState) => {
        const todo = getState().todos.byId[todoId]

        // 1. –ú–∏—Ç—Ç—î–≤–æ –æ–Ω–æ–≤–ª—é—î–º–æ UI (optimistic)
        dispatch({
            type: 'TODO_TOGGLED_OPTIMISTIC',
            payload: { id: todoId, completed: !todo.completed },
        })

        try {
            // 2. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const response = await fetch(`/api/todos/${todoId}`, {
                method: 'PATCH',
                body: JSON.stringify({ completed: !todo.completed }),
            })

            const updatedTodo = await response.json()

            // 3. –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏–º–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞
            dispatch({
                type: 'TODO_TOGGLED_SUCCESS',
                payload: updatedTodo,
            })
        } catch (error) {
            // 4. –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ ‚Äî –≤—ñ–¥–∫–æ—á—É—î–º–æ –∑–º—ñ–Ω–∏ (rollback)
            dispatch({
                type: 'TODO_TOGGLED_ROLLBACK',
                payload: { id: todoId, completed: todo.completed },
            })

            dispatch(showError('Failed to update todo'))
        }
    }
}
```

### 6. extraArgument: Dependency Injection

–ü–µ—Ä–µ–¥–∞—Ç–∏ API client —É thunks:

```javascript
// store.js
import thunk from 'redux-thunk'
import api from './api' // –í–∞—à API client

const store = createStore(rootReducer, applyMiddleware(thunk.withExtraArgument(api)))
```

```javascript
// actions/todoActions.js
export const fetchTodos = () => {
    // –¢—Ä–µ—Ç—ñ–π –∞—Ä–≥—É–º–µ–Ω—Ç ‚Äî —Ü–µ extraArgument!
    return async (dispatch, getState, api) => {
        dispatch(fetchStart())

        try {
            const data = await api.todos.getAll() // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ api
            dispatch(fetchSuccess(data))
        } catch (error) {
            dispatch(fetchError(error.message))
        }
    }
}
```

::tip
**–ü–µ—Ä–µ–≤–∞–≥–∏ extraArgument:**

- –õ–µ–≥—à–µ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ (–º–æ–∂–Ω–∞ –ø–µ—Ä–µ–¥–∞—Ç–∏ mock api)
- –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è API (headers, –±–∞–∑–æ–≤–∏–π URL)
- –ú–æ–∂–Ω–∞ –ø–µ—Ä–µ–¥–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ —Å–µ—Ä–≤—ñ—Å—ñ–≤: `thunk.withExtraArgument({ api, analytics, logger })`
  ::

## –¢–∏–ø–æ–ª–æ–≥—ñ—è Middleware

### –ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ç–∏–ø–∏ middleware

::code-group

```javascript [Logger Middleware]
const logger = (store) => (next) => (action) => {
    console.group(action.type)
    console.log('Dispatching:', action)
    const result = next(action)
    console.log('Next state:', store.getState())
    console.groupEnd()
    return result
}
```

```javascript [Crash Reporter]
const crashReporter = (store) => (next) => (action) => {
    try {
        return next(action)
    } catch (err) {
        console.error('Caught an exception!', err)

        // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ Sentry
        Sentry.captureException(err, {
            extra: {
                action,
                state: store.getState(),
            },
        })

        throw err // Re-throw, —â–æ–± –Ω–µ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏
    }
}
```

```javascript [Analytics Middleware]
const analytics = (store) => (next) => (action) => {
    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–¥—ñ—ó –≤ Google Analytics
    if (action.type.startsWith('USER_')) {
        window.gtag('event', action.type, {
            ...action.payload,
        })
    }

    return next(action)
}
```

::

### –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è Async Middleware

| Feature                   | Redux Thunk          | Redux Saga                    | Redux Observable                      |
| ------------------------- | -------------------- | ----------------------------- | ------------------------------------- |
| **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è**   | ‚≠ê –ù–∏–∑—å–∫–∞            | ‚≠ê‚≠ê‚≠ê –í–∏—Å–æ–∫–∞                 | ‚≠ê‚≠ê‚≠ê‚≠ê –î—É–∂–µ –≤–∏—Å–æ–∫–∞                  |
| **–†–æ–∑–º—ñ—Ä –±–∞–Ω–¥–ª—É**         | ~500 bytes           | ~10 KB                        | ~50 KB (+ RxJS)                       |
| **Cancellation**          | ‚ùå –í—Ä—É—á–Ω—É            | ‚úÖ –í–±—É–¥–æ–≤–∞–Ω–∞                  | ‚úÖ –í–±—É–¥–æ–≤–∞–Ω–∞                          |
| **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è**            | –õ–µ–≥–∫–æ (pure —Ñ—É–Ω–∫—Ü—ñ—ó) | –°–∫–ª–∞–¥–Ω—ñ—à–µ (–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∏)        | –°–∫–ª–∞–¥–Ω—ñ—à–µ (observables)               |
| **Best for**              | 90% –≤–∏–ø–∞–¥–∫—ñ–≤         | –°–∫–ª–∞–¥–Ω—ñ async flows           | Reactive patterns, WebSockets         |
| **Debouncing/Throttling** | ‚ùå –í—Ä—É—á–Ω—É            | ‚úÖ `debounce()`, `throttle()` | ‚úÖ `debounceTime()`, `throttleTime()` |

::note
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:** –ü–æ—á–∏–Ω–∞–π—Ç–µ –∑ Redux Thunk. –ü–µ—Ä–µ—Ö–æ–¥—å—Ç–µ –Ω–∞ Saga/Observable —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –¥—ñ–π—Å–Ω–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —ó—Ö –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ.
::

## Debugging —Ç–∞ Troubleshooting

### –¢–∏–ø–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏

::accordion

#### "Actions must be plain objects. Use custom middleware for async actions."

**–ü—Ä–∏—á–∏–Ω–∞:** –í–∏ –∑–∞–±—É–ª–∏ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ redux-thunk middleware!

```javascript
// ‚ùå –ü–û–ì–ê–ù–û: –ù–µ–º–∞—î middleware
const store = createStore(rootReducer)

// ‚úÖ –î–û–ë–†–ï
const store = createStore(rootReducer, applyMiddleware(thunk))
```

#### "Cannot read property 'dispatch' of undefined"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ thunk. –ó–∞–±—É–ª–∏ `return`:

```javascript
// ‚ùå –ü–û–ì–ê–ù–û
export const fetchTodos = () => {
    ;async (dispatch) => {
        // –ó–∞–±—É–ª–∏ return!
        // ...
    }
}

// ‚úÖ –î–û–ë–†–ï
export const fetchTodos = () => {
    return async (dispatch) => {
        // ...
    }
}
```

#### "A non-serializable value was detected in an action"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–∞–º–∞–≥–∞—î—Ç–µ—Å—å –ø–µ—Ä–µ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é, Promise –∞–±–æ –∫–ª–∞—Å –≤ action payload:

```javascript
// ‚ùå –ü–û–ì–ê–ù–û
dispatch({
    type: 'SET_CALLBACK',
    payload: () => console.log('hi'), // –§—É–Ω–∫—Ü—ñ—ó –Ω–µ serializable!
})

// ‚úÖ –î–û–ë–†–ï: –ó–±–µ—Ä—ñ–≥–∞–π—Ç–µ —Ç—ñ–ª—å–∫–∏ –¥–∞–Ω—ñ
dispatch({
    type: 'SET_CONFIG',
    payload: { callbackName: 'onSuccess' },
})
```

::

### Redux DevTools Integration

```javascript
import { createStore, applyMiddleware, compose } from 'redux'
import thunk from 'redux-thunk'

const composeEnhancers = (typeof window !== 'undefined' && window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__) || compose

const store = createStore(rootReducer, composeEnhancers(applyMiddleware(thunk)))
```

**–©–æ –¥–∞—î DevTools:**

- –ü–µ—Ä–µ–≥–ª—è–¥ –≤—Å—ñ—Ö dispatched actions (–≤–∫–ª—é—á–Ω–æ –∑ thunk —Ñ—É–Ω–∫—Ü—ñ—è–º–∏)
- Time-travel debugging
- Diff –º—ñ–∂ —Å—Ç–∞–Ω–∞–º–∏
- Export/Import —Å—Ç–∞–Ω—É

### Debugging Techniques

1. **console.log –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ thunk:**

```javascript
export const fetchTodos = () => {
    return async (dispatch, getState) => {
        console.log('üöÄ Starting fetch, current state:', getState())

        dispatch(fetchStart())
        console.log('üì° Fetch started, loading:', getState().todos.loading)

        const data = await fetch('/api/todos').then((r) => r.json())
        console.log('‚úÖ Data received:', data)

        dispatch(fetchSuccess(data))
        console.log('üíæ Data saved to store:', getState().todos.items)
    }
}
```

2. **Breakpoints —É DevTools:**
    - –ü–æ—Å—Ç–∞–≤—Ç–µ breakpoint –Ω–∞ `dispatch(fetchStart())`
    - –Ü–Ω—Å–ø–µ–∫—Ç—É–π—Ç–µ `getState()` —É –∫–æ–Ω—Å–æ–ª—ñ

3. **Redux Logger Middleware:**

```bash
npm install redux-logger
```

```javascript
import logger from 'redux-logger'

const store = createStore(
    rootReducer,
    applyMiddleware(thunk, logger), // logger –æ—Å—Ç–∞–Ω–Ω—ñ–º!
)
```

## –ü—ñ–¥—Å—É–º–æ–∫: –ö–ª–∞—Å–∏—á–Ω–∏–π Redux

### –í—ñ–∑—É–∞–ª—å–Ω–µ —Ä–µ–∑—é–º–µ –ø–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫—É

::mermaid

```mermaid
graph TD
    A[User clicks button] --> B[Component calls dispatch fetchTodos]
    B --> C{Thunk Middleware}
    C -->|typeof action === 'function'| D[Execute thunk function]
    D --> E[dispatch FETCH_START]
    E --> F[Reducer: loading = true]
    F --> G[Store updated]
    G --> H[Component re-renders with spinner]

    D --> I[await fetch/api/todos]
    I -->|Success| J[dispatch FETCH_SUCCESS]
    I -->|Error| K[dispatch FETCH_ERROR]

    J --> L[Reducer: items = data, loading = false]
    K --> M[Reducer: error = message, loading = false]

    L --> N[Store updated]
    M --> N
    N --> O[Component re-renders with data/error]

    style C fill:#ffd700,stroke:#333,stroke-width:2px
    style D fill:#90EE90,stroke:#333,stroke-width:2px
```

::

### Best Practices

::tip

#### Golden Rules –¥–ª—è Redux Thunk

1. **–ó–∞–≤–∂–¥–∏ –¥–∏—Å–ø–∞—Ç—á—ñ—Ç—å 3 actions** –¥–ª—è async –æ–ø–µ—Ä–∞—Ü—ñ–π: START, SUCCESS, ERROR
2. **–ü–æ–≤–µ—Ä—Ç–∞–π—Ç–µ Promise** –∑ thunk, —â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ —á–µ–∫–∞—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
3. **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ async/await** –∑–∞–º—ñ—Å—Ç—å `.then()` –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ
4. **–í–∞–ª—ñ–¥—É–π—Ç–µ –¥–∞–Ω—ñ** –ø–µ—Ä–µ–¥ dispatch —É store
5. **–û–±—Ä–æ–±–ª—è–π—Ç–µ –ø–æ–º–∏–ª–∫–∏** —É try-catch, –Ω–µ –ø–æ–∫–ª–∞–¥–∞–π—Ç–µ—Å—è –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
6. **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ getState()** –¥–ª—è —É–º–æ–≤–Ω–æ—ó –ª–æ–≥—ñ–∫–∏ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ cache)
7. **–ù–µ –º—É—Ç—É–π—Ç–µ —Å—Ç–∞–Ω** –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ thunk ‚Äî —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ dispatch
   ::

### –©–æ –º–∏ –¥—ñ–∑–Ω–∞–ª–∏—Å—è

- ‚úÖ –ß–æ–º—É —Ä–µ–¥—é—Å–µ—Ä–∏ –º–∞—é—Ç—å –±—É—Ç–∏ —á–∏—Å—Ç–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏
- ‚úÖ –©–æ —Ç–∞–∫–µ middleware —ñ —è–∫ –≤–æ–Ω–æ –ø—Ä–∞—Ü—é—î –ø—ñ–¥ –∫–∞–ø–æ—Ç–æ–º
- ‚úÖ –Ø–∫ Redux Thunk –¥–æ–∑–≤–æ–ª—è—î –¥–∏—Å–ø–∞—Ç—á–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó
- ‚úÖ –ü–∞—Ç–µ—Ä–Ω –∑ 3 actions –¥–ª—è async –æ–ø–µ—Ä–∞—Ü—ñ–π (START/SUCCESS/ERROR)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∑ async/await
- ‚úÖ –ü—Ä–æ—Å—É–Ω—É—Ç—ñ –ø–∞—Ç–µ—Ä–Ω–∏: retry, cancellation, optimistic updates
- ‚úÖ Dependency injection –∑ extraArgument
- ‚úÖ Debugging –∑ Redux DevTools

### –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ –∫–æ–¥—É (Boilerplate)

–©–æ–± –∑—Ä–æ–±–∏—Ç–∏ **–æ–¥–Ω—É** –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É –æ–ø–µ—Ä–∞—Ü—ñ—é, –Ω–∞–º –¥–æ–≤–µ–ª–æ—Å—è:

1. ‚úçÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ 3 –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ action types (`FETCH_START`, `FETCH_SUCCESS`, `FETCH_ERROR`)
2. ‚úçÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ 3 action creators
3. ‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç–∏ thunk —Ñ—É–Ω–∫—Ü—ñ—é
4. ‚úçÔ∏è –û–±—Ä–æ–±–∏—Ç–∏ 3 cases —É `switch` —Ä–µ–¥—é—Å–µ—Ä–∞
5. ‚úçÔ∏è –í—Ä—É—á–Ω—É –∫–µ—Ä—É–≤–∞—Ç–∏ `loading` —Ç–∞ `error` states

**–î–ª—è 10 API endpoints = ~500 —Ä—è–¥–∫—ñ–≤ –∫–æ–¥—É! üò±**

–°–∞–º–µ —Ü–µ –¥—Ä–∞—Ç—É–≤–∞–ª–æ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤ —Ä–æ–∫–∞–º–∏. Redux –±—É–≤ **–ø–æ—Ç—É–∂–Ω–∏–º, –∞–ª–µ –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ—Å–ª—ñ–≤–Ω–∏–º**.

::warning
**–Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:**  
–£ 2019 —Ä–æ—Ü—ñ –∫–æ–º–∞–Ω–¥–∞ Redux –ø—Ä–æ–≤–µ–ª–∞ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è —ñ –≤–∏—è–≤–∏–ª–∞, —â–æ **#1 —Å–∫–∞—Ä–≥–∞** ‚Äî —Ü–µ boilerplate. –¢–æ–¥—ñ –≤–æ–Ω–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏ **Redux Toolkit**, —è–∫–∏–π —Å–∫–æ—Ä–æ—á—É—î —Ü–µ–π –∫–æ–¥ **–≤ 4-5 —Ä–∞–∑—ñ–≤**.
::

–£ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –º–∏ –ø–æ–±–∞—á–∏–º–æ, —è–∫ Redux Toolkit –≤–∏—Ä—ñ—à—É—î —Ü—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –¥–æ–ø–æ–º–æ–≥–æ—é `createAsyncThunk` —Ç–∞ `createSlice`.

---

üëâ **[–î–∞–ª—ñ: –ß–æ–º—É –º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ Redux Toolkit?](../03.transition-to-rtk/01.problems-with-classic.md)**

üí° **[–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –∑ Thunk](./07.practice-exercises.md)**
