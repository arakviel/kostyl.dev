# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ—Å—Ç—å (createAsyncThunk)

–£ –∫–ª–∞—Å–∏—á–Ω–æ–º—É Redux –Ω–∞–º –¥–æ–≤–æ–¥–∏–ª–æ—Å—è –≤—Ä—É—á–Ω—É —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ 3 —Ç–∏–ø–∏ –µ–∫—à–µ–Ω—ñ–≤ (`REQUEST`, `SUCCESS`, `FAILURE`) —ñ –ø–∏—Å–∞—Ç–∏ –≥—Ä–æ–º—ñ–∑–¥–∫—ñ thunk-—Ñ—É–Ω–∫—Ü—ñ—ó.
Redux Toolkit –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É—î —Ü–µ–π –ø—Ä–æ—Ü–µ—Å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `createAsyncThunk`.

## –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Thunk

–î–∞–≤–∞–π—Ç–µ —Å—Ç–≤–æ—Ä–∏–º–æ –æ–ø–µ—Ä–∞—Ü—ñ—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

```javascript [features/users/usersSlice.js]
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';

// 1. –°—Ç–≤–æ—Ä—é—î–º–æ thunk
// –ü–µ—Ä—à–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç: –ø—Ä–µ—Ñ—ñ–∫—Å –¥–ª—è —Ç–∏–ø—É –µ–∫—à–µ–Ω—É ('users/fetchById')
// –î—Ä—É–≥–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è (payload creator)
export const fetchUserById = createAsyncThunk(
  'users/fetchById',
  async (userId, thunkAPI) => {
    const response = await fetch(`https://reqres.in/api/users/${userId}`);
    
    // –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 404), –∫–∏–¥–∞—î–º–æ Error
    if (!response.ok) {
        throw new Error('Server error!');
    }
    
    const data = await response.json();
    return data; // –¶–µ –∑–Ω–∞—á–µ–Ω–Ω—è —Å—Ç–∞–Ω–µ action.payload —É –≤–∏–ø–∞–¥–∫—É —É—Å–ø—ñ—Ö—É
  }
);
```

### –©–æ —Ä–æ–±–∏—Ç—å `createAsyncThunk`?

–í–æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î –¥–ª—è –Ω–∞—Å —Ç—Ä–∏ —Ç–∏–ø–∏ –µ–∫—à–µ–Ω—ñ–≤:
1.  `users/fetchById/pending` ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó.
2.  `users/fetchById/fulfilled` ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è, —è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —É—Å–ø—ñ—à–Ω–æ. `action.payload` –±—É–¥–µ —Ç–∏–º, —â–æ –≤–∏ –ø–æ–≤–µ—Ä–Ω—É–ª–∏ (`return data`).
3.  `users/fetchById/rejected` ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è, —è–∫—â–æ –≤–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ (throw Error).

## –û–±—Ä–æ–±–∫–∞ –≤ Reducer (extraReducers)

–û—Å–∫—ñ–ª—å–∫–∏ —Ü—ñ –µ–∫—à–µ–Ω–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ *–∑–∞ –º–µ–∂–∞–º–∏* –Ω–∞—à–æ–≥–æ —Å–ª–∞–π—Å—É (—á–µ—Ä–µ–∑ `createAsyncThunk`, –∞ –Ω–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `reducers`), –º–∏ –º–∞—î–º–æ –æ–±—Ä–æ–±–ª—è—Ç–∏ —ó—Ö —É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–º—É –ø–æ–ª—ñ `extraReducers`.

```javascript
const usersSlice = createSlice({
  name: 'users',
  initialState: {
    entities: [],
    loading: 'idle', // 'idle' | 'pending' | 'succeeded' | 'failed'
    error: null,
  },
  reducers: {
    // –¢—É—Ç –∑–≤–∏—á–∞–π–Ω—ñ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ —Ä–µ–¥—é—Å–µ—Ä–∏
  },
  extraReducers: (builder) => {
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ builder pattern (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
    
    builder
      // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—á–∞–ª–æ—Å—è
      .addCase(fetchUserById.pending, (state) => {
        state.loading = 'pending';
        state.error = null;
      })
      // 2. –£—Å–ø—ñ—Ö
      .addCase(fetchUserById.fulfilled, (state, action) => {
        state.loading = 'succeeded';
        // –î–æ–¥–∞—î–º–æ –æ—Ç—Ä–∏–º–∞–Ω–æ–≥–æ —é–∑–µ—Ä–∞ –≤ –º–∞—Å–∏–≤
        state.entities.push(action.payload.data); 
      })
      // 3. –ü–æ–º–∏–ª–∫–∞
      .addCase(fetchUserById.rejected, (state, action) => {
        state.loading = 'failed';
        state.error = action.error.message;
      });
  },
});

export default usersSlice.reducer;
```

## –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ

```jsx
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { fetchUserById } from './usersSlice';

export function UserProfile({ userId }) {
  const dispatch = useDispatch();
  
  // –í–∏—Ç—è–≥—É—î–º–æ –¥–∞–Ω—ñ –∑—ñ —Å—Ç–∞–Ω—É
  const { entities, loading, error } = useSelector((state) => state.users);

  useEffect(() => {
    // –ü—Ä–æ—Å—Ç–æ –¥—ñ—Å–ø–∞—Ç—á–∏–º–æ –Ω–∞—à thunk
    dispatch(fetchUserById(userId));
  }, [dispatch, userId]);

  if (loading === 'pending') return <div>Loading...</div>;
  if (loading === 'failed') return <div>Error: {error}</div>;

  const user = entities.find(u => u.id === userId);

  return (
    <div>
      <h1>{user?.first_name} {user?.last_name}</h1>
      <img src={user?.avatar} alt="Avatar" />
    </div>
  );
}
```

## –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ (Custom Reject)

–Ü–Ω–æ–¥—ñ –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—É –ø–æ–º–∏–ª–∫—É –∑ –±–µ–∫–µ–Ω–¥—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, validation errors), –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ `message` –∑ –æ–±'—î–∫—Ç–∞ Error.
–î–ª—è —Ü—å–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ `rejectWithValue`.

```javascript
export const loginUser = createAsyncThunk(
  'users/login',
  async ({ username, password }, { rejectWithValue }) => {
    try {
      const response = await api.login(username, password);
      return response.data;
    } catch (err) {
      // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ payload –¥–ª—è rejected action
      return rejectWithValue(err.response.data);
    }
  }
);

// –£ —Å–ª–∞–π—Å—ñ:
.addCase(loginUser.rejected, (state, action) => {
  // –¢–µ–ø–µ—Ä —Ç—É—Ç –¥–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω–∏–π payload
  state.error = action.payload; 
})
```

---

–¶–µ –ø–æ–∫—Ä–∏–≤–∞—î 90% –ø–æ—Ç—Ä–µ–± —É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—ñ. –ê–ª–µ —â–æ —Ä–æ–±–∏—Ç–∏, —è–∫—â–æ –¥–∞–Ω–∏—Ö –¥—É–∂–µ –±–∞–≥–∞—Ç–æ? –Ø–∫—â–æ –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ —ó—Ö –Ω–æ—Ä–º–∞–ª—ñ–∑—É–≤–∞—Ç–∏, —à—É–∫–∞—Ç–∏ –ø–æ ID, –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —á–∞—Å—Ç–∫–æ–≤–æ? –î–ª—è —Ü—å–æ–≥–æ –≤ RTK —î **Entity Adapter**.

üëâ [–î–∞–ª—ñ: –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –∑ createEntityAdapter](./04.entity-adapter.md)
