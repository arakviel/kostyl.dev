# –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –∑ createEntityAdapter

–ö–æ–ª–∏ —É –≤–∞—à–æ–º—É –¥–æ–¥–∞—Ç–∫—É —î –∫–æ–ª–µ–∫—Ü—ñ—ó –æ–¥–Ω–æ—Ç–∏–ø–Ω–∏—Ö –æ–±'—î–∫—Ç—ñ–≤ (users, posts, todos), —ó—Ö –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —É –≤–∏–≥–ª—è–¥—ñ –º–∞—Å–∏–≤—É —Å—Ç–≤–æ—Ä—é—î –ø—Ä–æ–±–ª–µ–º–∏ –∑ performance. `createEntityAdapter` –≤–∏—Ä—ñ—à—É—î —Ü–µ —á–µ—Ä–µ–∑ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—é.

## –ü—Ä–æ–±–ª–µ–º–∞: –ú–∞—Å–∏–≤–∏ –Ω–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ

```javascript
// ‚ùå –ú–∞—Å–∏–≤: –ø–æ—à—É–∫ O(n)
const state = {
    users: [
        { id: 1, name: 'Alice' },
        { id: 2, name: 'Bob' },
        { id: 3, name: 'Charlie' },
        // ... 1000+ users
    ],
}

// –ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
const user = state.users.find((u) => u.id === 2) // O(n) - –ø–æ–≤—ñ–ª—å–Ω–æ!

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è
const updated = state.users.map((u) => (u.id === 2 ? { ...u, name: 'Robert' } : u)) // O(n) - –ø–µ—Ä–µ–±–∏—Ä–∞—î –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏!
```

**–ü—Ä–æ–±–ª–µ–º–∏:**

- –ü–æ—à—É–∫ –∑–∞ ID: O(n) —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
- –û–Ω–æ–≤–ª–µ–Ω–Ω—è: –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç (O(n))
- –í–∏–¥–∞–ª–µ–Ω–Ω—è: –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ —ñ–Ω–¥–µ–∫—Å (O(n))
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è: O(n)

---

## –†—ñ—à–µ–Ω–Ω—è: –ù–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```javascript
// ‚úÖ –ù–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ: –ø–æ—à—É–∫ O(1)
const state = {
    users: {
        ids: [1, 2, 3], // –ü–æ—Ä—è–¥–æ–∫ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
        entities: {
            // Lookup table
            1: { id: 1, name: 'Alice' },
            2: { id: 2, name: 'Bob' },
            3: { id: 3, name: 'Charlie' },
        },
    },
}

// –ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ - O(1)
const user = state.users.entities[2] // –ú–∏—Ç—Ç—î–≤–æ!

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è - O(1)
state.users.entities[2] = { ...state.users.entities[2], name: 'Robert' }
```

::tip
**Performance boost**: –î–ª—è 1000 –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ O(n) —Ç–∞ O(1) ‚Äî —Ü–µ 1000x —à–≤–∏–¥—à–µ!
::

---

## –ö–æ–Ω—Ü–µ–ø—Ü—ñ—è –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó

::mermaid

```mermaid
graph TB
    A[–ú–∞—Å–∏–≤ –¥–∞–Ω–∏—Ö] --> B{–ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è}
    B --> C[ids array]
    B --> D[entities object]

    C --> E["[1, 2, 3, 4]"]
    D --> F["{<br/>  1: {...},<br/>  2: {...},<br/>  3: {...}<br/>}"]

    E --> G[–ó–±–µ—Ä—ñ–≥–∞—î –ø–æ—Ä—è–¥–æ–∫]
    F --> H[–®–≤–∏–¥–∫–∏–π lookup]

    style A fill:#ef4444,stroke:#dc2626,color:#ffffff
    style C fill:#10b981,stroke:#059669,color:#ffffff
    style D fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style G fill:#10b981,stroke:#059669,color:#ffffff
    style H fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
```

::

**–ü–µ—Ä–µ–≤–∞–≥–∏:**

- ‚úÖ –®–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø –∑–∞ ID (O(1))
- ‚úÖ –ü—Ä–æ—Å—Ç—ñ—à–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç
- ‚úÖ –õ–µ–≥–∫–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è
- ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ø–æ—Ä—è–¥–æ–∫ —á–µ—Ä–µ–∑ `ids`

---

## createEntityAdapter API

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–¥–∞–ø—Ç–µ—Ä–∞

```javascript
import { createEntityAdapter } from '@reduxjs/toolkit'

// –ë–∞–∑–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
const usersAdapter = createEntityAdapter()

// –ó –∫–∞—Å—Ç–æ–º–Ω–∏–º ID
const usersAdapter = createEntityAdapter({
    selectId: (user) => user.userId, // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —à—É–∫–∞—î 'id'
})

// –ó —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è–º
const usersAdapter = createEntityAdapter({
    sortComparer: (a, b) => a.name.localeCompare(b.name),
})
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ state

```javascript
// –ü–æ—á–∞—Ç–∫–æ–≤–∏–π state
const initialState = usersAdapter.getInitialState({
  loading: 'idle',
  error: null,
  // ids —Ç–∞ entities –¥–æ–¥–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
});

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  ids: [],
  entities: {},
  loading: 'idle',
  error: null,
}
```

---

## CRUD –º–µ—Ç–æ–¥–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞

`createEntityAdapter` –Ω–∞–¥–∞—î –º–µ—Ç–æ–¥–∏ –¥–ª—è –≤—Å—ñ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π:

| –ú–µ—Ç–æ–¥        | –û–ø–∏—Å                     | –ü—Ä–∏–∫–ª–∞–¥                                   |
| ------------ | ------------------------ | ----------------------------------------- |
| `addOne`     | –î–æ–¥–∞—Ç–∏ –æ–¥–∏–Ω –µ–ª–µ–º–µ–Ω—Ç      | `adapter.addOne(state, user)`             |
| `addMany`    | –î–æ–¥–∞—Ç–∏ –º–∞—Å–∏–≤ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤   | `adapter.addMany(state, users)`           |
| `setOne`     | –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏ –æ–¥–∏–Ω  | `adapter.setOne(state, user)`             |
| `setMany`    | –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏ –º–∞—Å–∏–≤ | `adapter.setMany(state, users)`           |
| `setAll`     | –ó–∞–º—ñ–Ω–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ        | `adapter.setAll(state, users)`            |
| `updateOne`  | –û–Ω–æ–≤–∏—Ç–∏ –æ–¥–∏–Ω (partial)   | `adapter.updateOne(state, {id, changes})` |
| `updateMany` | –û–Ω–æ–≤–∏—Ç–∏ –±–∞–≥–∞—Ç–æ           | `adapter.updateMany(state, updates)`      |
| `upsertOne`  | –î–æ–¥–∞—Ç–∏ –∞–±–æ –æ–Ω–æ–≤–∏—Ç–∏       | `adapter.upsertOne(state, user)`          |
| `upsertMany` | –î–æ–¥–∞—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏ –±–∞–≥–∞—Ç–æ    | `adapter.upsertMany(state, users)`        |
| `removeOne`  | –í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞ ID           | `adapter.removeOne(state, userId)`        |
| `removeMany` | –í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Å–∏–≤ ID        | `adapter.removeMany(state, [1, 2, 3])`    |
| `removeAll`  | –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å–µ             | `adapter.removeAll(state)`                |

---

## Patterns –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### 1. –ë–∞–∑–æ–≤–∏–π –ø—Ä–∏–∫–ª–∞–¥

```javascript [features/users/usersSlice.js]
import { createSlice, createEntityAdapter } from '@reduxjs/toolkit'

const usersAdapter = createEntityAdapter()

const usersSlice = createSlice({
    name: 'users',
    initialState: usersAdapter.getInitialState(),
    reducers: {
        userAdded: usersAdapter.addOne,
        usersReceived: usersAdapter.setAll,
        userUpdated: usersAdapter.updateOne,
        userRemoved: usersAdapter.removeOne,
    },
})

export const { userAdded, usersReceived, userUpdated, userRemoved } = usersSlice.actions
export default usersSlice.reducer
```

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:

```javascript
// –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
dispatch(userAdded({ id: 1, name: 'Alice' }))

// –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
dispatch(
    usersReceived([
        { id: 1, name: 'Alice' },
        { id: 2, name: 'Bob' },
    ]),
)

// –û–Ω–æ–≤–∏—Ç–∏
dispatch(userUpdated({ id: 1, changes: { name: 'Alicia' } }))

// –í–∏–¥–∞–ª–∏—Ç–∏
dispatch(userRemoved(1))
```

### 2. –ó –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º state

```javascript
const usersAdapter = createEntityAdapter()

const usersSlice = createSlice({
    name: 'users',
    initialState: usersAdapter.getInitialState({
        loading: 'idle',
        error: null,
        selectedUserId: null,
    }),
    reducers: {
        userAdded: usersAdapter.addOne,
        userSelected: (state, action) => {
            state.selectedUserId = action.payload
        },
    },
})
```

### 3. –ó async thunks

```javascript
import { createAsyncThunk, createSlice, createEntityAdapter } from '@reduxjs/toolkit'

const usersAdapter = createEntityAdapter()

export const fetchUsers = createAsyncThunk('users/fetchAll', async () => {
    const response = await fetch('/api/users')
    return response.json()
})

export const deleteUser = createAsyncThunk('users/delete', async (userId) => {
    await fetch(`/api/users/${userId}`, { method: 'DELETE' })
    return userId
})

const usersSlice = createSlice({
    name: 'users',
    initialState: usersAdapter.getInitialState({
        loading: 'idle',
        error: null,
    }),
    reducers: {},
    extraReducers: (builder) => {
        builder
            // Fetch
            .addCase(fetchUsers.pending, (state) => {
                state.loading = 'pending'
            })
            .addCase(fetchUsers.fulfilled, (state, action) => {
                state.loading = 'succeeded'
                usersAdapter.setAll(state, action.payload)
            })
            .addCase(fetchUsers.rejected, (state, action) => {
                state.loading = 'failed'
                state.error = action.error.message
            })
            // Delete
            .addCase(deleteUser.fulfilled, (state, action) => {
                usersAdapter.removeOne(state, action.payload)
            })
    },
})

export default usersSlice.reducer
```

### 4. –ö–∞—Å—Ç–æ–º–Ω–∏–π selectId

```javascript
// –Ø–∫—â–æ –≤–∞—à—ñ –æ–±'—î–∫—Ç–∏ –º–∞—é—Ç—å —ñ–Ω—à–µ –ø–æ–ª–µ –∑–∞–º—ñ—Å—Ç—å 'id'
const booksAdapter = createEntityAdapter({
    selectId: (book) => book.isbn, // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á
})

// –ê–±–æ —è–∫—â–æ ID –≤–∫–ª–∞–¥–µ–Ω–∏–π
const productsAdapter = createEntityAdapter({
    selectId: (product) => product.data.productId,
})
```

### 5. –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è

```javascript
// –ó–∞ —ñ–º–µ–Ω–µ–º (–∞–ª—Ñ–∞–≤—ñ—Ç–Ω–æ)
const usersAdapter = createEntityAdapter({
    sortComparer: (a, b) => a.name.localeCompare(b.name),
})

// –ó–∞ –¥–∞—Ç–æ—é —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è (–Ω–æ–≤—ñ—à—ñ —Å–ø–æ—á–∞—Ç–∫—É)
const postsAdapter = createEntityAdapter({
    sortComparer: (a, b) => b.createdAt - a.createdAt,
})

// –°–∫–ª–∞–¥–Ω–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
const tasksAdapter = createEntityAdapter({
    sortComparer: (a, b) => {
        // –°–ø–æ—á–∞—Ç–∫—É –∑–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º
        if (a.priority !== b.priority) {
            return b.priority - a.priority
        }
        // –ü–æ—Ç—ñ–º –∑–∞ –¥–∞—Ç–æ—é
        return new Date(b.createdAt) - new Date(a.createdAt)
    },
})
```

::warning
**–í–∞–∂–ª–∏–≤–æ**: –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –∑–º—ñ–Ω—ñ** ids. –î–ª—è –≤–µ–ª–∏–∫–∏—Ö –∫–æ–ª–µ–∫—Ü—ñ–π —Ü–µ –º–æ–∂–µ –≤–ø–ª–∏–≤–∞—Ç–∏ –Ω–∞ performance.
::

---

## Auto-generated Selectors

–ê–¥–∞–ø—Ç–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î —Å–µ–ª–µ–∫—Ç–æ—Ä–∏:

```javascript
const usersAdapter = createEntityAdapter()

// –ì–µ–Ω–µ—Ä—É—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏
const usersSelectors = usersAdapter.getSelectors(
    (state) => state.users, // –®–ª—è—Ö –¥–æ slice –≤ store
)

// –î–æ—Å—Ç—É–ø–Ω—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏:
usersSelectors.selectIds // (state) => state.users.ids
usersSelectors.selectEntities // (state) => state.users.entities
usersSelectors.selectAll // (state) => –º–∞—Å–∏–≤ –≤—Å—ñ—Ö users
usersSelectors.selectTotal // (state) => –∫—ñ–ª—å–∫—ñ—Å—Ç—å users
usersSelectors.selectById // (state, id) => –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π user
```

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```javascript
import { useSelector } from 'react-redux'
import { usersSelectors } from './usersSlice'

function UsersList() {
    const users = useSelector(usersSelectors.selectAll)
    const totalUsers = useSelector(usersSelectors.selectTotal)

    return (
        <div>
            <h2>Total: {totalUsers}</h2>
            {users.map((user) => (
                <div key={user.id}>{user.name}</div>
            ))}
        </div>
    )
}

function UserProfile({ userId }) {
    const user = useSelector((state) => usersSelectors.selectById(state, userId))

    if (!user) return <div>User not found</div>

    return <div>{user.name}</div>
}
```

### –ï–∫—Å–ø–æ—Ä—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä—ñ–≤

```javascript [features/users/usersSlice.js]
const usersAdapter = createEntityAdapter()

const usersSlice = createSlice({
    // ...
})

// –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
export const usersSelectors = usersAdapter.getSelectors((state) => state.users)

export default usersSlice.reducer
```

---

## –û–ø–µ—Ä–∞—Ü—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

### updateOne ‚Äî —á–∞—Å—Ç–∫–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

```javascript
reducers: {
  userNameUpdated: (state, action) => {
    usersAdapter.updateOne(state, {
      id: action.payload.id,
      changes: { name: action.payload.name },
    });
  },
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
dispatch(userNameUpdated({ id: 1, name: 'New Name' }));
```

### updateMany ‚Äî –º–Ω–æ–∂–∏–Ω–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

```javascript
reducers: {
  usersArchived: (state, action) => {
    const updates = action.payload.map(id => ({
      id,
      changes: { archived: true },
    }));
    usersAdapter.updateMany(state, updates);
  },
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
dispatch(usersArchived([1, 2, 3]));
```

### upsertOne ‚Äî –¥–æ–¥–∞—Ç–∏ –∞–±–æ –æ–Ω–æ–≤–∏—Ç–∏

```javascript
reducers: {
  userUpserted: (state, action) => {
    // –Ø–∫—â–æ —ñ—Å–Ω—É—î ‚Äî –æ–Ω–æ–≤–∏—Ç—å, —è–∫—â–æ –Ω—ñ ‚Äî –¥–æ–¥–∞—Å—Ç—å
    usersAdapter.upsertOne(state, action.payload);
  },
}

// –ö–æ—Ä–∏—Å–Ω–æ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ —Å–µ—Ä–≤–µ—Ä–æ–º
dispatch(userUpserted({ id: 1, name: 'Alice', email: 'new@email.com' }));
```

---

## Real-World Examples

::accordion

::accordion-item{label="Shopping Cart –∑ Entity Adapter" icon="i-lucide-shopping-cart"}

```javascript [features/cart/cartSlice.js]
import { createSlice, createEntityAdapter } from '@reduxjs/toolkit'

const cartAdapter = createEntityAdapter({
    selectId: (item) => item.productId,
})

const cartSlice = createSlice({
    name: 'cart',
    initialState: cartAdapter.getInitialState({
        total: 0,
    }),
    reducers: {
        itemAdded: (state, action) => {
            const { productId, name, price } = action.payload
            const existingItem = state.entities[productId]

            if (existingItem) {
                // –ó–±—ñ–ª—å—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
                cartAdapter.updateOne(state, {
                    id: productId,
                    changes: { quantity: existingItem.quantity + 1 },
                })
            } else {
                // –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π
                cartAdapter.addOne(state, {
                    productId,
                    name,
                    price,
                    quantity: 1,
                })
            }

            // –û–Ω–æ–≤–∏—Ç–∏ total
            state.total = state.ids.reduce((sum, id) => sum + state.entities[id].price * state.entities[id].quantity, 0)
        },

        itemRemoved: (state, action) => {
            cartAdapter.removeOne(state, action.payload)
            state.total = state.ids.reduce((sum, id) => sum + state.entities[id].price * state.entities[id].quantity, 0)
        },

        quantityUpdated: (state, action) => {
            const { productId, quantity } = action.payload
            if (quantity <= 0) {
                cartAdapter.removeOne(state, productId)
            } else {
                cartAdapter.updateOne(state, {
                    id: productId,
                    changes: { quantity },
                })
            }
            state.total = state.ids.reduce((sum, id) => sum + state.entities[id].price * state.entities[id].quantity, 0)
        },

        cartCleared: (state) => {
            cartAdapter.removeAll(state)
            state.total = 0
        },
    },
})

export const { itemAdded, itemRemoved, quantityUpdated, cartCleared } = cartSlice.actions

export const cartSelectors = cartAdapter.getSelectors((state) => state.cart)

export default cartSlice.reducer
```

::

::accordion-item{label="Posts –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏ (Nested Normalization)" icon="i-lucide-message-square"}

```javascript
// –û–∫—Ä–µ–º—ñ –∞–¥–∞–ø—Ç–µ—Ä–∏ –¥–ª—è posts —Ç–∞ comments
const postsAdapter = createEntityAdapter({
    sortComparer: (a, b) => b.createdAt - a.createdAt,
})

const commentsAdapter = createEntityAdapter({
    sortComparer: (a, b) => a.createdAt - b.createdAt,
})

const postsSlice = createSlice({
    name: 'posts',
    initialState: postsAdapter.getInitialState({
        comments: commentsAdapter.getInitialState(),
    }),
    reducers: {
        postAdded: postsAdapter.addOne,

        commentAdded: (state, action) => {
            commentsAdapter.addOne(state.comments, action.payload)
        },

        postWithCommentsReceived: (state, action) => {
            const { post, comments } = action.payload
            postsAdapter.addOne(state, post)
            commentsAdapter.addMany(state.comments, comments)
        },
    },
})

// –°–µ–ª–µ–∫—Ç–æ—Ä–∏
export const postsSelectors = postsAdapter.getSelectors((state) => state.posts)
export const commentsSelectors = commentsAdapter.getSelectors((state) => state.posts.comments)
```

::

::accordion-item{label="Inbox –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ —Ç–∞ –ø–æ—à—É–∫–æ–º" icon="i-lucide-inbox"}

```javascript
const messagesAdapter = createEntityAdapter({
    sortComparer: (a, b) => b.timestamp - a.timestamp,
})

const messagesSlice = createSlice({
    name: 'messages',
    initialState: messagesAdapter.getInitialState({
        filter: 'all', // 'all' | 'read' | 'unread'
        searchQuery: '',
    }),
    reducers: {
        messagesReceived: messagesAdapter.setAll,

        messageRead: (state, action) => {
            messagesAdapter.updateOne(state, {
                id: action.payload,
                changes: { read: true },
            })
        },

        allMessagesRead: (state) => {
            const updates = state.ids.map((id) => ({
                id,
                changes: { read: true },
            }))
            messagesAdapter.updateMany(state, updates)
        },

        filterChanged: (state, action) => {
            state.filter = action.payload
        },

        searchQueryChanged: (state, action) => {
            state.searchQuery = action.payload
        },
    },
})

// Memoized —Å–µ–ª–µ–∫—Ç–æ—Ä –∑ —Ñ—ñ–ª—å—Ç—Ä–æ–º
import { createSelector } from '@reduxjs/toolkit'

const selectMessagesState = (state) => state.messages

export const selectFilteredMessages = createSelector(
    [
        messagesAdapter.getSelectors(selectMessagesState).selectAll,
        (state) => state.messages.filter,
        (state) => state.messages.searchQuery,
    ],
    (messages, filter, searchQuery) => {
        let filtered = messages

        // –§—ñ–ª—å—Ç—Ä –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º
        if (filter === 'read') {
            filtered = filtered.filter((m) => m.read)
        } else if (filter === 'unread') {
            filtered = filtered.filter((m) => !m.read)
        }

        // –ü–æ—à—É–∫
        if (searchQuery) {
            filtered = filtered.filter(
                (m) =>
                    m.subject.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    m.body.toLowerCase().includes(searchQuery.toLowerCase()),
            )
        }

        return filtered
    },
)
```

::

::accordion-item{label="Collaborative Todo List (Optimistic Updates)" icon="i-lucide-check-square"}

```javascript
import { createAsyncThunk, createSlice, createEntityAdapter } from '@reduxjs/toolkit'

const todosAdapter = createEntityAdapter()

export const toggleTodo = createAsyncThunk('todos/toggle', async (todoId, { rejectWithValue }) => {
    try {
        const response = await fetch(`/api/todos/${todoId}/toggle`, {
            method: 'PATCH',
        })
        return response.json()
    } catch (error) {
        return rejectWithValue(todoId)
    }
})

const todosSlice = createSlice({
    name: 'todos',
    initialState: todosAdapter.getInitialState(),
    reducers: {
        todosReceived: todosAdapter.setAll,
    },
    extraReducers: (builder) => {
        builder
            // Optimistic update
            .addCase(toggleTodo.pending, (state, action) => {
                const todoId = action.meta.arg
                const todo = state.entities[todoId]
                if (todo) {
                    todosAdapter.updateOne(state, {
                        id: todoId,
                        changes: { completed: !todo.completed },
                    })
                }
            })
            // Rollback –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
            .addCase(toggleTodo.rejected, (state, action) => {
                const todoId = action.payload
                const todo = state.entities[todoId]
                if (todo) {
                    todosAdapter.updateOne(state, {
                        id: todoId,
                        changes: { completed: !todo.completed }, // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –Ω–∞–∑–∞–¥
                    })
                }
            })
    },
})

export default todosSlice.reducer
```

::

::

---

## Migration: Array ‚Üí Entity Adapter

::tabs
::tabs-item{label="–î–æ (–º–∞—Å–∏–≤)"}

```javascript
const todosSlice = createSlice({
    name: 'todos',
    initialState: {
        items: [],
    },
    reducers: {
        todoAdded: (state, action) => {
            state.items.push(action.payload)
        },

        todoToggled: (state, action) => {
            const todo = state.items.find((t) => t.id === action.payload)
            if (todo) {
                todo.completed = !todo.completed
            }
        },

        todoDeleted: (state, action) => {
            state.items = state.items.filter((t) => t.id !== action.payload)
        },
    },
})

// –°–µ–ª–µ–∫—Ç–æ—Ä
const selectAllTodos = (state) => state.todos.items
const selectTodoById = (state, todoId) => state.todos.items.find((t) => t.id === todoId)
```

::

::tabs-item{label="–ü—ñ—Å–ª—è (entity adapter)"}

```javascript
const todosAdapter = createEntityAdapter()

const todosSlice = createSlice({
    name: 'todos',
    initialState: todosAdapter.getInitialState(),
    reducers: {
        todoAdded: todosAdapter.addOne,

        todoToggled: (state, action) => {
            const todo = state.entities[action.payload]
            if (todo) {
                todo.completed = !todo.completed
            }
        },

        todoDeleted: todosAdapter.removeOne,
    },
})

// –°–µ–ª–µ–∫—Ç–æ—Ä–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ!)
export const todosSelectors = todosAdapter.getSelectors((state) => state.todos)
// todosSelectors.selectAll, todosSelectors.selectById - –≥–æ—Ç–æ–≤—ñ!
```

::
::

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ú–µ–Ω—à–µ –∫–æ–¥—É, –∫—Ä–∞—â–∏–π performance, –≥–æ—Ç–æ–≤—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏!

---

## TypeScript –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è

```typescript [features/users/usersSlice.ts]
import { createSlice, createEntityAdapter, EntityState } from '@reduxjs/toolkit'

interface User {
    id: number
    name: string
    email: string
}

const usersAdapter = createEntityAdapter<User>()

interface UsersState extends EntityState<User> {
    loading: 'idle' | 'pending' | 'succeeded' | 'failed'
    error: string | null
}

const initialState: UsersState = usersAdapter.getInitialState({
    loading: 'idle',
    error: null,
})

const usersSlice = createSlice({
    name: 'users',
    initialState,
    reducers: {
        userAdded: usersAdapter.addOne,
        userUpdated: usersAdapter.updateOne,
    },
})

export const usersSelectors = usersAdapter.getSelectors<RootState>((state) => state.users)

export default usersSlice.reducer
```

---

## Performance Tips

::card-group
::card{title="‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –¥–ª—è –∫–æ–ª–µ–∫—Ü—ñ–π" icon="i-lucide-zap"}
–Ø–∫—â–æ —É –≤–∞—Å –±—ñ–ª—å—à–µ 10 –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –∑ ID ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ adapter
::

::card{title="‚ö†Ô∏è –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≤—ñ–ª—å–Ω–∏–º" icon="i-lucide-clock"}
–î–ª—è 1000+ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –∑–º—ñ–Ω—ñ ‚Äî –¥–æ—Ä–æ–≥–µ
::

::card{title="‚úÖ –°–µ–ª–µ–∫—Ç–æ—Ä–∏ memoized" icon="i-lucide-cpu"}
`selectAll` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ memoized –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
::

::card{title="‚ö° Normalization = O(1)" icon="i-lucide-gauge"}
Lookup, update, delete ‚Äî –≤—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
::
::

---

## –ö–æ–ª–∏ –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏

::warning
**Entity Adapter –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω —è–∫—â–æ:**

- –ú–∞–ª–æ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ (< 10)
- –ï–ª–µ–º–µ–Ω—Ç–∏ –Ω–µ –º–∞—é—Ç—å —É–Ω—ñ–∫–∞–ª—å–Ω–æ–≥–æ ID
- –ù–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω —à–≤–∏–¥–∫–∏–π lookup –∑–∞ ID
- –î–∞–Ω—ñ –≤–∂–µ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —ñ–Ω—à–∏–º —Å–ø–æ—Å–æ–±–æ–º
  ::

---

## –í–∏—Å–Ω–æ–≤–æ–∫

`createEntityAdapter` ‚Äî —Ü–µ:

‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö  
‚úÖ O(1) —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü—ñ–π  
‚úÖ –ì–æ—Ç–æ–≤—ñ CRUD –º–µ—Ç–æ–¥–∏  
‚úÖ Auto-generated —Å–µ–ª–µ–∫—Ç–æ—Ä–∏  
‚úÖ –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è  
‚úÖ –í—ñ–¥–º—ñ–Ω–Ω–∞ TypeScript –ø—ñ–¥—Ç—Ä–∏–º–∫–∞

::tip
**–ó–æ–ª–æ—Ç–µ –ø—Ä–∞–≤–∏–ª–æ**: –Ø–∫—â–æ —É –≤–∞—Å —î –∫–æ–ª–µ–∫—Ü—ñ—è –æ–±'—î–∫—Ç—ñ–≤ –∑ ID —ñ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω —à–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Entity Adapter.
::

---

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

–¢–µ–ø–µ—Ä –º–∏ –æ—Å–≤–æ—ó–ª–∏ –≤—Å—ñ –±–∞–∑–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ Redux Toolkit. –ß–∞—Å –ø–µ—Ä–µ–π—Ç–∏ –¥–æ advanced —Ç–µ–º!

üëâ [–î–∞–ª—ñ: –ú–µ–º–æ—ñ–∑–∞—Ü—ñ—è —Å–µ–ª–µ–∫—Ç–æ—Ä—ñ–≤ –∑ Reselect](../05.advanced/01.selectors-reselect.md)
