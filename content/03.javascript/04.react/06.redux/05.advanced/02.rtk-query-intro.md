# RTK Query: –†–µ–≤–æ–ª—é—Ü—ñ—è –≤ Data Fetching

RTK Query ‚Äî —Ü–µ –Ω–∞–¥–±—É–¥–æ–≤–∞ –Ω–∞–¥ Redux Toolkit, —è–∫–∞ **–ø–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É—î data fetching**: –∫–µ—à—É–≤–∞–Ω–Ω—è, invalidation, re-fetching, optimistic updates, polling. –¶–µ —è–∫ React Query, –∞–ª–µ —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∏–π –∑ Redux.

## –ü—Ä–æ–±–ª–µ–º–∞: Manual Data Fetching

–†–∞–Ω—ñ—à–µ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ API endpoint –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–ª–æ:

```javascript
// ‚ùå –ë–∞–≥–∞—Ç–æ —Ä—É—á–Ω–æ—ó —Ä–æ–±–æ—Ç–∏
const usersSlice = createSlice({
    name: 'users',
    initialState: { data: [], loading: false, error: null },
    reducers: {},
    extraReducers: (builder) => {
        builder
            .addCase(fetchUsers.pending, (state) => {
                state.loading = true
            })
            .addCase(fetchUsers.fulfilled, (state, action) => {
                state.loading = false
                state.data = action.payload
            })
            .addCase(fetchUsers.rejected, (state, action) => {
                state.loading = false
                state.error = action.error.message
            })
    },
})

export const fetchUsers = createAsyncThunk('users/fetch', async () => {
    const response = await fetch('/api/users')
    return response.json()
})
```

**–ü—Ä–æ–±–ª–µ–º–∏:**

- –ö–æ–¥ –¥—É–±–ª—é—î—Ç—å—Å—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ endpoint
- –ù–µ–º–∞—î –∫–µ—à—É–≤–∞–Ω–Ω—è
- –ù–µ–º–∞—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ re-fetching
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä—É—á–Ω—É –∫–µ—Ä—É–≤–∞—Ç–∏ loading states
- –°–∫–ª–∞–¥–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ

---

## –†—ñ—à–µ–Ω–Ω—è: RTK Query

```javascript
// ‚úÖ RTK Query ‚Äî –≤—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'

export const api = createApi({
    reducerPath: 'api',
    baseQuery: fetchBaseQuery({ baseUrl: '/api' }),
    endpoints: (builder) => ({
        getUsers: builder.query({
            query: () => 'users',
        }),
    }),
})

export const { useGetUsersQuery } = api

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ
function UsersList() {
    const { data, isLoading, error } = useGetUsersQuery()

    if (isLoading) return <div>Loading...</div>
    if (error) return <div>Error: {error.message}</div>

    return (
        <ul>
            {data.map((user) => (
                <li key={user.id}>{user.name}</li>
            ))}
        </ul>
    )
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è
- ‚úÖ Auto-generated hooks
- ‚úÖ Loading/error states
- ‚úÖ Re-fetching –ø—Ä–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ
- ‚úÖ Invalidation –ø—ñ—Å–ª—è mutations
- ‚úÖ Optimistic updates
- ‚úÖ Polling —Ç–∞ streaming

::mermaid

```mermaid
graph TB
    A[Component] -->|useQuery| B[RTK Query]
    B -->|Check cache| C{–Ñ –≤ –∫–µ—à—ñ?}
    C -->|–¢–∞–∫| D[–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑ –∫–µ—à—É]
    C -->|–ù—ñ| E[Fetch –∑ API]
    E --> F[–ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –∫–µ—à]
    F --> D
    D --> A

    G[Mutation] -->|useMutation| B
    B --> H[Invalidate tags]
    H --> I[Re-fetch queries]

    style A fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style B fill:#10b981,stroke:#059669,color:#ffffff
    style D fill:#f59e0b,stroke:#b45309,color:#ffffff
    style G fill:#ef4444,stroke:#dc2626,color:#ffffff
```

::

---

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è API Slice

```javascript [src/services/api.js]
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'

export const api = createApi({
    reducerPath: 'api',
    baseQuery: fetchBaseQuery({
        baseUrl: 'https://api.example.com',
        prepareHeaders: (headers, { getState }) => {
            const token = getState().auth.token
            if (token) {
                headers.set('authorization', `Bearer ${token}`)
            }
            return headers
        },
    }),
    tagTypes: ['User', 'Post'], // –î–ª—è cache invalidation
    endpoints: (builder) => ({
        // Endpoints —Ç—É—Ç
    }),
})
```

### 2. –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Store

```javascript [src/store.js]
import { configureStore } from '@reduxjs/toolkit'
import { api } from './services/api'

export const store = configureStore({
    reducer: {
        [api.reducerPath]: api.reducer,
        // —ñ–Ω—à—ñ reducers
    },
    middleware: (getDefaultMiddleware) => getDefaultMiddleware().concat(api.middleware),
})
```

---

## Query Endpoints (GET –∑–∞–ø–∏—Ç–∏)

### –ë–∞–∑–æ–≤–∏–π Query

```javascript
endpoints: (builder) => ({
    getUsers: builder.query({
        query: () => 'users',
    }),

    getUserById: builder.query({
        query: (id) => `users/${id}`,
    }),

    searchUsers: builder.query({
        query: (searchTerm) => ({
            url: 'users/search',
            params: { q: searchTerm },
        }),
    }),
})

// Auto-generated hooks:
export const { useGetUsersQuery, useGetUserByIdQuery, useSearchUsersQuery } = api
```

### Query –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

```javascript
getUserPosts: builder.query({
    query: ({ userId, limit = 10, offset = 0 }) => ({
        url: `users/${userId}/posts`,
        params: { limit, offset },
    }),
})

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
const { data } = useGetUserPostsQuery({ userId: 1, limit: 20 })
```

### Transform Response

```javascript
getUsers: builder.query({
    query: () => 'users',
    transformResponse: (response) => {
        // –û–±—Ä–æ–±–∏—Ç–∏ –¥–∞–Ω—ñ –ø–µ—Ä–µ–¥ –∫–µ—à—É–≤–∞–Ω–Ω—è–º
        return response.data.map((user) => ({
            ...user,
            fullName: `${user.firstName} ${user.lastName}`,
        }))
    },
})
```

---

## Mutation Endpoints (POST, PUT, DELETE)

```javascript
endpoints: (builder) => ({
    createUser: builder.mutation({
        query: (newUser) => ({
            url: 'users',
            method: 'POST',
            body: newUser,
        }),
    }),

    updateUser: builder.mutation({
        query: ({ id, ...patch }) => ({
            url: `users/${id}`,
            method: 'PATCH',
            body: patch,
        }),
    }),

    deleteUser: builder.mutation({
        query: (id) => ({
            url: `users/${id}`,
            method: 'DELETE',
        }),
    }),
})

export const { useCreateUserMutation, useUpdateUserMutation, useDeleteUserMutation } = api
```

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Mutations

```javascript
function CreateUserForm() {
    const [createUser, { isLoading, error }] = useCreateUserMutation()

    const handleSubmit = async (formData) => {
        try {
            const result = await createUser(formData).unwrap()
            console.log('Created:', result)
        } catch (err) {
            console.error('Failed:', err)
        }
    }

    return <form onSubmit={handleSubmit}>...</form>
}
```

---

## Cache Invalidation –∑ Tags

Tags –¥–æ–∑–≤–æ–ª—è—é—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ queries –ø—ñ—Å–ª—è mutations:

```javascript
tagTypes: ['User', 'Post'],

endpoints: (builder) => ({
  getUsers: builder.query({
    query: () => 'users',
    providesTags: ['User'], // –¶–µ–π query use tag 'User'
  }),

  getUserById: builder.query({
    query: (id) => `users/${id}`,
    providesTags: (result, error, id) => [{ type: 'User', id }],
  }),

  createUser: builder.mutation({
    query: (newUser) => ({
      url: 'users',
      method: 'POST',
      body: newUser,
    }),
    invalidatesTags: ['User'], // Invalidate –≤—Å—ñ User queries
  }),

  updateUser: builder.mutation({
    query: ({ id, ...patch }) => ({
      url: `users/${id}`,
      method: 'PATCH',
      body: patch,
    }),
    invalidatesTags: (result, error, { id }) => [{ type: 'User', id }],
  }),
})
```

::tip
**–Ø–∫ –ø—Ä–∞—Ü—é—î**: –ü—ñ—Å–ª—è `createUser` RTK Query –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ re-fetch `getUsers` query!
::

---

## Patterns –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### 1. Skip query (conditional fetching)

```javascript
function UserProfile({ userId }) {
  const { data } = use GetUserByIdQuery(userId, {
    skip: !userId, // –ù–µ —Ä–æ–±–∏—Ç–∏ fetch —è–∫—â–æ –Ω–µ–º–∞—î ID
  });

  return data ? <div>{data.name}</div> : null;
}
```

### 2. Polling (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è)

```javascript
function LiveDashboard() {
    const { data } = useGetStatsQuery(undefined, {
        pollingInterval: 5000, // Re-fetch –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
    })

    return <div>Active users: {data?.activeUsers}</div>
}
```

### 3. Optimistic Updates

```javascript
updatePost: builder.mutation({
    query: ({ id, ...patch }) => ({
        url: `posts/${id}`,
        method: 'PATCH',
        body: patch,
    }),
    async onQueryStarted({ id, ...patch }, { dispatch, queryFulfilled }) {
        // –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        const patchResult = dispatch(
            api.util.updateQueryData('getPosts', undefined, (draft) => {
                const post = draft.find((p) => p.id === id)
                if (post) {
                    Object.assign(post, patch)
                }
            }),
        )

        try {
            await queryFulfilled
        } catch {
            patchResult.undo() // Rollback –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
        }
    },
})
```

### 4. Prefetching

```javascript
function PostsList() {
    const { data: posts } = useGetPostsQuery()
    const dispatch = useDispatch()

    const handleMouseEnter = (postId) => {
        // Prefetch –¥–µ—Ç–∞–ª—ñ –ø–æ—Å—Ç—É
        dispatch(api.util.prefetch('getPostById', postId, { force: false }))
    }

    return posts.map((post) => (
        <div key={post.id} onMouseEnter={() => handleMouseEnter(post.id)}>
            {post.title}
        </div>
    ))
}
```

### 5. Manual Cache Updates

```javascript
function Component() {
    const dispatch = useDispatch()

    const handleAction = () => {
        // –†—É—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–µ—à—É
        dispatch(
            api.util.updateQueryData('getUsers', undefined, (draft) => {
                draft.push({ id: 999, name: 'New User' })
            }),
        )
    }
}
```

---

## Real-World Example: Full CRUD

```javascript [src/services/postsApi.js]
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'

export const postsApi = createApi({
    reducerPath: 'postsApi',
    baseQuery: fetchBaseQuery({ baseUrl: '/api' }),
    tagTypes: ['Post'],
    endpoints: (builder) => ({
        // LIST
        getPosts: builder.query({
            query: ({ page = 1, limit = 10 }) => ({
                url: 'posts',
                params: { page, limit },
            }),
            providesTags: (result) =>
                result
                    ? [...result.map(({ id }) => ({ type: 'Post', id })), { type: 'Post', id: 'LIST' }]
                    : [{ type: 'Post', id: 'LIST' }],
        }),

        // GET
        getPost: builder.query({
            query: (id) => `posts/${id}`,
            providesTags: (result, error, id) => [{ type: 'Post', id }],
        }),

        // CREATE
        createPost: builder.mutation({
            query: (newPost) => ({
                url: 'posts',
                method: 'POST',
                body: newPost,
            }),
            invalidatesTags: [{ type: 'Post', id: 'LIST' }],
        }),

        // UPDATE
        updatePost: builder.mutation({
            query: ({ id, ...patch }) => ({
                url: `posts/${id}`,
                method: 'PATCH',
                body: patch,
            }),
            invalidatesTags: (result, error, { id }) => [{ type: 'Post', id }],
        }),

        // DELETE
        deletePost: builder.mutation({
            query: (id) => ({
                url: `posts/${id}`,
                method: 'DELETE',
            }),
            invalidatesTags: (result, error, id) => [{ type: 'Post', id }],
        }),
    }),
})

export const {
    useGetPostsQuery,
    useGetPostQuery,
    useCreatePostMutation,
    useUpdatePostMutation,
    useDeletePostMutation,
} = postsApi
```

---

## TypeScript Support

```typescript
interface Post {
    id: number
    title: string
    content: string
    authorId: number
}

interface PostsResponse {
    data: Post[]
    total: number
}

export const api = createApi({
    baseQuery: fetchBaseQuery({ baseUrl: '/api' }),
    endpoints: (builder) => ({
        getPosts: builder.query<PostsResponse, { page: number }>({
            query: ({ page }) => `posts?page=${page}`,
        }),

        getPost: builder.query<Post, number>({
            query: (id) => `posts/${id}`,
        }),

        createPost: builder.mutation<Post, Partial<Post>>({
            query: (newPost) => ({
                url: 'posts',
                method: 'POST',
                body: newPost,
            }),
        }),
    }),
})
```

---

## –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è: createAsyncThunk vs RTK Query

| –ö—Ä–∏—Ç–µ—Ä—ñ–π               | createAsyncThunk     | RTK Query               |
| ---------------------- | -------------------- | ----------------------- |
| **Use case**           | –°–∫–ª–∞–¥–Ω–∞ async –ª–æ–≥—ñ–∫–∞ | CRUD API operations     |
| **Boilerplate**        | –°–µ—Ä–µ–¥–Ω—ñ–π             | –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π             |
| **Caching**            | –†—É—á–Ω–∏–π               | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π            |
| **Deduplication**      | –†—É—á–Ω–∏–π               | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π            |
| **Re-fetching**        | –†—É—á–Ω–∏–π               | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π            |
| **Optimistic updates** | –ú–æ–∂–ª–∏–≤–æ, —Å–∫–ª–∞–¥–Ω–æ     | –í–±—É–¥–æ–≤–∞–Ω–æ               |
| **Polling**            | –†—É—á–Ω–∏–π               | –û–ø—Ü—ñ—è `pollingInterval` |
| **Invalidation**       | –†—É—á–Ω–∏–π               | –ß–µ—Ä–µ–∑ tags              |
| **TypeScript**         | –î–æ–±—Ä–∏–π               | –í—ñ–¥–º—ñ–Ω–Ω–∏–π               |

::tip
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ RTK Query –¥–ª—è REST/GraphQL APIs. createAsyncThunk ‚Äî –¥–ª—è —Å–∫–ª–∞–¥–Ω–æ—ó –ª–æ–≥—ñ–∫–∏.
::

---

## –í–∏—Å–Ω–æ–≤–æ–∫

RTK Query ‚Äî —Ü–µ:

‚úÖ –ü–æ–≤–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è data fetching  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è —Ç–∞ invalidation  
‚úÖ Optimistic updates –∑ rollback  
‚úÖ Polling, prefetching, streaming  
‚úÖ –ú—ñ–Ω—ñ–º—É–º boilerplate –∫–æ–¥—É  
‚úÖ –í—ñ–¥–º—ñ–Ω–Ω–∞ TypeScript –ø—ñ–¥—Ç—Ä–∏–º–∫–∞

::warning
**–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É**: RTK Query –Ω–∞–π–∫—Ä–∞—â–∏–π –¥–ª—è RESTful/GraphQL APIs. –î–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö workflows –∞–±–æ non-standard API –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ createAsyncThunk.
::

---

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

–¢–µ–ø–µ—Ä, –∫–æ–ª–∏ –≤–∏ –∑–Ω–∞—î—Ç–µ –≤—Å—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ Redux Toolkit, –¥–∞–≤–∞–π—Ç–µ –ø–æ–≥–æ–≤–æ—Ä–∏–º–æ –ø—Ä–æ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É —Ç–∞ best practices!

üëâ [–î–∞–ª—ñ: –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Ç–∞ Best Practices](./03.architecture-best-practices.md)
