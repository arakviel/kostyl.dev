# –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ RTK Query

–¢–µ–ø–µ—Ä –∑—Ä–æ–±–∏–º–æ –Ω–∞—à –¥–æ–¥–∞—Ç–æ–∫ "–∂–∏–≤–∏–º". –ú–∏ –±—É–¥–µ–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω –∑ —Å–µ—Ä–≤–µ—Ä–∞ —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –∑–º—ñ–Ω–∏ –Ω–∞–∑–∞–¥.

## –°—Ç–≤–æ—Ä–µ–Ω–Ω—è API Slice

```typescript [src/features/api/apiSlice.ts]
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';
import { BoardData } from '../../types/kanban';

export const apiSlice = createApi({
  reducerPath: 'api',
  baseQuery: fetchBaseQuery({ baseUrl: '/api' }),
  tagTypes: ['Board'],
  endpoints: (builder) => ({
    getBoard: builder.query<BoardData, void>({
      query: () => 'board',
      providesTags: ['Board'],
    }),
    updateBoard: builder.mutation<void, BoardData>({
      query: (board) => ({
        url: 'board',
        method: 'POST', // –∞–±–æ PUT/PATCH
        body: board,
      }),
      // –ú–∏ –ù–ï —ñ–Ω–≤–∞–ª—ñ–¥—É—î–º–æ —Ç–µ–≥ 'Board' —Ç—É—Ç –Ω–∞–≤–º–∏—Å–Ω–æ!
      // –ß–æ–º—É? –ß–∏—Ç–∞–π—Ç–µ –Ω–∏–∂—á–µ –ø—Ä–æ Optimistic Updates.
    }),
  }),
});

export const { useGetBoardQuery, useUpdateBoardMutation } = apiSlice;
```

## –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è (Hydration)

–£ –Ω–∞—Å —î –ø—Ä–æ–±–ª–µ–º–∞: –¥–∞–Ω—ñ –∂–∏–≤—É—Ç—å —É –¥–≤–æ—Ö –º—ñ—Å—Ü—è—Ö. –í –∫–µ—à—ñ RTK Query —ñ –≤ –Ω–∞—à–æ–º—É –ª–æ–∫–∞–ª—å–Ω–æ–º—É `boardSlice`. –ù–∞–º —Ç—Ä–µ–±–∞ —ó—Ö —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏.

–ú–æ–¥–∏—Ñ—ñ–∫—É—î–º–æ `Board.tsx`.

```tsx [src/features/board/Board.tsx]
import { useEffect } from 'react';
import { useGetBoardQuery, useUpdateBoardMutation } from '../../features/api/apiSlice';
import { setBoard } from './boardSlice'; // –¢—Ä–µ–±–∞ –¥–æ–¥–∞—Ç–∏ —Ü–µ–π action

export const Board: React.FC = () => {
  const { data, isLoading } = useGetBoardQuery();
  const [updateBoard] = useUpdateBoardMutation();
  const dispatch = useAppDispatch();
  
  // –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –¥–æ—à–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–∏–π)
  const board = useAppSelector(state => state.board);

  // 1. –ü—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫–æ–ø—ñ—é—î–º–æ –¥–∞–Ω—ñ –≤ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å–ª–∞–π—Å
  useEffect(() => {
    if (data) {
      dispatch(setBoard(data));
    }
  }, [data, dispatch]);

  const onDragEnd = (result: DropResult) => {
    // ... –ª–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ ...

    // 2. –û–Ω–æ–≤–ª—é—î–º–æ –õ–û–ö–ê–õ–¨–ù–ò–ô —Å—Ç–∞–Ω (–º–∏—Ç—Ç—î–≤–æ)
    dispatch(moveTask({ source, destination, draggableId }));

    // 3. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∞–Ω –Ω–∞ –°–ï–†–í–ï–†
    // –û—Å–∫—ñ–ª—å–∫–∏ moveTask —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π, state.board –≤–∂–µ –æ–Ω–æ–≤–ª–µ–Ω–∏–π
    // –ê–ª–µ —Ç—É—Ç —î –Ω—é–∞–Ω—Å: —É React state updates –º–æ–∂—É—Ç—å –±—É—Ç–∏ –±–∞—Ç—á–∏–Ω–≥.
    // –¢–æ–º—É –∫—Ä–∞—â–µ –±—Ä–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–µ–π—Ç –∑ store.getState() –∞–±–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –æ–±—á–∏—Å–ª–µ–Ω—ñ –¥–∞–Ω—ñ.
    
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥—É, –º–∏ –≤–∏–∫–ª–∏–∫–∞—î–º–æ –º—É—Ç–∞—Ü—ñ—é –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ middleware listener.
    // –ê–ª–µ –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–µ: –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ "—Å–∏–≥–Ω–∞–ª" —Å–µ—Ä–≤–µ—Ä—É, —â–æ –º–∏ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏–ª–∏ —Ç–∞—Å–∫—É.
    // –ê–±–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤–µ—Å—å –±–æ—Ä–¥.
    
    // updateBoard(–æ–±—á–∏—Å–ª–µ–Ω–∏–π_–Ω–æ–≤–∏–π_–±–æ—Ä–¥);
  };
  
  if (isLoading) return <div>Loading...</div>;

  return ( ... );
};
```

::alert{type="warning"}
–ß–µ–∫–∞—Ç–∏ `useEffect`, —â–æ–± –∑–∞–ø–∏—Å–∞—Ç–∏ –¥–∞–Ω—ñ –≤ Redux ‚Äî —Ü–µ –Ω–µ —ñ–¥–µ–∞–ª—å–Ω–∏–π –ø–∞—Ç–µ—Ä–Ω (—Ü–µ –≤–∏–∫–ª–∏–∫–∞—î –ø–æ–¥–≤—ñ–π–Ω–∏–π —Ä–µ–Ω–¥–µ—Ä). –ö—Ä–∞—â–∏–º —Ä—ñ—à–µ–Ω–Ω—è–º —î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `extraReducers` –≤ —Å–ª–∞–π—Å—ñ, —â–æ–± —Å–ª—É—Ö–∞—Ç–∏ `apiSlice.endpoints.getBoard.matchFulfilled`.
::

## –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è (extraReducers)

–î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–ø–∏—à–µ–º–æ `boardSlice.ts`, —â–æ–± –≤—ñ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ª–æ–≤–∏–≤ –¥–∞–Ω—ñ –∑ API.

```typescript
import { apiSlice } from '../api/apiSlice';

// ...

extraReducers: (builder) => {
  builder.addMatcher(
    apiSlice.endpoints.getBoard.matchFulfilled,
    (state, action) => {
      // –ö–æ–ª–∏ –∑–∞–ø–∏—Ç —É—Å–ø—ñ—à–Ω–∏–π, –º–∏ –∑–∞–º—ñ–Ω—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –¥–∞–Ω–∏–º–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞
      return action.payload;
    }
  );
},
```

–¢–µ–ø–µ—Ä –Ω–∞–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω `useEffect` –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ! –Ø–∫ —Ç—ñ–ª—å–∫–∏ `useGetBoardQuery` –æ—Ç—Ä–∏–º–∞—î –¥–∞–Ω—ñ, –≤–æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—Ç—Ä–∞–ø–ª—è—Ç—å –≤ `boardSlice`.

## –ü—Ä–æ–±–ª–µ–º–∞ "–ú–µ—Ä–µ—Ö—Ç—ñ–Ω–Ω—è"

–Ø–∫—â–æ –º–∏ –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–ø—Ä–∞–≤–∏–º–æ –∑–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –∞ –ø–æ—Ç—ñ–º —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω–µ –Ω–æ–≤—ñ –¥–∞–Ω—ñ, —ñ –º–∏ –∑–Ω–æ–≤—É –æ–Ω–æ–≤–∏–º–æ —Å—Ç–æ—Ä... –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –ø–æ–±–∞—á–∏—Ç–∏ "—Å—Ç—Ä–∏–±–æ–∫" –∫–∞—Ä—Ç–∫–∏ –Ω–∞–∑–∞–¥ —ñ –≤–ø–µ—Ä–µ–¥, —è–∫—â–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–≤—ñ–ª—å–Ω–∏–π.

–©–æ–± —Ü—å–æ–≥–æ —É–Ω–∏–∫–Ω—É—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è **Optimistic Updates** (–û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è).

üëâ [–î–∞–ª—ñ: Optimistic Updates](./06.optimistic-updates.md)
