---
title: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤ SQL
description: –î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑–±—ñ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π - ACID –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ, BEGIN/COMMIT/ROLLBACK, savepoints, —Ä—ñ–≤–Ω—ñ —ñ–∑–æ–ª—è—Ü—ñ—ó, –ø—Ä–∞–∫—Ç–∏—á–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó
---

# –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤ SQL

## –ü—Ä–æ–±–ª–µ–º–∞: –Ø–∫ –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö?

–£—è–≤—ñ—Ç—å –±–∞–Ω–∫—ñ–≤—Å—å–∫—É –æ–ø–µ—Ä–∞—Ü—ñ—é –ø–µ—Ä–µ–∫–∞–∑—É –≥—Ä–æ—à–µ–π:

1. –ó–Ω—è—Ç–∏ 1000‚Ç¥ –∑ —Ä–∞—Ö—É–Ω–∫—É –ê
2. –î–æ–¥–∞—Ç–∏ 1000‚Ç¥ –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫ –ë

–©–æ —Å—Ç–∞–Ω–µ—Ç—å—Å—è, —è–∫—â–æ —Å–∏—Å—Ç–µ–º–∞ –≤–ø–∞–¥–µ **–º—ñ–∂** —Ü–∏–º–∏ –¥–≤–æ–º–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è–º–∏? –ì—Ä–æ—à—ñ –∑–Ω–∏–∫–Ω—É—Ç—å!

::mermaid

```mermaid
sequenceDiagram
participant User as –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á
participant DB as –ë–∞–∑–∞ –î–∞–Ω–∏—Ö
participant AccA as –†–∞—Ö—É–Ω–æ–∫ –ê
participant AccB as –†–∞—Ö—É–Ω–æ–∫ –ë

    User->>DB: BEGIN TRANSACTION
    DB->>Acc A: UPDATE: -1000‚Ç¥
    AccA-->>DB: ‚úÖ OK

    critical –©–æ —è–∫—â–æ —Ç—É—Ç crash?
        DB->>DB: üí• –°–∏—Å—Ç–µ–º–∞ –≤–ø–∞–ª–∞!
        DB->>DB: ROLLBACK –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
        DB->>AccA: –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ 1000‚Ç¥ –Ω–∞–∑–∞–¥
    end

    DB->>AccB: UPDATE: +1000‚Ç¥
    AccB-->>DB: ‚úÖ OK
    DB->>User: COMMIT - –≤—Å—ñ –∑–º—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ

```

::

**–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è** ‚Äî —Ü–µ **–≥—Ä—É–ø–∞ –æ–ø–µ—Ä–∞—Ü—ñ–π**, —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —è–∫ **–æ–¥–Ω–µ —Ü—ñ–ª–µ**: –∞–±–æ **–≤—Å—ñ —É—Å–ø—ñ—à–Ω–æ**, –∞–±–æ **–∂–æ–¥–Ω–∞**.

::tip
**–†–µ–∞–ª—å–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π**:

- –ü–µ—Ä–µ–∫–∞–∑ –≥—Ä–æ—à–µ–π –º—ñ–∂ —Ä–∞—Ö—É–Ω–∫–∞–º–∏
- –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (—Å—Ç–≤–æ—Ä–∏—Ç–∏ Order + OrderItems + –∑–º–µ–Ω—à–∏—Ç–∏ Stock)
- –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—Å—Ç–≤–æ—Ä–∏—Ç–∏ User + Profile + –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ Email)
  ::

---

## ACID –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ

–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –º–∞—é—Ç—å 4 –∫–ª—é—á–æ–≤—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ (**ACID**):

::card-group

::card{title="A - Atomicity (–ê—Ç–æ–º–∞—Ä–Ω—ñ—Å—Ç—å)" icon="i-lucide-atom"}

**–í—Å–µ –∞–±–æ –Ω—ñ—á–æ–≥–æ**: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∞–±–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø–æ–≤–Ω—ñ—Å—Ç—é, –∞–±–æ –Ω–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤–∑–∞–≥–∞–ª—ñ.

```sql
BEGIN TRANSACTION;
    UPDATE AccountA SET Balance = Balance - 1000;
    UPDATE AccountB SET Balance = Balance + 1000;
COMMIT;

-- –ê–±–æ –æ–±–∏–¥–≤–∞ UPDATE –≤–∏–∫–æ–Ω–∞—é—Ç—å—Å—è, –∞–±–æ –∂–æ–¥–µ–Ω
```

::

::card{title="C - Consistency (–£–∑–≥–æ–¥–∂–µ–Ω—ñ—Å—Ç—å)" icon="i-lucide-check-circle"}

**–î–∞–Ω—ñ –∑–∞–≤–∂–¥–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ**: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –ë–î –∑ –æ–¥–Ω–æ–≥–æ –≤–∞–ª—ñ–¥–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –≤ —ñ–Ω—à–∏–π.

```sql
-- –ë–∞–ª–∞–Ω—Å–∏ –¥–æ: A=5000, B=3000, –°—É–º–∞=8000
BEGIN TRANSACTION;
    UPDATE AccountA SET Balance = Balance - 1000;  -- A=4000
    UPDATE AccountB SET Balance = Balance + 1000;  -- B=4000
COMMIT;
-- –ë–∞–ª–∞–Ω—Å–∏ –ø—ñ—Å–ª—è: A=4000, B=4000, –°—É–º–∞=8000 ‚úÖ
```

::

::card{title="I - Isolation (–Ü–∑–æ–ª—è—Ü—ñ—è)" icon="i-lucide-shield"}

**–ù–µ–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å**: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –Ω–µ –∑–∞–≤–∞–∂–∞—é—Ç—å –æ–¥–Ω–∞ –æ–¥–Ω—ñ–π (–Ω–µ –±–∞—á–∞—Ç—å –ø—Ä–æ–º—ñ–∂–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏).

```sql
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 1 (—â–µ –Ω–µ COMMIT)
BEGIN TRANSACTION;
    UPDATE Products SET Price = 100 WHERE Id = 1;
    -- –Ü–Ω—à—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —â–µ –±–∞—á–∞—Ç—å —Å—Ç–∞—Ä—É —Ü—ñ–Ω—É!

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 2 (–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ)
SELECT Price FROM Products WHERE Id = 1;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å—Ç–∞—Ä–∞ —Ü—ñ–Ω–∞ (–ø–æ–∫–∏ –Ω–µ COMMIT –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó 1)
```

::

::card{title="D - Durability (–î–æ–≤–≥–æ–≤—ñ—á–Ω—ñ—Å—Ç—å)" icon="i-lucide-database"}

**–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–∑–∞–≤–∂–¥–∏**: –ü—ñ—Å–ª—è COMMIT –∑–º—ñ–Ω–∏ **–≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ** (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –≤–ø–∞–¥–µ).

```sql
BEGIN TRANSACTION;
    INSERT INTO Orders (...) VALUES (...);
COMMIT;  -- ‚úÖ –ó —Ü—å–æ–≥–æ –º–æ–º–µ–Ω—Ç—É –∑–∞–ø–∏—Å –ì–ê–†–ê–ù–¢–û–í–ê–ù–û –≤ –ë–î
-- –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Å–µ–∫—É–Ω–¥–∏ –≤–∏–º–∫–Ω—É—Ç–∏ —Å–µ—Ä–≤–µ—Ä - –¥–∞–Ω—ñ –∑–±–µ—Ä–µ–∂—É—Ç—å—Å—è
```

::

::

---

## –ë–∞–∑–æ–≤–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó

```sql
BEGIN TRANSACTION;  -- –ê–±–æ –ø—Ä–æ—Å—Ç–æ BEGIN TRAN

    -- SQL –æ–ø–µ—Ä–∞—Ü—ñ—ó (INSERT, UPDATE, DELETE)

    IF <—É–º–æ–≤–∞_—É—Å–ø—ñ—Ö—É>
        COMMIT;  -- –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏
    ELSE
        ROLLBACK;  -- –°–∫–∞—Å—É–≤–∞—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏
```

### –ü—Ä–∏–∫–ª–∞–¥ 1: –£—Å–ø—ñ—à–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è

```sql
BEGIN TRANSACTION;

    INSERT INTO Students (FirstName, LastName, BirthDate)
    VALUES ('–¢–µ—Å—Ç', '–¢–µ—Å—Ç–æ–≤', '2000-01-01');

    UPDATE Students SET Grants = Grants * 1.1
    WHERE LastName = '–ü–µ—Ç—Ä–µ–Ω–∫–æ';

COMMIT;  -- ‚úÖ –û–±–∏–¥–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑–±–µ—Ä–µ–∂–µ–Ω–æ
```

### –ü—Ä–∏–∫–ª–∞–¥ 2: –°–∫–∞—Å—É–≤–∞–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó

```sql
BEGIN TRANSACTION;

    DELETE FROM Students WHERE Id = 1;

    -- –ü–æ–º–∏–ª–∫–∞! –ü–µ—Ä–µ–¥—É–º–∞–ª–∏

ROLLBACK;  -- ‚ùå DELETE —Å–∫–∞—Å–æ–≤–∞–Ω–æ, —Å—Ç—É–¥–µ–Ω—Ç –∑–∞–ª–∏—à–∏–≤—Å—è
```

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥: –ü–µ—Ä–µ–∫–∞–∑ –≥—Ä–æ—à–µ–π

```sql
-- –¢–∞–±–ª–∏—Ü—è —Ä–∞—Ö—É–Ω–∫—ñ–≤
CREATE TABLE Accounts (
    AccountId INT PRIMARY KEY,
    Balance DECIMAL(18, 2) NOT NULL CHECK (Balance >= 0)
);

INSERT INTO Accounts VALUES (1, 5000), (2, 3000);

-- –ü–µ—Ä–µ–∫–∞–∑ 1000 –∑ —Ä–∞—Ö—É–Ω–∫—É 1 –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫ 2
BEGIN TRANSACTION;

    DECLARE @Amount DECIMAL(18, 2) = 1000;
    DECLARE @FromAccount INT = 1;
    DECLARE @ToAccount INT = 2;

    -- –ö—Ä–æ–∫ 1: –ó–Ω—è—Ç–∏ –≥—Ä–æ—à—ñ
    UPDATE Accounts
    SET Balance = Balance - @Amount
    WHERE AccountId = @FromAccount;

    -- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–æ—à–µ–π?
    IF (SELECT Balance FROM Accounts WHERE AccountId = @FromAccount) < 0
    BEGIN
        ROLLBACK;  -- –°–∫–∞—Å—É–≤–∞—Ç–∏! –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–æ—à–µ–π
        PRINT '–ü–æ–º–∏–ª–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤';
    END
    ELSE
    BEGIN
        -- –ö—Ä–æ–∫ 2: –î–æ–¥–∞—Ç–∏ –≥—Ä–æ—à—ñ
        UPDATE Accounts
        SET Balance = Balance + @Amount
        WHERE AccountId = @ToAccount;

        COMMIT;  -- ‚úÖ –ü–µ—Ä–µ–∫–∞–∑ —É—Å–ø—ñ—à–Ω–∏–π
        PRINT '–ü–µ—Ä–µ–∫–∞–∑ –≤–∏–∫–æ–Ω–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ';
    END

-- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
SELECT * FROM Accounts;
-- AccountId | Balance
-- 1         | 4000.00
-- 2         | 4000.00
```

---

## TRY...CATCH –∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è–º–∏

**Best Practice**: –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ TRY...CATCH –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è—Ö.

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
BEGIN TRY
    BEGIN TRANSACTION;

        -- SQL –æ–ø–µ—Ä–∞—Ü—ñ—ó

    COMMIT;
END TRY
BEGIN CATCH
    -- –Ø–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞
    IF @@TRANCOUNT > 0
        ROLLBACK;  -- –°–∫–∞—Å—É–≤–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é

    -- –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É
    PRINT ERROR_MESSAGE();
END CATCH
```

### –ü—Ä–∏–∫–ª–∞–¥: –ë–µ–∑–ø–µ—á–Ω–∞ –≤—Å—Ç–∞–≤–∫–∞

```sql
BEGIN TRY
    BEGIN TRANSACTION;

        -- –î–æ–¥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
        INSERT INTO Students (FirstName, LastName, BirthDate, Email)
        VALUES ('–ù–æ–≤–∏–π', '–°—Ç—É–¥–µ–Ω—Ç', '2000-01-01', 'test@example.com');

        -- –î–æ–¥–∞—Ç–∏ –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è
        INSERT INTO Enrollments (StudentId, CourseId, EnrollmentDate)
        VALUES (SCOPE_IDENTITY(), 1, GETDATE());

        -- –Ø–∫—â–æ –æ–±–∏–¥–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó —É—Å–ø—ñ—à–Ω—ñ
    COMMIT;
    PRINT '–°—Ç—É–¥–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π';
END TRY
BEGIN CATCH
    -- –Ø–∫—â–æ —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫ (duplicate email, –Ω–µ—ñ—Å–Ω—É—é—á–∏–π CourseId —Ç–æ—â–æ)
    IF @@TRANCOUNT > 0
        ROLLBACK;

    PRINT '–ü–æ–º–∏–ª–∫–∞: ' + ERROR_MESSAGE();
END CATCH
```

### –ö–æ—Ä–∏—Å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –ø–æ–º–∏–ª–æ–∫

```sql
BEGIN CATCH
    SELECT
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_MESSAGE() AS ErrorMessage,
        ERROR_LINE() AS ErrorLine,
        ERROR_PROCEDURE() AS ErrorProcedure,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() AS ErrorState;

    ROLLBACK;
END CATCH
```

---

## SAVEPOINT: –ß–∞—Å—Ç–∫–æ–≤–µ –≤—ñ–¥–∫–æ—á—É–≤–∞–Ω–Ω—è

**SAVEPOINT** (–∞–±–æ **SAVE TRANSACTION**) –¥–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä–∏—Ç–∏ "checkpoint" –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
BEGIN TRANSACTION;

    -- –û–ø–µ—Ä–∞—Ü—ñ—è 1
    INSERT INTO Table1 VALUES (...);

    SAVE TRANSACTION SavePoint1;  -- Checkpoint

    -- –û–ø–µ—Ä–∞—Ü—ñ—è 2
    UPDATE Table2 SET ...;

    -- –©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫ –∑ –û–ø–µ—Ä–∞—Ü—ñ—î—é 2
    ROLLBACK TRANSACTION SavePoint1;  -- –í—ñ–¥–∫–æ—Ç–∏—Ç–∏ –¥–æ checkpoint
    -- –û–ø–µ—Ä–∞—Ü—ñ—è 1 –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è, –û–ø–µ—Ä–∞—Ü—ñ—è 2 —Å–∫–∞—Å–æ–≤–∞–Ω–∞

COMMIT;
```

### –ü—Ä–∏–∫–ª–∞–¥: –ü–∞–∫–µ—Ç–Ω–∞ –≤—Å—Ç–∞–≤–∫–∞ –∑ —á–∞—Å—Ç–∫–æ–≤–∏–º –æ—Ç–∫–∞—Ç–æ–º

```sql
BEGIN TRANSACTION;

    -- –í—Å—Ç–∞–≤–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ 1
    INSERT INTO Students (FirstName, LastName, BirthDate)
    VALUES ('–°—Ç—É–¥–µ–Ω—Ç1', '–ü—Ä—ñ–∑–≤–∏—â–µ1', '1998-01-01');

    SAVE TRANSACTION AfterStudent1;

    -- –°–ø—Ä–æ–±–∞ –≤—Å—Ç–∞–≤–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ 2
    BEGIN TRY
        INSERT INTO Students (FirstName, LastName, BirthDate)
        VALUES ('–°—Ç—É–¥–µ–Ω—Ç2', '–ü—Ä—ñ–∑–≤–∏—â–µ2', 'INVALID_DATE');  -- –ü–æ–º–∏–ª–∫–∞!
    END TRY
    BEGIN CATCH
        -- –í—ñ–¥–∫–æ—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ 2
        ROLLBACK TRANSACTION AfterStudent1;
        PRINT '–°—Ç—É–¥–µ–Ω—Ç 2 –Ω–µ –¥–æ–¥–∞–Ω–æ —á–µ—Ä–µ–∑ –ø–æ–º–∏–ª–∫—É';
    END CATCH

    -- –í—Å—Ç–∞–≤–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ 3
    INSERT INTO Students (FirstName, LastName, BirthDate)
    VALUES ('–°—Ç—É–¥–µ–Ω—Ç3', '–ü—Ä—ñ–∑–≤–∏—â–µ3', '1999-03-03');

COMMIT;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –°—Ç—É–¥–µ–Ω—Ç–∏ 1 —Ç–∞ 3 –¥–æ–¥–∞–Ω—ñ, —Å—Ç—É–¥–µ–Ω—Ç 2 - –Ω—ñ
```

---

## –†—ñ–≤–Ω—ñ —ñ–∑–æ–ª—è—Ü—ñ—ó (Isolation Levels)

–†—ñ–≤–µ–Ω—å —ñ–∑–æ–ª—è—Ü—ñ—ó –≤–∏–∑–Ω–∞—á–∞—î, **—è–∫** —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤–ø–ª–∏–≤–∞—é—Ç—å –æ–¥–Ω–∞ –Ω–∞ –æ–¥–Ω—É.

### 4 –æ—Å–Ω–æ–≤–Ω—ñ —Ä—ñ–≤–Ω—ñ

::tabs

::tabs-item{label="READ UNCOMMITTED (–Ω–∞–π–Ω–∏–∂—á–∏–π)"}

**–î–æ–∑–≤–æ–ª—è—î**: –ß–∏—Ç–∞—Ç–∏ **–Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ** –¥–∞–Ω—ñ —ñ–Ω—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π (dirty reads).

```sql
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

BEGIN TRANSACTION;
    -- –ú–æ–∂–µ –ø–æ–±–∞—á–∏—Ç–∏ –∑–º—ñ–Ω–∏, —è–∫—ñ —â–µ –Ω–µ COMMIT —É —ñ–Ω—à—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
    SELECT * FROM Products;
COMMIT;
```

**–ü—Ä–æ–±–ª–µ–º–∏**: Dirty reads (—á–∏—Ç–∞–Ω–Ω—è "–±—Ä—É–¥–Ω–∏—Ö" –¥–∞–Ω–∏—Ö)

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è**: –ó–≤—ñ—Ç–∏, –¥–µ —Ç–æ—á–Ω—ñ—Å—Ç—å –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞

::

::tabs-item{label="READ COMMITTED (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)"}

**–î–æ–∑–≤–æ–ª—è—î**: –ß–∏—Ç–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ **–∑–±–µ—Ä–µ–∂–µ–Ω—ñ** –¥–∞–Ω—ñ (–ø—ñ—Å–ª—è COMMIT).

```sql
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

BEGIN TRANSACTION;
    -- –ë–∞—á–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –¥–∞–Ω—ñ –ø—ñ—Å–ª—è COMMIT
    SELECT * FROM Products;
COMMIT;
```

**–ü—Ä–æ–±–ª–µ–º–∏**: Non-repeatable reads (–¥–∞–Ω—ñ –º–æ–∂—É—Ç—å –∑–º—ñ–Ω–∏—Ç–∏—Å—è –º—ñ–∂ –¥–≤–æ–º–∞ SELECT)

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è**: –ë—ñ–ª—å—à—ñ—Å—Ç—å –∑–≤–∏—á–∞–π–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π

::

::tabs-item{label="REPEATABLE READ"}

**–ì–∞—Ä–∞–Ω—Ç—É—î**: –¢—ñ –∂ –¥–∞–Ω—ñ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É —á–∏—Ç–∞–Ω–Ω—ñ –≤ –æ–¥–Ω—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.

```sql
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;

BEGIN TRANSACTION;
    SELECT * FROM Products WHERE Id = 1;  -- Price = 100
    -- –Ü–Ω—à–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è UPDATE Price = 200 (–±–ª–æ–∫—É—î—Ç—å—Å—è!)
    SELECT * FROM Products WHERE Id = 1;  -- Price = 100 (—Ç–µ –∂ —Å–∞–º–µ)
COMMIT;
```

**–ü—Ä–æ–±–ª–µ–º–∏**: Phantom reads (–º–æ–∂—É—Ç—å –∑'—è–≤–∏—Ç–∏—Å—è –Ω–æ–≤—ñ —Ä—è–¥–∫–∏)

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è**: –ö–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö

::

::tabs-item{label="SERIALIZABLE (–Ω–∞–π–≤–∏—â–∏–π)"}

**–ì–∞—Ä–∞–Ω—Ç—É—î**: –ü–æ–≤–Ω–∞ —ñ–∑–æ–ª—è—Ü—ñ—è, –Ω—ñ–±–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ.

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

BEGIN TRANSACTION;
    SELECT * FROM Products;
    -- –Ü–Ω—à—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –ù–ï –º–æ–∂—É—Ç—å INSERT/UPDATE/DELETE –≤ Products
    SELECT * FROM Products;  -- –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ —Ç—ñ –∂ –¥–∞–Ω—ñ
COMMIT;
```

**–ü—Ä–æ–±–ª–µ–º–∏**: –ù–∞–π–ø–æ–≤—ñ–ª—å–Ω—ñ—à–∏–π, –±–∞–≥–∞—Ç–æ –±–ª–æ–∫—É–≤–∞–Ω—å

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è**: –ö—Ä–∏—Ç–∏—á–Ω—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó

::

::

### –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è

| –†—ñ–≤–µ–Ω—å           | Dirty Reads                                                | Non-Repeatable Reads                                       | Phantom Reads                                              | Performance                                                   |
| :--------------- | :--------------------------------------------------------- | :--------------------------------------------------------- | :--------------------------------------------------------- | :------------------------------------------------------------ |
| READ UNCOMMITTED | :icon{name="i-lucide-x" class="text-red-500"} –ú–æ–∂–ª–∏–≤—ñ      | :icon{name="i-lucide-x" class="text-red-500"} –ú–æ–∂–ª–∏–≤—ñ      | :icon{name="i-lucide-x" class="text-red-500"} –ú–æ–∂–ª–∏–≤—ñ      | :icon{name="i-lucide-zap" class="text-green-500"} –ù–∞–π—à–≤–∏–¥—à–∏–π  |
| READ COMMITTED   | :icon{name="i-lucide-check" class="text-green-500"} –ó–∞—Ö–∏—Å—Ç | :icon{name="i-lucide-x" class="text-red-500"} –ú–æ–∂–ª–∏–≤—ñ      | :icon{name="i-lucide-x" class="text-red-500"} –ú–æ–∂–ª–∏–≤—ñ      | :icon{name="i-lucide-zap" class="text-green-500"} –®–≤–∏–¥–∫–∏–π     |
| REPEATABLE READ  | :icon{name="i-lucide-check" class="text-green-500"} –ó–∞—Ö–∏—Å—Ç | :icon{name="i-lucide-check" class="text-green-500"} –ó–∞—Ö–∏—Å—Ç | :icon{name="i-lucide-x" class="text-red-500"} –ú–æ–∂–ª–∏–≤—ñ      | :icon{name="i-lucide-clock" class="text-yellow-500"} –°–µ—Ä–µ–¥–Ω—ñ–π |
| SERIALIZABLE     | :icon{name="i-lucide-check" class="text-green-500"} –ó–∞—Ö–∏—Å—Ç | :icon{name="i-lucide-check" class="text-green-500"} –ó–∞—Ö–∏—Å—Ç | :icon{name="i-lucide-check" class="text-green-500"} –ó–∞—Ö–∏—Å—Ç | :icon{name="i-lucide-turtle" class="text-red-500"} –ü–æ–≤—ñ–ª—å–Ω–∏–π  |

---

## @@TRANCOUNT: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

**@@TRANCOUNT** –ø–æ–∫–∞–∑—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∏—Ö (–Ω–µ–∑–∞–∫—Ä–∏—Ç–∏—Ö) —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π.

```sql
PRINT @@TRANCOUNT;  -- 0 (–Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö)

BEGIN TRANSACTION;
PRINT @@TRANCOUNT;  -- 1

    BEGIN TRANSACTION;  -- –í–∫–ª–∞–¥–µ–Ω–∞
    PRINT @@TRANCOUNT;  -- 2

    COMMIT;
    PRINT @@TRANCOUNT;  -- 1

COMMIT;
PRINT @@TRANCOUNT;  -- 0
```

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –ø–æ–º–∏–ª–∫–∞—Ö

```sql
BEGIN TRY
    BEGIN TRANSACTION;
        -- –û–ø–µ—Ä–∞—Ü—ñ—ó
    COMMIT;
END TRY
BEGIN CATCH
    -- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ —î –∞–∫—Ç–∏–≤–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
    IF @@TRANCOUNT > 0
        ROLLBACK;

    PRINT ERROR_MESSAGE();
END CATCH
```

---

## Deadlocks (–í–∑–∞—î–º–Ω—ñ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è)

**Deadlock** –≤–∏–Ω–∏–∫–∞—î, –∫–æ–ª–∏ –¥–≤—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —á–µ–∫–∞—é—Ç—å –æ–¥–Ω–∞ –Ω–∞ –æ–¥–Ω—É —ñ –∂–æ–¥–Ω–∞ –Ω–µ –º–æ–∂–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏.

### –ü—Ä–∏–∫–ª–∞–¥ deadlock

::code-group

```sql [–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 1]
BEGIN TRANSACTION;
    -- –ë–ª–æ–∫—É—î —Ç–∞–±–ª–∏—Ü—é A
    UPDATE TableA SET Value = 1 WHERE Id = 1;

    WAITFOR DELAY '00:00:02';  -- –ß–µ–∫–∞—î–º–æ 2 —Å–µ–∫

    -- –ù–∞–º–∞–≥–∞—î—Ç—å—Å—è –∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é B (—á–µ–∫–∞—î –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é 2)
    UPDATE TableB SET Value = 1 WHERE Id = 1;
COMMIT;
```

```sql [–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 2 (–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ)]
BEGIN TRANSACTION;
    -- –ë–ª–æ–∫—É—î —Ç–∞–±–ª–∏—Ü—é B
    UPDATE TableB SET Value = 2 WHERE Id = 1;

    WAITFOR DELAY '00:00:02';  -- –ß–µ–∫–∞—î–º–æ 2 —Å–µ–∫

    -- –ù–∞–º–∞–≥–∞—î—Ç—å—Å—è –∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é A (—á–µ–∫–∞—î –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é 1)
    UPDATE TableA SET Value = 2 WHERE Id = 1;
COMMIT;

-- ‚ùå Deadlock! SQL Server –≤–∏–±–µ—Ä–µ "–∂–µ—Ä—Ç–≤—É" —ñ –≤—ñ–¥–∫–æ—Ç–∏—Ç—å —ó—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é
```

::

### –Ø–∫ —É–Ω–∏–∫–Ω—É—Ç–∏ deadlocks

::card-group

::card{title="1. –û–¥–Ω–∞–∫–æ–≤–∏–π –ø–æ—Ä—è–¥–æ–∫ –¥–æ—Å—Ç—É–ø—É" icon="i-lucide-arrow-right"}

```sql
-- ‚úÖ –ó–∞–≤–∂–¥–∏ –¥–æ—Å—Ç—É–ø –≤ –ø–æ—Ä—è–¥–∫—É: TableA ‚Üí TableB
BEGIN TRANSACTION;
    UPDATE TableA ...;
    UPDATE TableB ...;
COMMIT;
```

::

::card{title="2. –ö–æ—Ä–æ—Ç—à—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó" icon="i-lucide-clock"}

```sql
-- ‚ùå –î–æ–≤–≥–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
BEGIN TRANSACTION;
    UPDATE ...;
    -- –°–∫–ª–∞–¥–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö
    COMMIT;

-- ‚úÖ –ö–æ—Ä–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
-- –û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö –î–û —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
BEGIN TRANSACTION;
    UPDATE ...;
COMMIT;
```

::

::card{title="3. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è NOLOCK" icon="i-lucide-unlock"}

```sql
-- –î–ª—è SELECT —â–æ –Ω–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—ñ
SELECT * FROM Products WITH (NOLOCK);
```

::

::

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

```sql
BEGIN TRY
    BEGIN TRANSACTION;

        -- 1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        DECLARE @OrderId INT;
        INSERT INTO Orders (CustomerId, OrderDate, TotalAmount)
        VALUES (123, GETDATE(), 2500);
        SET @OrderId = SCOPE_IDENTITY();

        -- 2. –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä–∏ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        INSERT INTO OrderItems (OrderId, ProductId, Quantity, Price)
        VALUES
            (@OrderId, 1, 2, 1000),
            (@OrderId, 2, 1, 500);

        -- 3. –ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ —Å–∫–ª–∞–¥—ñ
        UPDATE Products SET Stock = Stock - 2 WHERE ProductId = 1;
        UPDATE Products SET Stock = Stock - 1 WHERE ProductId = 2;

        -- 4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –∑–∞–ª–∏—à–∏–≤—Å—è —Ç–æ–≤–∞—Ä
        IF EXISTS (SELECT 1 FROM Products WHERE ProductId IN (1, 2) AND Stock < 0)
        BEGIN
            RAISERROR('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ–≤–∞—Ä—É –Ω–∞ —Å–∫–ª–∞–¥—ñ', 16, 1);
        END

    COMMIT;
    PRINT '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #' + CAST(@OrderId AS NVARCHAR) + ' —É—Å–ø—ñ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ';
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK;
    PRINT '–ü–æ–º–∏–ª–∫–∞: ' + ERROR_MESSAGE();
END CATCH
```

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –ü–∞–∫–µ—Ç–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º

```sql
BEGIN TRY
    BEGIN TRANSACTION;

        -- –¢–∞–±–ª–∏—Ü—è –¥–ª—è –ª–æ–≥—É
        DECLARE @UpdateLog TABLE (
            StudentId INT,
            OldGrants DECIMAL(10, 2),
            NewGrants DECIMAL(10, 2)
        );

        -- –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∏–ø–µ–Ω–¥—ñ—ó –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º
        UPDATE Students
        SET Grants = Grants * 1.15
        OUTPUT
            INSERTED.Id,
            DELETED.Grants,
            INSERTED.Grants
        INTO @UpdateLog
        WHERE YEAR(BirthDate) = 1998;

        -- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö
        DECLARE @UpdatedCount INT = (SELECT COUNT(*) FROM @UpdateLog);

        IF @UpdatedCount = 0
        BEGIN
            ROLLBACK;
            PRINT '–ñ–æ–¥–µ–Ω —Å—Ç—É–¥–µ–Ω—Ç –Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–∏–π - –≤—ñ–¥–º—ñ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó';
        END
        ELSE
        BEGIN
            COMMIT;
            PRINT CAST(@UpdatedCount AS NVARCHAR) + ' —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –æ–Ω–æ–≤–ª–µ–Ω–æ';

            -- –ü–æ–∫–∞–∑–∞—Ç–∏ –ª–æ–≥
            SELECT * FROM @UpdateLog;
        END

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK;
    PRINT ERROR_MESSAGE();
END CATCH
```

---

## Best Practices

::card-group

::card{title="1. –ö–æ—Ä–æ—Ç—à—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó" icon="i-lucide-zap"}

```sql
-- ‚ùå –ü–æ–≥–∞–Ω–æ - –¥–æ–≤–≥–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
BEGIN TRANSACTION;
    SELECT * FROM BigTable;  -- –ü–æ–≤—ñ–ª—å–Ω–∏–π –∑–∞–ø–∏—Ç
    -- –û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö –≤ –∫–æ–¥—ñ
    UPDATE ...;
COMMIT;

-- ‚úÖ –î–æ–±—Ä–µ - –∫–æ—Ä–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
-- SELECT –ø–æ–∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—î—é
-- –û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö
BEGIN TRANSACTION;
    UPDATE ...;
COMMIT;
```

::

::card{title="2. –ó–∞–≤–∂–¥–∏ TRY...CATCH" icon="i-lucide-shield"}

```sql
BEGIN TRY
    BEGIN TRANSACTION;
        -- –û–ø–µ—Ä–∞—Ü—ñ—ó
    COMMIT;
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK;
    -- –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏
END CATCH
```

::

::card{title="3. –Ø–≤–Ω–∏–π COMMIT/ROLLBACK" icon="i-lucide-check"}

```sql
-- ‚úÖ –î–æ–±—Ä–µ - —è–≤–Ω–∏–π COMMIT
BEGIN TRANSACTION;
    UPDATE ...;
COMMIT;

-- ‚ùå –ü–æ–≥–∞–Ω–æ - –∑–∞–±—É–ª–∏ COMMIT
BEGIN TRANSACTION;
    UPDATE ...;
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–æ—é!
```

::

::card{title="4. –ú—ñ–Ω—ñ–º—É–º –æ–ø–µ—Ä–∞—Ü—ñ–π" icon="i-lucide-minimize-2"}

–¢—Ä–∏–º–∞–π—Ç–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó **—Ç—ñ–ª—å–∫–∏** —Ç–µ, —â–æ **–º–∞—î—Ç—å** –±—É—Ç–∏ –∞—Ç–æ–º–∞—Ä–Ω–∏–º:

```sql
-- ‚úÖ –î–æ–±—Ä–µ
BEGIN TRANSACTION;
    UPDATE AccountA SET Balance = Balance - 1000;
    UPDATE AccountB SET Balance = Balance + 1000;
COMMIT;

-- ‚ùå –ü–æ–≥–∞–Ω–æ
BEGIN TRANSACTION;
    UPDATE AccountA ...;
    -- –í—ñ–¥–ø—Ä–∞–≤–∫–∞ email (–ø–æ–≤—ñ–ª—å–Ω–æ!)
    -- –õ–æ–≥—É–≤–∞–Ω–Ω—è
    UPDATE AccountB ...;
COMMIT;
```

::

::

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

::accordion

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 1: –ë–∞–∑–æ–≤–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è" icon="i-lucide-database"}

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é —â–æ:

1. –î–æ–¥–∞—î –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
2. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –π–æ–º—É —Å—Ç–∏–ø–µ–Ω–¥—ñ—é 1500
3. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î TRY...CATCH

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
BEGIN TRY
    BEGIN TRANSACTION;

        INSERT INTO Students (FirstName, LastName, BirthDate, Grants)
        VALUES ('–ù–æ–≤–∏–π', '–°—Ç—É–¥–µ–Ω—Ç', '2000-05-15', 1500);

        PRINT '–°—Ç—É–¥–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∏–π –∑ ID: ' + CAST(SCOPE_IDENTITY() AS NVARCHAR);

    COMMIT;
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK;
    PRINT '–ü–æ–º–∏–ª–∫–∞: ' + ERROR_MESSAGE();
END CATCH
```

</details>

::

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 2: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é" icon="i-lucide-check-circle"}

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é —â–æ –∑–±—ñ–ª—å—à—É—î —Å—Ç–∏–ø–µ–Ω–¥—ñ—é –Ω–∞ 20%, –∞–ª–µ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ Email –±—ñ–ª—å—à–µ 5. –Ü–Ω–∞–∫—à–µ - ROLLBACK.

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
BEGIN TRY
    BEGIN TRANSACTION;

        DECLARE @StudentCount INT = (SELECT COUNT(*) FROM Students WHERE Email IS NOT NULL);

        IF @StudentCount < 5
        BEGIN
            ROLLBACK;
            PRINT '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ email (' + CAST(@StudentCount AS NVARCHAR) + ')';
        END
        ELSE
        BEGIN
            UPDATE Students
            SET Grants = Grants * 1.2
            WHERE Email IS NOT NULL;

            COMMIT;
            PRINT CAST(@@ROWCOUNT AS NVARCHAR) + ' —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –æ–Ω–æ–≤–ª–µ–Ω–æ';
        END

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK;
    PRINT ERROR_MESSAGE();
END CATCH
```

</details>

::

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 3: SAVEPOINT" icon="i-lucide-bookmark"}

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –∑ SAVEPOINT:

1. –î–æ–¥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ 1
2. SAVEPOINT
3. –°–ø—Ä–æ–±–∞ –¥–æ–¥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ 2 (–º–æ–∂–µ –±—É—Ç–∏ –ø–æ–º–∏–ª–∫–∞)
4. –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ - ROLLBACK –¥–æ SAVEPOINT
5. –î–æ–¥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ 3
6. COMMIT

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
BEGIN TRANSACTION;

    -- –°—Ç—É–¥–µ–Ω—Ç 1
    INSERT INTO Students (FirstName, LastName, BirthDate)
    VALUES ('–°—Ç—É–¥–µ–Ω—Ç1', '–¢–µ—Å—Ç', '1998-01-01');
    PRINT '–°—Ç—É–¥–µ–Ω—Ç 1 –¥–æ–¥–∞–Ω–æ';

    SAVE TRANSACTION SP1;

    -- –°—Ç—É–¥–µ–Ω—Ç 2 (–º–æ–∂–µ –±—É—Ç–∏ –ø–æ–º–∏–ª–∫–∞)
    BEGIN TRY
        INSERT INTO Students (FirstName, LastName, BirthDate)
        VALUES ('–°—Ç—É–¥–µ–Ω—Ç2', '–¢–µ—Å—Ç', 'INVALID');  -- –ü–æ–º–∏–ª–∫–∞!
        PRINT '–°—Ç—É–¥–µ–Ω—Ç 2 –¥–æ–¥–∞–Ω–æ';
    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION SP1;
        PRINT '–°—Ç—É–¥–µ–Ω—Ç 2 –ù–ï –¥–æ–¥–∞–Ω–æ: ' + ERROR_MESSAGE();
    END CATCH

    -- –°—Ç—É–¥–µ–Ω—Ç 3
    INSERT INTO Students (FirstName, LastName, BirthDate)
    VALUES ('–°—Ç—É–¥–µ–Ω—Ç3', '–¢–µ—Å—Ç', '1999-03-03');
    PRINT '–°—Ç—É–¥–µ–Ω—Ç 3 –¥–æ–¥–∞–Ω–æ';

COMMIT;
PRINT '–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
```

</details>

::

::

---

## –†–µ–∑—é–º–µ

::tip
**–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π**:

1. **ACID –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ**: Atomicity, Consistency, Isolation, Durability
2. **–°–∏–Ω—Ç–∞–∫—Å–∏—Å**: `BEGIN TRANSACTION` ‚Üí –æ–ø–µ—Ä–∞—Ü—ñ—ó ‚Üí `COMMIT` –∞–±–æ `ROLLBACK`
3. **TRY...CATCH** ‚Äî –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –¥–ª—è production –∫–æ–¥—É
4. **@@TRANCOUNT** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
5. **SAVEPOINT** ‚Äî —á–∞—Å—Ç–∫–æ–≤–µ –≤—ñ–¥–∫–æ—á—É–≤–∞–Ω–Ω—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
6. **–†—ñ–≤–Ω—ñ —ñ–∑–æ–ª—è—Ü—ñ—ó**:
    - READ UNCOMMITTED (–Ω–∞–π—à–≤–∏–¥—à–∏–π, –Ω–∞–π–º–µ–Ω—à –±–µ–∑–ø–µ—á–Ω–∏–π)
    - READ COMMITTED (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
    - REPEATABLE READ
    - SERIALIZABLE (–Ω–∞–π–ø–æ–≤—ñ–ª—å–Ω—ñ—à–∏–π, –Ω–∞–π–±–µ–∑–ø–µ—á–Ω—ñ—à–∏–π)
7. **Deadlocks** ‚Äî —É–Ω–∏–∫–∞–π—Ç–µ –æ–¥–Ω–∞–∫–æ–≤–∏–º –ø–æ—Ä—è–¥–∫–æ–º –¥–æ—Å—Ç—É–ø—É –¥–æ —Ç–∞–±–ª–∏—Ü—å
8. **Best Practices**:
    - –ö–æ—Ä–æ—Ç—à—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
    - –ú—ñ–Ω—ñ–º—É–º –æ–ø–µ—Ä–∞—Ü—ñ–π –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
    - –ó–∞–≤–∂–¥–∏ —è–≤–Ω–∏–π COMMIT/ROLLBACK
    - –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ —á–µ—Ä–µ–∑ TRY...CATCH

**–í—ñ—Ç–∞—î–º–æ!** –í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–∏–≤—á–µ–Ω–Ω—è –æ—Å–Ω–æ–≤ SQL!
::

---

**–ü–æ–≤'—è–∑–∞–Ω—ñ —Ç–µ–º–∏**:

- [–ü–æ–ø–µ—Ä–µ–¥–Ω—è: UPDATE —Ç–∞ DELETE](./06.update-delete-queries.md)
- [–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø–æ—á–∞—Ç–∫—É: Sample Database Setup](./00.sample-database-setup.md)
- [CREATE TABLE](./01.ddl-create-table.md)
- [INSERT –∑–∞–ø–∏—Ç–∏](./05.insert-queries.md)
