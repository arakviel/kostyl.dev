---
title: –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ (Subqueries)
description: –î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑–±—ñ—Ä –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤ (subqueries) - scalar, table, correlated, EXISTS, IN, –ø–æ–∑–∏—Ü—ñ—ó –≤ SELECT/FROM/WHERE
---

# –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ (Subqueries)

## –ü—Ä–æ–±–ª–µ–º–∞: –°–∫–ª–∞–¥–Ω—ñ –±–∞–≥–∞—Ç–æ—Ä—ñ–≤–Ω–µ–≤—ñ –∑–∞–ø–∏—Ç–∏

**–ó–∞–¥–∞—á–∞**: –ó–Ω–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤, —è–∫—ñ –º–∞—é—Ç—å –±–∞–ª **–≤–∏—â–µ –∑–∞ —Å–µ—Ä–µ–¥–Ω—ñ–π** –ø–æ —ó—Ö –≥—Ä—É–ø—ñ.

–ü—Ä–æ—Å—Ç–∏–π –ø—ñ–¥—Ö—ñ–¥ –ù–ï –ø—Ä–∞—Ü—é—î:

```sql
-- ‚ùå –ù–µ –ø—Ä–∞—Ü—é—î - WHERE –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –î–û –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó!
SELECT FirstName, Grade
FROM Students
WHERE Grade > AVG(Grade);  -- –ü–æ–º–∏–ª–∫–∞!
```

**–†—ñ—à–µ–Ω–Ω—è**: **–ü—ñ–¥–∑–∞–ø–∏—Ç (Subquery)**!

```sql
-- ‚úÖ –ü—Ä–∞—Ü—é—î - —Å–ø–æ—á–∞—Ç–∫—É –æ–±—á–∏—Å–ª—é—î–º–æ —Å–µ—Ä–µ–¥–Ω—î
SELECT FirstName, Grade
FROM Students
WHERE Grade > (
    SELECT AVG(Grade) FROM Students  -- –ü—ñ–¥–∑–∞–ø–∏—Ç
);
```

---

## 1. –©–æ —Ç–∞–∫–µ –ø—ñ–¥–∑–∞–ø–∏—Ç?

**–ü—ñ–¥–∑–∞–ø–∏—Ç (Subquery)** ‚Äî SQL-–∑–∞–ø–∏—Ç **–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ** —ñ–Ω—à–æ–≥–æ –∑–∞–ø–∏—Ç—É.

::mermaid

```mermaid
graph TD
    A[–ó–æ–≤–Ω—ñ—à–Ω—ñ–π –∑–∞–ø–∏—Ç<br/>Outer Query] -->|–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î| B[–ü—ñ–¥–∑–∞–ø–∏—Ç<br/>Subquery]
    B -->|–ø–æ–≤–µ—Ä—Ç–∞—î| C[–†–µ–∑—É–ª—å—Ç–∞—Ç]
    C -->|–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤| A

    style A fill:#3b82f6,color:#fff
    style B fill:#10b981,color:#fff
```

::

**–¢–µ—Ä–º—ñ–Ω–∏**:

- **Outer query** (–∑–æ–≤–Ω—ñ—à–Ω—ñ–π –∑–∞–ø–∏—Ç) - –≥–æ–ª–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç
- **Subquery / Inner query** (–ø—ñ–¥–∑–∞–ø–∏—Ç) - –≤–∫–ª–∞–¥–µ–Ω–∏–π –∑–∞–ø–∏—Ç

---

## 2. –¢–∏–ø–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤

### 2.1. –ó–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

::tabs

::tabs-item{label="Scalar Subquery"}

**–ü–æ–≤–µ—Ä—Ç–∞—î**: ONE VALUE (–æ–¥–∏–Ω —Ä—è–¥–æ–∫, –æ–¥–∏–Ω —Å—Ç–æ–≤–ø–µ—Ü—å)

```sql
SELECT FirstName,
    (SELECT AVG(Grade) FROM Assessments) AS AvgGrade
FROM Students;
```

::

::tabs-item{label="Table Subquery"}

**–ü–æ–≤–µ—Ä—Ç–∞—î**: –ú–ù–û–ñ–ò–ù–£ –†–Ø–î–ö–Ü–í (—Ç–∞–±–ª–∏—Ü—é)

```sql
SELECT *
FROM (
    SELECT FirstName, Grade
    FROM Students
    WHERE Grade > 80
) AS TopStudents;
```

::

::tabs-item{label="Row Subquery"}

**–ü–æ–≤–µ—Ä—Ç–∞—î**: –û–î–ò–ù –†–Ø–î–û–ö (–∫—ñ–ª—å–∫–∞ —Å—Ç–æ–≤–ø—Ü—ñ–≤)

```sql
SELECT *
FROM Students
WHERE (GroupId, Grade) = (
    SELECT GroupId, MAX(Grade)
    FROM Students
    GROUP BY GroupId
    LIMIT 1
);
```

::

::

### 2.2. –ó–∞ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—é

::tabs

::tabs-item{label="Non-Correlated"}

**–ù–µ–∑–∞–ª–µ–∂–Ω–∏–π** –≤—ñ–¥ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∑–∞–ø–∏—Ç—É - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**.

```sql
WHERE Grade > (
    SELECT AVG(Grade) FROM Students
    -- –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –û–î–ò–ù –†–ê–ó
)
```

::

::tabs-item{label="Correlated"}

**–ó–∞–ª–µ–∂–Ω–∏–π** –≤—ñ–¥ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∑–∞–ø–∏—Ç—É - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **for each row**.

```sql
WHERE Grade > (
    SELECT AVG(Grade)
    FROM Assessments AS A
    WHERE A.StudentId = S.Id  -- –ó–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ S!
    -- –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –î–õ–Ø –ö–û–ñ–ù–û–ì–û —Å—Ç—É–¥–µ–Ω—Ç–∞
)
```

::

::

---

## 3. –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ –≤ WHERE

### 3.1. Scalar subquery (–æ–¥–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è)

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑ –±–∞–ª–æ–º –≤–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ
SELECT
    FirstName,
    LastName,
    Grade
FROM Students
WHERE Grade > (SELECT AVG(Grade) FROM Students);
```

**–í–∏–∫–æ–Ω–∞–Ω–Ω—è**:

1. –°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∑–∞–ø–∏—Ç: `SELECT AVG(Grade)` ‚Üí `75.5`
2. –ü–æ—Ç—ñ–º: `WHERE Grade > 75.5`

### 3.2. IN –∑ –ø—ñ–¥–∑–∞–ø–∏—Ç–æ–º (–º–Ω–æ–∂–∏–Ω–∞ –∑–Ω–∞—á–µ–Ω—å)

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏, —è–∫—ñ —î –≤ –≥—Ä—É–ø–∞—Ö —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É "Computer Science"
SELECT FirstName, LastName
FROM Students
WHERE GroupId IN (
    SELECT G.Id
    FROM Groups AS G
    INNER JOIN Faculties AS F
        ON G.FacultyId = F.Id
    WHERE F.Name = 'Computer Science'
);
```

**–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –∑ JOIN**:

::code-group

```sql [–ó –ø—ñ–¥–∑–∞–ø–∏—Ç–æ–º]
SELECT S.FirstName
FROM Students AS S
WHERE S.GroupId IN (
    SELECT G.Id FROM Groups AS G
    WHERE G.FacultyId = 1
);
```

```sql [–ó JOIN (–∫—Ä–∞—â–µ performance)]
SELECT S.FirstName
FROM Students AS S
INNER JOIN Groups AS G
    ON S.GroupId = G.Id
WHERE G.FacultyId = 1;
```

::

::tip
**Performance**: JOIN –∑–∞–∑–≤–∏—á–∞–π —à–≤–∏–¥—à–∏–π –∑–∞ IN –∑ –ø—ñ–¥–∑–∞–ø–∏—Ç–æ–º. –ê–ª–µ IN –∑—Ä–æ–∑—É–º—ñ–ª—ñ—à–∏–π –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è.
::

### 3.3. NOT IN - –∑–Ω–∞–π—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ

```sql
-- –ö–∞—Ñ–µ–¥—Ä–∏ –ë–ï–ó –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤
SELECT Name
FROM Departments
WHERE Id NOT IN (
    SELECT DISTINCT DepartmentId
    FROM Teachers
    WHERE DepartmentId IS NOT NULL  -- –í–ê–ñ–õ–ò–í–û!
);
```

::warning
**NULL –ø—Ä–æ–±–ª–µ–º–∞**: `NOT IN` –∑ NULL –ø–æ–≤–µ—Ä—Ç–∞—î **–ü–£–°–¢–ï** —Ä–µ–∑—É–ª—å—Ç–∞—Ç!

```sql
-- ‚ùå –ü–æ–≤–µ—Ä–Ω–µ 0 —Ä—è–¥–∫—ñ–≤, —è–∫—â–æ —î NULL
WHERE Id NOT IN (1, 2, NULL)

-- ‚úÖ –§—ñ–ª—å—Ç—Ä—É–π—Ç–µ NULL
WHERE Id NOT IN (
    SELECT DepartmentId
    FROM Teachers
    WHERE DepartmentId IS NOT NULL
)
```

::

---

## 4. –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ –≤ SELECT

### 4.1. Scalar subquery –¥–ª—è –æ–±—á–∏—Å–ª–µ–Ω—å

```sql
-- –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ + —Å–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª –ø–æ –ë–î
SELECT
    FirstName,
    LastName,
    Grade,
    (SELECT AVG(Grade) FROM Students) AS OverallAvg,
    Grade - (SELECT AVG(Grade) FROM Students) AS Difference
FROM Students;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:

| FirstName | LastName | Grade | OverallAvg | Difference |
| :-------- | :------- | :---- | :--------- | :--------- |
| John      | Doe      | 85    | 75.5       | +9.5       |
| Jane      | Smith    | 70    | 75.5       | -5.5       |

### 4.2. Correlated subquery –≤ SELECT

```sql
-- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ - –π–æ–≥–æ –±–∞–ª + —Å–µ—Ä–µ–¥–Ω—ñ–π –ø–æ –π–æ–≥–æ –≥—Ä—É–ø—ñ
SELECT
    S.FirstName,
    S.Grade,
    (
        SELECT AVG(S2.Grade)
        FROM Students AS S2
        WHERE S2.GroupId = S.GroupId  -- Correlated!
    ) AS GroupAvg
FROM Students AS S;
```

**–í–∏–∫–æ–Ω–∞–Ω–Ω—è**: –î–ª—è **–∫–æ–∂–Ω–æ–≥–æ** —Å—Ç—É–¥–µ–Ω—Ç–∞ S –ø—ñ–¥–∑–∞–ø–∏—Ç –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ –∑ –π–æ–≥–æ `GroupId`.

::warning
**Performance**: Correlated subqueries **–ø–æ–≤—ñ–ª—å–Ω—ñ** - –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è N —Ä–∞–∑—ñ–≤ (–ø–æ —Ä–∞–∑—É –Ω–∞ —Ä—è–¥–æ–∫)!
::

---

## 5. –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ –≤ FROM (Derived Tables)

### 5.1. Table subquery

```sql
-- –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏, –ø–æ—Ç—ñ–º JOIN
SELECT
    TS.FirstName,
    TS.Grade,
    G.Name AS GroupName
FROM (
    SELECT *
    FROM Students
    WHERE Grade > 80  -- –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ñ—ñ–ª—å—Ç—Ä
) AS TS  -- "Derived table" - –û–ë–û–í'–Ø–ó–ö–û–í–ò–ô alias!
INNER JOIN Groups AS G
    ON TS.GroupId = G.Id;
```

::note
**–û–±–æ–≤'—è–∑–∫–æ–≤–æ**: Derived table –º–∞—î –º–∞—Ç–∏ **alias** (`AS TS`)!
::

### 5.2. –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –≤ –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ

```sql
-- –°–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª –ø–æ –≥—Ä—É–ø—ñ, –ø–æ—Ç—ñ–º –≤—ñ–¥—Å–æ—Ä—Ç—É–≤–∞—Ç–∏
SELECT
    GroupAvg.GroupId,
    GroupAvg.AvgGrade
FROM (
    SELECT
        GroupId,
        AVG(Grade) AS AvgGrade
    FROM Students
    GROUP BY GroupId
) AS GroupAvg  -- Derived table
WHERE GroupAvg.AvgGrade > 75
ORDER BY GroupAvg.AvgGrade DESC;
```

---

## 6. EXISTS —Ç–∞ NOT EXISTS

### 6.1. EXISTS - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è

**EXISTS** –ø–æ–≤–µ—Ä—Ç–∞—î `TRUE`, —è–∫—â–æ –ø—ñ–¥–∑–∞–ø–∏—Ç –ø–æ–≤–µ—Ä—Ç–∞—î **—Ö–æ—á –æ–¥–∏–Ω —Ä—è–¥–æ–∫**.

```sql
-- –ö–∞—Ñ–µ–¥—Ä–∏, –Ω–∞ —è–∫–∏—Ö –Ñ –≤–∏–∫–ª–∞–¥–∞—á—ñ
SELECT D.Name
FROM Departments AS D
WHERE EXISTS (
    SELECT 1  -- –ù–µ –≤–∞–∂–ª–∏–≤–æ —â–æ SELECT, –≤–∞–∂–ª–∏–≤–æ –ß–ò –Ñ —Ä—è–¥–∫–∏
    FROM Teachers AS T
    WHERE T.DepartmentId = D.Id
);
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ EXISTS**:

- ‚úÖ –ó—É–ø–∏–Ω—è—î—Ç—å—Å—è –ø—ñ—Å–ª—è **–ø–µ—Ä—à–æ–≥–æ** –∑–±—ñ–≥—É (—à–≤–∏–¥–∫–æ!)
- ‚úÖ –ù–µ –º–∞—î NULL –ø—Ä–æ–±–ª–µ–º
- ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º—É—î correlated –ø—ñ–¥–∑–∞–ø–∏—Ç–∏

::tip
**Best Practice**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `SELECT 1` –∞–±–æ `SELECT *` –≤ EXISTS - –≤—Å–µ –æ–¥–Ω–æ.
::

### 6.2. NOT EXISTS - –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤

```sql
-- –ö–∞—Ñ–µ–¥—Ä–∏ –ë–ï–ó –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤
SELECT D.Name
FROM Departments AS D
WHERE NOT EXISTS (
    SELECT 1
    FROM Teachers AS T
    WHERE T.DepartmentId = D.Id
);
```

### 6.3. EXISTS vs IN: –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è

::code-group

```sql [EXISTS (–∫—Ä–∞—â–µ)]
-- ‚úÖ –®–≤–∏–¥—à–µ, –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–±—ñ–≥—É
SELECT D.Name
FROM Departments AS D
WHERE EXISTS (
    SELECT 1
    FROM Teachers AS T
    WHERE T.DepartmentId = D.Id
);
```

```sql [IN (–ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ)]
-- ‚ö†Ô∏è –û–±—Ä–æ–±–ª—è—î –≤—Å—ñ —Ä—è–¥–∫–∏
SELECT D.Name
FROM Departments AS D
WHERE D.Id IN (
    SELECT DepartmentId
    FROM Teachers
);
```

::

**–ö–æ–ª–∏ —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏**:

| –°—Ü–µ–Ω–∞—Ä—ñ–π                        | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è            |
| :------------------------------ | :---------------------- |
| –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è             | **EXISTS**              |
| –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º —Å–ø–∏—Å–∫–æ–º | **IN ('A', 'B', 'C')**  |
| –í–µ–ª–∏–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–±—ñ–≥—ñ–≤         | **EXISTS**              |
| NULL –º–æ–∂–ª–∏–≤—ñ                    | **EXISTS** (–±–µ–∑–ø–µ—á–Ω—ñ—à–µ) |

---

## 7. ANY, ALL, SOME

### 7.1. ANY - —Ö–æ—á –æ–¥–∏–Ω

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑ –±–∞–ª–æ–º –≤–∏—â–µ –ó–ê –ë–£–î–¨-–Ø–ö–ò–ô –±–∞–ª –≥—Ä—É–ø–∏ 1
SELECT FirstName, Grade
FROM Students
WHERE Grade > ANY (
    SELECT Grade
    FROM Students
    WHERE GroupId = 1
);

-- –ï–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω–æ: Grade > MIN(subquery)
```

### 7.2. ALL - –≤—Å—ñ

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑ –±–∞–ª–æ–º –≤–∏—â–µ –ó–ê –í–°–Ü –±–∞–ª–∏ –≥—Ä—É–ø–∏ 1
SELECT FirstName, Grade
FROM Students
WHERE Grade > ALL (
    SELECT Grade
    FROM Students
    WHERE GroupId = 1
);

-- –ï–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω–æ: Grade > MAX(subquery)
```

### 7.3. SOME - —Å–∏–Ω–æ–Ω—ñ–º ANY

```sql
WHERE Grade > SOME (subquery)
-- –¢–µ —Å–∞–º–µ —â–æ ANY
```

::note
**–ù–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ**: `ANY`/`ALL` **—Ä—ñ–¥–∫–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è** - `MIN`/`MAX` –∑—Ä–æ–∑—É–º—ñ–ª—ñ—à—ñ.
::

---

## 8. Correlated Subqueries

### 8.1. –ö–æ–Ω—Ü–µ–ø—Ü—ñ—è

**Correlated subquery** –ø–æ—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ —Å—Ç–æ–≤–ø—Ü—ñ –∑ **–∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ** –∑–∞–ø–∏—Ç—É.

```sql
SELECT
    S1.FirstName,
    S1.Grade,
    (
        SELECT AVG(S2.Grade)
        FROM Students AS S2
        WHERE S2.GroupId = S1.GroupId  -- ‚Üê Correlated!
    ) AS GroupAvg
FROM Students AS S1;
```

**–í–∏–∫–æ–Ω–∞–Ω–Ω—è**:

```
–î–ª—è S1 (—Ä—è–¥–æ–∫ 1): –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ S1.GroupId = 1
–î–ª—è S1 (—Ä—è–¥–æ–∫ 2): –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ S1.GroupId = 1
–î–ª—è S1 (—Ä—è–¥–æ–∫ 3): –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ S1.GroupId = 2
...
```

::mermaid

```mermaid
sequenceDiagram
    participant Outer as Outer Query
    participant Sub as Subquery

    loop For each row
        Outer->>Sub: –ü–µ—Ä–µ–¥–∞—Ç–∏ S1.GroupId
        Sub->>Sub: –í–∏–∫–æ–Ω–∞—Ç–∏ –∑–∞–ø–∏—Ç
        Sub-->>Outer: –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    end

    Outer->>Outer: –ó–∞–≤–µ—Ä—à–∏—Ç–∏
```

::

### 8.2. –ü—Ä–∏–∫–ª–∞–¥: –í–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–æ –≥—Ä—É–ø—ñ

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑ –±–∞–ª–æ–º –≤–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ü–û –á–• –ì–†–£–ü–Ü
SELECT
    S1.FirstName,
    S1.Grade,
    S1.GroupId
FROM Students AS S1
WHERE S1.Grade > (
    SELECT AVG(S2.Grade)
    FROM Students AS S2
    WHERE S2.GroupId = S1.GroupId  -- Correlated
);
```

### 8.3. Performance –ø—Ä–æ–±–ª–µ–º–∏

::warning
**–ü–û–í–Ü–õ–¨–ù–û**: Correlated subquery –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **N —Ä–∞–∑—ñ–≤** (–¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞)!

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - CTE –∞–±–æ JOIN**:

```sql
-- ‚úÖ –®–≤–∏–¥—à–µ - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –û–î–ò–ù —Ä–∞–∑
WITH GroupAvgs AS (
    SELECT GroupId, AVG(Grade) AS AvgGrade
    FROM Students
    GROUP BY GroupId
)
SELECT S.FirstName, S.Grade
FROM Students AS S
INNER JOIN GroupAvgs AS GA
    ON S.GroupId = GA.GroupId
WHERE S.Grade > GA.AvgGrade;
```

::

---

## 9. Common Table Expressions (CTE) - Preview

**CTE** - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –ø—ñ–¥–∑–∞–ø–∏—Ç–∞–º, –∑—Ä–æ–∑—É–º—ñ–ª—ñ—à–∞ —Ç–∞ —à–≤–∏–¥—à–∞.

```sql
-- –ó–∞–º—ñ—Å—Ç—å –ø—ñ–¥–∑–∞–ø–∏—Ç—É –≤ FROM
WITH TopStudents AS (
    SELECT FirstName, Grade
    FROM Students
    WHERE Grade > 80
)
SELECT TS.FirstName, G.Name
FROM TopStudents AS TS
INNER JOIN Groups AS G
    ON TS.GroupId = G.Id;
```

::tip
**CTE** –±—É–¥–µ –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–æ –≤ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö —É—Ä–æ–∫–∞—Ö. –ü–æ–∫–∏ —â–æ –ø–∞–º'—è—Ç–∞–π—Ç–µ: CTE = "—ñ–º–µ–Ω–æ–≤–∞–Ω–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç".
::

---

## 10. –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏

### 10.1. –¢–æ–ø-N –∑–∞–ø–∏—Ç

```sql
-- –¢–æ–ø-3 —Å—Ç—É–¥–µ–Ω—Ç–∏ –ø–æ –±–∞–ª—É
SELECT FirstName, Grade
FROM Students
WHERE Grade IN (
    SELECT DISTINCT TOP 3 Grade
    FROM Students
    ORDER BY Grade DESC
)
ORDER BY Grade DESC;
```

### 10.2. –ó–Ω–∞–π—Ç–∏ –¥—Ä—É–≥–∏–π –º–∞–∫—Å–∏–º—É–º

```sql
-- –î—Ä—É–≥–∏–π –Ω–∞–π–≤–∏—â–∏–π –±–∞–ª
SELECT MAX(Grade) AS SecondMax
FROM Students
WHERE Grade < (SELECT MAX(Grade) FROM Students);
```

### 10.3. Duplicate detection

```sql
-- –ó–Ω–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ —ñ–º–µ–Ω–∞–º–∏
SELECT FirstName, LastName
FROM Students AS S1
WHERE EXISTS (
    SELECT 1
    FROM Students AS S2
    WHERE S1.FirstName = S2.FirstName
    AND S1.LastName = S2.LastName
    AND S1.Id <> S2.Id  -- –ù–µ —Ç–æ–π —Å–∞–º–∏–π –∑–∞–ø–∏—Å
);
```

### 10.4. –ó–Ω–∞–π—Ç–∏ "—Å–∏—Ä–æ—Ç–∏"

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –±–µ–∑ –≥—Ä—É–ø–∏ (–≥—Ä—É–ø–∞ –≤–∏–¥–∞–ª–µ–Ω–∞)
SELECT FirstName
FROM Students AS S
WHERE NOT EXISTS (
    SELECT 1
    FROM Groups AS G
    WHERE G.Id = S.GroupId
);
```

---

## 11. Best Practices

::card-group

::card{title="1. JOIN –∑–∞–º—ñ—Å—Ç—å IN" icon="i-lucide-zap"}

```sql
-- ‚úÖ –®–≤–∏–¥—à–µ
FROM Students S
INNER JOIN Groups G
    ON S.GroupId = G.Id

-- ‚ö†Ô∏è –ü–æ–≤—ñ–ª—å–Ω—ñ—à–µ
WHERE GroupId IN (
    SELECT Id FROM Groups
)
```

::

::card{title="2. EXISTS –∑–∞–º—ñ—Å—Ç—å IN" icon="i-lucide-check"}

```sql
-- ‚úÖ –î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è
WHERE EXISTS (SELECT 1 ...)

-- ‚ö†Ô∏è –î–ª—è —Å–ø–∏—Å–∫—É –∑–Ω–∞—á–µ–Ω—å
WHERE Id IN (1, 2, 3)
```

::

::card{title="3. –£–Ω–∏–∫–∞–π—Ç–µ Correlated" icon="i-lucide-alert-triangle"}

```sql
-- ‚ùå –ü–æ–≤—ñ–ª—å–Ω–æ (N –≤–∏–∫–æ–Ω–∞–Ω—å)
WHERE Grade > (
    SELECT AVG(Grade)
    WHERE GroupId = S.GroupId
)

-- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ CTE/JOIN
```

::

::card{title="4. Filter NULL –≤ NOT IN" icon="i-lucide-filter"}

```sql
WHERE Id NOT IN (
    SELECT DepartmentId
    FROM Teachers
    WHERE DepartmentId IS NOT NULL  -- !
)
```

::

::

---

## 12. –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

::accordion

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 1: –í–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ" icon="i-lucide-trending-up"}

–ó–Ω–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ –±–∞–ª–æ–º –≤–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–æ –≤—Å—ñ–π –ë–î.

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
SELECT FirstName, LastName, Grade
FROM Students
WHERE Grade > (
    SELECT AVG(Grade) FROM Students
)
ORDER BY Grade DESC;
```

</details>

::

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 2: –ü–æ—Ä–æ–∂–Ω—ñ –∫–∞—Ñ–µ–¥—Ä–∏" icon="i-lucide-building"}

–ó–Ω–∞–π—Ç–∏ –∫–∞—Ñ–µ–¥—Ä–∏ –±–µ–∑ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ NOT EXISTS.

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
SELECT Name
FROM Departments AS D
WHERE NOT EXISTS (
    SELECT 1
    FROM Teachers AS T
    WHERE T.DepartmentId = D.Id
);
```

</details>

::

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 3: –¢–æ–ø-5 –≥—Ä—É–ø" icon="i-lucide-award"}

–ì—Ä—É–ø–∏ –∑ –Ω–∞–π–≤–∏—â–∏–º —Å–µ—Ä–µ–¥–Ω—ñ–º –±–∞–ª–æ–º (—Ç–æ–ø-5).

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
SELECT
    G.Name,
    (
        SELECT AVG(S.Grade)
        FROM Students AS S
        WHERE S.GroupId = G.Id
    ) AS AvgGrade
FROM Groups AS G
ORDER BY AvgGrade DESC
OFFSET 0 ROWS FETCH NEXT 5 ROWS ONLY;
```

</details>

::

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 4: –ö—Ä–∞—â—ñ –∑–∞ –≥—Ä—É–ø—É" icon="i-lucide-star"}

–°—Ç—É–¥–µ–Ω—Ç–∏ –∑ –±–∞–ª–æ–º –≤–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ **–ø–æ —ó—Ö –≥—Ä—É–ø—ñ** (correlated).

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
SELECT S1.FirstName, S1.Grade, G.Name AS GroupName
FROM Students AS S1
INNER JOIN Groups AS G
    ON S1.GroupId = G.Id
WHERE S1.Grade > (
    SELECT AVG(S2.Grade)
    FROM Students AS S2
    WHERE S2.GroupId = S1.GroupId
);
```

</details>

::

::

---

## –†–µ–∑—é–º–µ

::tip
**–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏ –ø –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤**:

1. **–¢–∏–ø–∏ –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º**:
    - Scalar (–æ–¥–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è)
    - Table (—Ç–∞–±–ª–∏—Ü—è)
    - Row (–æ–¥–∏–Ω —Ä—è–¥–æ–∫)

2. **–ü–æ–∑–∏—Ü—ñ—ó**:
    - **WHERE**: —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è (`WHERE Grade > (SELECT ...))`)
    - **SELECT**: –æ–±—á–∏—Å–ª–µ–Ω–Ω—è (` SELECT (SELECT AVG...) AS Avg`)
    - **FROM**: derived tables

3. **–û–ø–µ—Ä–∞—Ç–æ—Ä–∏**:
    - **IN / NOT IN**: —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω—å
    - **EXISTS / NOT EXISTS**: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è (–∫—Ä–∞—â–µ –∑–∞ IN!)
    - **ANY / ALL**: –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –º–Ω–æ–∂–∏–Ω–æ—é

4. **Correlated Subqueries**:
    - –ó–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∑–∞–ø–∏—Ç—É
    - ‚ö†Ô∏è –ü–æ–≤—ñ–ª—å–Ω—ñ (–≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è N —Ä–∞–∑—ñ–≤)
    - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: CTE –∞–±–æ JOIN

5. **Performance**:
    - JOIN > EXISTS > IN
    - –£–Ω–∏–∫–∞–π—Ç–µ correlated –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤
    - –û—Å—Ç–µ—Ä—ñ–≥–∞–π—Ç–µ—Å—è NULL –≤ NOT IN

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏**:

- –ë–∞–≥–∞—Ç–æ—Ä—ñ–≤–Ω–µ–≤—ñ —É–º–æ–≤–∏
- Comparison –∑ –∞–≥—Ä–µ–≥–∞—Ç–∞–º–∏
- –ó–Ω–∞–π—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –∑–≤'—è–∑–∫–∏
- –î–∏–Ω–∞–º—ñ—á–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
  ::

---

**–ü–æ–ø–µ—Ä–µ–¥–Ω—è —Ç–µ–º–∞**: [CROSS —Ç–∞ SELF JOINs](./03.cross-self-joins.md)  
**–ù–∞—Å—Ç—É–ø–Ω–∞ —Ç–µ–º–∞**: [–ê–≥—Ä–µ–≥–∞—Ü—ñ—ó –∑ JOIN](./05.aggregations-with-joins.md)
