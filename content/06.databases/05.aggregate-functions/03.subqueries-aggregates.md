---
title: –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ –∑ –∞–≥—Ä–µ–≥–∞—Ç–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏
description: –°–∫–∞–ª—è—Ä–Ω—ñ, —Ç–∞–±–ª–∏—á–Ω—ñ —Ç–∞ –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏, CTE —Ç–∞ Window Functions —è–∫ —Å—É—á–∞—Å–Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
---

# –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ –∑ –∞–≥—Ä–µ–≥–∞—Ç–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏

## –í—Å—Ç—É–ø: –ö–æ–ª–∏ –ø—Ä–æ—Å—Ç–∏—Ö –∞–≥—Ä–µ–≥–∞—Ç—ñ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ?

–£ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —Ä–æ–∑–¥—ñ–ª–∞—Ö –º–∏ –Ω–∞–≤—á–∏–ª–∏—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∞–≥—Ä–µ–≥–∞—Ç–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ `GROUP BY` –¥–ª—è –±–∞–∑–æ–≤–∏—Ö –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—ñ–≤. –ê–ª–µ —â–æ —Ä–æ–±–∏—Ç–∏, –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ **–±—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞**?

### –†–µ–∞–ª—å–Ω–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π: "–ö—Ä–∞—â—ñ –∑–∞ —Å–µ—Ä–µ–¥–Ω—î"

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –ó–Ω–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤, —è–∫—ñ –æ—Ç—Ä–∏–º—É—é—Ç—å —Å—Ç–∏–ø–µ–Ω–¥—ñ—é **–≤–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ—ó**.

::tabs

::tab{label="‚ùå –°–ø—Ä–æ–±–∞ –±–µ–∑ –ø—ñ–¥–∑–∞–ø–∏—Ç—É"}

```sql
-- –ù–ï –ü–†–ê–¶–Æ–Ñ!
SELECT FirstName, LastName, Grants
FROM Students
WHERE Grants > AVG(Grants);
```

**–ü–æ–º–∏–ª–∫–∞**:

```
An aggregate may not appear in the WHERE clause
unless it is in a subquery contained in a HAVING clause
or a select list.
```

::

::tab{label="‚úÖ –†—ñ—à–µ–Ω–Ω—è –∑ –ø—ñ–¥–∑–∞–ø–∏—Ç–æ–º"}

```sql
SELECT FirstName, LastName, Grants
FROM Students
WHERE Grants > (SELECT AVG(Grants) FROM Students);
```

**–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î**:

1. **–ü—ñ–¥–∑–∞–ø–∏—Ç** `(SELECT AVG(Grants) ...)` –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–ü–ï–†–®–ò–ô** ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î `1201.50`
2. **–û—Å–Ω–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç** –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è: `WHERE Grants > 1201.50`

::

::

::note
**–ö–ª—é—á–æ–≤–∞ —ñ–¥–µ—è**: –ü—ñ–¥–∑–∞–ø–∏—Ç (Subquery) –¥–æ–∑–≤–æ–ª—è—î **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —ñ–Ω—à–æ–≥–æ**, —â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î –≤–µ–ª–∏—á–µ–∑–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –¥–ª—è —Å–∫–ª–∞–¥–Ω–æ—ó –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.
::

---

## –¢–∏–ø–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤

SQL Server –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä—ñ–∑–Ω—ñ –≤–∏–¥–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, **—â–æ –≤–æ–Ω–∏ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å**:

::mermaid

```mermaid
graph TD
    A[–ü—ñ–¥–∑–∞–ø–∏—Ç–∏<br/>Subqueries] --> B[–°–∫–∞–ª—è—Ä–Ω—ñ<br/>Scalar]
    A --> C[–¢–∞–±–ª–∏—á–Ω—ñ<br/>Table]
    A --> D[–ë–∞–≥–∞—Ç–æ–∑–Ω–∞—á–Ω—ñ<br/>Multi-valued]

    B --> B1[–ü–æ–≤–µ—Ä—Ç–∞—é—Ç—å<br/>–û–î–ù–ï –∑–Ω–∞—á–µ–Ω–Ω—è]
    C --> C1[–ü–æ–≤–µ—Ä—Ç–∞—é—Ç—å<br/>–¢–ê–ë–õ–ò–¶–Æ]
    D --> D1[–ü–æ–≤–µ—Ä—Ç–∞—é—Ç—å<br/>–û–î–ò–ù —Å—Ç–æ–≤–ø–µ—Ü—å<br/>–±–∞–≥–∞—Ç–æ —Ä—è–¥–∫—ñ–≤]

    B1 --> B2["–ü—Ä–∏–∫–ª–∞–¥:<br/>SELECT MAX(price)"]
    C1 --> C2["–ü—Ä–∏–∫–ª–∞–¥:<br/>SELECT * FROM ..."]
    D1 --> D2["–ü—Ä–∏–∫–ª–∞–¥:<br/>SELECT id FROM ..."]

    style A fill:#3b82f6,color:#fff
    style B fill:#10b981,color:#fff
    style C fill:#f59e0b,color:#000
    style D fill:#ef4444,color:#fff
```

::

---

## –°–∫–∞–ª—è—Ä–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏ (Scalar Subqueries)

**–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –ü—ñ–¥–∑–∞–ø–∏—Ç, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î **–¢–û–ß–ù–û –û–î–ù–ï** –∑–Ω–∞—á–µ–Ω–Ω—è (–æ–¥–∏–Ω —Ä—è–¥–æ–∫, –æ–¥–∏–Ω —Å—Ç–æ–≤–ø–µ—Ü—å).

### –î–µ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–∫–∞–ª—è—Ä–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏?

::tabs

::tab{label="–£ SELECT"}

```sql
-- –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–æ–∂–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ + —Å–µ—Ä–µ–¥–Ω—è —Å—Ç–∏–ø–µ–Ω–¥—ñ—è –ø–æ –≤—Å—ñ–π —Ç–∞–±–ª–∏—Ü—ñ
SELECT
    FirstName,
    LastName,
    Grants,
    (SELECT AVG(Grants) FROM Students) AS overall_avg,
    Grants - (SELECT AVG(Grants) FROM Students) AS diff_from_avg
FROM Students;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:

| FirstName | LastName | Grants | overall_avg | diff_from_avg |
| :-------- | :------- | -----: | ----------: | ------------: |
| John      | Doe      |   1200 |     1201.50 |         -1.50 |
| Jane      | Moore    |   1300 |     1201.50 |         98.50 |
| ...       | ...      |    ... |         ... |           ... |

::

::tab{label="–£ WHERE"}

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑—ñ —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é –≤–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ
SELECT FirstName, LastName, Grants
FROM Students
WHERE Grants > (SELECT AVG(Grants) FROM Students);
```

::

::tab{label="–£ HAVING"}

```sql
-- –ì—Ä—É–ø–∏, –¥–µ —Å–µ—Ä–µ–¥–Ω—è —Å—Ç–∏–ø–µ–Ω–¥—ñ—è –≤–∏—â–∞ –∑–∞ –∑–∞–≥–∞–ª—å–Ω—É —Å–µ—Ä–µ–¥–Ω—é
SELECT
    G.GroupName,
    AVG(S.Grants) AS avg_group_grant
FROM Students AS S
JOIN Groups AS G ON S.GroupId = G.Id
GROUP BY G.GroupName
HAVING AVG(S.Grants) > (SELECT AVG(Grants) FROM Students);
```

::

::

### –ê–Ω–∞—Ç–æ–º—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Å–∫–∞–ª—è—Ä–Ω–æ–≥–æ –ø—ñ–¥–∑–∞–ø–∏—Ç—É

```sql {4}
SELECT
    FirstName,
    LastName,
    Grants,
    (SELECT MAX(Grants) FROM Students) AS max_grant  -- –ü—ñ–¥–∑–∞–ø–∏—Ç
FROM Students
WHERE Grants > 1100;
```

**–ü–æ–∫—Ä–æ–∫–æ–≤–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è**:

::steps

### –ö—Ä–æ–∫ 1: –í–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—ñ–¥–∑–∞–ø–∏—Ç—É

```sql
SELECT MAX(Grants) FROM Students
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 1300
```

### –ö—Ä–æ–∫ 2: –ü—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É

```sql
-- –ó–∞–ø–∏—Ç —Å—Ç–∞—î —Ç–∞–∫–∏–º:
SELECT FirstName, LastName, Grants, 1300 AS max_grant
FROM Students
WHERE Grants > 1100;
```

### –ö—Ä–æ–∫ 3: –í–∏–∫–æ–Ω–∞–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É

SQL Server –≤–∏–∫–æ–Ω—É—î –≤–∂–µ –ø—Ä–æ—Å—Ç–∏–π –∑–∞–ø–∏—Ç –∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ—é `1300`

::

::tip
**–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è**: SQL Server **–∫–µ—à—É—î** —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–ª—è—Ä–Ω–æ–≥–æ –ø—ñ–¥–∑–∞–ø–∏—Ç—É, —Ç–æ–º—É –≤—ñ–Ω –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–ª–∏—à–µ —Ä–∞–∑**, –∞ –Ω–µ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞!
::

---

## –ë–∞–≥–∞—Ç–æ–∑–Ω–∞—á–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏ (Multi-valued Subqueries)

**–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –ü—ñ–¥–∑–∞–ø–∏—Ç, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î **–û–î–ò–ù —Å—Ç–æ–≤–ø–µ—Ü—å, –ë–ê–ì–ê–¢–û —Ä—è–¥–∫—ñ–≤**.

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –∫—ñ–ª—å–∫–æ–º–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏

```sql
-- ‚ùå –ü–û–ú–ò–õ–ö–ê!
SELECT * FROM Students
WHERE GroupId = (SELECT Id FROM Groups WHERE GroupName LIKE '30%');
```

**–ü–æ–º–∏–ª–∫–∞**:

```
Subquery returned more than 1 value. This is not permitted
when the subquery follows =, !=, <, <=, >, >=
```

**–ß–æ–º—É**: –ü—ñ–¥–∑–∞–ø–∏—Ç –ø–æ–≤–µ—Ä–Ω—É–≤ `[1, 2]` (–¥–≤—ñ –≥—Ä—É–ø–∏: 30PR11 —ñ 30PR12), –∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä `=` –º–æ–∂–µ –ø–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∑ **–û–î–ù–ò–ú** –∑–Ω–∞—á–µ–Ω–Ω—è–º.

### –†—ñ—à–µ–Ω–Ω—è: –û–ø–µ—Ä–∞—Ç–æ—Ä–∏ IN, NOT IN, ANY, ALL

::tabs

::tab{label="IN"}

```sql
-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ó–Ω–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ –≥—Ä—É–ø, —è–∫—ñ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –Ω–∞ '30'
SELECT FirstName, LastName
FROM Students
WHERE GroupId IN (SELECT Id FROM Groups WHERE GroupName LIKE '30%');
```

**–ï–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç –±–µ–∑ –ø—ñ–¥–∑–∞–ø–∏—Ç—É**:

```sql
WHERE GroupId = 1 OR GroupId = 2
```

::

::tab{label="NOT IN"}

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –ù–ï –∑ –≥—Ä—É–ø, —è–∫—ñ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –Ω–∞ '30'
SELECT FirstName, LastName
FROM Students
WHERE GroupId NOT IN (SELECT Id FROM Groups WHERE GroupName LIKE '30%');
```

::warning
**–ü–∞—Å—Ç–∫–∞ NULL**: –Ø–∫—â–æ –ø—ñ–¥–∑–∞–ø–∏—Ç –ø–æ–≤–µ—Ä—Ç–∞—î NULL, `NOT IN` –º–æ–∂–µ –¥–∞—Ç–∏ **–Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**!

```sql
-- –Ø–∫—â–æ –ø—ñ–¥–∑–∞–ø–∏—Ç –ø–æ–≤–µ—Ä—Ç–∞—î [1, 2, NULL]
WHERE GroupId NOT IN (1, 2, NULL)
-- –¶–µ –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω–æ:
WHERE GroupId != 1 AND GroupId != 2 AND GroupId != NULL
-- GroupId != NULL –∑–∞–≤–∂–¥–∏ UNKNOWN ‚Üí –≤–µ—Å—å WHERE —Å—Ç–∞—î FALSE!
```

**–†—ñ—à–µ–Ω–Ω—è**: –§—ñ–ª—å—Ç—Ä—É–π—Ç–µ NULL —É –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ:

```sql
WHERE GroupId NOT IN (SELECT Id FROM Groups WHERE Id IS NOT NULL)
```

::

::

::tab{label="ANY / SOME"}

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑—ñ —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é –±—ñ–ª—å—à–æ—é –∑–∞ –ë–£–î–¨-–Ø–ö–£ —Å—Ç–∏–ø–µ–Ω–¥—ñ—é –≤ –≥—Ä—É–ø—ñ 30PR11
SELECT FirstName, LastName, Grants
FROM Students
WHERE Grants > ANY (
    SELECT Grants
    FROM Students AS S
    JOIN Groups AS G ON S.GroupId = G.Id
    WHERE G.GroupName = '30PR11'
);
```

**–õ–æ–≥—ñ–∫–∞**: `> ANY (100, 200, 300)` –æ–∑–Ω–∞—á–∞—î `> 100 OR > 200 OR > 300` (—Ñ–∞–∫—Ç–∏—á–Ω–æ `> MIN`)

::

::tab{label="ALL"}

```sql
-- –°—Ç—É–¥–µ–Ω—Ç–∏ –∑—ñ —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é –±—ñ–ª—å—à–æ—é –∑–∞ –í–°–Ü —Å—Ç–∏–ø–µ–Ω–¥—ñ—ó –≤ –≥—Ä—É–ø—ñ 30PR11
SELECT FirstName, LastName, Grants
FROM Students
WHERE Grants > ALL (
    SELECT Grants
    FROM Students AS S
    JOIN Groups AS G ON S.GroupId = G.Id
    WHERE G.GroupName = '30PR11'
);
```

**–õ–æ–≥—ñ–∫–∞**: `> ALL (100, 200, 300)` –æ–∑–Ω–∞—á–∞—î `> 100 AND > 200 AND > 300` (—Ñ–∞–∫—Ç–∏—á–Ω–æ `> MAX`)

::

::

---

## –¢–∞–±–ª–∏—á–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏ (Table Subqueries)

**–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –ü—ñ–¥–∑–∞–ø–∏—Ç, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î **–ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω—É —Ç–∞–±–ª–∏—Ü—é** (–±–∞–≥–∞—Ç–æ —Ä—è–¥–∫—ñ–≤, –±–∞–≥–∞—Ç–æ —Å—Ç–æ–≤–ø—Ü—ñ–≤) —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É **FROM**.

### –ë–∞–∑–æ–≤–∏–π –ø—Ä–∏–∫–ª–∞–¥

```sql
SELECT *
FROM (
    SELECT
        FirstName,
        LastName,
        Grants,
        CASE
            WHEN Grants >= 1200 THEN '–í–∏—Å–æ–∫–∞'
            WHEN Grants >= 1100 THEN '–°–µ—Ä–µ–¥–Ω—è'
            ELSE '–ù–∏–∑—å–∫–∞'
        END AS grant_category
    FROM Students
) AS categorized_students
WHERE grant_category = '–í–∏—Å–æ–∫–∞';
```

**–ê–Ω–∞—Ç–æ–º—ñ—è**:

1. **–ü—ñ–¥–∑–∞–ø–∏—Ç** —Å—Ç–≤–æ—Ä—é—î –≤—ñ—Ä—Ç—É–∞–ª—å–Ω—É —Ç–∞–±–ª–∏—Ü—é –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º —Å—Ç–æ–≤–ø—Ü–µ–º `grant_category`
2. **AS categorized_students** ‚Äî **–æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π** –ø—Å–µ–≤–¥–æ–Ω—ñ–º –¥–ª—è –ø—ñ–¥–∑–∞–ø–∏—Ç—É
3. **–û—Å–Ω–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç** —Ñ—ñ–ª—å—Ç—Ä—É—î —Ü—é —Ç–∞–±–ª–∏—Ü—é

::warning
**–ö—Ä–∏—Ç–∏—á–Ω–æ**: –ü—ñ–¥–∑–∞–ø–∏—Ç —É FROM **–ó–ê–í–ñ–î–ò** –ø–æ—Ç—Ä–µ–±—É—î **–ø—Å–µ–≤–¥–æ–Ω—ñ–º—É** (AS)!

```sql
-- ‚ùå –ü–û–ú–ò–õ–ö–ê
SELECT * FROM (SELECT * FROM Students);

-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
SELECT * FROM (SELECT * FROM Students) AS S;
```

::

### –°–∫–ª–∞–¥–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥: –ê–≥—Ä–µ–≥–∞—Ü—ñ—è + —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –ó–Ω–∞–π—Ç–∏ –≥—Ä—É–ø–∏, –¥–µ —Å–µ—Ä–µ–¥–Ω—è —Å—Ç–∏–ø–µ–Ω–¥—ñ—è > 1200, —Ç–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ —Ü–∏—Ö –≥—Ä—É–ø.

```sql
SELECT
    S.FirstName,
    S.LastName,
    S.Grants,
    high_grant_groups.avg_grant
FROM Students AS S
JOIN (
    -- –ü—ñ–¥–∑–∞–ø–∏—Ç: –≥—Ä—É–ø–∏ –∑ –≤–∏—Å–æ–∫–æ—é —Å–µ—Ä–µ–¥–Ω—å–æ—é —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é
    SELECT
        GroupId,
        AVG(Grants) AS avg_grant
    FROM Students
    GROUP BY GroupId
    HAVING AVG(Grants) > 1200
) AS high_grant_groups ON S.GroupId = high_grant_groups.GroupId;
```

**–ü–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è**:

1. –ü—ñ–¥–∑–∞–ø–∏—Ç —Å—Ç–≤–æ—Ä—é—î —Ç–∞–±–ª–∏—Ü—é `high_grant_groups` –∑ –≥—Ä—É–ø–∞–º–∏, –¥–µ AVG > 1200
2. JOIN –∑'—î–¥–Ω—É—î Students –∑ —Ü—ñ—î—é –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ—é —Ç–∞–±–ª–∏—Ü–µ—é
3. –ü–æ–∫–∞–∑—É—é—Ç—å—Å—è –≤—Å—ñ —Å—Ç—É–¥–µ–Ω—Ç–∏ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –≥—Ä—É–ø

---

## –ö–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏ (Correlated Subqueries)

**–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –ü—ñ–¥–∑–∞–ø–∏—Ç, —è–∫–∏–π **–∑–∞–ª–µ–∂–∏—Ç—å** –≤—ñ–¥ –∑–Ω–∞—á–µ–Ω—å –∑ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∑–∞–ø–∏—Ç—É —ñ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞** –æ–∫—Ä–µ–º–æ.

### –í—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –≤—ñ–¥ –∑–≤–∏—á–∞–π–Ω–∏—Ö –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤

::tabs

::tab{label="–ù–µ–∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏–π (–∑–≤–∏—á–∞–π–Ω–∏–π)"}

```sql
-- –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –û–î–ò–ù –†–ê–ó
SELECT * FROM Students
WHERE Grants > (SELECT AVG(Grants) FROM Students);
```

**–í–∏–∫–æ–Ω–∞–Ω–Ω—è**:

1. –ü—ñ–¥–∑–∞–ø–∏—Ç ‚Üí `1201.50`
2. –û—Å–Ω–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç ‚Üí `WHERE Grants > 1201.50`

**–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**: ‚ö° –®–≤–∏–¥–∫–æ (–ø—ñ–¥–∑–∞–ø–∏—Ç –ª–∏—à–µ —Ä–∞–∑)

::

::tab{label="–ö–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏–π"}

```sql
-- –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –î–õ–Ø –ö–û–ñ–ù–û–ì–û –†–Ø–î–ö–ê
SELECT
    S1.FirstName,
    S1.LastName,
    S1.Grants,
    (SELECT AVG(S2.Grants)
     FROM Students AS S2
     WHERE S2.GroupId = S1.GroupId) AS group_avg
FROM Students AS S1;
```

**–í–∏–∫–æ–Ω–∞–Ω–Ω—è**:

- –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ #1: –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ `GroupId = 1` ‚Üí `1150`
- –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ #2: –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ `GroupId = 1` ‚Üí `1150` (—Ç–æ–π —Å–∞–º–∏–π)
- –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ #3: –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ `GroupId = 2` ‚Üí `1280`
- ...

**–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**: üêå –ü–æ–≤—ñ–ª—å–Ω–æ (–ø—ñ–¥–∑–∞–ø–∏—Ç N —Ä–∞–∑—ñ–≤, –¥–µ N = –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤)

::

::

### –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–æ–≥–æ –ø—ñ–¥–∑–∞–ø–∏—Ç—É

::mermaid

```mermaid
sequenceDiagram
    participant Main as –û—Å–Ω–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç
    participant Sub as –ö–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç

    Main->>Main: –ß–∏—Ç–∞—î —Å—Ç—É–¥–µ–Ω—Ç–∞ #1 (GroupId=1)
    Main->>Sub: –í–∏–∫–æ–Ω—É—î –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ GroupId=1
    Sub-->>Main: –ü–æ–≤–µ—Ä—Ç–∞—î AVG=1150
    Main->>Main: –ó–∞–ø–∏—Å—É—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ #1

    Main->>Main: –ß–∏—Ç–∞—î —Å—Ç—É–¥–µ–Ω—Ç–∞ #2 (GroupId=1)
    Main->>Sub: –í–∏–∫–æ–Ω—É—î –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ GroupId=1
    Sub-->>Main: –ü–æ–≤–µ—Ä—Ç–∞—î AVG=1150
    Main->>Main: –ó–∞–ø–∏—Å—É—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ #2

    Main->>Main: –ß–∏—Ç–∞—î —Å—Ç—É–¥–µ–Ω—Ç–∞ #3 (GroupId=2)
    Main->>Sub: –í–∏–∫–æ–Ω—É—î –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ GroupId=2
    Sub-->>Main: –ü–æ–≤–µ—Ä—Ç–∞—î AVG=1280
    Main->>Main: –ó–∞–ø–∏—Å—É—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ #3

    Note over Main,Sub: –ü—ñ–¥–∑–∞–ø–∏—Ç –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è<br/>–¥–ª—è –ö–û–ñ–ù–û–ì–û —Ä—è–¥–∫–∞!
```

::

### –ü—Ä–∞–∫—Ç–∏—á–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥: EXISTS

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –ó–Ω–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤, —è–∫—ñ –Ω–∞–≤—á–∞—é—Ç—å—Å—è –≤ –≥—Ä—É–ø–∞—Ö –∑ –ø–æ—Ç–æ–∫—É 30.

```sql
SELECT FirstName, LastName
FROM Students AS S
WHERE EXISTS (
    SELECT 1
    FROM Groups AS G
    WHERE G.Id = S.GroupId
      AND G.GroupName LIKE '30%'
);
```

**–Ø–∫ –ø—Ä–∞—Ü—é—î EXISTS**:

- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ **—ñ—Å–Ω—É—î** –≥—Ä—É–ø–∞ –∑ –ø–æ—Ç–æ–∫—É 30
- –Ø–∫—â–æ —Ç–∞–∫ ‚Üí TRUE ‚Üí —Å—Ç—É–¥–µ–Ω—Ç –ø–æ—Ç—Ä–∞–ø–ª—è—î —É —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –Ø–∫—â–æ –Ω—ñ ‚Üí FALSE ‚Üí —Å—Ç—É–¥–µ–Ω—Ç —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è

::tip
**EXISTS vs IN**: –î–ª—è –≤–µ–ª–∏–∫–∏—Ö —Ç–∞–±–ª–∏—Ü—å `EXISTS` —á–∞—Å—Ç–æ **—à–≤–∏–¥—à–∏–π** –∑–∞ `IN`, –±–æ –≤—ñ–Ω –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è –Ω–∞ **–ø–µ—Ä—à–æ–º—É –∑–Ω–∞–π–¥–µ–Ω–æ–º—É** —Ä—è–¥–∫—É, –∞ `IN` –∑–∞–≤–∂–¥–∏ —á–∏—Ç–∞—î –≤—Å—ñ.

```sql
-- ‚úÖ –®–≤–∏–¥—à–µ –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö —Ç–∞–±–ª–∏—Ü—å
WHERE EXISTS (SELECT 1 FROM Groups WHERE ...)

-- üêå –ü–æ–≤—ñ–ª—å–Ω—ñ—à–µ, –±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≤—Å—ñ ID
WHERE GroupId IN (SELECT Id FROM Groups WHERE ...)
```

::

---

## CTE (Common Table Expressions)

**–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –Ü–º–µ–Ω–æ–≤–∞–Ω–∏–π —Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Ç—É, —è–∫–∏–π –º–æ–∂–Ω–∞ **–ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏** —É –æ—Å–Ω–æ–≤–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ.

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
WITH cte_name AS (
    -- –ó–∞–ø–∏—Ç CTE
    SELECT ...
)
-- –û—Å–Ω–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç
SELECT * FROM cte_name;
```

### –ü–µ—Ä–µ–≤–∞–≥–∏ –ø–µ—Ä–µ–¥ –ø—ñ–¥–∑–∞–ø–∏—Ç–∞–º–∏

::tabs

::tab{label="–ü—ñ–¥–∑–∞–ø–∏—Ç —É FROM (—Å–∫–ª–∞–¥–Ω–æ —á–∏—Ç–∞—Ç–∏)"}

```sql
SELECT
    S.FirstName,
    S.LastName,
    high_groups.avg_grant
FROM Students AS S
JOIN (
    SELECT GroupId, AVG(Grants) AS avg_grant
    FROM Students
    GROUP BY GroupId
    HAVING AVG(Grants) > 1200
) AS high_groups ON S.GroupId = high_groups.GroupId
JOIN (
    SELECT GroupId, COUNT(*) AS student_count
    FROM Students
    GROUP BY GroupId
) AS group_counts ON S.GroupId = group_counts.GroupId;
```

**–ü—Ä–æ–±–ª–µ–º–∏**:

- –í–∞–∂–∫–æ —á–∏—Ç–∞—Ç–∏ (–≤–∫–ª–∞–¥–µ–Ω—ñ—Å—Ç—å)
- –ù–µ–º–æ–∂–ª–∏–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç

::

::tab{label="CTE (—á–∏—Ç–∞–±–µ–ª—å–Ω–æ)"}

```sql
WITH HighGrantGroups AS (
    SELECT GroupId, AVG(Grants) AS avg_grant
    FROM Students
    GROUP BY GroupId
    HAVING AVG(Grants) > 1200
),
GroupCounts AS (
    SELECT GroupId, COUNT(*) AS student_count
    FROM Students
    GROUP BY GroupId
)
SELECT
    S.FirstName,
    S.LastName,
    HGG.avg_grant,
    GC.student_count
FROM Students AS S
JOIN HighGrantGroups AS HGG ON S.GroupId = HGG.GroupId
JOIN GroupCounts AS GC ON S.GroupId = GC.GroupId;
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**:

- ‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–∏–π –ø–æ—Ä—è–¥–æ–∫ (–∑–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)
- ‚úÖ –ú–æ–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ CTE
- ‚úÖ –õ–µ–≥–∫–æ –¥–µ–±–∞–∂–∏—Ç–∏ (–≤–∏–∫–æ–Ω–∞–π—Ç–µ CTE –æ–∫—Ä–µ–º–æ)

::

::

### –†–µ–∫—É—Ä—Å–∏–≤–Ω—ñ CTE

CTE –º–æ–∂–µ **–ø–æ—Å–∏–ª–∞—Ç–∏—Å—è —Å–∞–º –Ω–∞ —Å–µ–±–µ** ‚Äî —Ü–µ –¥–æ–∑–≤–æ–ª—è—î –æ–±—Ä–æ–±–ª—è—Ç–∏ **—ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω—ñ –¥–∞–Ω—ñ**.

**–ü—Ä–∏–∫–ª–∞–¥: –Ü—î—Ä–∞—Ä—Ö—ñ—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤**

```sql
WITH EmployeeHierarchy AS (
    -- Anchor: –¢–æ–ø-–º–µ–Ω–µ–¥–∂–µ—Ä (–±–µ–∑ –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞)
    SELECT
        employee_id,
        name,
        manager_id,
        1 AS level
    FROM Employees
    WHERE manager_id IS NULL

    UNION ALL

    -- Recursive: –ü—ñ–¥–ª–µ–≥–ª—ñ
    SELECT
        E.employee_id,
        E.name,
        E.manager_id,
        EH.level + 1
    FROM Employees AS E
    JOIN EmployeeHierarchy AS EH ON E.manager_id = EH.employee_id
)
SELECT * FROM EmployeeHierarchy
ORDER BY level, name;
```

::note
**–û–±–º–µ–∂–µ–Ω–Ω—è**: –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ä–µ–∫—É—Ä—Å—ñ—è –æ–±–º–µ–∂–µ–Ω–∞ **100 —Ä—ñ–≤–Ω—è–º–∏**. –î–ª—è –∑–±—ñ–ª—å—à–µ–Ω–Ω—è:

```sql
WITH EmployeeHierarchy AS (...)
SELECT * FROM EmployeeHierarchy
OPTION (MAXRECURSION 1000);  -- –ú–∞–∫—Å 1000 —Ä—ñ–≤–Ω—ñ–≤
```

::

---

## Window Functions: –°—É—á–∞—Å–Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏ –ø–æ–≤—ñ–ª—å–Ω—ñ. Window Functions –≤–∏—Ä—ñ—à—É—é—Ç—å —Ü–µ –µ–ª–µ–≥–∞–Ω—Ç–Ω–æ.

### –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—ñ–¥—Ö–æ–¥—ñ–≤

::code-group

```sql [‚ùå –ö–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç (–ø–æ–≤—ñ–ª—å–Ω–æ)]
-- –î–ª—è –ö–û–ñ–ù–û–ì–û —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ–∫—Ä–µ–º–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç
SELECT
    FirstName,
    LastName,
    Grants,
    (SELECT AVG(Grants)
     FROM Students AS S2
     WHERE S2.GroupId = S1.GroupId) AS group_avg
FROM Students AS S1;
-- –ù–∞ 10,000 —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤: 10,000 –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤!
```

```sql [‚úÖ Window Function (—à–≤–∏–¥–∫–æ)]
-- –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –û–î–ò–ù –†–ê–ó, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–µ—à—É—î—Ç—å—Å—è –¥–ª—è –≥—Ä—É–ø
SELECT
    FirstName,
    LastName,
    Grants,
    AVG(Grants) OVER (PARTITION BY GroupId) AS group_avg
FROM Students;
-- –ù–∞ 10,000 —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤: 1 –ø—Ä–æ—Ö–æ–¥!
```

::

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å Window Functions

```sql
<–∞–≥—Ä–µ–≥–∞—Ç–Ω–∞_—Ñ—É–Ω–∫—Ü—ñ—è> OVER (
    [PARTITION BY <—Å—Ç–æ–≤–ø—Ü—ñ_–≥—Ä—É–ø—É–≤–∞–Ω–Ω—è>]
    [ORDER BY <—Å—Ç–æ–≤–ø—Ü—ñ_—Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è>]
    [ROWS/RANGE <–≤—ñ–∫–Ω–æ>]
)
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è**:

- `PARTITION BY` ‚Äî –∞–Ω–∞–ª–æ–≥ `GROUP BY`, –∞–ª–µ **–ù–ï** –∑–≥–æ—Ä—Ç–∞—î —Ä—è–¥–∫–∏
- `ORDER BY` ‚Äî —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–∞—Ä—Ç–∏—Ü—ñ—ó
- `ROWS/RANGE` ‚Äî –≤–∏–∑–Ω–∞—á–∞—î "–≤—ñ–∫–Ω–æ" —Ä—è–¥–∫—ñ–≤ –¥–ª—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è

### –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ Window Functions

::tabs

::tab{label="AVG –ø–æ –≥—Ä—É–ø–∞—Ö"}

```sql
SELECT
    FirstName,
    LastName,
    GroupId,
    Grants,
    AVG(Grants) OVER (PARTITION BY GroupId) AS group_avg,
    Grants - AVG(Grants) OVER (PARTITION BY GroupId) AS diff_from_group_avg
FROM Students;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:

| FirstName | GroupId | Grants | group_avg | diff_from_group_avg |
| :-------- | ------: | -----: | --------: | ------------------: |
| John      |       1 |   1200 |   1166.67 |               33.33 |
| Jane      |       1 |   1100 |   1166.67 |              -66.67 |
| Mike      |       1 |   1200 |   1166.67 |               33.33 |
| Anna      |       2 |   1300 |   1278.00 |               22.00 |

::

::tab{label="ROW_NUMBER - –ù—É–º–µ—Ä–∞—Ü—ñ—è"}

```sql
SELECT
    FirstName,
    LastName,
    Grants,
    ROW_NUMBER() OVER (ORDER BY Grants DESC) AS rank_overall,
    ROW_NUMBER() OVER (PARTITION BY GroupId ORDER BY Grants DESC) AS rank_in_group
FROM Students;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:

| FirstName | Grants | rank_overall | rank_in_group |
| :-------- | -----: | -----------: | ------------: |
| Mike      |   1300 |            1 |             1 |
| Anna      |   1300 |            2 |             1 |
| John      |   1256 |            3 |             2 |
| Peter     |   1200 |            4 |             1 |

::

::tab{label="Running Total (–ù–∞–∫–æ–ø–∏—á—É–≤–∞–ª—å–Ω–∞ —Å—É–º–∞)"}

```sql
SELECT
    order_date,
    daily_sales,
    SUM(daily_sales) OVER (ORDER BY order_date) AS running_total
FROM DailySales;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:

| order_date | daily_sales | running_total |
| :--------- | ----------: | ------------: |
| 2024-01-01 |        1000 |          1000 |
| 2024-01-02 |        1500 |          2500 |
| 2024-01-03 |        1200 |          3700 |

::

::

---

## –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ vs JOIN: –ö–æ–ª–∏ —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?

### –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è

| –ö—Ä–∏—Ç–µ—Ä—ñ–π              | –ü—ñ–¥–∑–∞–ø–∏—Ç                        | JOIN                        |
| :-------------------- | :------------------------------ | :-------------------------- |
| **–ß–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å**     | üü° –°–∫–ª–∞–¥–Ω–æ –ø—Ä–∏ –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ      | ‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª—ñ—à–µ –¥–ª—è –±–∞–≥–∞—Ç—å–æ—Ö |
| **–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**    | üî¥ –ü–æ–≤—ñ–ª—å–Ω–æ (–∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ)       | ‚úÖ –®–≤–∏–¥—à–µ (–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ)    |
| **–ì–Ω—É—á–∫—ñ—Å—Ç—å**         | ‚úÖ –ó—Ä—É—á–Ω–æ –¥–ª—è EXISTS/NOT EXISTS | üü° –ú–µ–Ω—à –≥–Ω—É—á–∫–æ              |
| **–î—É–±–ª—é–≤–∞–Ω–Ω—è —Ä—è–¥–∫—ñ–≤** | ‚úÖ –ù–µ–º–∞—î –¥—É–±–ª—é–≤–∞–Ω–Ω—è             | üî¥ –ú–æ–∂–ª–∏–≤–µ –ø—Ä–∏ 1:N –∑–≤'—è–∑–∫–∞—Ö |
| **CTE —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å**    | ‚úÖ –ú–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ CTE        | ‚úÖ –ü—Ä–∞—Ü—é—î –∑ CTE             |

### –ü—Ä–∏–∫–ª–∞–¥: –°—Ç—É–¥–µ–Ω—Ç–∏ –∑ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—é —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é

::code-group

```sql [–ü—ñ–¥–∑–∞–ø–∏—Ç]
SELECT FirstName, LastName, Grants
FROM Students
WHERE Grants = (SELECT MAX(Grants) FROM Students);
```

```sql [JOIN (—Å–∫–ª–∞–¥–Ω—ñ—à–µ)]
SELECT S.FirstName, S.LastName, S.Grants
FROM Students AS S
JOIN (
    SELECT MAX(Grants) AS max_grant
    FROM Students
) AS MaxGrant ON S.Grants = MaxGrant.max_grant;
```

```sql [Window Function (–Ω–∞–π–∫—Ä–∞—â–µ)]
WITH RankedStudents AS (
    SELECT
        FirstName,
        LastName,
        Grants,
        RANK() OVER (ORDER BY Grants DESC) AS grant_rank
    FROM Students
)
SELECT FirstName, LastName, Grants
FROM RankedStudents
WHERE grant_rank = 1;
```

::

::tip
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó**:

1. **–°–∫–∞–ª—è—Ä–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏** ‚Üí OK –¥–ª—è –ø—Ä–æ—Å—Ç–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤
2. **–ö–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏** ‚Üí –∑–∞–º—ñ–Ω—é–π—Ç–µ –Ω–∞ Window Functions
3. **–°–∫–ª–∞–¥–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏** ‚Üí –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ CTE
4. **EXISTS/NOT EXISTS** ‚Üí –∑–∞–ª–∏—à–∞–π—Ç–µ —è–∫ —î (–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ SQL Server)

::

---

## –¢–∏–ø–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏ —Ç–∞ Anti-Patterns

### ‚ùå –ü–æ–º–∏–ª–∫–∞ 1: –ë—ñ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è —É —Å–∫–∞–ª—è—Ä–Ω–æ–º—É –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ

```sql
-- ‚ùå –ü–û–ú–ò–õ–ö–ê
SELECT * FROM Students
WHERE Grants = (SELECT Grants FROM Students WHERE FirstName = 'John');
-- –Ø–∫—â–æ —î 2 John'–∏, –ø—ñ–¥–∑–∞–ø–∏—Ç –ø–æ–≤–µ—Ä–Ω–µ 2 –∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí –ü–û–ú–ò–õ–ö–ê!
```

**–†—ñ—à–µ–Ω–Ω—è**:

```sql
-- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ IN –∞–±–æ –æ–±–º–µ–∂—Ç–µ –ø—ñ–¥–∑–∞–ø–∏—Ç
WHERE Grants IN (SELECT Grants FROM Students WHERE FirstName = 'John');
```

---

### ‚ùå –ü–æ–º–∏–ª–∫–∞ 2: NULL —É NOT IN

```sql
-- ‚ùå –ü–ê–°–¢–ö–ê
SELECT * FROM Students
WHERE GroupId NOT IN (SELECT GroupId FROM Groups WHERE GroupName LIKE '30%');
-- –Ø–∫—â–æ –ø—ñ–¥–∑–∞–ø–∏—Ç –ø–æ–≤–µ—Ä–Ω–µ NULL ‚Üí –≤–µ—Å—å WHERE —Å—Ç–∞–Ω–µ FALSE!
```

**–†—ñ—à–µ–Ω–Ω—è**:

```sql
-- ‚úÖ –§—ñ–ª—å—Ç—Ä—É–π—Ç–µ NULL
WHERE GroupId NOT IN (
    SELECT GroupId FROM Groups
    WHERE GroupName LIKE '30%' AND GroupId IS NOT NULL
);

-- ‚úÖ –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ NOT EXISTS
WHERE NOT EXISTS (
    SELECT 1 FROM Groups AS G
    WHERE G.Id = Students.GroupId AND G.GroupName LIKE '30%'
);
```

---

### ‚ùå Anti-Pattern: –ù–∞–¥–º—ñ—Ä–Ω—ñ –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏

```sql
-- ‚ùå –ü–û–í–Ü–õ–¨–ù–û: –î–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ 3 –ø—ñ–¥–∑–∞–ø–∏—Ç–∏!
SELECT
    FirstName,
    (SELECT AVG(Grants) FROM Students AS S2 WHERE S2.GroupId = S1.GroupId) AS avg,
    (SELECT MIN(Grants) FROM Students AS S2 WHERE S2.GroupId = S1.GroupId) AS min,
    (SELECT MAX(Grants) FROM Students AS S2 WHERE S2.GroupId = S1.GroupId) AS max
FROM Students AS S1;
```

**–†—ñ—à–µ–Ω–Ω—è**:

```sql
-- ‚úÖ –®–í–ò–î–ö–û: Window Functions
SELECT
    FirstName,
    AVG(Grants) OVER (PARTITION BY GroupId) AS avg,
    MIN(Grants) OVER (PARTITION BY GroupId) AS min,
    MAX(Grants) OVER (PARTITION BY GroupId) AS max
FROM Students;
```

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

::steps

### –°–∫–∞–ª—è—Ä–Ω–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –ó–Ω–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤, —Å—Ç–∏–ø–µ–Ω–¥—ñ—è —è–∫–∏—Ö –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ —Å–µ—Ä–µ–¥–Ω—å–æ—ó –±—ñ–ª—å—à –Ω—ñ–∂ –Ω–∞ 100 –≥—Ä–Ω

::collapsible{label="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è"}

```sql
SELECT FirstName, LastName, Grants
FROM Students
WHERE ABS(Grants - (SELECT AVG(Grants) FROM Students)) > 100;
```

::

### EXISTS vs IN

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –ó–Ω–∞–π—Ç–∏ –≥—Ä—É–ø–∏, –≤ —è–∫–∏—Ö —î —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç –∑—ñ —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é > 1200

::collapsible{label="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è"}

```sql
-- –í–∞—Ä—ñ–∞–Ω—Ç 1: EXISTS (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
SELECT GroupName
FROM Groups AS G
WHERE EXISTS (
    SELECT 1 FROM Students AS S
    WHERE S.GroupId = G.Id AND S.Grants > 1200
);

-- –í–∞—Ä—ñ–∞–Ω—Ç 2: IN
SELECT GroupName
FROM Groups
WHERE Id IN (
    SELECT DISTINCT GroupId FROM Students WHERE Grants > 1200
);
```

::

### CTE + Window Function

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –î–ª—è –∫–æ–∂–Ω–æ—ó –≥—Ä—É–ø–∏ –ø–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ–ø-3 —Å—Ç—É–¥–µ–Ω—Ç–∏ –∑ –Ω–∞–π–≤–∏—â–æ—é —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é

::collapsible{label="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è"}

```sql
WITH RankedStudents AS (
    SELECT
        S.FirstName,
        S.LastName,
        S.Grants,
        G.GroupName,
        ROW_NUMBER() OVER (PARTITION BY S.GroupId ORDER BY S.Grants DESC) AS rank
    FROM Students AS S
    JOIN Groups AS G ON S.GroupId = G.Id
)
SELECT GroupName, FirstName, LastName, Grants
FROM RankedStudents
WHERE rank <= 3
ORDER BY GroupName, rank;
```

::

::

---

## –†–µ–∑—é–º–µ

::note
**–ö–ª—é—á–æ–≤—ñ –≤–∏—Å–Ω–æ–≤–∫–∏**:

1. **–ü—ñ–¥–∑–∞–ø–∏—Ç–∏** –¥–æ–∑–≤–æ–ª—è—é—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —ñ–Ω—à–æ–≥–æ
2. **3 —Ç–∏–ø–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤**: –°–∫–∞–ª—è—Ä–Ω—ñ (1 –∑–Ω–∞—á–µ–Ω–Ω—è), –ë–∞–≥–∞—Ç–æ–∑–Ω–∞—á–Ω—ñ (1 —Å—Ç–æ–≤–ø–µ—Ü—å, N —Ä—è–¥–∫—ñ–≤), –¢–∞–±–ª–∏—á–Ω—ñ (—Ç–∞–±–ª–∏—Ü—è)
3. **–ö–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏** –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞ ‚Üí **–ø–æ–≤—ñ–ª—å–Ω–æ**
4. **CTE** —Ä–æ–±–ª—è—Ç—å –∫–æ–¥ —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—à–∏–º —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏–º
5. **Window Functions** ‚Äî —Å—É—á–∞—Å–Ω–∞ –∑–∞–º—ñ–Ω–∞ –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏–º –ø—ñ–¥–∑–∞–ø–∏—Ç–∞–º
6. **EXISTS** —à–≤–∏–¥—à–∏–π –∑–∞ **IN** –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö —Ç–∞–±–ª–∏—Ü—å
7. **–û—Å—Ç–µ—Ä—ñ–≥–∞–π—Ç–µ—Å—å NULL** —É `NOT IN`

::

::tip
**–©–æ –¥–∞–ª—ñ?**

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ —Ç–µ–º–∏ –¥–ª—è –ø–æ–≥–ª–∏–±–ª–µ–Ω–æ–≥–æ –≤–∏–≤—á–µ–Ω–Ω—è:

- Execution Plans –¥–ª—è –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤
- –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Å–∫–ª–∞–¥–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
- Advanced Window Functions (LAG, LEAD, PERCENTILE)
- Temporal Tables –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó –∑–º—ñ–Ω

::

---

## –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏

- [–û—Ñ—ñ—Ü—ñ–π–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è: Subqueries](https://learn.microsoft.com/en-us/sql/relational-databases/performance/subqueries)
- [Common Table Expressions (CTE)](https://learn.microsoft.com/en-us/sql/t-sql/queries/with-common-table-expression-transact-sql)
- [Window Functions](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql)
- [Query Optimization Best Practices](https://learn.microsoft.com/en-us/sql/relational-databases/performance/query-processing-architecture-guide)
