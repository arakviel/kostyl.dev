---
title: SELF JOIN —Ç–∞ —Å–∫–ª–∞–¥–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó JOIN
description: –°–∞–º–æ–æ–±'—î–¥–Ω–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å, —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏, –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å JOIN –æ–ø–µ—Ä–∞—Ü—ñ–π —Ç–∞ best practices –¥–ª—è —Ä–µ–∞–ª—å–Ω–∏—Ö –ø—Ä–æekt—ñ–≤
---

# SELF JOIN —Ç–∞ —Å–∫–ª–∞–¥–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó JOIN

## –©–æ —Ç–∞–∫–µ SELF JOIN?

**SELF JOIN** ‚Äî —Ü–µ –æ–±'—î–¥–Ω–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ **—Å–∞–º–∞ –∑ —Å–æ–±–æ—é**. –¶–µ –º–æ–∂–µ –∑–¥–∞—Ç–∏—Å—è –¥–∏–≤–Ω–∏–º, –∞–ª–µ –≤–∏—Ä—ñ—à—É—î –≤–∞–∂–ª–∏–≤–∏–π –∫–ª–∞—Å –∑–∞–¥–∞—á.

### –ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω SELF JOIN?

::note
**SELF JOIN –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫–æ–ª–∏**:

1. –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ —Ä—è–¥–∫–∏ –≤ –º–µ–∂–∞—Ö **–æ–¥–Ω—ñ—î—ó** —Ç–∞–±–ª–∏—Ü—ñ
2. –Ñ —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω—ñ –∑–≤'—è–∑–∫–∏ (—Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä)
3. –ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ –ø–∞—Ä–∏ –∞–±–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏

::

---

## –Ü—î—Ä–∞—Ä—Ö—ñ—á–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏: –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏ —Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∏

### –†–µ–∞–ª—å–Ω–∞ –∑–∞–¥–∞—á–∞

–£ –∫–æ–º–ø–∞–Ω—ñ—ó –∫–æ–∂–µ–Ω —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ (–æ–∫—Ä—ñ–º CEO) –º–∞—î –º–µ–Ω–µ–¥–∂–µ—Ä–∞, —è–∫–∏–π **—Ç–µ–∂ —î —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–æ–º**.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:

```sql
CREATE TABLE Employees (
    Id INT PRIMARY KEY,
    FirstName NVARCHAR(50),
    LastName NVARCHAR(50),
    Position NVARCHAR(100),
    ManagerId INT NULL,  -- FOREIGN KEY ‚Üí —Å–∞–º–∞ —Ç–∞–±–ª–∏—Ü—è!
    FOREIGN KEY (ManagerId) REFERENCES Employees(Id)
);
```

**–î–∞–Ω—ñ**:

```sql
INSERT INTO Employees VALUES
(1, '–û–ª–µ–Ω–∞', '–Ü–≤–∞–Ω–µ–Ω–∫–æ', 'CEO', NULL),           -- CEO –±–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
(2, '–ü–µ—Ç—Ä–æ', '–ö–æ–≤–∞–ª—å', 'CTO', 1),                -- CTO ‚Üí CEO
(3, '–ú–∞—Ä—ñ—è', '–°–∏–¥–æ—Ä–æ–≤–∞', 'Team Lead Dev', 2),   -- Team Lead ‚Üí CTO
(4, '–Ü–≤–∞–Ω', '–ü–µ—Ç—Ä–µ–Ω–∫–æ', 'Senior Developer', 3), -- Developer ‚Üí Team Lead
(5, '–û–ª–µ–≥', '–°–º–∏—Ä–Ω–æ–≤', 'Junior Developer', 3);
```

**–Ü—î—Ä–∞—Ä—Ö—ñ—è**:

::mermaid

```mermaid
graph TD
    CEO[–û–ª–µ–Ω–∞ –Ü–≤–∞–Ω–µ–Ω–∫–æ<br/>CEO<br/>Id:1] --> CTO[–ü–µ—Ç—Ä–æ –ö–æ–≤–∞–ª—å<br/>CTO<br/>Id:2]
    CTO --> TL[–ú–∞—Ä—ñ—è –°–∏–¥–æ—Ä–æ–≤–∞<br/>Team Lead<br/>Id:3]
    TL --> SD[–Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ<br/>Senior Dev<br/>Id:4]
    TL --> JD[–û–ª–µ–≥ –°–º–∏—Ä–Ω–æ–≤<br/>Junior Dev<br/>Id:5]

    style CEO fill:#10b981,color:#fff
    style CTO fill:#3b82f6,color:#fff
    style TL fill:#8b5cf6,color:#fff
```

::

---

### SELF JOIN –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–º–µ–Ω—ñ –º–µ–Ω–µ–¥–∂–µ—Ä–∞

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–æ–∂–Ω–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ —Ç–∞ –π–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

```sql {5-6}
SELECT
    E.FirstName + ' ' + E.LastName AS Employee,
    E.Position,
    M.FirstName + ' ' + M.LastName AS Manager
FROM Employees AS E
LEFT JOIN Employees AS M ON E.ManagerId = M.Id;
```

**–ö–ª—é—á–µ–≤—ñ –º–æ–º–µ–Ω—Ç–∏**:

1. **–†—è–¥–æ–∫ 5**: `Employees AS E` ‚Äî **—Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏** (–ª—ñ–≤–∞ —Ç–∞–±–ª–∏—Ü—è)
2. **–†—è–¥–æ–∫ 6**: `Employees AS M` ‚Äî **–º–µ–Ω–µ–¥–∂–µ—Ä–∏** (–ø—Ä–∞–≤–∞ —Ç–∞–±–ª–∏—Ü—è, —Ç–∞ —Å–∞–º–∞!)
3. **–£–º–æ–≤–∞**: `E.ManagerId = M.Id` ‚Äî ManagerId —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ = Id –º–µ–Ω–µ–¥–∂–µ—Ä–∞
4. **LEFT JOIN**: –©–æ–± CEO (–±–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞) —Ç–µ–∂ –ø–æ—Ç—Ä–∞–ø–∏–≤ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:

| Employee       | Position         | Manager        |
| :------------- | :--------------- | :------------- |
| –û–ª–µ–Ω–∞ –Ü–≤–∞–Ω–µ–Ω–∫–æ | CEO              | NULL           |
| –ü–µ—Ç—Ä–æ –ö–æ–≤–∞–ª—å   | CTO              | –û–ª–µ–Ω–∞ –Ü–≤–∞–Ω–µ–Ω–∫–æ |
| –ú–∞—Ä—ñ—è –°–∏–¥–æ—Ä–æ–≤–∞ | Team Lead Dev    | –ü–µ—Ç—Ä–æ –ö–æ–≤–∞–ª—å   |
| –Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ  | Senior Developer | –ú–∞—Ä—ñ—è –°–∏–¥–æ—Ä–æ–≤–∞ |
| –û–ª–µ–≥ –°–º–∏—Ä–Ω–æ–≤   | Junior Developer | –ú–∞—Ä—ñ—è –°–∏–¥–æ—Ä–æ–≤–∞ |

::tip
**–ü—Å–µ–≤–¥–æ–Ω—ñ–º–∏ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ!** –ë–µ–∑ `AS E` —Ç–∞ `AS M` SQL Server –Ω–µ –∑—Ä–æ–∑—É–º—ñ—î, —â–æ –≤–∏ –ø–æ—Å–∏–ª–∞—î—Ç–µ—Å—å –Ω–∞ —Ç—É —Å–∞–º—É —Ç–∞–±–ª–∏—Ü—é –¥–≤—ñ—á—ñ.
::

---

## –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è SELF JOIN

::plant-uml

```plantuml
@startuml
skinparam backgroundColor #1e1e2e
skinparam defaultFontColor #cdd6f4

!define EMPLOYEE1 #a6e3a1
!define EMPLOYEE2 #89b4fa

rectangle "Employees (E)" as E EMPLOYEE1 {
    (Id=2, –ü–µ—Ç—Ä–æ –ö–æ–≤–∞–ª—å, ManagerId=1) as E2
    (Id=3, –ú–∞—Ä—ñ—è, ManagerId=2) as E3
    (Id=4, –Ü–≤–∞–Ω, ManagerId=3) as E4
}

rectangle "Employees (M)" as M EMPLOYEE2 {
    (Id=1, –û–ª–µ–Ω–∞ CEO) as M1
    (Id=2, –ü–µ—Ç—Ä–æ CTO) as M2
    (Id=3, –ú–∞—Ä—ñ—è TL) as M3
}

E2 -right-> M1 : ManagerId=1 ‚Üí Id=1
E3 -right-> M2 : ManagerId=2 ‚Üí Id=2
E4 -right-> M3 : ManagerId=3 ‚Üí Id=3

note right of M
  –¢–∞ —Å–∞–º–∞ —Ç–∞–±–ª–∏—Ü—è,
  –∞–ª–µ —Ä–æ–∑–≥–ª—è–¥–∞—î—Ç—å—Å—è —è–∫
  "—Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤"
end note

@enduml
```

::

---

## –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ä—è–¥–∫—ñ–≤ –≤ –º–µ–∂–∞—Ö —Ç–∞–±–ª–∏—Ü—ñ

### –ó–∞–≤–¥–∞–Ω–Ω—è: –°—Ç—É–¥–µ–Ω—Ç–∏ –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é

**–ú–µ—Ç–∞**: –ó–Ω–∞–π—Ç–∏ –ø–∞—Ä–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤, —É —è–∫–∏—Ö **–æ–¥–Ω–∞–∫–æ–≤–∞** —Å—Ç–∏–ø–µ–Ω–¥—ñ—è.

```sql {5}
SELECT
    S1.FirstName + ' ' + S1.LastName AS Student1,
    S2.FirstName + ' ' + S2.LastName AS Student2,
    S1.Grants
FROM Students AS S1
INNER JOIN Students AS S2
    ON S1.Grants = S2.Grants AND S1.Id < S2.Id;
```

**–ê–Ω–∞—Ç–æ–º—ñ—è –∫–æ–¥—É**:

- `S1.Grants = S2.Grants` ‚Äî —Å—Ç—É–¥–µ–Ω—Ç–∏ –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é —Å—Ç–∏–ø–µ–Ω–¥—ñ—î—é
- `S1.Id < S2.Id` ‚Äî **–∫—Ä–∏—Ç–∏—á–Ω–æ!** –ë–µ–∑ —Ü—å–æ–≥–æ –æ—Ç—Ä–∏–º–∞—î–º–æ:
    - –î—É–±–ª—ñ–∫–∞—Ç–∏: (–Ü–≤–∞–Ω, –û–ª–µ–Ω–∞) —Ç–∞ (–û–ª–µ–Ω–∞, –Ü–≤–∞–Ω)
    - –°–∞–º–∏—Ö —Å–µ–±–µ: (–Ü–≤–∞–Ω, –Ü–≤–∞–Ω)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:

| Student1      | Student2      | Grants |
| :------------ | :------------ | -----: |
| –Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ | –ú–∞—Ä—ñ—è –Ü–≤–∞–Ω–æ–≤–∞ |   1200 |
| –û–ª–µ–≥ –°–º–∏—Ä–Ω–æ–≤  | –ê–Ω–¥—Ä—ñ–π –ö–æ–≤–∞–ª—å |   1250 |

::warning
**–ë–µ–∑ `S1.Id < S2.Id`** –æ—Ç—Ä–∏–º–∞—î—Ç–µ N¬≤ —Ä—è–¥–∫—ñ–≤ (–∫–æ–∂–µ–Ω –∑—ñ –≤—Å—ñ–º–∞, –≤–∫–ª—é—á–Ω–æ –∑ —Å–æ–±–æ—é)!
::

---

### –ó–∞–≤–¥–∞–Ω–Ω—è: –ü—Ä–æ–¥—É–∫—Ç–∏ –¥–æ—Ä–æ–∂—á—ñ –∑–∞ —ñ–Ω—à—ñ

**–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö Products**:

```sql
CREATE TABLE Products (
    Id INT PRIMARY KEY,
    Name NVARCHAR(100),
    Price DECIMAL(10,2),
    Category NVARCHAR(50)
);
```

**–ó–Ω–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –¥–æ—Ä–æ–∂—á—ñ –∑–∞ —Å–µ—Ä–µ–¥–Ω—î –≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó**:

```sql
SELECT
    P1.Name,
    P1.Price,
    P1.Category,
    AVG(P2.Price) AS CategoryAvgPrice
FROM Products AS P1
INNER JOIN Products AS P2 ON P1.Category = P2.Category
GROUP BY P1.Name, P1.Price, P1.Category
HAVING P1.Price > AVG(P2.Price);
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è**:

- –ö–æ–∂–µ–Ω –ø—Ä–æ–¥—É–∫—Ç –ø–æ—Ä—ñ–≤–Ω—é—î—Ç—å—Å—è –∑ **—É—Å—ñ–º–∞ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏** —Å–≤–æ—î—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
- `AVG(P2.Price)` ‚Äî —Å–µ—Ä–µ–¥–Ω—è —Ü—ñ–Ω–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
- `HAVING P1.Price > AVG(P2.Price)` ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–æ—Ä–æ–∂—á—ñ

---

## Recursive CTE: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ SELF JOIN –¥–ª—è —ñ—î—Ä–∞—Ä—Ö—ñ–π

–î–ª—è **–≥–ª–∏–±–æ–∫–∏—Ö** —ñ—î—Ä–∞—Ä—Ö—ñ–π (–±–∞–≥–∞—Ç–æ —Ä—ñ–≤–Ω—ñ–≤) SELF JOIN –Ω–µ–∑—Ä—É—á–Ω–∏–π. **–†–µ–∫—É—Ä—Å–∏–≤–Ω—ñ CTE** –≤–∏—Ä—ñ—à—É—é—Ç—å —Ü–µ –µ–ª–µ–≥–∞–Ω—Ç–Ω–æ.

### –ü—Ä–∏–∫–ª–∞–¥: –í—Å—è —ñ—î—Ä–∞—Ä—Ö—ñ—è –ø—ñ–¥–ª–µ–≥–ª–∏—Ö

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –û—Ç—Ä–∏–º–∞—Ç–∏ **–≤—Å—ñ—Ö** –ø—ñ–¥–ª–µ–≥–ª–∏—Ö –ü–µ—Ç—Ä–∞ –ö–æ–≤–∞–ª—è (CTO), –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä—ñ–≤–Ω—è.

```sql
WITH EmployeeHierarchy AS (
    -- Anchor: –ü–µ—Ç—Ä–æ –ö–æ–≤–∞–ª—å (—Ç–æ—á–∫–∞ —Å—Ç–∞—Ä—Ç—É)
    SELECT Id, FirstName, LastName, Position, ManagerId, 1 AS Level
    FROM Employees
    WHERE Id = 2  -- CTO

    UNION ALL

    -- Recursive: –ü—ñ–¥–ª–µ–≥–ª—ñ –ø—ñ–¥–ª–µ–≥–ª–∏—Ö
    SELECT E.Id, E.FirstName, E.LastName, E.Position, E.ManagerId, EH.Level + 1
    FROM Employees AS E
    INNER JOIN EmployeeHierarchy AS EH ON E.ManagerId = EH.Id
)
SELECT
    REPLICATE('  ', Level - 1) + FirstName + ' ' + LastName AS Employee,
    Position,
    Level
FROM EmployeeHierarchy
ORDER BY Level;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:

| Employee       | Position         | Level |
| :------------- | :--------------- | ----: |
| –ü–µ—Ç—Ä–æ –ö–æ–≤–∞–ª—å   | CTO              |     1 |
| –ú–∞—Ä—ñ—è –°–∏–¥–æ—Ä–æ–≤–∞ | Team Lead Dev    |     2 |
| –Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ  | Senior Developer |     3 |
| –û–ª–µ–≥ –°–º–∏—Ä–Ω–æ–≤   | Junior Developer |     3 |

**–ü–µ—Ä–µ–≤–∞–≥–∏ CTE –Ω–∞–¥ SELF JOIN**:

- –ü—Ä–∞—Ü—é—î –¥–ª—è **–Ω–µ–æ–±–º–µ–∂–µ–Ω–æ—ó** –≥–ª–∏–±–∏–Ω–∏
- –ü–æ–∫–∞–∑—É—î **—Ä—ñ–≤–µ–Ω—å** —ñ—î—Ä–∞—Ä—Ö—ñ—ó
- –ë—ñ–ª—å—à —á–∏—Ç–∞–±–µ–ª—å–Ω–æ

::tip
**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ CTE –∑–∞–º—ñ—Å—Ç—å SELF JOIN?**

- –Ü—î—Ä–∞—Ä—Ö—ñ—ó –∑ –Ω–µ–≤—ñ–¥–æ–º–æ—é –≥–ª–∏–±–∏–Ω–æ—é
- –ü–æ—Ç—Ä—ñ–±–µ–Ω –Ω–æ–º–µ—Ä —Ä—ñ–≤–Ω—è
- –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –ø–æ –≤—Å—ñ–π –≥—ñ–ª—Ü—ñ

::

---

## JOIN –∑ –ø—ñ–¥–∑–∞–ø–∏—Ç–∞–º–∏

### –ü—ñ–¥–∑–∞–ø–∏—Ç —É FROM (Derived Table)

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –°—Ç—É–¥–µ–Ω—Ç–∏ –∑ –æ—Ü—ñ–Ω–∫–æ—é –≤–∏—â–æ—é –∑–∞ —Å–µ—Ä–µ–¥–Ω—é —ó—Ö–Ω—å–æ—ó –≥—Ä—É–ø–∏.

```sql {2-6}
SELECT
    S.FirstName,
    S.AvgGrade,
    GroupAvg.Avg AS GroupAverage
FROM (
    SELECT
        StudentId,
        AVG(Grade) AS AvgGrade
    FROM Achievements
    GROUP BY StudentId
) AS S
INNER JOIN Students AS St ON S.StudentId = St.Id
INNER JOIN (
    SELECT
        G.Id AS GroupId,
        AVG(A.Grade) AS Avg
    FROM Groups AS G
    INNER JOIN Students AS S ON G.Id = S.GroupId
    INNER JOIN Achievements AS A ON S.Id = A.StudentId
    GROUP BY G.Id
) AS GroupAvg ON St.GroupId = GroupAvg.GroupId
WHERE S.AvgGrade > GroupAvg.Avg;
```

::note
**Derived Table** ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—ñ–¥–∑–∞–ø–∏—Ç—É, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —è–∫ —Ç–∞–±–ª–∏—Ü—è. –û–±–æ–≤'—è–∑–∫–æ–≤–æ –ø–æ—Ç—Ä–µ–±—É—î –ø—Å–µ–≤–¥–æ–Ω—ñ–º—É (`AS S`).
::

---

### Common Table Expression (CTE) –∑–∞–º—ñ—Å—Ç—å –≤–∫–ª–∞–¥–µ–Ω–∏—Ö JOIN

**–¢–æ–π —Å–∞–º–∏–π –∑–∞–ø–∏—Ç –∑ CTE** (–±—ñ–ª—å—à —á–∏—Ç–∞–±–µ–ª—å–Ω–æ):

```sql
WITH StudentAvg AS (
    SELECT StudentId, AVG(Grade) AS AvgGrade
    FROM Achievements
    GROUP BY StudentId
),
GroupAvg AS (
    SELECT
        G.Id AS GroupId,
        AVG(A.Grade) AS Avg
    FROM Groups AS G
    INNER JOIN Students AS S ON G.Id = S.GroupId
    INNER JOIN Achievements AS A ON S.Id = A.StudentId
    GROUP BY G.Id
)
SELECT
    St.FirstName,
    SA.AvgGrade,
    GA.Avg AS GroupAverage
FROM Students AS St
INNER JOIN StudentAvg AS SA ON St.Id = SA.StudentId
INNER JOIN GroupAvg AS GA ON St.GroupId = GA.GroupId
WHERE SA.AvgGrade > GA.Avg;
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ CTE**:

- ‚úÖ –ß–∏—Ç–∞–±–µ–ª—å–Ω—ñ—à–µ
- ‚úÖ –ú–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤
- ‚úÖ –õ–µ–≥—à–µ –¥–µ–±–∞–∂–∏—Ç–∏ (–º–æ–∂–Ω–∞ SELECT –∑ CTE –æ–∫—Ä–µ–º–æ)

---

## Performance JOIN –æ–ø–µ—Ä–∞—Ü—ñ–π

### –Ø–∫ SQL Server –≤–∏–∫–æ–Ω—É—î JOIN?

SQL Server –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **3 –æ—Å–Ω–æ–≤–Ω—ñ –∞–ª–≥–æ—Ä–∏—Ç–º–∏**:

::tabs

::tab{label="Nested Loop Join"}

**–ü—Ä–∏–Ω—Ü–∏–ø**: –î–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –∑ **outer** table —à—É–∫–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –≤ **inner** table.

```
FOR –∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫ —É —Ç–∞–±–ª–∏—Ü—ñ 1:
    FOR –∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫ —É —Ç–∞–±–ª–∏—Ü—ñ 2:
        IF —É–º–æ–≤–∞ ON –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è:
            –¥–æ–¥–∞—Ç–∏ –¥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
```

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è**:

- –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü—è **–º–∞–ª–∞** (< 100 —Ä—è–¥–∫—ñ–≤)
- –Ñ **—ñ–Ω–¥–µ–∫—Å** –Ω–∞ inner table

**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å**: O(N √ó M)

::

::tab{label="Hash Join"}

**–ü—Ä–∏–Ω—Ü–∏–ø**: –°—Ç–≤–æ—Ä—é—î **hash-—Ç–∞–±–ª–∏—Ü—é** –∑ –º–µ–Ω—à–æ—ó —Ç–∞–±–ª–∏—Ü—ñ, –ø–æ—Ç—ñ–º —à—É–∫–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –≤ –±—ñ–ª—å—à—ñ–π.

```
–ï—Ç–∞–ø 1: BUILD - —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è hash-—Ç–∞–±–ª–∏—Ü—ñ –∑ –º–µ–Ω—à–æ—ó —Ç–∞–±–ª–∏—Ü—ñ
–ï—Ç–∞–ø 2: PROBE - —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –±—ñ–ª—å—à–æ—ó —Ç–∞–±–ª–∏—Ü—ñ —Ç–∞ –ø–æ—à—É–∫ –≤ hash
```

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è**:

- –û–±–∏–¥–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ **–≤–µ–ª–∏–∫—ñ**
- **–ù–µ–º–∞—î —ñ–Ω–¥–µ–∫—Å—É** –Ω–∞ join column
- Equality JOIN (`=`)

**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å**: O(N + M)

::

::tab{label="Merge Join"}

**–ü—Ä–∏–Ω—Ü–∏–ø**: –û–±–∏–¥–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ **–≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω—ñ** –ø–æ join column, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è.

```
–ü–æ–∫–∞–∂—á–∏–∫–∏ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –æ–±–æ—Ö —Ç–∞–±–ª–∏—Ü—å:
–ü–û–ö–ò –Ω–µ –∫—ñ–Ω–µ—Ü—å –±—É–¥—å-—è–∫–æ—ó —Ç–∞–±–ª–∏—Ü—ñ:
    IF –∑–Ω–∞—á–µ–Ω–Ω—è —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å ‚Üí –¥–æ–¥–∞—Ç–∏
    ELSE –ø—Ä–æ—Å—É–Ω—É—Ç–∏ –ø–æ–∫–∞–∂—á–∏–∫ –∑ –º–µ–Ω—à–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º
```

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è**:

- –î–∞–Ω—ñ –≤–∂–µ **–≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω—ñ** (—î —ñ–Ω–¥–µ–∫—Å)
- Equality JOIN (`=`)
- Many-to-Many –≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è

**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å**: O(N + M) ‚Äî **–Ω–∞–π—à–≤–∏–¥—à–∏–π**!

::

::

---

### Execution Plan: –ß–∏—Ç–∞–Ω–Ω—è

::code-group

```sql [–ü–æ–≤—ñ–ª—å–Ω–∏–π –∑–∞–ø–∏—Ç (Table Scan)]
SELECT S.FirstName, G.GroupName
FROM Students AS S
INNER JOIN Groups AS G ON S.GroupId = G.Id;

-- Execution Plan:
-- Hash Match (Cost: 75%)
--   ‚îú‚îÄ Table Scan Students (Cost: 50%)
--   ‚îî‚îÄ Table Scan Groups (Cost: 25%)
```

```sql [–®–≤–∏–¥–∫–∏–π –∑–∞–ø–∏—Ç (Index Seek)]
CREATE INDEX IX_Students_GroupId ON Students(GroupId);

-- Execution Plan:
-- Nested Loop (Cos—Ç: 15%)
--   ‚îú‚îÄ Index Scan Students.IX_Students_GroupId (Cost: 5%)
--   ‚îî‚îÄ Clustered Index Seek Groups.PK (Cost: 10%)
```

::

**–Ø–∫ —á–∏—Ç–∞—Ç–∏ Execution Plan**:

```
Hash Match (75%) ‚Üê –ê–ª–≥–æ—Ä–∏—Ç–º JOIN (% –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ—ó –≤–∞—Ä—Ç–æ—Å—Ç—ñ)
  ‚îú‚îÄ Table Scan (50%) ‚Üê Table Scan = –ü–û–í–Ü–õ–¨–ù–û!
  ‚îî‚îÄ Index Seek (10%) ‚Üê Index Seek = –®–í–ò–î–ö–û!
```

::tip
**–í—ñ–¥–∫—Ä–∏—Ç–∏ Execution Plan** –≤ SQL Server Management Studio:

- `Ctrl + M` ‚Üí –£–≤—ñ–º–∫–Ω—É—Ç–∏ Actual Execution Plan
- –í–∏–∫–æ–Ω–∞—Ç–∏ –∑–∞–ø–∏—Ç
- –í–∫–ª–∞–¥–∫–∞ "Execution Plan"

::

---

## –Ü–Ω–¥–µ–∫—Å–∏ –¥–ª—è JOIN: Best Practices

### Covering Index

**Covering Index** –º—ñ—Å—Ç–∏—Ç—å **–í–°–Ü** —Å—Ç–æ–≤–ø—Ü—ñ, –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è –∑–∞–ø–∏—Ç—É.

```sql
-- –ó–∞–ø–∏—Ç
SELECT S.FirstName, S.LastName, S.Grants, G.GroupName
FROM Students AS S
INNER JOIN Groups AS G ON S.GroupId = G.Id
WHERE S.Grants > 1200;

-- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Covering Index
CREATE NONCLUSTERED INDEX IX_Students_Covering
ON Students(GroupId)  -- JOIN column
INCLUDE (FirstName, LastName, Grants);  -- SELECT columns
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**:

- SQL Server —á–∏—Ç–∞—î **—Ç—ñ–ª—å–∫–∏ —ñ–Ω–¥–µ–∫—Å**, –Ω–µ –∑–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ —Ç–∞–±–ª–∏—Ü—ñ
- Execution Plan: **Index Seek** –∑–∞–º—ñ—Å—Ç—å **Key Lookup**

---

### Composite Index –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö JOIN

```sql
-- –ó–∞–ø–∏—Ç –∑ –∫—ñ–ª—å–∫–æ–º–∞ —É–º–æ–≤–∞–º–∏
FROM Students AS S
INNER JOIN Groups AS G
    ON S.GroupId = G.Id AND G.Faculty = 'IT';

-- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Composite Index
CREATE INDEX IX_Groups_Faculty_Id ON Groups(Faculty, Id);
```

**–ü–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–≤–ø—Ü—ñ–≤ –≤–∞–∂–ª–∏–≤–∏–π**:

- –ü–µ—Ä—à–∏–π —Å—Ç–æ–≤–ø–µ—Ü—å ‚Äî —Ç–æ–π, —â–æ —É **WHERE** –∞–±–æ **GROUP BY**
- –î—Ä—É–≥–∏–π ‚Äî —Ç–æ–π, —â–æ —É **JOIN**

---

## –°–∫–ª–∞–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏: –†–µ–∞–ª—å–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –ó–≤—ñ—Ç –∑ 5 —Ç–∞–±–ª–∏—Ü—è–º–∏

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –ü–æ–≤–Ω–∏–π –∑–≤—ñ—Ç —É—Å–ø—ñ—à–Ω–æ—Å—Ç—ñ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –≥—Ä—É–ø—É, –≤–∏–∫–ª–∞–¥–∞—á–∞ —Ç–∞ –ø—Ä–µ–¥–º–µ—Ç–∏.

```sql
WITH StudentGrades AS (
    SELECT
        StudentId,
        SubjectId,
        AVG(Grade) AS AvgGrade,
        COUNT(*) AS TestCount
    FROM Achievements
    GROUP BY StudentId, SubjectId
)
SELECT
    S.FirstName + ' ' + S.LastName AS Student,
    G.GroupName,
    T.FirstName + ' ' + T.LastName AS Teacher,
    Sub.SubjectName,
    SG.AvgGrade,
    SG.TestCount,
    CASE
        WHEN SG.AvgGrade >= 90 THEN '–í—ñ–¥–º—ñ–Ω–Ω–æ'
        WHEN SG.AvgGrade >= 75 THEN '–î–æ–±—Ä–µ'
        WHEN SG.AvgGrade >= 60 THEN '–ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ'
        ELSE '–ù–µ–∑–∞–¥–æ–≤—ñ–ª—å–Ω–æ'
    END AS Performance
FROM Students AS S
INNER JOIN Groups AS G ON S.GroupId = G.Id
INNER JOIN Teachers AS T ON G.TeacherId = T.Id
INNER JOIN StudentGrades AS SG ON S.Id = SG.StudentId
INNER JOIN Subjects AS Sub ON SG.SubjectId = Sub.Id
WHERE SG.AvgGrade >= 60
ORDER BY G.GroupName, S.LastName, Sub.SubjectName;
```

**–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó**:

1. CTE –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó
2. –Ü–Ω–¥–µ–∫—Å–∏ –Ω–∞ –≤—Å—ñ FK
3. WHERE –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –Ω–µ–∑–∞–¥–æ–≤—ñ–ª—å–Ω–∏—Ö –æ—Ü—ñ–Ω–æ–∫

---

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: Dashboard –∑–∞–ø–∏—Ç

**–ó–∞–≤–¥–∞–Ω–Ω—è**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—Ä—É–ø–∞—Ö –¥–ª—è –∞–¥–º—ñ–Ω—Å—å–∫–æ—ó –ø–∞–Ω–µ–ª—ñ.

```sql
SELECT
    G.GroupName,
    G.Faculty,
    T.FirstName + ' ' + T.LastName AS Teacher,
    COUNT(DISTINCT S.Id) AS TotalStudents,
    COUNT(DISTINCT CASE WHEN S.Grants IS NOT NULL THEN S.Id END) AS StudentsWithGrants,
    AVG(S.Grants) AS AvgGrant,
    COUNT(DISTINCT A.Id) AS TotalAchievements,
    AVG(A.Grade) AS AvgGrade,
    MAX(A.Grade) AS MaxGrade,
    MIN(A.Grade) AS MinGrade
FROM Groups AS G
LEFT JOIN Teachers AS T ON G.TeacherId = T.Id
LEFT JOIN Students AS S ON G.Id = S.GroupId
LEFT JOIN Achievements AS A ON S.Id = A.StudentId
GROUP BY G.GroupName, G.Faculty, T.FirstName, T.LastName
ORDER BY TotalStudents DESC;
```

**–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏**:

- **LEFT JOIN** –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è –≥—Ä—É–ø –±–µ–∑ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤
- `COUNT(DISTINCT S. Id)` –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É
- –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –ø–æ –∫—ñ–ª—å–∫–æ—Ö –≤–∏–º—ñ—Ä–∞—Ö

---

## Best Practices: –ü—ñ–¥—Å—É–º–æ–∫

::steps

### 1. –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —è–≤–Ω–∏–π JOIN —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
-- ‚ùå –ü–û–ì–ê–ù–û (—Å—Ç–∞—Ä–∏–π —Å—Ç–∏–ª—å)
FROM Students, Groups
WHERE Students.GroupId = Groups.Id

-- ‚úÖ –î–û–ë–†–ï
FROM Students AS S
INNER JOIN Groups AS G ON S.GroupId = G.Id
```

### 2. –ü—Å–µ–≤–¥–æ–Ω—ñ–º–∏ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ

```sql
-- ‚úÖ –ß–∏—Ç–∞–±–µ–ª—å–Ω–æ —Ç–∞ –∫–æ—Ä–æ—Ç–∫–æ
FROM Students AS S
INNER JOIN Groups AS G
```

### 3. –§—ñ–ª—å—Ç—Ä—É–π—Ç–µ —Ä–∞–Ω–æ

```sql
-- ‚úÖ WHERE –ø–µ—Ä–µ–¥ JOIN (—è–∫—â–æ –º–æ–∂–ª–∏–≤–æ)
FROM Students AS S
WHERE S.GroupId = 1  -- –ó–º–µ–Ω—à—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—è–¥–∫—ñ–≤ –¥–ª—è JOIN
INNER JOIN Groups AS G ON S.GroupId = G.Id
```

### 4. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ CTE –¥–ª—è —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ

```sql
-- ‚úÖ –†–æ–∑–±–∏–≤–∞–π—Ç–µ —Å–∫–ª–∞–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞ CTE
WITH FilteredStudents AS (...),
     GroupStats AS (...)
SELECT ... FROM FilteredStudents ...
```

### 5. –Ü–Ω–¥–µ–∫—Å–∏ –Ω–∞ FK

```sql
-- ‚úÖ –Ü–Ω–¥–µ–∫—Å–∏ –Ω–∞ –í–°–Ü –∫–æ–ª–æ–Ω–∫–∏ JOIN
CREATE INDEX IX_Students_GroupId ON Students(GroupId);
CREATE INDEX IX_Achievements_StudentId ON Achievements(StudentId);
```

### 6. Covering Indexes –¥–ª—è —á–∞—Å—Ç–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤

```sql
CREATE INDEX IX_Students_Covering
ON Students(GroupId)
INCLUDE (FirstName, LastName, Grants);
```

### 7. –ê–Ω–∞–ª—ñ–∑—É–π—Ç–µ Execution Plans

```sql
-- –®—É–∫–∞–π—Ç–µ:
-- ‚ùå Table Scan (–ø–æ–≤—ñ–ª—å–Ω–æ)
-- ‚ùå Key Lookup (–±–∞–≥–∞—Ç–æ –∑–≤–µ—Ä–Ω–µ–Ω—å)
-- ‚ùå Hash Match (—è–∫—â–æ –º–æ–∂–Ω–∞ Merge Join)
-- ‚úÖ Index Seek (—ñ–¥–µ–∞–ª—å–Ω–æ!)
```

::

---

## –¢–∏–ø–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏ —Ç–∞ —Ä—ñ—à–µ–Ω–Ω—è

::tabs

::tab{label="–ü–æ–º–∏–ª–∫–∞: –î–µ–∫–∞—Ä—Ç–æ–≤–∏–π –¥–æ–±—É—Ç–æ–∫"}

```sql
-- ‚ùå –ó–∞–±—É–ª–∏ –∑–≤'—è–∑–∞—Ç–∏ Students –∑ Achievements
SELECT *
FROM Students AS S, Groups AS G, Achievements AS A;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 10 √ó 5 √ó 100 = 5000 —Ä—è–¥–∫—ñ–≤!

-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
FROM Students AS S
INNER JOIN Groups AS G ON S.GroupId = G.Id
INNER JOIN Achievements AS A ON S.Id = A.StudentId;
```

::

::tab{label="–ü–æ–º–∏–ª–∫–∞: –í—Ç—Ä–∞—Ç–∞ NULL"}

```sql
-- ‚ùå WHERE –≤–∏–¥–∞–ª—è—î NULL
FROM Students AS S
LEFT JOIN Achievements AS A ON S.Id = A.StudentId
WHERE A.Grade > 80;  -- –í—Ç—Ä–∞—Ç–∏–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –±–µ–∑ –æ—Ü—ñ–Ω–æ–∫!

-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
WHERE A.Grade > 80 OR A.Grade IS NULL;
```

::

::tab{label="–ü–æ–º–∏–ª–∫–∞: –ù–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π JOIN"}

```sql
-- ‚ùå JOIN –±–µ–∑ —ñ–Ω–¥–µ–∫—Å—É
FROM LargeTable1 AS T1
INNER JOIN LargeTable2 AS T2 ON T1.Column = T2.Column;
-- Table Scan –Ω–∞ –æ–±–æ—Ö ‚Üí O(N¬≤)

-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
CREATE INDEX IX_LargeTable1_Column ON LargeTable1(Column);
CREATE INDEX IX_LargeTable2_Column ON LargeTable2(Column);
-- Index Seek ‚Üí O(N log N)
```

::

::

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

::steps

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: SELF JOIN –¥–ª—è —ñ—î—Ä–∞—Ä—Ö—ñ—ó

–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç –¥–ª—è –≤–∏–≤–µ–¥–µ–Ω–Ω—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞, –π–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –π–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

::collapsible{label="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è"}

```sql
SELECT
    E.FirstName + ' ' + E.LastName AS Employee,
    M1.FirstName + ' ' + M1.LastName AS DirectManager,
    M2.FirstName + ' ' + M2.LastName AS SecondLevelManager
FROM Employees AS E
LEFT JOIN Employees AS M1 ON E.ManagerId = M1.Id
LEFT JOIN Employees AS M2 ON M1.ManagerId = M2.Id
ORDER BY E.LastName;
```

::

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –°–∫–ª–∞–¥–Ω–∏–π –∑–≤—ñ—Ç –∑ CTE

–ó–Ω–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤, —á–∏—è —Å–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞ –≤–∏—â–∞ –∑–∞ —Å–µ—Ä–µ–¥–Ω—é —ó—Ö–Ω—å–æ—ó –≥—Ä—É–ø–∏.

::collapsible{label="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è"}

```sql
WITH StudentAvg AS (
    SELECT
        StudentId,
        AVG(Grade) AS AvgGrade
    FROM Achievements
    GROUP BY StudentId
),
GroupAvg AS (
    SELECT
        S.GroupId,
        AVG(A.Grade) AS GroupAvgGrade
    FROM Students AS S
    INNER JOIN Achievements AS A ON S.Id = A.StudentId
    GROUP BY S.GroupId
)
SELECT
    S.FirstName + ' ' + S.LastName AS Student,
    G.GroupName,
    SA.AvgGrade AS StudentAvg,
    GA.GroupAvgGrade
FROM Students AS S
INNER JOIN StudentAvg AS SA ON S.Id = SA.StudentId
INNER JOIN Groups AS G ON S.GroupId = G.Id
INNER JOIN GroupAvg AS GA ON S.GroupId = GA.GroupId
WHERE SA.AvgGrade > GA.GroupAvgGrade
ORDER BY SA.AvgGrade DESC;
```

::

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –∑–∞–ø–∏—Ç—É

–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ Execution Plan —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —ñ–Ω–¥–µ–∫—Å–∏ –¥–ª—è –∑–∞–ø–∏—Ç—É:

```sql
SELECT
    S.FirstName,
    G.GroupName,
    AVG(A.Grade) AS AvgGrade
FROM Students AS S
INNER JOIN Groups AS G ON S.GroupId = G.Id
INNER JOIN Achievements AS A ON S.Id = A.StudentId
WHERE G.Faculty = 'IT'
GROUP BY S.FirstName, G.GroupName
HAVING AVG(A.Grade) > 80;
```

::collapsible{label="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è"}

```sql
-- –Ü–Ω–¥–µ–∫—Å–∏ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:

-- 1. –î–ª—è Groups (WHERE –ø–æ Faculty)
CREATE INDEX IX_Groups_Faculty_Id
ON Groups(Faculty)
INCLUDE (Id, GroupName);

-- 2. –î–ª—è Students (JOIN)
CREATE INDEX IX_Students_GroupId_FirstName
ON Students(GroupId)
INCLUDE (Id, FirstName);

-- 3. –î–ª—è Achievements (JOIN + GROUP BY)
CREATE INDEX IX_Achievements_StudentId_Grade
ON Achievements(StudentId)
INCLUDE (Grade);

-- –ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤ Execution Plan –ø–æ–∫–∞–∂–µ:
-- ‚úÖ Index Seek –∑–∞–º—ñ—Å—Ç—å Table Scan
-- ‚úÖ Nested Loop –∑–∞–º—ñ—Å—Ç—å Hash Match (—à–≤–∏–¥—à–µ)
```

::

::

---

## –†–µ–∑—é–º–µ

::note
**–ö–ª—é—á–æ–≤—ñ –≤–∏—Å–Ω–æ–≤–∫–∏**:

1. **SELF JOIN** –¥–æ–∑–≤–æ–ª—è—î –ø–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ —Ä—è–¥–∫–∏ –≤ –º–µ–∂–∞—Ö –æ–¥–Ω—ñ—î—ó —Ç–∞–±–ª–∏—Ü—ñ
2. –Ü—î—Ä–∞—Ä—Ö—ñ—á–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏: SELF JOIN –¥–ª—è 1-2 —Ä—ñ–≤–Ω—ñ–≤, **Recursive CTE** –¥–ª—è –≥–ª–∏–±–æ–∫–∏—Ö —ñ—î—Ä–∞—Ä—Ö—ñ–π
3. **CTE** –ø–æ–∫—Ä–∞—â—É—î —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å —Å–∫–ª–∞–¥–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
4. SQL Server –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **3 –∞–ª–≥–æ—Ä–∏—Ç–º–∏ JOIN**: Nested Loop, Hash Match, Merge Join
5. **–Ü–Ω–¥–µ–∫—Å–∏** –∫—Ä–∏—Ç–∏—á–Ω—ñ: Covering Index, Composite Index
6. **Execution Plan** –ø–æ–∫–∞–∑—É—î –≤—É–∑—å–∫—ñ –º—ñ—Å—Ü—è
7. –ó–∞–≤–∂–¥–∏ –∞–Ω–∞–ª—ñ–∑—É–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö

::

::tip
**–ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –ø–æ—Ä–∞–¥–∏**:

- –ü–æ—á–∏–Ω–∞–π—Ç–µ –∑ –ø—Ä–æ—Å—Ç–∏—Ö JOIN, –ø–æ—Å—Ç—É–ø–æ–≤–æ —É—Å–∫–ª–∞–¥–Ω—é–π—Ç–µ
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ CTE –¥–ª—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—ó –ª–æ–≥—ñ–∫–∏
- –°—Ç–≤–æ—Ä—é–π—Ç–µ —ñ–Ω–¥–µ–∫—Å–∏ **–ø—ñ—Å–ª—è** –Ω–∞–ø–∏—Å–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É (—Å–ø–æ—á–∞—Ç–∫—É –ª–æ–≥—ñ–∫–∞, –ø–æ—Ç—ñ–º –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è)
- –¢–µ—Å—Ç—É–π—Ç–µ –Ω–∞ –≤–µ–ª–∏–∫–∏—Ö –æ–±—Å—è–≥–∞—Ö –¥–∞–Ω–∏—Ö (–Ω–µ –Ω–∞ 10 —Ä—è–¥–∫–∞—Ö!)
- Execution Plan ‚Äî –≤–∞—à –Ω–∞–π–∫—Ä–∞—â–∏–π –¥—Ä—É–≥

::

---

## –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏

- [Recursive Queries](https://learn.microsoft.com/en-us/sql/t-sql/queries/with-common-table-expression-transact-sql#guidelines-for-defining-and-using-recursive-common-table-expressions)
- [JOIN Fundamentals](https://learn.microsoft.com/en-us/sql/relational-databases/performance/joins)
- [Index Design Guide](https://learn.microsoft.com/en-us/sql/relational-databases/sql-server-index-design-guide)
- [Execution Plans](https://learn.microsoft.com/en-us/sql/relational-databases/performance/execution-plans)
- [Query Optimization Tips](https://learn.microsoft.com/en-us/sql/relational-databases/performance/performance-monitoring-and-tuning-tools)

---

::note
üéâ **–í—ñ—Ç–∞—î–º–æ!** –í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø–æ–≤–Ω–∏–π –∫—É—Ä—Å –ø–æ JOIN –æ–ø–µ—Ä–∞—Ü—ñ—è—Ö —É MS SQL Server!

–¢–µ–ø–µ—Ä –≤–∏ –∑–Ω–∞—î—Ç–µ:

- ‚úÖ INNER JOIN –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç–µ–π
- ‚úÖ LEFT/RIGHT/FULL JOIN –¥–ª—è –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –æ–±'—î–¥–Ω–∞–Ω—å
- ‚úÖ SELF JOIN –¥–ª—è —ñ—î—Ä–∞—Ä—Ö—ñ–π
- ‚úÖ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—é —á–µ—Ä–µ–∑ —ñ–Ω–¥–µ–∫—Å–∏ —Ç–∞ Execution Plans
- ‚úÖ Best practices –¥–ª—è —Ä–µ–∞–ª—å–Ω–∏—Ö –ø—Ä–æ—î–∫—Ç—ñ–≤

**–ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏**: –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö —Ç–∞ –≤–∏–≤—á–∞–π—Ç–µ Window Functions –¥–ª—è —â–µ –±—ñ–ª—å—à –ø–æ—Ç—É–∂–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤!
::
