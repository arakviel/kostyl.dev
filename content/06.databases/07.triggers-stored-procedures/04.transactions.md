---
title: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
description: –ó–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ ACID –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ
---

# –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó

## –ü—Ä–æ–±–ª–µ–º–∞: –Ø–∫ –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –ø—Ä–∏ –∫—ñ–ª—å–∫–æ—Ö –æ–ø–µ—Ä–∞—Ü—ñ—è—Ö?

–£—è–≤—ñ—Ç—å –ø–µ—Ä–µ–∫–∞–∑ –≥—Ä–æ—à–µ–π –º—ñ–∂ –±–∞–Ω–∫—ñ–≤—Å—å–∫–∏–º–∏ —Ä–∞—Ö—É–Ω–∫–∞–º–∏:

```sql
-- –ö—Ä–æ–∫ 1: –ó–Ω—è—Ç–∏ –≥—Ä–æ—à—ñ –∑ —Ä–∞—Ö—É–Ω–∫—É –ê
UPDATE Accounts SET Balance = Balance - 1000 WHERE Id = 1;

-- üí• –û–ô! –°–µ—Ä–≤–µ—Ä –≤–ø–∞–≤ —Ç—É—Ç...

-- –ö—Ä–æ–∫ 2: –î–æ–¥–∞—Ç–∏ –≥—Ä–æ—à—ñ –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫ –ë (–ù–ï –í–ò–ö–û–ù–ê–í–°–Ø!)
UPDATE Accounts SET Balance = Balance + 1000 WHERE Id = 2;
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ì—Ä–æ—à—ñ –∑–Ω–∏–∫–ª–∏! –ó–Ω—è–ª–∏ –∑ —Ä–∞—Ö—É–Ω–∫—É –ê, –∞–ª–µ –Ω–µ –¥–æ–¥–∞–ª–∏ –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫ –ë.

**–†–æ–∑–≤'—è–∑–æ–∫**: –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –¢–†–ê–ù–ó–ê–ö–¶–Ü–Æ!

```sql
BEGIN TRANSACTION;

    -- –ö—Ä–æ–∫ 1
    UPDATE Accounts SET Balance = Balance - 1000 WHERE Id = 1;
    
    -- –ö—Ä–æ–∫ 2
    UPDATE Accounts SET Balance = Balance + 1000 WHERE Id = 2;

COMMIT TRANSACTION;  -- –ê–ë–û –æ–±–∏–¥–≤–∞ –∫—Ä–æ–∫–∏, –ê–ë–û –∂–æ–¥–µ–Ω!
```

::mermaid

```mermaid
flowchart TB
    Start[BEGIN TRANSACTION]
    
    Op1[UPDATE Account A\n-1000]
    Op2[UPDATE Account B\n+1000]
    
    Check{–ü–æ–º–∏–ª–∫–∞?}
    
    Commit[COMMIT\n–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏]
    Rollback[ROLLBACK\n–í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –í–°–ï]
    
    Start --> Op1
    Op1 --> Op2
    Op2 --> Check
    
    Check -->|–ù—ñ| Commit
    Check -->|–¢–∞–∫| Rollback
    
    Rollback -.->|–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –¥–æ\n–ø–µ—Ä—à–æ–≥–æ —Å—Ç–∞–Ω—É| Start
    
    style Commit fill:#10b981,color:#fff
    style Rollback fill:#ef4444,color:#fff
```

::

**–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è** ‚Äî —Ü–µ –≥—Ä—É–ø–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π, —è–∫—ñ –ª–æ–≥—ñ—á–Ω–æ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —è–∫ **–æ–¥–Ω–µ —Ü—ñ–ª–µ**. –ê–±–æ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è **–≤—Å—ñ**, –∞–±–æ **–∂–æ–¥–Ω–∞**.

---

## ACID –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ

–ö–æ–∂–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–æ–≤–∏–Ω–Ω–∞ –º–∞—Ç–∏ **4 –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ** (ACID):

::card-group
::card{icon="i-lucide-atom" title="Atomicity (–ê—Ç–æ–º–∞—Ä–Ω—ñ—Å—Ç—å)"}
**"–í—Å–µ –∞–±–æ –Ω—ñ—á–æ–≥–æ"**

–ê–±–æ –≤–∏–∫–æ–Ω–∞–ª–∏—Å—è –í–°–Ü –æ–ø–µ—Ä–∞—Ü—ñ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó, –∞–±–æ –ñ–û–î–ù–ê. –ß–∞—Å—Ç–∫–æ–≤–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –Ω–µ–º–æ–∂–ª–∏–≤–µ.

```sql
BEGIN TRAN;
  INSERT INTO Orders (...);  -- –í–∏–∫–æ–Ω–∞–Ω–æ
  -- üí• –ü–æ–º–∏–ª–∫–∞ —Ç—É—Ç!
  UPDATE Stock ...;          -- –ù–ï –≤–∏–∫–æ–Ω–∞–Ω–æ
ROLLBACK;  -- –í–°–ï –≤—ñ–¥–º—ñ–Ω–µ–Ω–æ!
```
::

::card{icon="i-lucide-check-circle" title="Consistency (–£–∑–≥–æ–¥–∂–µ–Ω—ñ—Å—Ç—å)"}
**"–î–∞–Ω—ñ –∑–∞–≤–∂–¥–∏ –≤–∞–ª—ñ–¥–Ω—ñ"**

–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –ë–î –∑ –æ–¥–Ω–æ–≥–æ **–≤–∞–ª—ñ–¥–Ω–æ–≥–æ —Å—Ç–∞–Ω—É** –≤ —ñ–Ω—à–∏–π **–≤–∞–ª—ñ–¥–Ω–∏–π —Å—Ç–∞–Ω**. –ü—Ä–∞–≤–∏–ª–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ (constraints) –¥–æ—Ç—Ä–∏–º—É—é—Ç—å—Å—è.

```sql
-- –ë—É–ª–æ: A=1000, B=500
BEGIN TRAN;
  UPDATE ... A-500;  -- A=500
  UPDATE ... B+500;  -- B=1000
COMMIT;
-- –°—Ç–∞–ª–æ: A=500, B=1000
-- –°—É–º–∞: 1500 = 1500 ‚úÖ
```
::

::card{icon="i-lucide-shield" title="Isolation (–Ü–∑–æ–ª—å–æ–≤–∞–Ω—ñ—Å—Ç—å)"}
**"–ù–µ –∑–∞–≤–∞–∂–∞—Ç–∏ —ñ–Ω—à–∏–º"**

–ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—é—Ç—å –º—ñ–∂ —Å–æ–±–æ—é. –ö–æ–∂–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è "–±–∞—á–∏—Ç—å" —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—ó –∑–º—ñ–Ω–∏ –¥–æ COMMIT.

```sql
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 1
BEGIN TRAN;
  UPDATE Products SET Price=100 WHERE Id=1;
  -- –Ü–Ω—à—ñ –ù–ï –±–∞—á–∞—Ç—å –∑–º—ñ–Ω–∏!
COMMIT;  -- –¢–µ–ø–µ—Ä –≤—Å—ñ –±–∞—á–∞—Ç—å
```
::

::card{icon="i-lucide-database" title="Durability (–î–æ–≤–≥–æ—á–∞—Å–Ω—ñ—Å—Ç—å)"}
**"–ù–∞–∑–∞–≤–∂–¥–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ"**

–ü—ñ—Å–ª—è COMMIT –∑–º—ñ–Ω–∏ **–≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ** –∑–±–µ—Ä–µ–∂–µ–Ω—ñ, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –≤–ø–∞–¥–µ.

```sql
COMMIT TRANSACTION;
-- üí• –°–µ—Ä–≤–µ—Ä –≤–ø–∞–≤!
-- –ü—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω—ñ –ù–ê –ú–Ü–°–¶–Ü ‚úÖ
```
::
::

---

## –¢–∏–ø–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π —û MS SQL Server

### 1. –Ø–≤–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó (Explicit)

–í–∏ **—è–≤–Ω–æ** –≤–∫–∞–∑—É—î—Ç–µ –ø–æ—á–∞—Ç–æ–∫ —ñ –∫—ñ–Ω–µ—Ü—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.

```sql
BEGIN TRANSACTION;  -- –∞–±–æ BEGIN TRAN

    INSERT INTO book.Books (...);
    UPDATE book.Authors SET ...;
    DELETE FROM book.Themes WHERE ...;

COMMIT TRANSACTION;  -- –∞–±–æ COMMIT
-- –ê–ë–û
ROLLBACK TRANSACTION;  -- –∞–±–æ ROLLBACK
```

**–ö–æ–º–∞–Ω–¥–∏**:
- `BEGIN TRANSACTION [name]` ‚Äî –ø–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é
- `COMMIT [TRANSACTION] [name]` ‚Äî –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
- `ROLLBACK [TRANSACTION] [name]` ‚Äî –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏ –∑–º—ñ–Ω–∏
- `SAVE TRANSACTION savepoint_name` ‚Äî —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–æ—á–∫—É –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è

### 2. –ù–µ —è–≤–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó (Implicit)

–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ **–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è** –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ DML/DDL, –∞–ª–µ **–≤—Ä—É—á–Ω—É –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è**.

```sql
SET IMPLICIT_TRANSACTIONS ON;

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è
INSERT INTO Books (...);

-- –¢—Ä–µ–±–∞ –≤—Ä—É—á–Ω—É –∑–∞–≤–µ—Ä—à–∏—Ç–∏!
COMMIT;
```

::warning
**–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ**: –õ–µ–≥–∫–æ –∑–∞–±—É—Ç–∏ COMMIT ‚Üí –¥–∞–Ω—ñ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ!
::

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó (Autocommit)

–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∫–æ–∂–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ ‚Äî —Ü–µ –æ–∫—Ä–µ–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è.

```sql
INSERT INTO Books (...);  -- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ: BEGIN + COMMIT

UPDATE Authors ...;  -- –©–µ –æ–¥–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
```

**–†–µ–∂–∏–º –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º** –≤ SQL Server.

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏

### –ü—Ä–∏–∫–ª–∞–¥ 1: –ë–∞–∑–æ–≤–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è

```sql
BEGIN TRANSACTION;

    -- 1. –î–æ–¥–∞—î–º–æ –Ω–æ–≤—É —Ç–µ–º–∞—Ç–∏–∫—É
    INSERT INTO book.Themes (NameTheme)
    VALUES ('–®—Ç—É—á–Ω–∏–π —ñ–Ω—Ç–µ–ª–µ–∫—Ç');
    
    -- 2. –û–Ω–æ–≤–ª—é—î–º–æ –∞–≤—Ç–æ—Ä–∞
    UPDATE book.Authors
    SET CountryId = (SELECT Id FROM global.Country WHERE NameCountry = '–£–∫—Ä–∞—ó–Ω–∞');

COMMIT TRANSACTION;
```

### –ü—Ä–∏–∫–ª–∞–¥ 2: –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ —á–µ—Ä–µ–∑ TRY...CATCH

```sql
BEGIN TRY
    BEGIN TRANSACTION;
    
        INSERT INTO sale.Sales (BookId, Quantity, Price)
        VALUES (1, 2, 299.99);
        
        UPDATE book.Books
        SET QuantityInStock = QuantityInStock - 2
        WHERE Id = 1;
    
    COMMIT TRANSACTION;
    PRINT '–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
    
END TRY
BEGIN CATCH
    ROLLBACK TRANSACTION;
    
    PRINT '–ü–æ–º—ñ–ª–∫–∞: ' + ERROR_MESSAGE();
    PRINT '–ù–æ–º–µ—Ä –ø–æ–º–∏–ª–∫–∏: ' + CAST(ERROR_NUMBER() AS NVARCHAR);
    PRINT '–†—è–¥–æ–∫ –ø–æ–º–∏–ª–∫–∏: ' + CAST(ERROR_LINE() AS NVARCHAR);
END CATCH;
```

**–§—É–Ω–∫—Ü—ñ—ó –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫**:
- `ERROR_NUMBER()` ‚Äî –Ω–æ–º–µ—Ä –ø–æ–º–∏–ª–∫–∏
- `ERROR_MESSAGE()` ‚Äî —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏
- `ERROR_LINE()` ‚Äî —Ä—è–¥–æ–∫, –¥–µ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞
- `ERROR_SEVERITY()` ‚Äî —Ä—ñ–≤–µ–Ω—å —Å–µ—Ä–π–æ–∑–Ω–æ—Å—Ç—ñ –ø–æ–º–∏–ª–∫–∏
- `ERROR_STATE()` ‚Äî —Å—Ç–∞–Ω –ø–æ–º–∏–ª–∫–∏

### –ü—Ä–∏–∫–ª–∞–¥ 3: –¢–æ—á–∫–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è (Savepoints)

–î–æ–∑–≤–æ–ª—è—é—Ç—å –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏ **—á–∞—Å—Ç–∏–Ω—É** —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó, –∞ –Ω–µ –≤—Å—é.

```sql
BEGIN TRANSACTION;

    -- –ö—Ä–æ–∫ 1
    INSERT INTO book.Authors (FirstName, LastName) VALUES ('–Ü–≤–∞–Ω', '–§—Ä–∞–Ω–∫–æ');
    SAVE TRANSACTION SavePoint1;  -- –¢–æ—á–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è 1
    
    -- –ö—Ä–æ–∫ 2
    INSERT INTO book.Themes (NameTheme) VALUES ('–ü–æ–µ–∑—ñ—è');
    SAVE TRANSACTION SavePoint2;  -- –¢–æ—á–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è 2
    
    -- –ö—Ä–æ–∫ 3
    UPDATE book.Authors SET CountryId = NULL;  -- –ü–æ–º–∏–ª–∫–∞!
    
    -- –í—ñ–¥–º—ñ–Ω–∞ —Ç—ñ–ª—å–∫–∏ –¥–æ —Ç–æ—á–∫–∏ 2
    ROLLBACK TRANSACTION SavePoint2;
    
    -- –ö—Ä–æ–∫ 1 —Ç–∞ 2 –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è!
COMMIT TRANSACTION;
```

::plant-uml

```plantuml
@startuml
skinparam style plain
skinparam defaultFontName "Segoe UI"

rectangle "BEGIN TRANSACTION" as Begin #LightBlue

rectangle "INSERT Authors" as Op1 #LightGreen
rectangle "SAVE SavePoint1" as SP1 #Yellow

rectangle "INSERT Themes" as Op2 #LightGreen
rectangle "SAVE SavePoint2" as SP2 #Yellow

rectangle "UPDATE (–ø–æ–º–∏–ª–∫–∞)" as Op3 #LightCoral

rectangle "ROLLBACK TO SavePoint2" as RB #Orange
note right of RB
  –í—ñ–¥–º—ñ–Ω—è—î —Ç—ñ–ª—å–∫–∏ Op3
  Op1 —Ç–∞ Op2 –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è!
end note

rectangle "COMMIT" as Commit #LightGreen

Begin --> Op1
Op1 --> SP1
SP1 --> Op2
Op2 --> SP2
SP2 --> Op3
Op3 --> RB
RB --> Commit

@enduml
```

::

### –ü—Ä–∏–∫–ª–∞–¥ 4: –í–∫–ª–∞–¥–µ–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó

```sql
BEGIN TRANSACTION OuterTran;  -- –ó–æ–≤–Ω—ñ—à–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
    PRINT '–ó–æ–≤–Ω—ñ—à–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–æ—á–∞–ª–∞—Å—è';
    
    INSERT INTO book.Authors (...);
    
    BEGIN TRANSACTION InnerTran;  -- –í–Ω—É—Ç—Ä—ñ—à–Ω—è
        PRINT '–í–Ω—É—Ç—Ä—ñ—à–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–æ—á–∞–ª–∞—Å—è';
        
        INSERT INTO book.Books (...);
        
    COMMIT TRANSACTION InnerTran;
    
COMMIT TRANSACTION OuterTran;

-- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä—ñ–≤–Ω—è –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ
SELECT @@TRANCOUNT AS TransactionLevel;
```

::note
**–í–∞–∂–ª–∏–≤–æ –ø—Ä–æ –≤–∫–ª–∞–¥–µ–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó**:

- `@@TRANCOUNT` ‚Äî –ø–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ (0 = –Ω–µ–º–∞—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π)
- `COMMIT` –∑–º–µ–Ω—à—É—î `@@TRANCOUNT` –Ω–∞ 1
- `ROLLBACK` (–±–µ–∑ —ñ–º–µ–Ω—ñ) –æ–±–Ω—É–ª—è—î `@@TRANCOUNT` —ñ –≤—ñ–¥–º—ñ–Ω—è—î –í–°–ï!
- –†–µ–∞–ª—å–Ω–∏–π COMMIT –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ `@@TRANCOUNT` —Å—Ç–∞—î 0
::

---

## –°–∏—Å—Ç–µ–º–Ω—ñ –∑–º—ñ–Ω–Ω—ñ

### @@TRANCOUNT

–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π (—Ä—ñ–≤–µ–Ω—å –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ).

```sql
SELECT @@TRANCOUNT;  -- 0 (–Ω–µ–º–∞—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π)

BEGIN TRAN;
SELECT @@TRANCOUNT;  -- 1

  BEGIN TRAN;
  SELECT @@TRANCOUNT;  -- 2
  
  COMMIT;
SELECT @@TRANCOUNT;  -- 1

COMMIT;
SELECT @@TRANCOUNT;  -- 0
```

### @@ERROR

–ù–æ–º–µ—Ä –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –ø–æ–º–∏–ª–∫–∏ (0 = –Ω–µ–º–∞—î –ø–æ–º–∏–ª–∫–∏).

```sql
INSERT INTO Books (Id, Title) VALUES (1, 'Test');

IF @@ERROR <> 0
BEGIN
    PRINT '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤—Ü—ñ!';
    ROLLBACK;
END
ELSE
BEGIN
    COMMIT;
END
```

::tip
**Best Practice**: –ó–∞–º—ñ—Å—Ç—å `@@ERROR` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ **TRY...CATCH** –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫!
::

---

## –†—ñ–≤–Ω—ñ —ñ–∑–æ–ª—è—Ü—ñ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

–†—ñ–≤–µ–Ω—å —ñ–∑–æ–ª—è—Ü—ñ—ó –≤–∏–∑–Ω–∞—á–∞—î **—è–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤–ø–ª–∏–≤–∞—é—Ç—å –æ–¥–Ω–∞ –Ω–∞ –æ–¥–Ω—É**.

| –†—ñ–≤–µ–Ω—å                 | Dirty Read | Non-Repeatable Read | Phantom Read |
| :--------------------- | :--------- | :------------------ | :----------- |
| READ UNCOMMITTED       | ‚úÖ –ú–æ–∂–ª–∏–≤–æ | ‚úÖ –ú–æ–∂–ª–∏–≤–æ          | ‚úÖ –ú–æ–∂–ª–∏–≤–æ   |
| READ COMMITTED (–∑–∞ –∑–∞–º–æ–≤—á.) | ‚ùå –ù—ñ | ‚úÖ –ú–æ–∂–ª–∏–≤–æ          | ‚úÖ –ú–æ–∂–ª–∏–≤–æ   |
| REPEATABLE READ        | ‚ùå –ù—ñ      | ‚ùå –ù—ñ               | ‚úÖ –ú–æ–∂–ª–∏–≤–æ   |
| SERIALIZABLE           | ‚ùå –ù—ñ      | ‚ùå –ù—ñ               | ‚ùå –ù—ñ        |

**–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è**:

```sql
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

BEGIN TRANSACTION;
    SELECT * FROM Books;
COMMIT;
```

::note
**Terminology**:
- **Dirty Read** ‚Äî –ß–∏—Ç–∞–Ω–Ω—è –Ω–µ–∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö —ñ–Ω—à–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
- **Non-Repeatable Read** ‚Äî –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É —á–∏—Ç–∞–Ω–Ω—ñ –¥–∞–Ω—ñ –∑–º—ñ–Ω–∏–ª–∏—Å—è
- **Phantom Read** ‚Äî –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É —á–∏—Ç–∞–Ω–Ω—ñ –∑'—è–≤–∏–ª–∏—Å—è/–∑–Ω–∏–∫–ª–∏ —Ä—è–¥–∫–∏
::

---

## Deadlock (–í–∑–∞—î–º–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è)

–î–≤—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —á–µ–∫–∞—é—Ç—å –æ–¥–Ω–∞ –Ω–∞ –æ–¥–Ω—É ‚Üí **–≥–ª—É—Ö–∏–π –∫—É—Ç**.

::mermaid

```mermaid
flowchart LR
    T1[–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 1] -->|–ë–ª–æ–∫—É—î| TableA[Table A]
    T1 -.->|–ß–µ–∫–∞—î| TableB
    
    T2[–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 2] -->|–ë–ª–æ–∫—É—î| TableB[Table B]
    T2 -.->|–ß–µ–∫–∞—î| TableA
    
    style T1 fill:#ef4444,color:#fff
    style T2 fill:#ef4444,color:#fff
```

::

**–ü—Ä–∏–∫–ª–∞–¥**:

```sql
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 1
BEGIN TRAN;
  UPDATE Books SET Price=100 WHERE Id=1;  -- –ë–ª–æ–∫—É—î Books
  -- –ß–µ–∫–∞—î Themes...
  UPDATE Themes SET ...;  -- Themes –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—î—é 2!
COMMIT;

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è 2 (–æ–¥–Ω–æ—á–∞—Å–Ω–æ)
BEGIN TRAN;
  UPDATE Themes SET ...;  -- –ë–ª–æ–∫—É—î Themes
  -- –ß–µ–∫–∞—î Books...
  UPDATE Books SET ...;  -- Books –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—î—é 1!
COMMIT;

-- üí• DEADLOCK!
```

**SQL Server –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ**:
1. –í–∏—è–≤–ª—è—î deadlock
2. –í–∏–±–∏—Ä–∞—î "–∂–µ—Ä—Ç–≤—É" (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –∑ –º–µ–Ω—à–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –∑–º—ñ–Ω)
3. –í—ñ–¥–º—ñ–Ω—è—î —Ü—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é (ROLLBACK)

**–Ø–∫ —É–Ω–∏–∫–Ω—É—Ç–∏**:
- –ó–∞–≤–∂–¥–∏ –±–ª–æ–∫—É–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ –≤ **–æ–¥–Ω–∞–∫–æ–≤–æ–º—É –ø–æ—Ä—è–¥–∫—É**
- –¢—Ä–∏–º–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó **–∫–æ—Ä–æ—Ç–∫–∏–º–∏**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ä—ñ–≤–µ–Ω—å —ñ–∑–æ–ª—è—Ü—ñ—ó

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

::accordion

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 1: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é" icon="i-lucide-check-square"}

**–£–º–æ–≤–∞**: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–Ω–∏ –∫–Ω–∏–≥–∏ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é (—Ü—ñ–Ω–∞ > 0).

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
BEGIN TRY
    BEGIN TRANSACTION;
    
    DECLARE @newPrice DECIMAL(10,2) = 299.99;
    
    IF @newPrice <= 0
    BEGIN
        RAISERROR('–¶—ñ–Ω–∞ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –±—ñ–ª—å—à–∞ –∑–∞ 0', 16, 1);
    END
    
    UPDATE book.Books
    SET Price = @newPrice
    WHERE Id = 1;
    
    COMMIT TRANSACTION;
    PRINT '–¶—ñ–Ω—É –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ';
    
END TRY
BEGIN CATCH
    ROLLBACK TRANSACTION;
    PRINT '–ü–æ–º–∏–ª–∫–∞: ' + ERROR_MESSAGE();
END CATCH;
```

</details>

::

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 2: –¢–æ—á–∫–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è" icon="i-lucide-bookmark"}

**–£–º–æ–≤–∞**: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Ç–æ—á–∫–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–ª—è —á–∞—Å—Ç–∫–æ–≤–æ–≥–æ –≤—ñ–¥–º—ñ–Ω–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.

<details>
<summary>üí° –†–æ–∑–≤'—è–∑–æ–∫</summary>

```sql
BEGIN TRANSACTION;

    INSERT INTO book.Authors (FirstName, LastName) VALUES ('–¢–∞—Ä–∞—Å', '–®–µ–≤—á–µ–Ω–∫–æ');
    PRINT '–ê–≤—Ç–æ—Ä –¥–æ–¥–∞–Ω–∏–π';
    SAVE TRANSACTION AuthorAdded;
    
    INSERT INTO book.Themes (NameTheme) VALUES ('–ö–ª–∞—Å–∏–∫–∞');
    PRINT '–¢–µ–º–∞—Ç–∏–∫–∞ –¥–æ–¥–∞–Ω–∞';
    SAVE TRANSACTION ThemeAdded;
    
    -- –°–ø—Ä–æ–±–∞ –¥–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É (–º–æ–∂–ª–∏–≤–∞ –ø–æ–º–∏–ª–∫–∞)
    BEGIN TRY
        INSERT INTO book.Books (AuthorId, ThemeId, Title) VALUES (999, 1, 'Test');
    END TRY
    BEGIN CATCH
        PRINT '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–Ω–∏–≥–∏, –≤—ñ–¥–º—ñ–Ω–∞ –¥–æ ThemeAdded';
        ROLLBACK TRANSACTION ThemeAdded;
    END CATCH;

COMMIT TRANSACTION;
```

</details>

::

::

---

## –†–µ–∑—é–º–µ

::tip
**–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π**:

1. **ACID**: Atomicity, Consistency, Isolation, Durability
2. **BEGIN TRAN**: –ü–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é
3. **COMMIT**: –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
4. **ROLLBACK**: –í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –∑–º—ñ–Ω–∏
5. **SAVE TRANSACTION**: –¢–æ—á–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
6. **TRY...CATCH**: –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
7. **@@TRANCOUNT**: –†—ñ–≤–µ–Ω—å –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ
8. **–†—ñ–≤–Ω—ñ —ñ–∑–æ–ª—è—Ü—ñ—ó**: READ COMMITTED –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

**Best Practices**:
- –¢—Ä–∏–º–∞–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∫–æ—Ä–æ—Ç–∫–∏–º–∏
- –ó–∞–≤–∂–¥–∏ –æ–±—Ä–æ–±–ª—è–π—Ç–µ –ø–æ–º–∏–ª–∫–∏ —á–µ—Ä–µ–∑ TRY...CATCH
- –£–Ω–∏–∫–∞–π—Ç–µ deadlock —á–µ—Ä–µ–∑ –æ–¥–Ω–∞–∫–æ–≤–∏–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ SAVE TRANSACTION –¥–ª—è —Å–∫–ª–∞–¥–Ω–æ—ó –ª–æ–≥—ñ–∫–∏
- –ü–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ @@TRANCOUNT –ø–µ—Ä–µ–¥ COMMIT

**–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫**: –í–∏–≤—á—ñ—Ç—å [Transact-SQL —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è](03.transact-sql-extensions.md) –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–Ω—è —Å–∫–ª–∞–¥–Ω—ñ—à–æ—ó –ª–æ–≥—ñ–∫–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è—Ö.
::
