Розділ: Обмежені контексти. Інтеграція обмежених контекстів.

Пункт: Що таке модель?

Модель — це спрощене уявлення об'єкта або явища, в якому свідомо виділяються певні аспекти та ігноруються інші. Це абстракція, створена для конкретного використання.

Ребекка Вірфс-Брок (англійською Rebecca Wirfs-Brock) сказала — модель — це не копія реального світу, а конструкція, створена людиною, що допомагає зрозуміти системи реального світу.

Класичним прикладом моделі є карта. Наприклад, навігаційна карта, карта місцевості, карта метро — кожна з них показує лише ту інформацію, яка необхідна для її конкретного завдання.

Як ми бачимо на відповідній схемі, карта як модель демонструє цей принцип.

Пункт: Ефективне моделювання

Кожна модель має свою мету, і ефективна модель включає лише ті деталі, які потрібні для її досягнення.

Наприклад, на карті світу не буде станцій метро. На карті метро неможливо оцінити географічні відстані.

Корисна модель — це не копія реального світу, а інструмент для вирішення конкретної задачі. Як сказав статистик Джордж Бокс (англійською George Box) — "Усі моделі є хибними, але деякі корисними".

Моделі допомагають зменшувати складність, опускаючи зайві деталі й залишаючи лише те, що необхідно. Проте погана абстракція може упустити важливі деталі або додати зайве, що створить проблеми.

Як зазначив Едсгер Дейкстра (англійською Edsger Dijkstra) — "Мета абстрагування — створення нового рівня семантики, де можна бути абсолютно точним".

Пункт: Моделювання предметної області

Створюючи єдину мову, ми фактично будуємо модель предметної області, яка повинна відображати уявлення експертів про бізнес, включати об'єкти, їх поведінку, причинно-наслідкові зв'язки та інваріанти.

Модель не повинна охоплювати всі деталі. Вона має включати лише ті аспекти, які потрібні для реалізації конкретного програмного продукту.

Комунікація між розробниками та експертами є критично важливою. Недопрацювання у спілкуванні можуть призвести до серйозних помилок у продукті.

Пункт: Неперервна робота

Створення єдиної мови вимагає постійної взаємодії з експертами. Мова має використовуватись усіма зацікавленими сторонами на кожному етапі проекту. Її слід вдосконалювати у вимогах, тестах, документації та коді. Єдина мова — це динамічний процес.

Зміни у предметній області вимагають оновлення мови. Постійне використання мови дозволяє глибше зрозуміти суть предметної області.

Пункт: Інструменти для підтримки

Для управління та зберігання єдиної мови можна використовувати кілька інструментів.

Перший інструмент — глосарій, наприклад, на вікі-сторінках. Допомагає новим членам команди швидше адаптуватись. Має оновлюватись всіма членами команди.

Другий інструмент — сценарії використання або Геркін-тести (англійською Gherkin-тести). Дозволяють фіксувати поведінку та бізнес-логіку. Наприклад, розглянемо сценарій "Повідомити агента про новий запит". Дано — користувач подає запит з текстом "Мені потрібна допомога в налаштуванні Ей-Дабл-Ю-Ес" (англійською AWS). Коли — запит призначено містеру Вольфу. Тоді — агент отримує повідомлення про новий запит.

Третій інструмент — інструменти статичного аналізу коду, наприклад, Ен-Депенд (англійською NDepend). Допомагають перевіряти використання термінів єдиної мови в коді.

Незважаючи на важливість інструментів, вони не замінять реального використання мови у повсякденній роботі.

Підрозділ: Складнощі в розробці єдиної мови

Пункт: Теоретичний підхід

Розробка єдиного мови виглядає простою в теорії, але на практиці це може бути складніше. Успіх залежить від спілкування з експертами — вони є ключовими носіями знань про предметну область. Також від виявлення невидимих знань — часто важливі знання не задокументовані і не систематизовані, вони перебувають лише в свідомості експертів.

Пункт: Проблеми при зборі знань

Згодом, ви зрозумієте, що процес збору знань часто полягає не тільки в ідентифікації вже існуючих фактів, а й у спільному створенні моделі разом з експертами.

Можливі проблеми. По-перше, неясності у розумінні — у самих експертів можуть бути прогалини в розумінні своєї бізнес-сфери. По-друге, недостатність визначень — концепції, які не мають чітких визначень. По-третє, граничні випадки — важливо враховувати всі можливі сценарії, а не лише позитивні.

Пункт: Взаємне навчання

Процес навчання в таких умовах є взаємним — ви допомагаєте експертам краще розуміти їхню предметну область. Це дозволяє виявити приховані невідповідності та підвищити точність моделі.

Пункт: Впровадження в існуючий проект

Іноді предметна область вже описана наявним мовним апаратом в організації. Але цей мова може бути технічним — використання термінів типу "імена таблиць бази даних". Або неефективним — він може не відображати суть предметної області, оскільки не слідує методології предметно-орієнтованого проектування.

Виклики. По-перше, зміна існуючого мови — це складний і довготривалий процес. По-друге, терпіння — важливо переконатися, що новий мова використовується у документації та коді.

Пункт: Як вибрати мову?

На питання, яку мову вибрати в неангломовній країні, моя порада — використовуйте англійські іменники для позначення об'єктів предметної області. Це спростить застосування єдиної термінології в коді.

Підрозділ: Висновок

Пункт: Ключові ідеї

Перша ідея. Ефективне спілкування є основою для успішного створення програмного продукту.

Друга ідея. Єдиний мова допомагає усунути розрив у знаннях між експертами та розробниками.

Пункт: Роль єдиної мови

По-перше, уніфікація термінів. Усі поняття мають бути чітко визначені, без неоднозначностей.

По-друге, спільне використання. Мова має бути використана у всіх сферах — від розмов до коду.

Пункт: Розвиток єдиного мови

Це безперервний процес — мова має еволюціонувати разом з проектом.

Залучення інструментів. Глосарії на основі вікі-сторінок. Геркін-тести для документування.

Пункт: Підсумок

Єдиний мова — це не просто термінологія. Це основа для ефективного спілкування та взаємодії на всіх етапах проекту.

Підрозділ: Як осмислити складність предметної області

Пункт: Протиріччя в моделях

Приклад — телемаркетингова компанія. Розглянемо ситуацію з телемаркетинговою компанією. Маркетинговий відділ залучає потенційних клієнтів через онлайн-рекламу. Відділ продажів працює з потенційними клієнтами, щоб перетворити їх на покупців.

Як ми бачимо на відповідній схемі, можна побачити послідовність процесу обробки лідів.

Проблема. При аналізі мови експертів предметної області з'являється дивна особливість. Термін "лід" (англійською lead) в маркетинговому відділі та відділі продажів має різні значення.

Маркетинговий відділ. Для маркетологів "лід" — це подія отримання контактної інформації потенційного клієнта. Простий опис — "Хтось проявив інтерес".

Відділ продажів. Для продавців "лід" — це весь життєвий цикл взаємодії з клієнтом. Це складний процес, який включає багато етапів.

Виникає питання — як створити єдину мову для компанії?

Пункт: Виклик

Єдина мова має бути позбавлена протиріч. У кожного терміну має бути одне значення. Але ментальні моделі експертів у відділах маркетингу та продажів суттєво різняться.

На практиці люди легко розуміють значення терміну "лід" із контексту розмови. Але у вихідному коді така неоднозначність може стати причиною помилок.

Спроби вирішення. Перша спроба — модель продажів у маркетингу. Надлишок деталей, які не потрібні для оптимізації рекламних кампаній. Друга спроба — модель маркетингу у продажах. Занадто спрощений підхід, що не відповідає вимогам продажів.

У першому випадку виникає зайва складність, а в другому — втрата важливої інформації.

Пункт: Рішення

Перше рішення — універсальна модель. Традиційний підхід — створення єдиної моделі для всіх задач. Але такі моделі часто стають надто громіздкими.

Проблеми — зайві деталі, складність пошуку потрібної інформації, підтримання непротирічності даних.

Друге рішення — додавання префіксів. Наприк
лад, "маркетинговий лід" і "продажний лід".

Недоліки. По-перше, когнітивне навантаження — яку модель використовувати в конкретному випадку? По-друге, невідповідність єдиній мові — у розм овах люди не використовують префікси, покладаючись на контекст.

Третє рішення — паттерн обмеженого контексту (баундед контекст — англійською Bounded Context). Використання окремих контекстів для маркетингового та продажного лідів. Цей підхід дозволяє створювати незалежні моделі для кожного піддомена, зменшуючи кількість конфліктів.

Як ми бачимо на відповідній схемі обмеженого контексту, можна побачити цей підхід.

Далі ми детально розглянемо, як працює паттерн обмеженого контексту та які вигоди він приносить у розробці програмного забезпечення.

Підрозділ: Що таке обмежений контекст?

Ця проблема в предметно-орієнтованому проєктуванні вирішується доволі просто: необхідно розділити єдину мову на кілька менших за обсягом мов і призначити кожній із них чіткий контекст застосування — її обмежений контекст.

У попередньому прикладі можна виділити два обмежених контексти: маркетинг і продажі. Як ми бачимо на рисунку, термін "лід" (або лід — англійською lead) використовується в обох обмежених контекстах. Поки кожен контекст має єдине значення терміна, обидві мови залишаються послідовними та відповідають ментальним моделям експертів предметної області. Термінологічні конфлікти та неявні контексти є природною частиною будь-якого великого бізнесу.

У шаблоні обмеженого контексту самі контексти моделюються як явна і невід'ємна частина предметної області.

Підрозділ: Межі моделі.

Модель — це не копія реального світу, а концепт, який допомагає зрозуміти складну систему. Завдання, яке вирішується за допомогою моделі, є її призначенням. Модель не може існувати без меж, інакше вона розшириться до копії реального світу. Тому визначення меж моделі — її обмежених контекстів — є обов’язковою частиною процесу моделювання.

Розглянемо приклад із картами. Кожна карта має свій контекст: авіаційний, морський, ландшафтний, метро тощо. Карта є корисною та несуперечливою лише в рамках свого призначення.

Так само, як карта метро є марною для морської навігації, єдина мова в одному обмеженому контексті може бути недоречною в іншому контексті.

Обмежені контексти визначають сферу застосування єдиної мови та моделі, яку вона представляє. Вони дозволяють створювати різні моделі для різних областей задач (тобто для проблемних доменів — англійською problem domain).

Іншими словами, обмежені контексти — це межі узгодженості єдиної мови. Її термінологія, принципи та бізнес-правила узгоджуються лише в рамках відповідного контексту.

Підрозділ: Уточнення терміна «єдина мова».

Обмежені контексти дозволяють завершити визначення терміна «єдина мова» (або юбіквітос ленгвідж — англійською ubiquitous language).

По-перше. Єдина мова не є «універсальною». Вона не обов'язково має використовуватися в усій організації.
По-друге. Єдина мова застосовується лише в межах свого обмеженого контексту.
По-третє. Мова орієнтована на опис лише той моделі, яка визначена в межах цього контексту.

Оскільки модель не може існувати без задачі, для вирішення якої вона створена, єдину мову неможливо визначити або використовувати без чіткого контексту її застосування.

Підрозділ: Область застосування обмеженого контексту.

Пункт: Розмежування контекстів у предметній області.

На прикладі, наведеному на початку, ми побачили, як визначити межі, властиві предметній області. Експерти предметної області часто використовують різні ментальні моделі одного і того ж бізнес-об’єкта.

Щоб створити зрозумілу модель, доводиться:
Перше: Розділити модель на кілька частин.
Друге: Визначити чіткий контекст застосування для кожної частини – тобто обмежений контекст.

Основна перевага: непротиворічність єдиної мови в межах одного контексту. Це дозволяє уникати суперечливих моделей і термінології.

Підрозділ: Розмір обмеженого контексту.

Пункт: Вплив на дизайн.

По-перше. Великі контексти забезпечують узгодженість, але складні у підтримці.
По-друге. Маленькі контексти легші в управлінні, але викликають значні витрати на інтеграцію.

Пункт: Важливо розуміти.

По-перше. Розмір контексту має відповідати потребам бізнесу та організаційним обмеженням.
По-друге. Рішення щодо розміру обмеженого контексту – це стратегічний вибір.

Наприклад: у великих компаніях із розподіленими командами часто вигідніше ділити контексти для незалежного розвитку різних функцій.

Підрозділ: Коли слід розділяти обмежені контексти?

По-перше. Поява нових команд розробників. Коли в проєкті з'являються нові розробники, їм легше працювати з невеликими та чітко визначеними контекстами.

По-друге. Вимоги до життєвого циклу компонентів. Якщо компонент потрібно оновлювати або масштабувати незалежно від інших, його варто виділити в окремий контекст.

По-третє. Масштабування функціоналу. Якщо певна функція вимагає масштабування окремо від інших, це може стати приводом для виділення її в окремий контекст.

Пункт: Як уникнути проблем із декомпозицією?

Деколи надмірне розділення функціональності на контексти призводить до таких негативних наслідків як:
- Ускладнення синхронізації між контекстами.
- Підвищення витрат на інтеграцію.

Тому варто використовувати наступне емпіричне правило:
Перше: Знайдіть пов'язані сценарії використання (тобто когерентні юз кейси — англійською coherent use cases).
Друге: Переконайтесь, що вони працюють із однаковими даними.
Третє: Уникайте поділу таких сценаріїв на різні контексти, адже це ускладнює незалежний розвиток.

Підрозділ: Порівняння обмежених контекстів і піддоменів.

Пункт: Піддомени.
Піддомени виділяються на етапі аналізу бізнесу з метою зрозуміти бізнес-стратегію компанії. Згідно з методологією предметно-орієнтованого проєктування, піддомени класифікуються на:
По-перше. Основні (або кор — англійською Core).
По-друге. Універсальні (або дженерік — англійською Generic).
По-третє. Допоміжні (або саппортінг — англійською Supporting).

Піддомени схожі на набір взаємопов’язаних сценаріїв використання (або юз кейсів — англійською use cases), які визначаються предметною областю та вимогами бізнесу. Визначення піддоменів — це виключно бізнес-рішення, і розробники лише аналізують їх для кращого розуміння системи.

Пункт: Обмежені контексти.
Обмежені контексти визначаються вже на етапі проєктування системи. Вони відповідають за розподіл предметної області на більш керовані частини, які можна зручно підтримувати і розвивати. Це стратегічне рішення, яке залежить від особливостей проєкту, вимог до моделі та технічних обмежень.

Пункт: Взаємодія піддоменів і обмежених контекстів.

Теоретично можливо створити одну модель, яка охоплює всю предметну область, але це практично непридатно для складних систем. Коли з’являються конфліктуючі моделі, предметну область доцільно розділити на обмежені контексти.

Якщо моделі все ще занадто складні, їх можна розділити ще більше, утворюючи для кожного піддомену окремий обмежений контекст. Наприклад:
- Маленька система — одна модель охоплює весь домен.
- Складніша система — декілька моделей у межах піддоменів.
- Велика система — кожен піддомен має окремий обмежений контекст.

Ключові висновки:
- Піддомени виявляються як частина бізнес-аналізу.
- Обмежені контексти проектуються відповідно до потреб системи та команди.

Підрозділ: Границя як концепт проєктування.

Границя — ключова концепція системного проєктування.

Фраза: «Системне проєктування — це контекстуальне проєктування. Воно визначає, що буде всередині системи, що залишиться зовні, та як відбуватиметься взаємодія через ці межі». Ця думка належить Рут Малан.

Пункт: Фізичні границі.
Обмежені контексти не лише розділяють моделі, а й визначають фізичні межі реалізації систем.
По-перше. Кожен обмежений контекст реалізується як окремий сервіс або проєкт.
По-друге. Різні контексти можуть використовувати різні технологічні стеки для задоволення специфічних вимог.
По-третє. Один обмежений контекст може містити кілька піддоменів, які логічно розділяються за допомогою просторів імен, модулів чи пакетів.

Пункт: Границя володіння.

Розподіл роботи між командами — це ще одне стратегічне рішення, що використовує концепт обмежених контекстів.
- Один обмежений контекст має належати тільки одній команді.
- Команда може володіти кількома обмеженими контекстами, але жоден контекст не може бути спільним між різними командами.

Переваги такого розподілу:
- Уникнення неявних припущень між командами.
- Чітке визначення протоколів обміну даними для інтеграції моделей.

Підрозділ: Обмежені контексти у реальному житті.

Під час одного з моїх занять з предметно-орієнтованого проєктування один із учасників зауважив: «Ви сказали, що Ді-Ді-Ді (тобто DDD — англійською Domain-Driven Design) — це приведення дизайну програмного продукту у відповідність із предметними областями. Але де можна побачити обмежені контексти у реальному житті? В предметних областях немає обмежених контекстів».

Обмежені контексти дійсно не так очевидні, як предметні області і піддомени, але вони існують, так само як і ментальні моделі експертів предметної області. Вам потрібно просто зрозуміти, як експерти предметної області мислять про різні бізнес-сутності та процеси.

Я хочу завершити цю главу прикладами, які демонструють, що обмежені контексти набули широкого поширення не тільки при моделюванні предметних областей у програмних продуктах, але й при представленні того, як різні моделі використовуються в різних контекстах у реальному житті.

Пункт: Семантичні області.

Семантична область визначається як область значень і слів, що використовуються для того, щоб говорити про обмежений контекст. Наприклад, в семантичних областях розробки програмного і апаратного забезпечення такі слова, як "монітор", "порт" і "процесор", мають різні значення.

Досить своєрідним прикладом різних семантичних областей є значення слова "помідор".

Ось таблиця відповідності терміна в різних контекстах:
Контекст: Ботаніка. Визначення: Фрукт. Характеристики: Виростає з квітки та містить насіння.
Контекст: Кулінарія. Визначення: Овоч. Характеристики: Має м'яку або жорстку структуру, смак може бути солодким або кислим проти менш вираженого смаку.
Контекст: Оподаткування. Визначення: Овоч. Це юридичне рішення Верховного суду Сполучених Штатів Америки від 1893 року.
Контекст: Театр. Визначення: Механізм відгуку. Як зазначає мій колега Роме Моура (англійською Romeu Moura), це спосіб глядацького відгуку.

Згідно з визначенням, яке використовується в ботаніці, фрукт є способом поширення рослинами своїх насіння. Фрукт має виростати з квітки рослини та містити хоча б одне насіння. З іншого боку, овоч є загальним терміном, що охоплює всі інші їстівні частини рослини: корені, стебла та листя. Виходячи з цього визначення, помідор — це фрукт.

Але це визначення зовсім не підходить в контексті кулінарного мистецтва. У цьому контексті фрукти та овочі визначаються на основі їх смакових характеристик. Фрукти мають м'яку структуру, бувають солодкими або кислими, їх можна їсти сирими, а овочі мають більш жорстку структуру, менш виражений смак і часто потребують приготування. Згідно з цим визначенням, помідор є овочем.

Отже, в обмеженому контексті ботаніки помідор — це фрукт, а в обмеженому контексті кулінарії — овоч. Але це ще не все. У 1883 році Сполучені Штати запровадили 10-відсотковий податок, який поширювався на імпортовані овочі, але не на фрукти. Ботанічне визначення помідора як фрукта дозволяло ввозити помідори до Сполучених Штатів без сплати податку на імпорт. Щоб закрити лазівку, у 1893 році Верховний суд США ухвалив рішення класифікувати помідори як овочі. Отже, в обмеженому контексті оподаткування помідор є овочем.

Більше того, як говорить мій друг Роме Моура (англійською Romeu Moura), в обмеженому контексті театрального виступу помідор є механізмом глядацького відгуку.

Пункт: Наука.

Фраза: "Вчені в загальному згодні з тим, що жодна теорія не є на сто відсотків правильною. Тому знання справжньо перевіряються не їхньою істинністю, а їхньою корисністю". Ці слова належать Ювалю Ною Харарі (англійською Yuval Noah Harari).

Іншими словами, жодна наукова теорія не буде правильною абсолютно у всіх випадках. Різні теорії корисні в різних контекстах. Цю ідею можна продемонструвати за допомогою різних моделей гравітації, представлених сером Ісааком Ньютоном та Альбертом Ейнштейном. Згідно з законами руху Ньютона, простір і час абсолютні. Вони є сценою, на якій відбувається рух об'єктів. В теорії відносності Ейнштейна простір і час вже не абсолютні, а різні для різних спостерігачів.

Незважаючи на те, що ці дві моделі можна розглядати як взаємовиключні, обидві вони корисні в своїх відповідних або обмежених контекстах.

Пункт: Покупка холодильника.

Розглянемо більш реалістичний приклад з обмеженими контекстами. Що ви бачите на малюнку? Це просто шматок картону? Ні, це модель. І це модель конкретного холодильника компанії Сіменс, а саме моделі Сіменс Кей-Джі-вісімдесят шість-Ен-Ей-Ай-три-Ель (англійською Siemens KG86NAI3L).

При ближчому розгляді можна сказати, що цей шматок картону зовсім не схожий на зазначений холодильник. У нього немає дверцят, і навіть колір інший. Однак, це не має значення. Як уже зазначалося, модель не повинна точно копіювати реальний об'єкт. Її мета — допомогти вирішити конкретну задачу.

Отже, правильне питання щодо картону: яку задачу допомагає вирішити ця модель?

У нашій квартирі нестандартний вхід на кухню. Картон вирізали точно за розмірами ширини і глибини холодильника. І задача, яку ми вирішуємо за допомогою цієї моделі, — чи зможе холодильник пройти через двері кухні (як ми бачимо на відповідному малюнку).

Нехай картон і не схожий на холодильник, але він виявився дуже корисним, коли потрібно було вирішити, чи варто купувати цю модель або обрати меншу. Знову ж таки, не всі моделі точні, але деякі з них можуть бути корисними. Створення три-де моделі (тобто 3D — англійською) холодильника, безумовно, буде цікавою ідеєю. Але чи вирішить це проблему ефективніше за картон? Ні. Якщо картон підходить, підходить і три-де модель, і навпаки.

З точки зору розробки програмного забезпечення, створення три-де моделі холодильника було б необґрунтованим ускладненням (тобто овер-інджинірингом — англійською overengineering).

А як щодо висоти холодильника? Що робити, якщо підставка підходить, але холодильник може бути вищим за дверний проєм? Чи виправдовує це створення три-де моделі холодильника? Ні. Проблему можна вирішити значно швидше і простіше, якщо виміряти висоту дверного проєму звичайною рулеткою. І що таке рулетка в цьому випадку? Це ще одна проста модель.

Отже, ми маємо дві моделі одного і того ж холодильника. Використання двох моделей, кожна з яких оптимізована для вирішення конкретної задачі, відображає підхід Ді-Ді-Ді (тобто Domain-Driven Design) до моделювання предметних областей. Кожна модель має свій чітко визначений контекст: картон підтверджує, що підстава холодильника пройде через двері, а рулетка підтверджує, що холодильник не надто високий. Модель повинна виключати зайву інформацію, яка не стосується поставленої задачі. Крім того, немає потреби створювати складну універсальну модель, якщо кілька простіших моделей здатні ефективно вирішити кожну задачу окремо.

Через кілька днів після публікації цієї історії в Твіттері (англійською Twitter) я отримав коментар, що замість того, щоб морочитися з картоном, я міг би просто скористатися мобільним телефоном зі сканером Лай-Дар (англійською LiDAR) і додатком доповненої реальності, або Ей-Ар (англійською AR). Давайте проаналізуємо цю пропозицію з точки зору предметно-орієнтованого проектування.

Автор коментаря стверджує, що ця задача вже вирішена іншими людьми і це рішення доступне в відкритому доступі. Не важко зрозуміти, що і технологія сканування, і додаток доповненої реальності — це складні рішення. На жаргоні Ді-Ді-Ді це відносить задачу перевірки можливості проходу холодильника через двері до універсального піддомену.

Підрозділ: Висновок до першої частини.

При кожному зіткненні з неминучим конфліктом ментальних моделей експертів предметної області нам доводиться розбивати єдину мову на кілька обмежених контекстів. Єдина мова в рамках свого обмеженого контексту повинна бути непротирічливою.

Однак у межах обмежених контекстів одні й ті ж поняття можуть мати різні значення.

При виявленні піддоменів розробляються обмежені контексти. Розподіл предметної області на обмежені контексти є стратегічним проектним рішенням.

Обмежений контекст і його єдина мова можуть реалізовуватися та підтримуватися однією командою. Жодні дві команди не повинні одночасно працювати над одним і тим же обмеженим контекстом. Проте одна й та ж команда може працювати з кількома обмеженими контекстами.

Обмежені контексти розбивають систему на фізичні компоненти — сервіси, підсистеми тощо. Життєвий цикл кожного обмеженого контексту відокремлений від усіх інших. Кожен обмежений контекст може розвиватися незалежно від решти системи. Але для формування системи обмежені контексти повинні працювати разом. Деякі зміни непередбачувано можуть впливати і на інші обмежені контексти. В наступному розділі будуть розглянуті різні паттерни інтеграції обмежених контекстів, якими можна буде скористатися для їх захисту від каскадних змін.

Розділ: Інтеграція обмежених контекстів.

Підрозділ: Вступ.

Обмежений контекст (або Баундед Контекст — англійською Bounded Context) — це ключова концепція предметно-орієнтованого проектування (Ді-Ді-Ді). Вона забезпечує узгодженість єдиної мови (або Юбіквітос Ленгвідж — англійською Ubiquitous Language) в межах визначених кордонів та відкриває можливості для побудови моделей. Визначення меж моделі є критично важливим для успішного проектування, адже без чітких меж неможливо побудувати ефективну модель.

Межа відповідальності мов означає, що одна й та сама бізнес-сутність може мати різні призначення в різних обмежених контекстах. Наприклад, "Користувач" у контексті продажу може означати покупця, а у контексті логістики — отримувача товару.

Попри те, що розвиток моделей в обмежених контекстах може бути незалежним, самі контексти не є ізольованими. Вони повинні взаємодіяти для досягнення основних цілей системи, що створює необхідність у визначенні контрактів між ними.

Пункт: Інтеграція обмежених контекстів.

Контракти між обмеженими контекстами необхідні через відмінності в моделях і мовах, що використовуються всередині них. Оскільки контракт зачіпає більш ніж одну сторону, його необхідно ретельно визначити та скоординувати. Крім того, під час інтеграції постає питання вибору мови для взаємодії, адже кожен контекст має свою єдину мову.

Інтеграція обмежених контекстів потребує використання патернів Ді-Ді-Ді. Вибір патерну залежить від характеру співпраці між командами, які працюють над контекстами. Ми розглянемо три основні типи взаємодії:
По-перше. Співпраця (англійською Cooperation).
По-друге. Споживач-постачальник (англійською Customer-Supplier).
По-третє. Різні шляхи (англійською Separate Ways).

Підрозділ: Співпраця (Cooperation).

Патерни співпраці застосовуються до обмежених контекстів, реалізованих командами з добре налагодженою взаємодією. У найпростішому випадку це контексти, що реалізуються однією командою. В інших випадках це можуть бути команди, чия успішність залежить одна від одної. Головним критерієм є щільність спілкування та спільна робота.

До патернів співпраці належать:
- Партнерство (англійською Partnership).
- Спільне ядро (англійською Shared Kernel).

Розглянемо детальніше патерн партнерства.

Пункт: Партнерство (Partnership).

Партнерство — це модель інтеграції, де обмежені контексти координуються за ситуацією. Наприклад, одна команда може повідомити іншу про зміну Ей-Пі-Ай (англійською API), а друга команда адаптується до змін у дусі співпраці.

Основні характеристики цього патерна:
- Двостороння координація: жодна команда не нав’язує свою мову чи стандарти для контрактів. Рішення приймаються спільно.
- Спільне вирішення проблем: команди разом долають виклики, що виникають під час інтеграції.
- Висока обов’язковість: успіх інтеграції залежить від дисципліни та частоти синхронізації між командами.
- Безперервна інтеграція: регулярна інтеграція змін допомагає мінімізувати час на зворотний зв’язок.

Переваги цього підходу:
- Гнучкість у виборі підходів до інтеграції.
- Покращення якості співпраці між командами.
- Зменшення ризику конфліктів завдяки спільним рішенням.

Недоліки:
- Потребує тісної співпраці та частих зустрічей, що може бути проблемою для географічно віддалених команд.
- Висока залежність однієї команди від іншої.

Коли застосовувати:
- Команди працюють у тісній взаємодії.
- Є необхідність швидкого реагування на зміни.
- Успіх одного контексту прямо залежить від іншого.

Приклад використання:
Уявімо дві команди: команда "Продажі" і команда "Логістика". Вони співпрацюють для забезпечення безперебійного обслуговування клієнтів. Якщо команда "Продажі" змінює Ей-Пі-Ай для замовлень, вона повідомляє команду "Логістика", щоб вони могли внести відповідні зміни до своїх процесів. Разом вони вирішують, як адаптувати інтеграцію, уникаючи конфліктів та простоїв.

Підрозділ: Спільне ядро (Shared Kernel).

Незважаючи на те, що межі моделі визначаються обмеженими контекстами, бувають випадки, коли одна й та сама модель піддомена (або сабдомен — англійською subdomain) або частина цієї моделі буде реалізована одразу в кількох обмежених контекстах. Тут вкрай важливо зазначити, що загальна модель розробляється відповідно до потреб усіх обмежених контекстів. Ба більше, загальна модель має бути узгодженою в усіх обмежених контекстах, які її використовують.

Наприклад, розглянемо корпоративну систему, що використовує власну модель управління доступами, які надаються користувачам для певних дій. Дозволи, видані кожному користувачеві, можуть надаватися безпосередньо або бути успадкованими від одного з організаційних підрозділів, до яких цей користувач належить. Ба більше, кожен обмежений контекст може змінювати модель авторизації, і зміни в одному контексті мають впливати на всі інші контексти, що використовують цю модель.

Пункт: Загальні рамки (або Шерд Скоуп — англійською Shared Scope).

Модель із перекриттям, що використовується в кількох обмежених контекстах, пов'язує життєві цикли. Зміна в загальній моделі одразу впливає на всі обмежені контексти. Щоб мінімізувати каскадні ефекти змін, модель із перекриттям повинна розкривати лише ту частину, яка має бути реалізована в обох контекстах.

В ідеалі спільне ядро (тобто шерд кернел — англійською shared kernel) складатиметься з:
- Інтеграційних контрактів.
- Структур даних для передавання даних між обмеженими контекстами.

Пункт: Реалізація.

Спільне ядро (shared kernel) реалізується так, щоб будь-яка модифікація його вихідного коду одразу відображалася у всіх обмежених контекстах, які його використовують.

Способи реалізації:
По-перше. Монорепозиторій: спільне ядро у вигляді одних і тих самих вихідних файлів, на які посилаються кілька обмежених контекстів.
По-друге. Окремий проєкт: спільне ядро виділяється в окремий проєкт і підключається як пов'язана бібліотека.

У будь-якому випадку діють такі правила:
- Кожна зміна в загальному ядрі має запускати інтеграційні тести для всіх обмежених контекстів.
- Зміни слід інтегрувати безперервно, щоб уникнути невідповідностей і розсинхронізації.

Коли слід використовувати спільне ядро?
Основний критерій — це порівняння затратності дублювання та координації.

Через сильну залежність між обмеженими контекстами патерн слід використовувати, якщо витрати на дублювання вищі за витрати на координацію. Це актуально для піддоменів, схильних до частих змін (мова йде про основні піддомени).

Обмеження використання:
- Обмежені контексти повинні належати одній команді.
- Використання спільного ядра суперечить принципам обмежених контекстів, якщо контексти реалізуються різними командами.

Типові випадки використання:
По-перше. Проблеми зі спілкуванням або спільною роботою: наприклад, через географічні або організаційні обмеження.
По-друге. Модернізація застарілої системи: спільна кодова база може слугувати проміжним рішенням для поступового розбиття системи на обмежені контексти.
По-третє. Інтеграція в межах однієї команди: використовується для визначення інтеграційних контрактів і збереження меж обмежених контекстів.

Як уникнути проблем:
- Мінімізувати область дії спільного ядра.
- Запускати інтеграційні тести для кожної зміни.
- Забезпечити ретельну координацію між командами.

Підрозділ: Споживач-Постачальник (Customer-supplier).

Пункт: Загальний опис.

Патерни типу «споживач-постачальник» (customer-supplier) описують відносини між двома обмеженими контекстами. Один контекст, постачальник (або сапплаєр — англійською supplier), надає послуги своєму споживачеві (або кастомеру — англійською customer). Постачальник знаходиться «вище за течією», а споживач — «нижче за течією».

Особливості цих патернів:
- Обидві команди можуть досягти успіху незалежно одна від одної.
- Інтеграційний контракт може диктувати як постачальник, так і споживач.

Основні патерни:

Перший патерн — Конформіст (Conformist).

Ситуація:
- Баланс сил зміщений на користь постачальника.
- Постачальник надає інтеграційний контракт за принципом "хочеш приймай, хочеш не приймай".

Характеристики:
- Споживач приймає модель постачальника.
- Знижується автономність команди споживача.
- Може бути вигідним, якщо контракт постачальника є стандартним або відповідає потребам.

Другий патерн — Запобіжний шар (тобто Анти-коррапшн леєр — англійською Anticorruption Layer).

Ситуація:
- Баланс сил також на користь постачальника.
- Споживач не бажає підлаштовуватися під модель постачальника.

Рішення:
- Використання запобіжного шару, який перетворює модель постачальника на модель, зручну для споживача.

Використання:
- Для захисту моделі споживача від сторонніх концепцій.
- Коли модель постачальника неефективна, змінюється часто або не відповідає потребам.

Третій патерн — Сервіс із відкритим протоколом (або Опен-Хост Сервіс — англійською Open-Host Service).

Ситуація:
- Головна роль належить споживачам.
- Постачальник намагається максимально задовольнити потреби споживачів.

Рішення:
- Постачальник відокремлює модель реалізації від загальнодоступного інтерфейсу.
- Використовується опублікована мова (або паблішд ленгвідж — англійською published language) для зручності інтеграції.

Переваги:
- Дозволяє постачальнику розвивати свою модель без впливу на споживачів.
- Підтримка кількох версій опублікованої мови.

Підрозділ: Різні шляхи (Separate Ways).

Ситуація:
Відмова від будь-якої співпраці між контекстами через такі фактори як:
- Труднощі спілкування.
- Відмінності в моделях.
- Особливості дубльованого піддомену.

Основні причини:
По-перше. Проблеми спілкування: великі розміри організації або внутрішня політика.
По-друге. Універсальний піддомен: дублювання функціональності може бути рентабельнішим, ніж інтеграція.
По-третє. Відмінності в моделях: конформістські відносини або запобіжний шар недоцільні.

Пункт: Проблеми спілкування.

Частою причиною відмови від співпраці можуть стати труднощі спілкування, зумовлені розмірами організації або її внутрішньою політикою. Коли командам важко розвивати співпрацю та домовлятися, можливо, рентабельніше буде піти різними шляхами і продублювати функціональність у кількох обмежених контекстах.

Пункт: Універсальний піддомен.

Причиною розбіжності шляхів команд можуть бути особливості дубльованого піддомену. У тих випадках, коли розглянутий піддомен є універсальним (дженерік — англійською generic), а універсальне рішення легко піддається інтеграції, може виявитися, що його локальна інтеграція в кожному обмеженому контексті буде більш рентабельною. Як приклад можна навести фреймворк логування. Навряд чи було б розумно виставляти його як сервіс в одному з обмежених контекстів. Додаткові складнощі інтеграції такого рішення переважали б вигоду від відмови від дублювання функцій у різних контекстах, яке обійшлося б дешевше за співпрацю.

Пункт: Відмінності в моделях.

Причиною вибору різних шляхів також можуть стати відмінності в моделях обмеженого контексту. Моделі можуть бути настільки різними, що конформістські відносини стають неможливими, а реалізація запобіжного рівня (англійською anticorruption layer) обійдеться дорожче, ніж дублювання функціональності. У цьому випадку для команд знову-таки вигідніше буде піти різними шляхами. Під час інтеграції основних піддоменів (англійською core subdomains) від використання різних шляхів краще відмовитися. Дублювання реалізації таких підобластей суперечило б стратегії компанії щодо їхньої найефективнішої та найоптимізованішої реалізації.

Підрозділ: Карта контекстів (Context Map).

Призначення:
Візуалізація обмежених контекстів системи та їхньої інтеграції.

Обмеження:
Важливо зазначити, що складання контекстної карти може бути непростим завданням. Коли обмежений контекст системи охоплює кілька піддоменів, можуть бути задіяні кілька інтеграційних моделей. Наприклад, як ми бачимо на відповідних рисунках, зокрема на рисунку чотири крапка дев'ять, можна побачити два обмежені контексти з двома інтеграційними моделями одночасно:
- Партнерство (англійською partnership).
- Запобіжний шар (англійською anticorruption layer).

Ба більше, навіть якщо обмежені контексти не виходять за межі одного піддомену, однаково може бути задіяно одразу кілька патернів інтеграції. Наприклад, якщо модулі піддоменів вимагають різних стратегій інтеграції.

Підрозділ: Висновок.

Обмежені контексти завжди взаємодіють один з одним, і способи їхньої інтеграції визначаються різними патернами:
По-перше. Партнерство (Partnership) — інтеграція відбувається залежно від ситуації.
По-друге. Спільне ядро (Shared Kernel) — обмежені контексти використовують спільну модель, що належить усім учасникам.
По-третє. Конформіст (Conformist) — клієнт адаптується під модель постачальника.
По-четверте. Запобіжний шар (Anticorruption Layer) — модель постачальника трансформується відповідно до потреб споживача.
По-п'яте. Сервіс із відкритим протоколом (Open-host Service) — постачальник надає загальнодоступну модель, оптимізовану для клієнтів.
Та нарешті, Різні шляхи (Separate Ways) — дублювання функціональності замість інтеграції.

Контекстна карта є важливим інструментом для відображення інтеграційних підходів, допомагаючи зрозуміти структуру системи, комунікації між компонентами та організаційні аспекти.

Після аналізу та моделювання бізнес-областей у цій главі, далі буде розглянуто тактичні підходи до реалізації логіки предметної області, архітектури системи та координації взаємодії компонентів.