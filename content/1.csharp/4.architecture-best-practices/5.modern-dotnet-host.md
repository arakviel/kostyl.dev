---
title: 'The Modern .NET Host (Microsoft.Extensions)'
description: '–ö–æ–º–ø–ª–µ–∫—Å–Ω–µ –≤–∏–≤—á–µ–Ω–Ω—è —Å—É—á–∞—Å–Ω–æ–≥–æ .NET Host: Dependency Injection, Configuration, Logging, Resilience —Ç–∞ Background Services –¥–ª—è production-ready –¥–æ–¥–∞—Ç–∫—ñ–≤.'
---

# The Modern .NET Host (Microsoft.Extensions)

## –í—Å—Ç—É–ø —Ç–∞ –ö–æ–Ω—Ç–µ–∫—Å—Ç

–£—è–≤—ñ—Ç—å, —â–æ –≤–∏ –±—É–¥—É—î—Ç–µ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å –¥–ª—è e-commerce –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏. –¶–µ–π —Å–µ—Ä–≤—ñ—Å –º–∞—î:

-   **–û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è** –∑ —á–µ—Ä–≥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
-   **–ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤** —á–µ—Ä–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—î API
-   **–û–±—Ä–æ–±–ª—è—Ç–∏ –ø–ª–∞—Ç–µ–∂—ñ** –∑ retry –ª–æ–≥—ñ–∫–æ—é –ø—Ä–∏ –∑–±–æ—è—Ö
-   **–õ–æ–≥—É–≤–∞—Ç–∏ –≤—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó** –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ —Ç–∞ –≤—ñ–¥–ª–∞–¥–∫–∏
-   **–ö–æ–Ω—Ñ—ñ–≥—É—Ä—É–≤–∞—Ç–∏—Å—è** –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (dev, staging, production)
-   **–ü—Ä–∞—Ü—é–≤–∞—Ç–∏ 24/7** –∑ graceful shutdown –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è—Ö

**–Ø–∫ –æ—Ä–≥–∞–Ω—ñ–∑—É–≤–∞—Ç–∏ —Ç–∞–∫–∏–π –¥–æ–¥–∞—Ç–æ–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?**

–î–æ .NET Core 2.1 —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∏ –ø–∏—Å–∞–ª–∏ –±–∞–≥–∞—Ç–æ boilerplate –∫–æ–¥—É –¥–ª—è:

-   –†—É—á–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π (`new EmailService(new SmtpClient())`)
-   –ü–∞—Ä—Å–∏–Ω–≥—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª
-   –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–∞–π–ª–∏
-   –û–±—Ä–æ–±–∫–∏ –≤–∏–Ω—è—Ç–∫—ñ–≤ —Ç–∞ retry –ª–æ–≥—ñ–∫–∏
-   –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∂–∏—Ç—Ç—î–≤–∏–º —Ü–∏–∫–ª–æ–º —Ñ–æ–Ω–æ–≤–∏—Ö –∑–∞–¥–∞—á

::caution
**–ü—Ä–æ–±–ª–µ–º–∏ —Å—Ç–∞—Ä–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É:**

```csharp
// ‚ùå –¢–∞–∫ –ø–∏—Å–∞–ª–∏ –¥–æ .NET Core
public class OrderService
{
    private readonly EmailService _emailService;
    private readonly PaymentGateway _paymentGateway;
    
    public OrderService()
    {
        // Tight coupling - –≤–∞–∂–∫–æ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏
        var smtpClient = new SmtpClient("smtp.gmail.com");
        _emailService = new EmailService(smtpClient);
        
        // Hard-coded –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
        var httpClient = new HttpClient();
        _paymentGateway = new PaymentGateway(httpClient);
    }
}
```

**–ù–∞—Å–ª—ñ–¥–∫–∏:**

-   ‚ùå **Tight coupling**: –ù–µ–º–æ–∂–ª–∏–≤–æ –∑–∞–º—ñ–Ω–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–ª—è —Ç–µ—Å—Ç—ñ–≤)
-   ‚ùå **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è**: –ö–æ–∂–µ–Ω —Ç–µ—Å—Ç —Å—Ç–≤–æ—Ä—é—î —Ä–µ–∞–ª—å–Ω—ñ HTTP/SMTP –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
-   ‚ùå **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å lifecycle management**: –•—Ç–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ Dispose?
-   ‚ùå **–î—É–±–ª—é–≤–∞–Ω–Ω—è –∫–æ–¥—É**: –ö–æ–∂–µ–Ω —Å–µ—Ä–≤—ñ—Å –º–∞—î –≤–ª–∞—Å–Ω—É –ª–æ–≥—ñ–∫—É —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    ::

**–†—ñ—à–µ–Ω–Ω—è: Modern .NET Host** ‚Äî —Ü–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ –±–∞–∑—ñ `Microsoft.Extensions.*` –ø–∞–∫–µ—Ç—ñ–≤, —è–∫–∞ –Ω–∞–¥–∞—î:

1.  **Dependency Injection**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏ —Ç–∞ —ó—Ö lifecycle
2.  **Configuration System**: –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–µ —á–∏—Ç–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª
3.  **Logging Infrastructure**: –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑ —Ä—ñ–∑–Ω–∏–º–∏ providers
4.  **Resilience Patterns**: Retry, Circuit Breaker, Timeout —á–µ—Ä–µ–∑ Polly
5.  **Background Services**: Managed lifecycle –¥–ª—è —Ñ–æ–Ω–æ–≤–∏—Ö –∑–∞–¥–∞—á

::mermaid

```mermaid
graph TD
    A[Application] --> B[Generic Host]
    B --> C[Dependency Injection]
    B --> D[Configuration System]
    B --> E[Logging Infrastructure]
    B --> F[Hosted Services]
    
    C --> C1[IServiceCollection]
    C --> C2[Lifetimes]
    C --> C3[Scopes]
    
    D --> D1[JSON Files]
    D --> D2[Environment Vars]
    D --> D3[User Secrets]
    
    E --> E1[ILogger]
    E --> E2[Serilog]
    E --> E3[Structured Logging]
    
    F --> F1[IHostedService]
    F --> F2[BackgroundService]
    
    style B fill:#f59e0b,stroke:#b45309,color:#ffffff
    style C fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style D fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style E fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style F fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
```

::

### –©–æ —Ç–∞–∫–µ .NET Host?

**Host** —É .NET ‚Äî —Ü–µ, –ø–æ —Å—É—Ç—ñ, NuGet –ø–∞–∫–µ—Ç –∞–±–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞, —è–∫—É –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —É –±—É–¥—å-—è–∫–∏–π –ø—Ä–æ—î–∫—Ç, –≤–∫–ª—é—á–∞—é—á–∏ –∑–≤–∏—á–∞–π–Ω—ñ –∫–æ–Ω—Å–æ–ª—å–Ω—ñ –ø—Ä–æ–≥—Ä–∞–º–∏. –¶–µ –Ω–µ —è–∫–∞—Å—å –º–∞–≥—ñ—á–Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—è, –∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∑ –Ω–µ–π–º—Å–ø–µ–π—Å—É `Microsoft.Extensions.Hosting`.

```bash
dotnet add package Microsoft.Extensions.Hosting
```

**–ì–æ–ª–æ–≤–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –•–æ—Å—Ç–∞** ‚Äî –ø–æ–±—É–¥–æ–≤–∞ _—ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏_ –Ω–∞–≤–∫–æ–ª–æ –≤–∞—à–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏, –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–∏—Ö –∫–æ–Ω—Å–æ–ª—å–Ω–∏—Ö –∑–∞—Å—Ç–æ—Å—É–Ω–∫—ñ–≤ –Ω–∞ **–¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª—ñ —Å–µ—Ä–≤—ñ—Å–∏ (long-running services)**.

–ü—Ä–∏–∫–ª–∞–¥–∏ –¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤:
-   üåê **–í–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–∫–∏** (ASP.NET Core)
-   ‚öôÔ∏è **–§–æ–Ω–æ–≤—ñ Worker Services** (–æ–±—Ä–æ–±–∫–∞ —á–µ—Ä–≥, –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∏)
-   üîÑ **–ú—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏** –∑ –ø–æ—Å—Ç—ñ–π–Ω–∏–º lifecycle
-   üì° **gRPC —Å–µ—Ä–≤–µ—Ä–∏**, **SignalR Hubs**

> –ö–æ–Ω—Å–æ–ª—å–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —ñ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è. –•–æ—Å—Ç-–∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ _–ø—Ä–∞—Ü—é—î –ø–æ—Å—Ç—ñ–π–Ω–æ_, –¥–Ω—è–º–∏, –º—ñ—Å—è—Ü—è–º–∏ –∞–±–æ —Ä–æ–∫–∞–º–∏, —ñ –Ω–µ –º–∞—î –∑–∞–≤–µ—Ä—à—É–≤–∞—Ç–∏—Å—è –±–µ–∑ –∫–æ–º–∞–Ω–¥–∏.

#### –í—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ –º—ñ–∂ –∑–≤–∏—á–∞–π–Ω–∏–º–∏ —Ç–∞ —Ö–æ—Å—Ç-–∑–∞—Å—Ç–æ—Å—É–Ω–∫–∞–º–∏

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞              | –ó–≤–∏—á–∞–π–Ω–µ –ö–æ–Ω—Å–æ–ª—å–Ω–µ –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è                       | –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞ –ë–∞–∑—ñ –•–æ—Å—Ç–∞ (Host Application)           |
| :-------------------------- | :---------------------------------------------------- | :------------------------------------------------------- |
| **–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –†–æ–±–æ—Ç–∏**       | –®–≤–∏–¥–∫–æ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è (—Å–µ–∫—É–Ω–¥–∏, —Ö–≤–∏–ª–∏–Ω–∏)                | –î–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª—ñ —Å–ª—É–∂–±–∏ (–¥–Ω—ñ, –º—ñ—Å—è—Ü—ñ, —Ä–æ–∫–∏); –Ω–µ –≤–∏–º–∏–∫–∞—é—Ç—å—Å—è |
| **–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**             | –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ñ –∑–∞–≤–¥–∞–Ω–Ω—è, —É—Ç–∏–ª—ñ—Ç–∏, —Å–∫—Ä–∏–ø—Ç–∏                 | –í–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–∫–∏, –ø–æ—Å—Ç—ñ–π–Ω—ñ —Ñ–æ–Ω–æ–≤—ñ —Å–ª—É–∂–±–∏                   |
| **–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞**             | –ü—Ä–æ—Å—Ç–∞, –º–∞–ª–æ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏                           | –°–∫–ª–∞–¥–Ω–∞: DI, Logging, Configuration –∑ –∫–æ—Ä–æ–±–∫–∏            |
| **Lifecycle Management**    | `Main()` –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —ñ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è                   | –ö–µ—Ä–æ–≤–∞–Ω–∏–π —Å—Ç–∞—Ä—Ç, graceful shutdown, restart policies     |
| **Dependency Injection**    | –ó–∞–∑–≤–∏—á–∞–π –≤—ñ–¥—Å—É—Ç–Ω—î –∞–±–æ —Ä—É—á–Ω–µ                           | –í–±—É–¥–æ–≤–∞–Ω–∏–π DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä                                  |
| **Configuration**           | –†—É—á–Ω–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –∞–±–æ —Ñ–∞–π–ª—ñ–≤                  | –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑ –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª                  |
| **Logging**                 | `Console.WriteLine` –∞–±–æ —Å—Ç–æ—Ä–æ–Ω–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏           | Structured logging –∑ `ILogger`                           |
| **–ü—Ä–∏–∫–ª–∞–¥–∏**                | CLI —É—Ç–∏–ª—ñ—Ç–∏, –º—ñ–≥—Ä–∞—Ü—ñ—ó –ë–î, —Å–∫—Ä–∏–ø—Ç–∏                     | ASP.NET Core, gRPC, Worker Services                      |

**–ö–ª—é—á–æ–≤–∞ –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å**: –ó–∞—Å—Ç–æ—Å—É–Ω–∫–∏ –Ω–∞ –±–∞–∑—ñ –•–æ—Å—Ç–∞ _–≤–∏–º–∞–≥–∞—é—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É_ —É —Ä–∞–∑—ñ –∑–±–æ—é, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ –º–∞—é—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø–æ—Å—Ç—ñ–π–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–µ–±-–¥–æ–¥–∞—Ç–æ–∫ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ—Å—Ç–æ –≤–∏–º–∫–Ω–µ–Ω–∏–π).

#### –Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —è–∫—É –Ω–∞–¥–∞—î Host

–î–ª—è –≤–µ–ª–∏–∫–∏—Ö –¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª–∏—Ö –∑–∞—Å—Ç–æ—Å—É–Ω–∫—ñ–≤ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –•–æ—Å—Ç –Ω–∞–¥–∞—î –≥–æ—Ç–æ–≤—É —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é —Å–∫–ª–∞–¥–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π:

::field-group

:::field{name="Dependency Injection Container"}
–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏ –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Ä—ñ–∑–Ω–∏—Ö lifetimes (Transient, Scoped, Singleton).

```csharp
builder.Services.AddSingleton<ICacheService, RedisCacheService>();
builder.Services.AddScoped<IOrderService, OrderService>();
```
:::

:::field{name="Configuration System"}
–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–µ —á–∏—Ç–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∑ JSON, Environment Variables, User Secrets, Command Line.

```csharp
var connectionString = builder.Configuration["ConnectionStrings:DefaultConnection"];
```
:::

:::field{name="Logging Infrastructure"}
Structured logging –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö providers (Console, File, Seq, Application Insights).

```csharp
builder.Services.AddLogging(config =>
{
    config.AddConsole();
    config.AddDebug();
});
```
:::

:::field{name="Lifecycle Management"}
–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å—Ç–∞—Ä—Ç–æ–º, –∑—É–ø–∏–Ω–∫–æ—é —Ç–∞ graceful shutdown –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É —á–µ—Ä–µ–∑ `IHostApplicationLifetime`.

```csharp
lifetime.ApplicationStarted.Register(() => Console.WriteLine("App started"));
lifetime.ApplicationStopping.Register(() => Console.WriteLine("App stopping..."));
```
:::

:::field{name="Background Services"}
Managed –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ñ–æ–Ω–æ–≤–∏—Ö –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ `IHostedService` —Ç–∞ `BackgroundService`.

```csharp
builder.Services.AddHostedService<EmailQueueProcessor>();
```
:::

:::field{name="Health Checks"}
–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞–Ω—É –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É —Ç–∞ –π–æ–≥–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π (–ë–î, API, —á–µ—Ä–≥–∏).

```csharp
builder.Services.AddHealthChecks()
    .AddDbContextCheck<AppDbContext>()
    .AddUrlCheck("https://api.example.com");
```
:::

::

#### –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∂–∏—Ç—Ç—î–≤–∏–º —Ü–∏–∫–ª–æ–º –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É

–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∂–∏—Ç—Ç—î–≤–∏–º —Ü–∏–∫–ª–æ–º –≤–∫–ª—é—á–∞—î:

1.  **–ü—ñ–¥–≥–æ—Ç–æ–≤—á—ñ —Ä–æ–±–æ—Ç–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º**: –°–∏–¥—ñ–Ω–≥ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–µ—à—ñ–≤, –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π
2.  **Graceful shutdown**: –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –ø–µ—Ä–µ–¥ –≤–∏–º–∫–Ω–µ–Ω–Ω—è–º (–¥–æ–æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ —á–µ—Ä–≥–∏, –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è HTTP requests)

–î–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∂–∏—Ç—Ç—î–≤–∏–º —Ü–∏–∫–ª–æ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å **`IHostApplicationLifetime`**, —è–∫–∏–π –¥–æ—Å—Ç—É–ø–Ω–∏–π —á–µ—Ä–µ–∑ DI:

```csharp showLineNumbers
public class LifecycleService
{
    private readonly IHostApplicationLifetime _lifetime;
    private readonly ILogger<LifecycleService> _logger;
    
    public LifecycleService(IHostApplicationLifetime lifetime, ILogger<LifecycleService> logger)
    {
        _lifetime = lifetime;
        _logger = logger;
        
        // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–æ–¥—ñ—ó –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É —á–µ—Ä–µ–∑ CancellationToken
        _lifetime.ApplicationStarted.Register(OnStarted);
        _lifetime.ApplicationStopping.Register(OnStopping);
        _lifetime.ApplicationStopped.Register(OnStopped);
    }
    
    private void OnStarted()
    {
        _logger.LogInformation("Application has started successfully");
        // –¢—É—Ç –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ post-startup –∑–∞–≤–¥–∞–Ω–Ω—è: warming up caches, health check
    }
    
    private void OnStopping()
    {
        _logger.LogWarning("Application is stopping... Finishing current work");
        // Graceful shutdown: –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó, flush –ª–æ–≥—ñ–≤
    }
    
    private void OnStopped()
    {
        _logger.LogInformation("Application has stopped");
        // Cleanup: –∑–∞–∫—Ä–∏—Ç–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è, –∑–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞–Ω
    }
    
    public void RequestShutdown()
    {
        _logger.LogWarning("Shutdown requested programmatically");
        _lifetime.StopApplication(); // –ü—Ä–æ–≥—Ä–∞–º–Ω–∞ –∑—É–ø–∏–Ω–∫–∞ –≤—Å—å–æ–≥–æ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É
    }
}
```

**`IHostApplicationLifetime` –Ω–∞–¥–∞—î:**

-   **`ApplicationStarted`**: –°–ø—Ä–∞—Ü—å–æ–≤—É—î, –∫–æ–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—è —Ç–∞ –≥–æ—Ç–æ–≤–∞ –ø—Ä–∏–π–º–∞—Ç–∏ –∑–∞–ø–∏—Ç–∏
-   **`ApplicationStopping`**: –°–ø—Ä–∞—Ü—å–æ–≤—É—î, –∫–æ–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ –æ—Ç—Ä–∏–º—É—î —Å–∏–≥–Ω–∞–ª –Ω–∞ –∑—É–ø–∏–Ω–∫—É (Ctrl+C, SIGTERM)
-   **`ApplicationStopped`**: –°–ø—Ä–∞—Ü—å–æ–≤—É—î, –∫–æ–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑—É–ø–∏–Ω–∏–ª–∞—Å—è
-   **`StopApplication()`**: –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ—ó –∑—É–ø–∏–Ω–∫–∏ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É

#### IHostedServices —Ç–∞ —Ñ–æ–Ω–æ–≤–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å

**IHostedService** ‚Äî —Ü–µ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ñ–æ–Ω–æ–≤–∏—Ö –∑–∞–¥–∞—á, —è–∫—ñ –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è —Ä–∞–∑–æ–º –∑ —Ö–æ—Å—Ç–æ–º —Ç–∞ –ø—Ä–∞—Ü—é—é—Ç—å –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ –æ—Å–Ω–æ–≤–Ω–æ—é –ª–æ–≥—ñ–∫–æ—é.

```csharp
public interface IHostedService
{
    Task StartAsync(CancellationToken cancellationToken);
    Task StopAsync(CancellationToken cancellationToken);
}
```

**–í–∞–∂–ª–∏–≤–æ**: –ù–µ –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ _—Ç—Ä–∏–≤–∞–ª—É –±–ª–æ–∫—É—é—á—É –æ–ø–µ—Ä–∞—Ü—ñ—é_ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ —É `StartAsync`! –Ø–∫—â–æ —Ü–µ –∑—Ä–æ–±–∏—Ç–∏, –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –Ω–µ –∑–º–æ–∂–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–ø—É—Å—Ç–∏—Ç–∏—Å—è, –æ—Å–∫—ñ–ª—å–∫–∏ –∑–∞–±–ª–æ–∫—É—î—Ç—å—Å—è –≤ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—ñ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è `StartAsync`.

```csharp showLineNumbers
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –±–ª–æ–∫—É—î –∑–∞–ø—É—Å–∫ Host
public class BadHostedService : IHostedService
{
    public async Task StartAsync(CancellationToken cancellationToken)
    {
        // –ë–ª–æ–∫—É—î–º–æ Host!
        while (!cancellationToken.IsCancellationRequested)
        {
            await ProcessQueueAsync();
            await Task.Delay(1000);
        }
    }
    
    public Task StopAsync(CancellationToken cancellationToken) => Task.CompletedTask;
}
```

**–†—ñ—à–µ–Ω–Ω—è: BackgroundService (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞)**

`BackgroundService` ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∏–π –∫–ª–∞—Å, —â–æ —Å–∞–º —Ä–µ–∞–ª—ñ–∑—É—î `IHostedService` —ñ –≤–∏–º–∞–≥–∞—î —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ª–∏—à–µ –æ–¥–Ω–æ–≥–æ –º–µ—Ç–æ–¥—É ‚Äî `ExecuteAsync`. –í—ñ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î –ª–æ–≥—ñ–∫—É `ExecuteAsync` —è–∫ –æ–∫—Ä–µ–º—É —Ñ–æ–Ω–æ–≤—É –∑–∞–¥–∞—á—É, —â–æ –¥–æ–∑–≤–æ–ª—è—î –•–æ—Å—Ç—É –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∑–∞–ø—É—Å–∫.

```csharp showLineNumbers
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –Ω–µ –±–ª–æ–∫—É—î –∑–∞–ø—É—Å–∫ Host
public class GoodHostedService : BackgroundService
{
    private readonly ILogger<GoodHostedService> _logger;
    
    public GoodHostedService(ILogger<GoodHostedService> logger)
    {
        _logger = logger;
    }
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("Background service started");
        
        // ExecuteAsync –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —É —Ñ–æ–Ω–æ–≤–æ–º—É Task - –Ω–µ –±–ª–æ–∫—É—î Host
        while (!stoppingToken.IsCancellationRequested)
        {
            await ProcessQueueAsync();
            await Task.Delay(1000, stoppingToken);
        }
        
        _logger.LogInformation("Background service stopped");
    }
}

// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
builder.Services.AddHostedService<GoodHostedService>();
```

**–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:**

1.  Host –≤–∏–∫–ª–∏–∫–∞—î `StartAsync()` –Ω–∞ `BackgroundService`
2.  `StartAsync()` —Å—Ç–≤–æ—Ä—é—î —Ñ–æ–Ω–æ–≤–∏–π `Task` –¥–ª—è `ExecuteAsync()` —ñ –æ–¥—Ä–∞–∑—É –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è
3.  Host –ø—Ä–æ–¥–æ–≤–∂—É—î –∑–∞–ø—É—Å–∫, –Ω–µ —á–µ–∫–∞—é—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è `ExecuteAsync()`
4.  `ExecuteAsync()` –ø—Ä–∞—Ü—é—î –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ –æ—Å–Ω–æ–≤–Ω–æ—é –ª–æ–≥—ñ–∫–æ—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–º)
5.  –ü—Ä–∏ –∑—É–ø–∏–Ω—Ü—ñ Host –≤–∏–∫–ª–∏–∫–∞—î `StopAsync()`, —è–∫–∏–π —Å–∏–≥–Ω–∞–ª—ñ–∑—É—î `CancellationToken`

::tip
**Best Practice**: –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `BackgroundService` –∑–∞–º—ñ—Å—Ç—å –ø—Ä—è–º–æ—ó —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—ó `IHostedService` –¥–ª—è —Ñ–æ–Ω–æ–≤–∏—Ö –∑–∞–¥–∞—á. `IHostedService` —Ä–µ–∑–µ—Ä–≤—É–π—Ç–µ –¥–ª—è –≤–∏–ø–∞–¥–∫—ñ–≤, –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∞–º–∏–º –ø—Ä–æ—Ü–µ—Å–æ–º —Å—Ç–∞—Ä—Ç—É/–∑—É–ø–∏–Ω–∫–∏.
::

### –ï–≤–æ–ª—é—Ü—ñ—è .NET Host

::steps

#### –ï—Ç–∞–ø 1: .NET Framework (–¥–æ 2016)

–ö–æ–∂–µ–Ω —Ç–∏–ø –¥–æ–¥–∞—Ç–∫—É –º–∞–≤ –≤–ª–∞—Å–Ω—É —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É:

-   **ASP.NET**: `Global.asax`, `Web.config`
-   **Console**: –†—É—á–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤—Å—å–æ–≥–æ
-   **Windows Services**: `ServiceBase`, —Å–∫–ª–∞–¥–Ω–∏–π setup

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–º–∞—î —î–¥–∏–Ω–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É, –±–∞–≥–∞—Ç–æ –¥—É–±–ª—é–≤–∞–Ω–Ω—è.

#### –ï—Ç–∞–ø 2: ASP.NET Core 1.x - 2.0 (2016-2017)

–í–≤–µ–¥–µ–Ω–Ω—è `WebHost` –¥–ª—è –≤–µ–±-–¥–æ–¥–∞—Ç–∫—ñ–≤:

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseStartup<Startup>()
    .Build()
    .Run();
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**: DI, Configuration, Logging –∑ –∫–æ—Ä–æ–±–∫–∏. **–ù–µ–¥–æ–ª—ñ–∫**: –¢—ñ–ª—å–∫–∏ –¥–ª—è –≤–µ–±-–¥–æ–¥–∞—Ç–∫—ñ–≤.

#### –ï—Ç–∞–ø 3: .NET Core 2.1+ Generic Host (2018)

`IHost` ‚Äî —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è _–±—É–¥—å-—è–∫–∏—Ö_ –¥–æ–¥–∞—Ç–∫—ñ–≤:

```csharp
Host.CreateDefaultBuilder(args)
    .ConfigureServices((context, services) =>
    {
        services.AddHostedService<Worker>();
    })
    .Build()
    .Run();
```

**–†–µ–≤–æ–ª—é—Ü—ñ—è**: –ö–æ–Ω—Å–æ–ª—å–Ω—ñ –¥–æ–¥–∞—Ç–∫–∏, Windows Services, Worker Services ‚Äî –≤—Å—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —î–¥–∏–Ω—É —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É.

#### –ï—Ç–∞–ø 4: .NET 6+ Minimal APIs (2021)

–°–ø—Ä–æ—â–µ–Ω–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∑ top-level statements:

```csharp
var builder = WebApplication.CreateBuilder(args);

// Configure services
builder.Services.AddSingleton<IEmailService, EmailService>();

var app = builder.Build();

app.Run();
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**: –ú–µ–Ω—à–µ boilerplate, –∞–ª–µ —Ç–∞ —Å–∞–º–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å.

::

### –¶—ñ–ª—ñ —Ü—å–æ–≥–æ —Ä–æ–∑–¥—ñ–ª—É

–ü—ñ—Å–ª—è –≤–∏–≤—á–µ–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—É –≤–∏ –∑–º–æ–∂–µ—Ç–µ:

-   ‚úÖ **–ü—Ä–æ–µ–∫—Ç—É–≤–∞—Ç–∏ DI –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É**: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Transient, Scoped, Singleton lifetimes
-   ‚úÖ **–£–Ω–∏–∫–∞—Ç–∏ DI anti-patterns**: Captive Dependency, Service Locator, Circular Dependencies
-   ‚úÖ **–ö–µ—Ä—É–≤–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è–º–∏**: Options Pattern, Hot Reload, Environment-specific settings
-   ‚úÖ **–õ–æ–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ**: Structured Logging, Serilog, High-performance LoggerMessage
-   ‚úÖ **–î–æ–¥–∞–≤–∞—Ç–∏ Resilience**: Polly patterns (Retry, Circuit Breaker, Timeout)
-   ‚úÖ **–°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ñ–æ–Ω–æ–≤—ñ —Å–µ—Ä–≤—ñ—Å–∏**: IHostedService –∑ graceful shutdown

### –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ä–æ–∑—É–º—ñ—î—Ç–µ:

-   [–û—Å–Ω–æ–≤–∏ C# (—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏, generic types)](/csharp/fundamentals/variables-data-types)
-   [–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è](/csharp/advanced-core/async-await)
-   [LINQ —Ç–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó](/csharp/fundamentals/collections)

---

## –ß–∞—Å—Ç–∏–Ω–∞ 1: Dependency Injection

### 1.1. –©–æ —Ç–∞–∫–µ Dependency Injection —Ç–∞ –Ω–∞–≤—ñ—â–æ –≤—ñ–Ω –ø–æ—Ç—Ä—ñ–±–µ–Ω?

**Dependency Injection (DI)** ‚Äî —Ü–µ –ø–∞—Ç–µ—Ä–Ω –ø—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—è, —è–∫–∏–π —Ä–µ–∞–ª—ñ–∑—É—î **Inversion of Control (IoC)**: –∑–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ, —â–æ–± –∫–ª–∞—Å —Å–∞–º —Å—Ç–≤–æ—Ä—é–≤–∞–≤ —Å–≤–æ—ó –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ, –≤–æ–Ω–∏ _–Ω–∞–¥–∞—é—Ç—å—Å—è –∑–∑–æ–≤–Ω—ñ_.

> –Ø–∫—â–æ –≤–∞—à –∫–æ–¥ —Å—Ç–≤–æ—Ä—é—î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —á–µ—Ä–µ–∑ `new`, –≤—ñ–Ω —ó—Ö _–∫–æ–Ω—Ç—Ä–æ–ª—é—î_. –Ø–∫—â–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –ø—Ä–∏—Ö–æ–¥—è—Ç—å –∑–∑–æ–≤–Ω—ñ ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å _—ñ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–æ_.

#### –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ DI

```csharp showLineNumbers
// ‚ùå Tight coupling - –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–ª–∞—Å—É
public class OrderService
{
    private readonly EmailService _emailService;
    private readonly PaymentProcessor _paymentProcessor;
    private readonly ILogger _logger;
    
    public OrderService()
    {
        // Hard-coded dependencies
        _emailService = new EmailService(new SmtpClient("smtp.gmail.com", 587));
        _paymentProcessor = new PaymentProcessor(new HttpClient());
        _logger = LogManager.GetLogger("OrderService");
    }
    
    public void ProcessOrder(Order order)
    {
        _paymentProcessor.Charge(order.Total);
        _emailService.SendConfirmation(order.CustomerEmail);
        _logger.LogInformation("Order processed: {OrderId}", order.Id);
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∏ —Ü—å–æ–≥–æ –∫–æ–¥—É:**

1.  **Tight Coupling**: `OrderService` –∂–æ—Ä—Å—Ç–∫–æ –∑–≤'—è–∑–∞–Ω–∏–π –∑ `EmailService`, `PaymentProcessor`
2.  **–ù–µ–º–æ–∂–ª–∏–≤–æ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏**: –Ø–∫ –∑–∞–º–æ–∫–∞—Ç–∏ `SmtpClient` –∞–±–æ `HttpClient`?
3.  **–ü–æ—Ä—É—à–µ–Ω–Ω—è SRP**: –ö–ª–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —ñ –∑–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É, —ñ –∑–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
4.  **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å lifecycle management**: –•—Ç–æ –≤–∏–∫–ª–∏–∫–∞—î `Dispose()` –Ω–∞ `HttpClient`?
5.  **–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è hard-coded**: –ó–º—ñ–Ω–∞ SMTP —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Ç—Ä–µ–±—É—î –ø–µ—Ä–µ–∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó

#### –í–∏—Ä—ñ—à–µ–Ω–Ω—è —á–µ—Ä–µ–∑ DI

```csharp showLineNumbers
// ‚úÖ Loose coupling - –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –æ—Ç—Ä–∏–º—É—î–º–æ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
public class OrderService
{
    private readonly IEmailService _emailService;
    private readonly IPaymentProcessor _paymentProcessor;
    private readonly ILogger<OrderService> _logger;
    
    // Constructor Injection - —î–¥–∏–Ω–∏–π —Å–ø–æ—Å—ñ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
    public OrderService(
        IEmailService emailService,
        IPaymentProcessor paymentProcessor,
        ILogger<OrderService> logger)
    {
        _emailService = emailService;
        _paymentProcessor = paymentProcessor;
        _logger = logger;
    }
    
    public void ProcessOrder(Order order)
    {
        _paymentProcessor.Charge(order.Total);
        _emailService.SendConfirmation(order.CustomerEmail);
        _logger.LogInformation("Order processed: {OrderId}", order.Id);
    }
}

// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤ DI Container
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddSingleton<IEmailService, EmailService>();
builder.Services.AddScoped<IPaymentProcessor, PaymentProcessor>();
builder.Services.AddScoped<OrderService>();

var app = builder.Build();
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ DI –ø—ñ–¥—Ö–æ–¥—É:**

-   ‚úÖ **Loose Coupling**: `OrderService` –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ _–∞–±—Å—Ç—Ä–∞–∫—Ü—ñ–π_ (—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ–≤)
-   ‚úÖ **Testability**: –õ–µ–≥–∫–æ –∑–∞–º–æ–∫–∞—Ç–∏ `IEmailService` —É —Ç–µ—Å—Ç–∞—Ö
-   ‚úÖ **Flexibility**: –ú–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—é –±–µ–∑ –∑–º—ñ–Ω–∏ `OrderService`
-   ‚úÖ **Lifecycle Management**: DI Container –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–µ—Ä—É—î —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º —Ç–∞ Dispose
-   ‚úÖ **Configuration**: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤–∏–Ω–æ—Å—è—Ç—å—Å—è –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é

### 1.2. DI Container —Ç–∞ IServiceCollection

**DI Container** (—Ç–∞–∫–æ–∂ **IoC Container**) ‚Äî —Ü–µ –æ–±'—î–∫—Ç, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞:

1.  **–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é** —Å–µ—Ä–≤—ñ—Å—ñ–≤ —Ç–∞ —ó—Ö —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ–π
2.  **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è** —ñ–Ω—Å—Ç–∞–Ω—Å—ñ–≤ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
3.  **–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è lifecycle** (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, –ø–µ—Ä–µ—ñ—Å–ø–æ–ª—å–∑—É–≤–∞–Ω–Ω—è, disposal)

–£ .NET —Ü–µ `IServiceCollection` –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞ `IServiceProvider` –¥–ª—è resolve.

#### –ë–∞–∑–æ–≤–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ DI

::mermaid

```mermaid
graph LR
    A[Application Startup] --> B[IServiceCollection]
    B -->|Register| C[Service Descriptors]
    C --> D[BuildServiceProvider]
    D --> E[IServiceProvider]
    E -->|Resolve| F[Service Instances]
    
    style B fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style E fill:#f59e0b,stroke:#b45309,color:#ffffff
    style F fill:#10b981,stroke:#059669,color:#ffffff
```

::

#### –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—ñ–≤

```csharp showLineNumbers
var builder = WebApplication.CreateBuilder(args);

// IServiceCollection - –∫–æ–ª–µ–∫—Ü—ñ—è ServiceDescriptor'—ñ–≤
var services = builder.Services;

// –†—ñ–∑–Ω—ñ —Å–ø–æ—Å–æ–±–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:

// 1. Interface ‚Üí Implementation
services.AddSingleton<IEmailService, EmailService>();

// 2. Concrete type (Interface = Implementation)
services.AddScoped<OrderService>();

// 3. Factory method
services.AddTransient<IPaymentProcessor>(sp =>
{
    var config = sp.GetRequiredService<IConfiguration>();
    var apiKey = config["PaymentGateway:ApiKey"];
    return new StripePaymentProcessor(apiKey);
});

// 4. Existing instance (only for singletons)
var cache = new MemoryCache(new MemoryCacheOptions());
services.AddSingleton<IMemoryCache>(cache);

// 5. Generic types
services.AddScoped(typeof(IRepository<>), typeof(Repository<>));
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è:**

-   **–†—è–¥–æ–∫ 9**: –ù–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏–π —Å–ø–æ—Å—ñ–± ‚Äî –º–∞–ø–∏–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –∫–ª–∞—Å
-   **–†—è–¥–æ–∫ 12**: –Ø–∫—â–æ –Ω–µ–º–∞—î —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É, —Ä–µ—î—Å—Ç—Ä—É—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ç–∏–ø –Ω–∞–ø—Ä—è–º—É
-   **–†—è–¥–æ–∫ 15-19**: Factory method –¥–æ–∑–≤–æ–ª—è—î —Å–∫–ª–∞–¥–Ω—É –ª–æ–≥—ñ–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑ –¥–æ—Å—Ç—É–ø–æ–º –¥–æ —ñ–Ω—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
-   **–†—è–¥–æ–∫ 22-23**: –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≥–æ—Ç–æ–≤–æ–≥–æ —ñ–Ω—Å—Ç–∞–Ω—Å—É (—Ä—ñ–¥–∫–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è)
-   **–†—è–¥–æ–∫ 26**: Open generic types –¥–ª—è generic —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤

#### Resolve —Å–µ—Ä–≤—ñ—Å—ñ–≤

```csharp showLineNumbers
var app = builder.Build();

// IServiceProvider - resolver –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—ñ–≤
var serviceProvider = app.Services;

// 1. GetRequiredService - –∫–∏–¥–∞—î exception —è–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
var emailService = serviceProvider.GetRequiredService<IEmailService>();

// 2. GetService - –ø–æ–≤–µ—Ä—Ç–∞—î null —è–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
var optionalService = serviceProvider.GetService<IOptionalService>();

// 3. GetServices - –ø–æ–≤–µ—Ä—Ç–∞—î –≤—Å—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (–¥–ª—è multiple implementations)
var handlers = serviceProvider.GetServices<INotificationHandler>();

// 4. Constructor Injection (preferred way)
public class MyController : ControllerBase
{
    private readonly IEmailService _emailService;
    
    public MyController(IEmailService emailService)
    {
        _emailService = emailService;
    }
}
```

**Best Practices:**

-   ‚úÖ **Constructor Injection –∑–∞–≤–∂–¥–∏ preferred**: –°–µ—Ä–≤—ñ—Å–∏ –æ—Ç—Ä–∏–º—É–π—Ç–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
-   ‚úÖ **GetRequiredService –¥–ª—è –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö**: Fail-fast —è–∫—â–æ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –≤—ñ–¥—Å—É—Ç–Ω—è
-   ‚úÖ **–£–Ω–∏–∫–∞–π—Ç–µ –ø—Ä—è–º–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤ GetService**: –¶–µ Service Locator anti-pattern (–ø—Ä–æ —Ü–µ –Ω–∏–∂—á–µ)

### 1.3. Service Lifetimes

**Service Lifetime** –≤–∏–∑–Ω–∞—á–∞—î, _–∫–æ–ª–∏_ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —ñ–Ω—Å—Ç–∞–Ω—Å —Å–µ—Ä–≤—ñ—Å—É —Ç–∞ _—Å–∫—ñ–ª—å–∫–∏ —á–∞—Å—É_ –≤—ñ–Ω –∂–∏–≤–µ.

#### –¢—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ñ lifetimes

| Lifetime      | –û–ø–∏—Å                                                       | –ö–æ–ª–∏ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è                  | –ö–æ–ª–∏ Dispose                       |
| :------------ | :--------------------------------------------------------- | :-------------------------------- | :--------------------------------- |
| **Transient** | –ù–æ–≤–∏–π —ñ–Ω—Å—Ç–∞–Ω—Å –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ                           | –ö–æ–∂–µ–Ω —Ä–∞–∑ –ø—Ä–∏ resolve             | –û–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è          |
| **Scoped**    | –û–¥–∏–Ω —ñ–Ω—Å—Ç–∞–Ω—Å –Ω–∞ scope (–∑–∞–∑–≤–∏—á–∞–π HTTP request)              | –ü–æ—á–∞—Ç–æ–∫ scope                     | –ö—ñ–Ω–µ—Ü—å scope                       |
| **Singleton** | –û–¥–∏–Ω —ñ–Ω—Å—Ç–∞–Ω—Å –Ω–∞ –≤–µ—Å—å —á–∞—Å –∂–∏—Ç—Ç—è –¥–æ–¥–∞—Ç–∫—É                     | –ü–µ—Ä—à–∏–π resolve (–∞–±–æ –ø—Ä–∏ startup)  | Shutdown –¥–æ–¥–∞—Ç–∫—É                   |

#### Transient Lifetime

```csharp showLineNumbers
services.AddTransient<IGuidService, GuidService>();

public class GuidService : IGuidService
{
    private readonly Guid _instanceId = Guid.NewGuid();
    
    public Guid GetInstanceId() => _instanceId;
}

// Usage
public class MyController : ControllerBase
{
    private readonly IGuidService _guidService1;
    private readonly IGuidService _guidService2;
    
    public MyController(IGuidService guidService1, IGuidService guidService2)
    {
        _guidService1 = guidService1;
        _guidService2 = guidService2;
    }
    
    [HttpGet("transient")]
    public IActionResult Test()
    {
        // ‚ùó _guidService1 —Ç–∞ _guidService2 ‚Äî —Ü–µ –†–Ü–ó–ù–Ü —ñ–Ω—Å—Ç–∞–Ω—Å–∏
        return Ok(new
        {
            service1 = _guidService1.GetInstanceId(),
            service2 = _guidService2.GetInstanceId()
        });
        // Output: {"service1": "abc-123", "service2": "def-456"}
    }
}
```

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Transient:**

-   ‚úÖ Stateless —Å–µ—Ä–≤—ñ—Å–∏ –±–µ–∑ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —Å—Ç–∞–Ω—É
-   ‚úÖ –õ–µ–≥–∫—ñ –æ–±'—î–∫—Ç–∏, —è–∫—ñ —à–≤–∏–¥–∫–æ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è
-   ‚úÖ –°–µ—Ä–≤—ñ—Å–∏, —â–æ –Ω–µ —Ç—Ä–∏–º–∞—é—Ç—å —Ä–µ—Å—É—Ä—Å–∏ (connections, files)

**–ü—Ä–∏–∫–ª–∞–¥–∏**: Validators, Mappers, Utilities, DTOs processors.

#### Scoped Lifetime

```csharp showLineNumbers
services.AddScoped<IGuidService, GuidService>();

// –í ASP.NET Core - –æ–¥–∏–Ω scope = –æ–¥–∏–Ω HTTP request
public class MyController : ControllerBase
{
    private readonly IGuidService _guidService1;
    private readonly IGuidService _guidService2;
    
    public MyController(IGuidService guidService1, IGuidService guidService2)
    {
        _guidService1 = guidService1;
        _guidService2 = guidService2;
    }
    
    [HttpGet("scoped")]
    public IActionResult Test()
    {
        // ‚úÖ _guidService1 —Ç–∞ _guidService2 ‚Äî —Ü–µ –û–î–ò–ù —ñ–Ω—Å—Ç–∞–Ω—Å (–≤ –º–µ–∂–∞—Ö request)
        return Ok(new
        {
            service1 = _guidService1.GetInstanceId(),
            service2 = _guidService2.GetInstanceId()
        });
        // Output: {"service1": "abc-123", "service2": "abc-123"}
    }
}
```

**Scope –≤ —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø–∞—Ö –¥–æ–¥–∞—Ç–∫—ñ–≤:**

| –¢–∏–ø –¥–æ–¥–∞—Ç–∫—É       | Scope                           |
| :---------------- | :------------------------------ |
| **ASP.NET Core**  | HTTP Request                    |
| **Worker Service**| Manual scope —á–µ—Ä–µ–∑ CreateScope()|
| **Console App**   | Manual scope                    |
| **Blazor Server** | SignalR Connection (Circuit)    |

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Scoped:**

-   ‚úÖ **DbContext** (EF Core): –û–¥–∏–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ request
-   ‚úÖ –°–µ—Ä–≤—ñ—Å–∏ –∑ request-specific state (current user, request ID)
-   ‚úÖ Unit of Work pattern

**–ü—Ä–∏–∫–ª–∞–¥–∏**: `DbContext`, `HttpContext`, Repository per request.

#### Singleton Lifetime

```csharp showLineNumbers
services.AddSingleton<IGuidService, GuidService>();

// –Ñ–¥–∏–Ω–∏–π —ñ–Ω—Å—Ç–∞–Ω—Å –¥–ª—è –≤—Å—å–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É
public class RequestController : ControllerBase
{
    private readonly IGuidService _guidService;
    
    public RequestController(IGuidService guidService)
    {
        _guidService = guidService;
    }
    
    [HttpGet("test")]
    public IActionResult Test()
    {
        return Ok(new { instanceId = _guidService.GetInstanceId() });
        // –ó–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î —Ç–æ–π —Å–∞–º–∏–π GUID –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—ñ–≤!
    }
}
```

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Singleton:**

-   ‚úÖ **Thread-safe** —Å–µ—Ä–≤—ñ—Å–∏ –±–µ–∑ mutable state
-   ‚úÖ Configuration objects, Caches
-   ‚úÖ Expensive-to-create –æ–±'—î–∫—Ç–∏ (connection pools)
-   ‚úÖ Background services, Hosted services

**–ü—Ä–∏–∫–ª–∞–¥–∏**: `IMemoryCache`, `ILogger`, `IHttpClientFactory`, Background workers.

::warning
**–ö–†–ò–¢–ò–ß–ù–û**: Singleton —Å–µ—Ä–≤—ñ—Å–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ **thread-safe**! –í–æ–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ —Ä—ñ–∑–Ω–∏—Ö –ø–æ—Ç–æ–∫—ñ–≤.
::

#### –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è Lifetimes: –î—ñ–∞–≥—Ä–∞–º–∞

::mermaid

```mermaid
sequenceDiagram
    participant App
    participant Container
    participant T as Transient
    participant Sc as Scoped
    participant Si as Singleton
    
    App->>Container: Request 1
    Container->>T: Create T1
    Container->>Sc: Create Sc1
    Container->>Si: Create Si1 (first time)
    App->>App: Process Request 1
    Note over T: T1 Disposed
    Note over Sc: Sc1 Disposed
    
    App->>Container: Request 2
    Container->>T: Create T2
    Container->>Sc: Create Sc2
    Container-->>Si: Reuse Si1
    App->>App: Process Request 2
    Note over T: T2 Disposed
    Note over Sc: Sc2 Disposed
    Note over Si: Si1 still alive
```

::

### 1.4. Scopes –≤ DI

**Scope** ‚Äî —Ü–µ –ª–æ–≥—ñ—á–Ω–∞ –º–µ–∂–∞, –≤ —è–∫—ñ–π scoped —Å–µ—Ä–≤—ñ—Å–∏ –º–∞—é—Ç—å –æ–¥–∏–Ω —ñ —Ç–æ–π –∂–µ —ñ–Ω—Å—Ç–∞–Ω—Å.

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ Scopes (ASP.NET Core)

```csharp showLineNumbers
// ASP.NET Core –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î scope –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ HTTP request
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddScoped<AppDbContext>(); // EF Core DbContext

var app = builder.Build();

app.MapGet("/order/{id}", async (int id, IOrderService orderService) =>
{
    // orderService —Ç–∞ AppDbContext –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –Ω–µ—ó ‚Äî –æ–¥–Ω—ñ —ñ —Ç—ñ –∂ –¥–ª—è —Ü—å–æ–≥–æ request
    var order = await orderService.GetOrderAsync(id);
    return Results.Ok(order);
}); // Scope –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è —Ç—É—Ç, –≤—Å—ñ Scoped —Å–µ—Ä–≤—ñ—Å–∏ Dispose

app.Run();
```

#### Manual Scopes (Console/Worker)

```csharp showLineNumbers
var builder = Host.CreateApplicationBuilder(args);

builder.Services.AddScoped<IDataProcessor, DataProcessor>();
builder.Services.AddScoped<AppDbContext>();

var host = builder.Build();

// Manual scope creation
using (var scope = host.Services.CreateScope())
{
    var serviceProvider = scope.ServiceProvider;
    
    var processor = serviceProvider.GetRequiredService<IDataProcessor>();
    await processor.ProcessAsync();
    
    // Scope –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è —Ç—É—Ç ‚Äî –≤—Å—ñ Scoped —Å–µ—Ä–≤—ñ—Å–∏ Dispose
}

// –ù–æ–≤–∏–π scope
using (var scope = host.Services.CreateScope())
{
    var processor = scope.ServiceProvider.GetRequiredService<IDataProcessor>();
    await processor.ProcessAsync();
    // –ù–æ–≤–∏–π —ñ–Ω—Å—Ç–∞–Ω—Å IDataProcessor —Ç–∞ AppDbContext!
}
```

**–ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ Manual Scopes:**

-   Background tasks, —â–æ –æ–±—Ä–æ–±–ª—è—é—Ç—å –¥–∞–Ω—ñ –±–∞—Ç—á–∞–º–∏
-   Long-running processes –∑ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–∏–º –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º DbContext
-   Console –¥–æ–¥–∞—Ç–∫–∏, —â–æ —ñ–º—ñ—Ç—É—é—Ç—å "request-like" –ª–æ–≥—ñ–∫—É

::tip
**EF Core Best Practice**: –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Scoped lifetime –¥–ª—è `DbContext`. –û–¥–∏–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—é/request.
::

### 1.5. DI Anti-patterns —Ç–∞ Best Practices

#### Anti-pattern 1: Captive Dependency

**Captive Dependency** ‚Äî –∫–æ–ª–∏ —Å–µ—Ä–≤—ñ—Å –∑ –∫–æ—Ä–æ—Ç—à–∏–º lifetime –∑–∞—Ö–æ–ø–ª—é—î—Ç—å—Å—è —Å–µ—Ä–≤—ñ—Å–æ–º –∑ –¥–æ–≤—à–∏–º lifetime.

```csharp showLineNumbers
// ‚ùå ANTI-PATTERN: Singleton captures Scoped
services.AddSingleton<CacheService>(); // –î–æ–≤–≥–∏–π lifetime
services.AddScoped<AppDbContext>();    // –ö–æ—Ä–æ—Ç–∫–∏–π lifetime

public class CacheService
{
    private readonly AppDbContext _dbContext;
    
    // ‚ùå DbContext (Scoped) injection into Singleton
    public CacheService(AppDbContext dbContext)
    {
        _dbContext = dbContext;
    }
    
    public async Task<User> GetUserAsync(int id)
    {
        // ‚ùå –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ–π —Å–∞–º–∏–π DbContext –¥–ª—è –≤—Å—ñ—Ö requests!
        return await _dbContext.Users.FindAsync(id);
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∏:**

-   üêõ **Stale data**: DbContext –Ω–µ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –º—ñ–∂ requests
-   üêõ **Threading issues**: DbContext –Ω–µ thread-safe, –∞–ª–µ Singleton –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ
-   üêõ **Memory leaks**: DbContext –Ω–µ Dispose –º—ñ–∂ requests

**–†—ñ—à–µ–Ω–Ω—è 1: –ó–º—ñ–Ω–∏—Ç–∏ Lifetime**

```csharp showLineNumbers
// ‚úÖ –û–±–∏–¥–≤–∞ Scoped
services.AddScoped<CacheService>();
services.AddScoped<AppDbContext>();
```

**–†—ñ—à–µ–Ω–Ω—è 2: IServiceScopeFactory**

```csharp showLineNumbers
services.AddSingleton<CacheService>();
services.AddScoped<AppDbContext>();

public class CacheService
{
    private readonly IServiceScopeFactory _scopeFactory;
    
    // ‚úÖ Inject IServiceScopeFactory –∑–∞–º—ñ—Å—Ç—å DbContext
    public CacheService(IServiceScopeFactory scopeFactory)
    {
        _scopeFactory = scopeFactory;
    }
    
    public async Task<User> GetUserAsync(int id)
    {
        // ‚úÖ –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π scope –∫–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É
        using var scope = _scopeFactory.CreateScope();
        var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        
        return await dbContext.Users.FindAsync(id);
    }
}
```

**Validation**:

```csharp
// –í–∫–ª—é—á–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤ Development
builder.Host.UseDefaultServiceProvider(options =>
{
    options.ValidateScopes = true; // –ö–∏–¥–∞—î exception –ø—Ä–∏ Captive Dependency
    options.ValidateOnBuild = true;
});
```

#### Anti-pattern 2: Service Locator

**Service Locator** ‚Äî –∫–æ–ª–∏ —Å–µ—Ä–≤—ñ—Å–∏ –≤–∏—Ç—è–≥—É—é—Ç—å—Å—è –∑ `IServiceProvider` –Ω–∞–ø—Ä—è–º—É –∑–∞–º—ñ—Å—Ç—å Constructor Injection.

```csharp showLineNumbers
// ‚ùå ANTI-PATTERN: Service Locator
public class OrderService
{
    private readonly IServiceProvider _serviceProvider;
    
    public OrderService(IServiceProvider serviceProvider)
    {
        _serviceProvider = serviceProvider;
    }
    
    public async Task ProcessOrderAsync(Order order)
    {
        // ‚ùå –í–∏—Ç—è–≥—É—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Ä—É—á–Ω—É
        var emailService = _serviceProvider.GetRequiredService<IEmailService>();
        var paymentProcessor = _serviceProvider.GetRequiredService<IPaymentProcessor>();
        
        await paymentProcessor.ChargeAsync(order.Total);
        await emailService.SendConfirmationAsync(order.CustomerEmail);
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∏:**

-   ‚ùå **Hidden dependencies**: –ù–µ—è—Å–Ω–æ —è–∫—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ (–Ω–µ –≤–∏–¥–Ω–æ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ñ)
-   ‚ùå **Runtime failures**: –ü–æ–º–∏–ª–∫–∏ –≤–∏—è–≤–ª—è—é—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –∞ –Ω–µ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó
-   ‚ùå **–í–∞–∂–∫–æ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏**: –°–∫–ª–∞–¥–Ω–æ –∑–∞–º–æ–∫–∞—Ç–∏ `IServiceProvider`
-   ‚ùå **–ü–æ—Ä—É—à—É—î SRP**: –ö–ª–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ resolve –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π

**–†—ñ—à–µ–Ω–Ω—è: Constructor Injection**

```csharp showLineNumbers
// ‚úÖ Explicit dependencies
public class OrderService
{
    private readonly IEmailService _emailService;
    private readonly IPaymentProcessor _paymentProcessor;
    
    public OrderService(
        IEmailService emailService,
        IPaymentProcessor paymentProcessor)
    {
        _emailService = emailService;
        _paymentProcessor = paymentProcessor;
    }
    
    public async Task ProcessOrderAsync(Order order)
    {
        await _paymentProcessor.ChargeAsync(order.Total);
        await _emailService.SendConfirmationAsync(order.CustomerEmail);
    }
}
```

::note
**–í–∏–Ω—è—Ç–æ–∫**: `IServiceProvider` –¥–æ–ø—É—Å—Ç–∏–º–∏–π —É _—Ñ–∞–±—Ä–∏–∫–∞—Ö_ –∞–±–æ _generic factory patterns_, –¥–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —Ç–∏–ø–∏:

```csharp
public class NotificationHandlerFactory
{
    private readonly IServiceProvider _serviceProvider;
    
    public NotificationHandlerFactory(IServiceProvider serviceProvider)
    {
        _serviceProvider = serviceProvider;
    }
    
    public INotificationHandler Create(NotificationType type)
    {
        return type switch
        {
            NotificationType.Email => _serviceProvider.GetRequiredService<EmailHandler>(),
            NotificationType.Sms => _serviceProvider.GetRequiredService<SmsHandler>(),
            _ => throw new ArgumentException("Unknown type")
        };
    }
}
```

::

#### Anti-pattern 3: Circular Dependencies

**Circular Dependencies** ‚Äî –∫–æ–ª–∏ –¥–≤–∞ –∞–±–æ –±—ñ–ª—å—à–µ —Å–µ—Ä–≤—ñ—Å—ñ–≤ –∑–∞–ª–µ–∂–∞—Ç—å –æ–¥–∏–Ω –≤—ñ–¥ –æ–¥–Ω–æ–≥–æ.

```csharp showLineNumbers
// ‚ùå ANTI-PATTERN: Circular dependency
public class OrderService
{
    private readonly IInventoryService _inventoryService;
    
    public OrderService(IInventoryService inventoryService)
    {
        _inventoryService = inventoryService;
    }
}

public class InventoryService : IInventoryService
{
    private readonly OrderService _orderService;
    
    // ‚ùå InventoryService –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ OrderService, —è–∫–∏–π –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ IInventoryService
    public InventoryService(OrderService orderService)
    {
        _orderService = orderService;
    }
}

// Runtime error:
// System.InvalidOperationException: A circular dependency was detected
```

**–†—ñ—à–µ–Ω–Ω—è 1: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏**

–í–∏–¥—ñ–ª—ñ—Ç—å —Å–ø—ñ–ª—å–Ω—É –ª–æ–≥—ñ–∫—É –≤ –æ–∫—Ä–µ–º–∏–π —Å–µ—Ä–≤—ñ—Å:

```csharp showLineNumbers
// ‚úÖ –í–≤–µ–¥—ñ—Ç—å –ø—Ä–æ–º—ñ–∂–Ω–∏–π —Å–µ—Ä–≤—ñ—Å
public interface IOrderValidator
{
    bool ValidateStock(int productId, int quantity);
}

public class OrderService
{
    private readonly IOrderValidator _validator;
    
    public OrderService(IOrderValidator validator)
    {
        _validator = validator;
    }
}

public class InventoryService : IInventoryService
{
    private readonly IOrderValidator _validator;
    
    public InventoryService(IOrderValidator validator)
    {
        _validator = validator;
    }
}
```

**–†—ñ—à–µ–Ω–Ω—è 2: Lazy Injection**

```csharp showLineNumbers
// ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Lazy<T> –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –ª–∏—à–µ –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ
public class OrderService
{
    private readonly Lazy<IInventoryService> _inventoryService;
    
    public OrderService(Lazy<IInventoryService> inventoryService)
    {
        _inventoryService = inventoryService;
    }
    
    public void ProcessOrder()
    {
        // –°–µ—Ä–≤—ñ—Å —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Ç—É—Ç, –∞ –Ω–µ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ñ
        var inventory = _inventoryService.Value;
    }
}
```

#### Best Practices –¥–ª—è DI

::field-group

:::field{name="‚úÖ Constructor Injection Only"}
–ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Constructor Injection. –£–Ω–∏–∫–∞–π—Ç–µ Property/Method Injection.

```csharp
// ‚úÖ Good
public class MyService
{
    private readonly IDependency _dependency;
    
    public MyService(IDependency dependency)
    {
        _dependency = dependency;
    }
}

// ‚ùå Bad - Property Injection
public class MyService
{
    public IDependency Dependency { get; set; }
}
```

:::

:::field{name="‚úÖ –ó–∞–ª–µ–∂—Ç–µ –≤—ñ–¥ Abstractions"}
Dependency Inversion Principle: –∑–∞–ª–µ–∂—Ç–µ –≤—ñ–¥ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ–≤, –∞ –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤.

```csharp
// ‚úÖ Good - –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
public class OrderService
{
    private readonly IEmailService _emailService;
    
    public OrderService(IEmailService emailService) { }
}

// ‚ùå Bad - –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—É
public class OrderService
{
    private readonly SmtpEmailService _emailService;
    
    public OrderService(SmtpEmailService emailService) { }
}
```

:::

:::field{name="‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ Captive Dependencies"}
–í–∫–ª—é—á–∞–π—Ç–µ `ValidateScopes` –≤ Development:

```csharp
builder.Host.UseDefaultServiceProvider(options =>
{
    options.ValidateScopes = Environment.IsDevelopment();
    options.ValidateOnBuild = true;
});
```

:::

:::field{name="‚úÖ –ú—ñ–Ω—ñ–º—ñ–∑—É–π—Ç–µ Dependencies"}
–Ø–∫—â–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –º–∞—î >5 –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π ‚Äî —Ü–µ code smell. –†–æ–∑–¥—ñ–ª—ñ—Ç—å –∫–ª–∞—Å –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ Facade.

```csharp
// ‚ùå Too many dependencies
public class OrderService(
    IEmailService emailService,
    IPaymentService paymentService,
    IInventoryService inventoryService,
    IShippingService shippingService,
    INotificationService notificationService,
    ILoggingService loggingService,
    ICacheService cacheService)
{
}

// ‚úÖ –†–æ–∑–¥—ñ–ª—ñ—Ç—å –Ω–∞ –º–µ–Ω—à—ñ —Å–µ—Ä–≤—ñ—Å–∏ –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ Facade
public class OrderFacade(
    IOrderProcessingService orderProcessing,
    IOrderNotificationService orderNotification)
{
}
```

:::

:::field{name="‚úÖ Dispose –∫–µ—Ä—É—î—Ç—å—Å—è Container'–æ–º"}
–ù–µ –≤–∏–∫–ª–∏–∫–∞–π—Ç–µ `Dispose()` –≤—Ä—É—á–Ω—É –Ω–∞ —Å–µ—Ä–≤—ñ—Å–∞—Ö –∑ DI. Container —Ü–µ —Ä–æ–±–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.

```csharp
// ‚ùå Bad
public class MyService
{
    public void DoWork(IServiceProvider sp)
    {
        var dbContext = sp.GetRequiredService<AppDbContext>();
        dbContext.Dispose(); // ‚ùå –ù–ï —Ä–æ–±—ñ—Ç—å —Ü–µ!
    }
}

// ‚úÖ Good - Container dispose –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
using (var scope = sp.CreateScope())
{
    var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
    // dbContext.Dispose() –≤–∏–∫–ª–∏—á–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
}
```

:::

::

---

## –ß–∞—Å—Ç–∏–Ω–∞ 2: Configuration System

### 2.1. IConfiguration —Ç–∞ Configuration Providers

**Configuration System** —É .NET –Ω–∞–¥–∞—î —î–¥–∏–Ω–∏–π API –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª.

#### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ Configuration

::mermaid

```mermaid
graph TD
    A[IConfiguration] --> B[JSON Files]
    A --> C[Environment Variables]
    A --> D[User Secrets]
    A --> E[Command Line Args]
    A --> F[Custom Providers]
    
    B --> G[appsettings.json]
    B --> H[appsettings.Development.json]
    
    style A fill:#f59e0b,stroke:#b45309,color:#ffffff
    style B fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style C fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style D fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style E fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
```

::

#### Default Configuration Sources

```csharp showLineNumbers
var builder = WebApplication.CreateBuilder(args);

// builder.Configuration –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î (–≤ –ø–æ—Ä—è–¥–∫—É –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É):
// 1. appsettings.json
// 2. appsettings.{Environment}.json
// 3. User Secrets (–ª–∏—à–µ –≤ Development)
// 4. Environment Variables
// 5. Command Line Arguments

var config = builder.Configuration;

// –ü—Ä–æ—Å—Ç–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –∑–Ω–∞—á–µ–Ω—å
var connectionString = config["ConnectionStrings:DefaultConnection"];
var logLevel = config["Logging:LogLevel:Default"];

// Hierarchical access
var smtpHost = config["EmailSettings:Smtp:Host"];
```

#### appsettings.json

```json showLineNumbers
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=MyApp;Trusted_Connection=True;"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "EmailSettings": {
    "Smtp": {
      "Host": "smtp.gmail.com",
      "Port": 587,
      "EnableSsl": true
    },
    "From": "noreply@myapp.com"
  },
  "FeatureFlags": {
    "EnableNewCheckout": false,
    "MaxOrderItems": 100
  }
}
```

#### Environment-specific Configurations

```csharp
// appsettings.Development.json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=MyApp_Dev;"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Debug" // –ë—ñ–ª—å—à –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ Dev
    }
  },
  "EmailSettings": {
    "Smtp": {
      "Host": "localhost", // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π SMTP –¥–ª—è —Ç–µ—Å—Ç—ñ–≤
      "Port": 25
    }
  }
}

// appsettings.Production.json
{
  "ConnectionStrings": {
    "DefaultConnection": "${DATABASE_CONNECTION_STRING}" // –ü—ñ–¥—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è –∑ Environment Variable
  },
  "Logging": {
    "LogLevel": {
      "Default": "Warning" // –ú—ñ–Ω—ñ–º—É–º –ª–æ–≥—ñ–≤ –≤ prod
    }
  }
}
```

### 2.2. User Secrets (Development Only)

**User Secrets** ‚Äî —Ü–µ –º–µ—Ö–∞–Ω—ñ–∑–º –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —á—É—Ç–ª–∏–≤–∏—Ö –¥–∞–Ω–∏—Ö _–ø–æ–∑–∞_ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—î–º –¥–ª—è Development.

#### –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è User Secrets

```bash
# CLI –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
dotnet user-secrets init

# –î–æ–¥–∞–≤–∞–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç—É
dotnet user-secrets set "EmailSettings:Smtp:Password" "my-secret-password"
dotnet user-secrets set "PaymentGateway:ApiKey" "sk_test_123456"

# –ü–µ—Ä–µ–≥–ª—è–¥ –≤—Å—ñ—Ö —Å–µ–∫—Ä–µ—Ç—ñ–≤
dotnet user-secrets list
```

–°–µ–∫—Ä–µ—Ç–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤:

-   **Windows**: `%APPDATA%\Microsoft\UserSecrets\<user_secrets_id>\secrets.json`
-   **macOS/Linux**: `~/.microsoft/usersecrets/<user_secrets_id>/secrets.json`

```json
// secrets.json
{
  "EmailSettings:Smtp:Password": "my-secret-password",
  "PaymentGateway:ApiKey": "sk_test_123456"
}
```

#### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è User Secrets

```csharp showLineNumbers
var builder = WebApplication.CreateBuilder(args);

// User Secrets –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –≤ Development
var config = builder.Configuration;

var smtpPassword = config["EmailSettings:Smtp:Password"]; // –ß–∏—Ç–∞—î—Ç—å—Å—è –∑ User Secrets
var apiKey = config["PaymentGateway:ApiKey"];

// –î–ª—è production –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Environment Variables –∞–±–æ Azure Key Vault
```

::warning
**–í–ê–ñ–õ–ò–í–û**: User Secrets ‚Äî —Ü–µ –ù–ï encryption! –í–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É plain text, –∞–ª–µ _–ø–æ–∑–∞_ –ø—Ä–æ—î–∫—Ç–æ–º. –î–ª—è production –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Azure Key Vault, AWS Secrets Manager –∞–±–æ –ø–æ–¥—ñ–±–Ω—ñ.
::

### 2.3. Environment Variables

Environment Variables –º–∞—é—Ç—å –≤–∏—â–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –∑–∞ JSON —Ñ–∞–π–ª–∏ —Ç–∞ –ø–µ—Ä–µ–æ–∑–Ω–∞—á–∞—é—Ç—å —ó—Ö.

#### –§–æ—Ä–º–∞—Ç Environment Variables

```bash
# Hierarchical keys –∑–∞–º—ñ–Ω—é—é—Ç—å : –Ω–∞ __ (–ø–æ–¥–≤—ñ–π–Ω–µ –ø—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è)
export ConnectionStrings__DefaultConnection="Server=prod-db;Database=MyApp;"
export EmailSettings__Smtp__Password="prod-password"
export Logging__LogLevel__Default="Warning"

# –ü—Ä–æ—Å—Ç—ñ—à–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (–¥–ª—è non-hierarchical)
export ASPNETCORE_ENVIRONMENT="Production"
export ASPNETCORE_URLS="http://+:5000"
```

#### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –∫–æ–¥—ñ

```csharp showLineNumbers
var builder = WebApplication.CreateBuilder(args);

// –ß–∏—Ç–∞–Ω–Ω—è Environment Variables
var environment = builder.Environment.EnvironmentName; // "Development", "Staging", "Production"

// –ó IConfiguration (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ)
var connectionString = builder.Configuration["ConnectionStrings:DefaultConnection"];
// –Ø–∫—â–æ —î Environment Variable, –≤–æ–Ω–∞ –ø–µ—Ä–µ–æ–∑–Ω–∞—á–∏—Ç—å appsettings.json
```

#### Docker / Kubernetes –ø—Ä–∏–∫–ª–∞–¥

```yaml
# docker-compose.yml
version: '3.8'
services:
  api:
    image: myapp:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=postgres;Database=myapp;
      - EmailSettings__Smtp__Host=smtp.sendgrid.net
      - EmailSettings__Smtp__Password=${SMTP_PASSWORD} # –ó .env —Ñ–∞–π–ª—É
```

### 2.4. Options Pattern

**Options Pattern** ‚Äî —Ü–µ —Å–ø–æ—Å—ñ–± _strongly-typed_ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π —á–µ—Ä–µ–∑ POCO –∫–ª–∞—Å–∏.

#### –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ Options Pattern

```csharp showLineNumbers
// ‚ùå Stringly-typed - –ª–µ–≥–∫–æ –∑—Ä–æ–±–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É
public class EmailService
{
    private readonly IConfiguration _configuration;
    
    public EmailService(IConfiguration configuration)
    {
        _configuration = configuration;
    }
    
    public async Task SendEmailAsync(string to, string subject, string body)
    {
        var host = _configuration["EmailSetings:Smtp:Host"]; // ‚ùå Typo: "Setings"
        var port = int.Parse(_configuration["EmailSettings:Smtp:Port"]);
        var enableSsl = bool.Parse(_configuration["EmailSettings:Smtp:EnableSsl"]);
        
        // ... SMTP logic
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∏:**

-   ‚ùå Typos –Ω–µ –≤–∏—è–≤–ª—è—é—Ç—å—Å—è –Ω–∞ compile-time
-   ‚ùå –ë–∞–≥–∞—Ç–æ boilerplate –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É
-   ‚ùå –ù–µ–º–∞—î IntelliSense

#### –†—ñ—à–µ–Ω–Ω—è: Options Pattern

**–ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä—ñ—Ç—å POCO –∫–ª–∞—Å**

```csharp showLineNumbers
public class EmailSettings
{
    public const string SectionName = "EmailSettings";
    
    public SmtpSettings Smtp { get; set; } = null!;
    public string From { get; set; } = string.Empty;
}

public class SmtpSettings
{
    public string Host { get; set; } = string.Empty;
    public int Port { get; set; }
    public bool EnableSsl { get; set; }
    public string? Username { get; set; }
    public string? Password { get; set; }
}
```

**–ö—Ä–æ–∫ 2: –ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ –≤ DI**

```csharp showLineNumbers
var builder = WebApplication.CreateBuilder(args);

// Bind configuration section to POCO
builder.Services.Configure<EmailSettings>(
    builder.Configuration.GetSection(EmailSettings.SectionName));

var app = builder.Build();
```

**–ö—Ä–æ–∫ 3: Inject —á–µ—Ä–µ–∑ IOptions<T>**

```csharp showLineNumbers
public class EmailService
{
    private readonly EmailSettings _settings;
    
    // ‚úÖ Strongly-typed, compile-time safe
    public EmailService(IOptions<EmailSettings> options)
    {
        _settings = options.Value;
    }
    
    public async Task SendEmailAsync(string to, string subject, string body)
    {
        var host = _settings.Smtp.Host; // IntelliSense –ø—Ä–∞—Ü—é—î!
        var port = _settings.Smtp.Port;
        
        using var client = new SmtpClient(host, port)
        {
            EnableSsl = _settings.Smtp.EnableSsl,
            Credentials = new NetworkCredential(_settings.Smtp.Username, _settings.Smtp.Password)
        };
        
        // ... send email
    }
}
```

#### IOptions vs IOptionsSnapshot vs IOptionsMonitor

| –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å           | Lifetime  | Hot Reload | Named Options | –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏                         |
| :------------------ | :-------- | :--------- | :------------ | :------------------------------------------- |
| **IOptions<T>**     | Singleton | ‚ùå –ù—ñ      | ‚úÖ –¢–∞–∫        | –°—Ç–∞—Ç–∏—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, —â–æ –Ω–µ –∑–º—ñ–Ω—é—é—Ç—å—Å—è      |
| **IOptionsSnapshot<T>** | Scoped    | ‚úÖ –¢–∞–∫     | ‚úÖ –¢–∞–∫        | –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, —â–æ –º–æ–∂—É—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—è per-request |
| **IOptionsMonitor<T>**  | Singleton | ‚úÖ –¢–∞–∫     | ‚úÖ –¢–∞–∫        | –†–µ–∞–∫—Ü—ñ—è –Ω–∞ –∑–º—ñ–Ω–∏ –≤ real-time                 |

#### IOptionsSnapshot –ü—Ä–∏–∫–ª–∞–¥

```csharp showLineNumbers
services.Configure<FeatureFlags>(
    builder.Configuration.GetSection("FeatureFlags"));

// IOptionsSnapshot –ø–µ—Ä–µ—á–∏—Ç—É—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∫–æ–∂–µ–Ω request
public class CheckoutController : ControllerBase
{
    private readonly FeatureFlags _featureFlags;
    
    public CheckoutController(IOptionsSnapshot<FeatureFlags> options)
    {
        _featureFlags = options.Value; // –°–≤—ñ–∂–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —Ü—å–æ–≥–æ request
    }
    
    [HttpPost]
    public IActionResult ProcessCheckout()
    {
        if (_featureFlags.EnableNewCheckout)
        {
            return ProcessNewCheckout();
        }
        
        return ProcessLegacyCheckout();
    }
}
```

#### IOptionsMonitor –ü—Ä–∏–∫–ª–∞–¥ (Hot Reload)

```csharp showLineNumbers
services.Configure<CacheSettings>(
    builder.Configuration.GetSection("CacheSettings"));

public class CacheService
{
    private readonly IOptionsMonitor<CacheSettings> _optionsMonitor;
    
    public CacheService(IOptionsMonitor<CacheSettings> optionsMonitor)
    {
        _optionsMonitor = optionsMonitor;
        
        // –†–µ–∞–≥—É—î–º–æ –Ω–∞ –∑–º—ñ–Ω–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
        _optionsMonitor.OnChange(settings =>
        {
            Console.WriteLine($"Cache TTL changed to: {settings.DefaultTtlMinutes}");
            ReconfigureCache(settings);
        });
    }
    
    public string GetValue(string key)
    {
        // –ó–∞–≤–∂–¥–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        var settings = _optionsMonitor.CurrentValue;
        return _cache.Get(key, settings.DefaultTtlMinutes);
    }
}
```

#### Validation –≤ Options Pattern

```csharp showLineNumbers
public class EmailSettings
{
    public SmtpSettings Smtp { get; set; } = null!;
    public string From { get; set; } = string.Empty;
}

// Validation —á–µ—Ä–µ–∑ Data Annotations
using System.ComponentModel.DataAnnotations;

public class SmtpSettings
{
    [Required]
    [RegularExpression(@"^[\w\.-]+$")]
    public string Host { get; set; } = string.Empty;
    
    [Range(1, 65535)]
    public int Port { get; set; }
    
    public bool EnableSsl { get; set; }
}

// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑ validation
builder.Services.AddOptions<EmailSettings>()
    .Bind(builder.Configuration.GetSection(EmailSettings.SectionName))
    .ValidateDataAnnotations() // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Data Annotations
    .ValidateOnStart(); // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –¥–æ–¥–∞—Ç–∫—É
```

**–°–∫–ª–∞–¥–Ω—ñ—à–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è:**

```csharp showLineNumbers
builder.Services.AddOptions<EmailSettings>()
    .Bind(builder.Configuration.GetSection(EmailSettings.SectionName))
    .Validate(settings =>
    {
        // Custom validation logic
        if (settings.Smtp.EnableSsl && settings.Smtp.Port == 25)
        {
            return false; // Port 25 –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î SSL
        }
        
        if (string.IsNullOrEmpty(settings.Smtp.Password) && settings.Smtp.EnableSsl)
        {
            return false; // SSL –ø–æ—Ç—Ä–µ–±—É—î password
        }
        
        return true;
    }, "Invalid SMTP configuration")
    .ValidateOnStart();
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 3: Logging

### 3.1. ILogger —Ç–∞ Microsoft.Extensions.Logging

**ILogger** ‚Äî —Ü–µ –∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—è –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è, —â–æ –¥–æ–∑–≤–æ–ª—è—î –ø–∏—Å–∞—Ç–∏ –ª–æ–≥–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—ó.

#### –ë–∞–∑–æ–≤–∏–π Logging

```csharp showLineNumbers
public class OrderService
{
    private readonly ILogger<OrderService> _logger;
    
    public OrderService(ILogger<OrderService> logger)
    {
        _logger = logger;
    }
    
    public async Task<Order> CreateOrderAsync(CreateOrderRequest request)
    {
        _logger.LogInformation("Creating order for user {UserId}", request.UserId);
        
        try
        {
            var order = new Order { UserId = request.UserId, Total = request.Total };
            await _repository.AddAsync(order);
            
            _logger.LogInformation("Order {OrderId} created successfully", order.Id);
            return order;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to create order for user {UserId}", request.UserId);
            throw;
        }
    }
}
```

#### Log Levels

| Level         | –ó–Ω–∞—á–µ–Ω–Ω—è | –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏                                |
| :------------ | :------- | :-------------------------------------------------- |
| **Trace**     | 0        | –ù–∞–π–¥–µ—Ç–∞–ª—å–Ω—ñ—à–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–ª—è debugging             |
| **Debug**     | 1        | Development debugging, –Ω–µ –¥–ª—è production            |
| **Information** | 2        | –ó–∞–≥–∞–ª—å–Ω–∏–π flow –¥–æ–¥–∞—Ç–∫—É                             |
| **Warning**   | 3        | –ù–µ–∑–≤–∏—á–∞–π–Ω—ñ –ø–æ–¥—ñ—ó, —è–∫—ñ –Ω–µ —î –ø–æ–º–∏–ª–∫–∞–º–∏               |
| **Error**     | 4        | –ü–æ–º–∏–ª–∫–∏, —â–æ –Ω–µ –∑—É–ø–∏–Ω—è—é—Ç—å —Ä–æ–±–æ—Ç—É –¥–æ–¥–∞—Ç–∫—É             |
| **Critical**  | 5        | –ö—Ä–∏—Ç–∏—á–Ω—ñ –∑–±–æ—ó, —â–æ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –Ω–µ–≥–∞–π–Ω–æ—ó —É–≤–∞–≥–∏        |

```csharp showLineNumbers
_logger.LogTrace("Entering method ProcessOrder");
_logger.LogDebug("Cache miss for key {CacheKey}", key);
_logger.LogInformation("User {UserId} logged in", userId);
_logger.LogWarning("Retry attempt {Attempt} for order {OrderId}", attempt, orderId);
_logger.LogError(exception, "Payment failed for order {OrderId}", orderId);
_logger.LogCritical(exception, "Database connection lost!");
```

#### Structured Logging

**Structured Logging** ‚Äî —Ü–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—è–º–∏, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–º.

```csharp showLineNumbers
// ‚ùå String interpolation - –≤—Ç—Ä–∞—á–∞—î—Ç—å—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
_logger.LogInformation($"User {userId} placed order {orderId} for ${total}");

// ‚úÖ Structured logging - –∑–±–µ—Ä—ñ–≥–∞—î properties
_logger.LogInformation(
    "User {UserId} placed order {OrderId} for {Total:C}",
    userId,
    orderId,
    total);
```

**–£ Serilog —Ü–µ –≤–∏–≥–ª—è–¥–∞—î —è–∫ JSON:**

```json
{
  "@t": "2024-12-12T10:30:00.123Z",
  "@mt": "User {UserId} placed order {OrderId} for {Total}",
  "@l": "Information",
  "UserId": 12345,
  "OrderId": "ORD-98765",
  "Total": 149.99
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**

-   ‚úÖ –õ–µ–≥–∫–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –ª–æ–≥–∏: `UserId == 12345`
-   ‚úÖ –ê–≥—Ä–µ–≥–∞—Ü—ñ—è: "–°–∫—ñ–ª—å–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω—å –∑—Ä–æ–±–∏–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á X?"
-   ‚úÖ –ö–æ—Ä–µ–∫–ª—è—Ü—ñ—è: –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –ª–æ–≥–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ OrderId

### 3.2. Serilog Integration

**Serilog** ‚Äî –Ω–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ structured logging –¥–ª—è .NET.

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
dotnet add package Serilog.AspNetCore
dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.Sinks.File
dotnet add package Serilog.Sinks.Seq  # Optional: –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è
```

#### –ë–∞–∑–æ–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

```csharp showLineNumbers
using Serilog;

var builder = WebApplication.CreateBuilder(args);

// –ó–∞–º—ñ–Ω—é—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π logger –Ω–∞ Serilog
builder.Host.UseSerilog((context, services, configuration) => configuration
    .ReadFrom.Configuration(context.Configuration)
    .ReadFrom.Services(services)
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File(
        path: "logs/log-.txt",
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 30));

var app = builder.Build();

// –õ–æ–≥—É–≤–∞–Ω–Ω—è HTTP requests
app.UseSerilogRequestLogging();

app.Run();
```

#### appsettings.json –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

```json
{
  "Serilog": {
    "Using": ["Serilog.Sinks.Console", "Serilog.Sinks.File"],
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "Microsoft.Hosting.Lifetime": "Information",
        "Microsoft.EntityFrameworkCore": "Warning"
      }
    },
    "WriteTo": [
      { "Name": "Console" },
      {
        "Name": "File",
        "Args": {
          "path": "logs/log-.txt",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30,
          "outputTemplate": "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} [{Level:u3}] {Message:lj}{NewLine}{Exception}"
        }
      }
    ],
    "Enrich": ["FromLogContext", "WithMachineName", "WithThreadId"]
  }
}
```

#### Serilog Enrichers

**Enrichers** –¥–æ–¥–∞—é—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –¥–æ –∫–æ–∂–Ω–æ–≥–æ log event.

```csharp showLineNumbers
builder.Host.UseSerilog((context, services, configuration) => configuration
    .ReadFrom.Configuration(context.Configuration)
    .Enrich.WithProperty("Application", "MyECommerceApp")
    .Enrich.WithProperty("Environment", context.HostingEnvironment.EnvironmentName)
    .Enrich.FromLogContext()
    .Enrich.WithMachineName()
    .Enrich.WithThreadId()
    .Enrich.WithCorrelationId() // –ü–æ—Ç—Ä–µ–±—É—î –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –ø–∞–∫–µ—Ç
    .WriteTo.Console()
    .WriteTo.Seq("http://localhost:5341")); // –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
```

#### LogContext –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

```csharp showLineNumbers
public class OrderController : ControllerBase
{
    private readonly IOrderService _orderService;
    
    [HttpPost]
    public async Task<IActionResult> CreateOrder(CreateOrderRequest request)
    {
        // –î–æ–¥–∞—î–º–æ UserId –¥–æ –≤—Å—ñ—Ö –ª–æ–≥—ñ–≤ —É —Ü—å–æ–º—É scope
        using (LogContext.PushProperty("UserId", request.UserId))
        using (LogContext.PushProperty("CorrelationId", HttpContext.TraceIdentifier))
        {
            _logger.LogInformation("Processing order creation");
            
            var order = await _orderService.CreateOrderAsync(request);
            // –í—Å—ñ –ª–æ–≥–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ OrderService –º–∞—Ç–∏–º—É—Ç—å UserId —Ç–∞ CorrelationId!
            
            return Ok(order);
        }
    }
}
```

### 3.3. High-Performance Logging –∑ LoggerMessage

**LoggerMessage** ‚Äî —Ü–µ source generator –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è high-performance logging methods.

#### –ü—Ä–æ–±–ª–µ–º–∞ –∑ –∑–≤–∏—á–∞–π–Ω–∏–º –ª–æ–≥—É–≤–∞–Ω–Ω—è–º

```csharp showLineNumbers
// ‚ùå –ü–æ–≤—ñ–ª—å–Ω–æ: —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è FormattedLogValues, boxing –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
_logger.LogInformation("Processing order {OrderId} for user {UserId}", orderId, userId);
```

–ö–æ–∂–µ–Ω –≤–∏–∫–ª–∏–∫ `LogInformation`:

1.  –°—Ç–≤–æ—Ä—é—î –º–∞—Å–∏–≤ `object[]` –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
2.  Boxing –¥–ª—è value types (int, Guid)
3.  –°—Ç–≤–æ—Ä—é—î `FormattedLogValues` –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
4.  Allocations —É heap

#### –†—ñ—à–µ–Ω–Ω—è: LoggerMessage Source Generator (.NET 6+)

```csharp showLineNumbers
public partial class OrderService
{
    private readonly ILogger<OrderService> _logger;
    
    public OrderService(ILogger<OrderService> logger)
    {
        _logger = logger;
    }
    
    // ‚úÖ Compile-time generated, zero allocations
    [LoggerMessage(
        EventId = 1000,
        Level = LogLevel.Information,
        Message = "Processing order {OrderId} for user {UserId}")]
    private partial void LogProcessingOrder(Guid orderId, int userId);
    
    [LoggerMessage(
        EventId = 1001,
        Level = LogLevel.Error,
        Message = "Failed to process order {OrderId}")]
    private partial void LogOrderFailed(Guid orderId, Exception exception);
    
    [LoggerMessage(
        EventId = 1002,
        Level = LogLevel.Warning,
        Message = "Retry attempt {Attempt} for order {OrderId}")]
    private partial void LogRetryAttempt(int attempt, Guid orderId);
    
    public async Task ProcessOrderAsync(Guid orderId, int userId)
    {
        LogProcessingOrder(orderId, userId);
        
        try
        {
            // Business logic
        }
        catch (Exception ex)
        {
            LogOrderFailed(orderId, ex);
            throw;
        }
    }
}
```

**–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–æ–¥ (–ø—Ä–∏–±–ª–∏–∑–Ω–æ):**

```csharp
private void LogProcessingOrder(Guid orderId, int userId)
{
    if (_logger.IsEnabled(LogLevel.Information))
    {
        _logger.Log(
            LogLevel.Information,
            new EventId(1000),
            new LogValues(orderId, userId),
            null,
            (state, ex) => $"Processing order {state.OrderId} for user {state.UserId}");
    }
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**

-   ‚úÖ **~5-10x —à–≤–∏–¥—à–µ** –∑–∞ –∑–≤–∏—á–∞–π–Ω—ñ `LogInformation`
-   ‚úÖ **Zero allocations** –¥–ª—è value types
-   ‚úÖ **Compile-time –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞** –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
-   ‚úÖ **EventId** –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –ª–æ–≥—ñ–≤

::tip
**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ LoggerMessage:**

-   High-traffic endpoints (>1000 RPS)
-   –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤ hot paths (loops)
-   –ú—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏ –∑ –≤–µ–ª–∏–∫–∏–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º
    ::

---

## –ß–∞—Å—Ç–∏–Ω–∞ 4: Resilience –∑ Polly

### 4.1. –ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ Resilience?

–£ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö _–≤—Å–µ –º–æ–∂–µ —ñ –±—É–¥–µ –ø–∞–¥–∞—Ç–∏_:

-   API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
-   –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞
-   –ú–µ—Ä–µ–∂–∞ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–∞
-   Third-party —Å–µ—Ä–≤—ñ—Å–∏ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å 503

**Resilience Patterns** –¥–æ–ø–æ–º–∞–≥–∞—é—Ç—å —Å–∏—Å—Ç–µ–º—ñ –≤–∏—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª—é–≤–∞—Ç–∏—Å—è –ø—ñ—Å–ª—è –∑–±–æ—ó–≤.

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Polly

```bash
dotnet add package Polly
dotnet add package Microsoft.Extensions.Http.Polly
```

### 4.2. Retry Pattern

**Retry** ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é –ø—Ä–∏ —Ç–∏–º—á–∞—Å–æ–≤–æ–º—É –∑–±–æ—ó.

#### –ë–∞–∑–æ–≤–∏–π Retry

```csharp showLineNumbers
using Polly;
using Polly.Retry;

// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Retry pipeline
var retryPipeline = new ResiliencePipelineBuilder()
    .AddRetry(new RetryStrategyOptions
    {
        ShouldHandle = new PredicateBuilder()
            .Handle<HttpRequestException>()
            .Handle<TimeoutException>(),
        MaxRetryAttempts = 3,
        Delay = TimeSpan.FromSeconds(1),
        BackoffType = DelayBackoffType.Exponential, // 1s, 2s, 4s
        OnRetry = args =>
        {
            Console.WriteLine($"Retry {args.AttemptNumber} after {args.RetryDelay}");
            return ValueTask.CompletedTask;
        }
    })
    .Build();

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
var result = await retryPipeline.ExecuteAsync(async ct =>
{
    return await httpClient.GetStringAsync("https://api.example.com/data", ct);
}, cancellationToken);
```

#### Retry –∑ HttpClientFactory

```csharp showLineNumbers
builder.Services.AddHttpClient("external-api", client =>
{
    client.BaseAddress = new Uri("https://api.example.com");
    client.Timeout = TimeSpan.FromSeconds(10);
})
.AddResilienceHandler("retry-policy", builder =>
{
    builder.AddRetry(new RetryStrategyOptions
    {
        MaxRetryAttempts = 3,
        Delay = TimeSpan.FromSeconds(1),
        BackoffType = DelayBackoffType.Exponential,
        ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
            .Handle<HttpRequestException>()
            .HandleResult(response =>
                response.StatusCode == System.Net.HttpStatusCode.TooManyRequests ||
                (int)response.StatusCode >= 500)
    });
});

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
public class ExternalApiService
{
    private readonly HttpClient _httpClient;
    
    public ExternalApiService(IHttpClientFactory httpClientFactory)
    {
        _httpClient = httpClientFactory.CreateClient("external-api");
    }
    
    public async Task<string> GetDataAsync()
    {
        // Retry –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è!
        return await _httpClient.GetStringAsync("/data");
    }
}
```

### 4.3. Circuit Breaker Pattern

**Circuit Breaker** ‚Äî —Ç–∏–º—á–∞—Å–æ–≤–æ –±–ª–æ–∫—É—î –≤–∏–∫–ª–∏–∫–∏ –¥–æ —Å–µ—Ä–≤—ñ—Å—É, —â–æ –ø–∞–¥–∞—î, —â–æ–± –Ω–µ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –π–æ–≥–æ.

::mermaid

```mermaid
stateDiagram-v2
    [*] --> Closed: –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω
    Closed --> Open: Failure threshold –¥–æ—Å—è–≥–Ω—É—Ç–æ
    Open --> HalfOpen: Break duration –º–∏–Ω—É–ª–∞
    HalfOpen --> Closed: Success threshold –¥–æ—Å—è–≥–Ω—É—Ç–æ
    HalfOpen --> Open: Failure detected
    
    note right of Closed: Requests –ø—Ä–æ—Ö–æ–¥—è—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ
    note right of Open: Requests –±–ª–æ–∫—É—é—Ç—å—Å—è (fail fast)
    note right of HalfOpen: –¢–µ—Å—Ç–æ–≤—ñ requests –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
```

::

#### Circuit Breaker –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

```csharp showLineNumbers
builder.Services.AddHttpClient("payment-gateway")
    .AddResilienceHandler("circuit-breaker", builder =>
    {
        builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions
        {
            FailureRatio = 0.5,          // 50% –ø–æ–º–∏–ª–æ–∫
            SamplingDuration = TimeSpan.FromSeconds(10), // –ó–∞ 10 —Å–µ–∫—É–Ω–¥
            MinimumThroughput = 5,       // –ú—ñ–Ω—ñ–º—É–º 5 –∑–∞–ø–∏—Ç—ñ–≤
            BreakDuration = TimeSpan.FromSeconds(30),    // –í—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–∞ 30 —Å–µ–∫
            
            ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
                .Handle<HttpRequestException>()
                .HandleResult(r => (int)r.StatusCode >= 500),
            
            OnOpened = args =>
            {
                Console.WriteLine($"Circuit breaker opened at {DateTime.Now}");
                return ValueTask.CompletedTask;
            },
            OnClosed = args =>
            {
                Console.WriteLine($"Circuit breaker closed at {DateTime.Now}");
                return ValueTask.CompletedTask;
            },
            OnHalfOpened = args =>
            {
                Console.WriteLine("Circuit breaker half-opened, testing...");
                return ValueTask.CompletedTask;
            }
        });
    });
```

**–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:**

1.  **Closed**: –í—Å—ñ –∑–∞–ø–∏—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å. –†–∞—Ö—É—é—Ç—å—Å—è failures.
2.  **Open**: –Ø–∫—â–æ failure ratio > 50% –∑–∞ 10 —Å–µ–∫ ‚Üí Circuit –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è. –í—Å—ñ –∑–∞–ø–∏—Ç–∏ –æ–¥—Ä–∞–∑—É fail—è—Ç—å—Å—è –∑ `BrokenCircuitException`.
3.  **HalfOpen**: –ü—ñ—Å–ª—è 30 —Å–µ–∫ Circuit –ø—Ä–æ–ø—É—Å–∫–∞—î —Ç–µ—Å—Ç–æ–≤–∏–π –∑–∞–ø–∏—Ç. –Ø–∫—â–æ —É—Å–ø—ñ—à–Ω–∏–π ‚Üí Closed, —è–∫—â–æ –Ω—ñ ‚Üí Open –∑–Ω–æ–≤—É.

### 4.4. Timeout Pattern

**Timeout** ‚Äî –æ–±–º–µ–∂—É—î —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ—ó.

```csharp showLineNumbers
builder.Services.AddHttpClient("slow-service")
    .AddResilienceHandler("timeout", builder =>
    {
        builder.AddTimeout(new TimeoutStrategyOptions
        {
            Timeout = TimeSpan.FromSeconds(5),
            OnTimeout = args =>
            {
                Console.WriteLine($"Timeout after {args.Timeout} for attempt {args.AttemptNumber}");
                return ValueTask.CompletedTask;
            }
        });
    });
```

### 4.5. –ö–æ–º–±—ñ–Ω—É–≤–∞–Ω–Ω—è Policies

**Best Practice**: –ö–æ–º–±—ñ–Ω—É–π—Ç–µ Retry, Circuit Breaker —Ç–∞ Timeout.

```csharp showLineNumbers
builder.Services.AddHttpClient("resilient-client")
    .AddResilienceHandler("resilience-pipeline", builder =>
    {
        // 1. Outer timeout - –∑–∞–≥–∞–ª—å–Ω–∏–π –ª—ñ–º—ñ—Ç –¥–ª—è –≤—Å—ñ—Ö —Å–ø—Ä–æ–±
        builder.AddTimeout(TimeSpan.FromSeconds(30));
        
        // 2. Retry –∑ exponential backoff
        builder.AddRetry(new RetryStrategyOptions
        {
            MaxRetryAttempts = 3,
            Delay = TimeSpan.FromSeconds(1),
            BackoffType = DelayBackoffType.Exponential,
            ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
                .Handle<HttpRequestException>()
                .Handle<TimeoutRejectedException>() // Retry –ø—Ä–∏ timeout
                .HandleResult(r => (int)r.StatusCode >= 500)
        });
        
        // 3. Circuit Breaker –¥–ª—è fail-fast
        builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions
        {
            FailureRatio = 0.5,
            SamplingDuration = TimeSpan.FromSeconds(10),
            MinimumThroughput = 3,
            BreakDuration = TimeSpan.FromSeconds(30)
        });
        
        // 4. Inner timeout - per attempt
        builder.AddTimeout(TimeSpan.FromSeconds(5));
    });
```

**–ü–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:**

```
Request ‚Üí Outer Timeout (30s) ‚Üí Retry ‚Üí Circuit Breaker ‚Üí Inner Timeout (5s) ‚Üí HTTP Call
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 5: Background Services

### 5.1. IHostedService —Ç–∞ BackgroundService

**IHostedService** ‚Äî —Ü–µ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è long-running –∑–∞–¥–∞—á, —â–æ –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è —Ä–∞–∑–æ–º –∑ –¥–æ–¥–∞—Ç–∫–æ–º.

#### IHostedService Interface

```csharp
public interface IHostedService
{
    Task StartAsync(CancellationToken cancellationToken);
    Task StopAsync(CancellationToken cancellationToken);
}
```

#### BackgroundService Base Class

```csharp showLineNumbers
public abstract class BackgroundService : IHostedService
{
    protected abstract Task ExecuteAsync(CancellationToken stoppingToken);
    
    public virtual Task StartAsync(CancellationToken cancellationToken)
    {
        // –ó–∞–ø—É—Å–∫–∞—î ExecuteAsync —É —Ñ–æ–Ω–æ–≤–æ–º—É Task
    }
    
    public virtual Task StopAsync(CancellationToken cancellationToken)
    {
        // –ß–µ–∫–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è ExecuteAsync –∑ graceful shutdown
    }
}
```

### 5.2. –ü—Ä–æ—Å—Ç–∏–π Background Service

```csharp showLineNumbers
public class EmailQueueProcessor : BackgroundService
{
    private readonly ILogger<EmailQueueProcessor> _logger;
    private readonly IServiceScopeFactory _scopeFactory;
    
    public EmailQueueProcessor(
        ILogger<EmailQueueProcessor> logger,
        IServiceScopeFactory scopeFactory)
    {
        _logger = logger;
        _scopeFactory = scopeFactory;
    }
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("Email Queue Processor started");
        
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                // –°—Ç–≤–æ—Ä—é—î–º–æ scope –¥–ª—è Scoped dependencies
                using var scope = _scopeFactory.CreateScope();
                var emailService = scope.ServiceProvider.GetRequiredService<IEmailService>();
                
                await emailService.ProcessQueueAsync(stoppingToken);
                
                // –ß–µ–∫–∞—î–º–æ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —ñ—Ç–µ—Ä–∞—Ü—ñ—î—é
                await Task.Delay(TimeSpan.FromSeconds(30), stoppingToken);
            }
            catch (OperationCanceledException)
            {
                // Graceful shutdown
                _logger.LogInformation("Email Queue Processor stopping");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error processing email queue");
                // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ —Ä–æ–±–æ—Ç—É –Ω–∞–≤—ñ—Ç—å –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
                await Task.Delay(TimeSpan.FromMinutes(1), stoppingToken);
            }
        }
        
        _logger.LogInformation("Email Queue Processor stopped");
    }
}

// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
builder.Services.AddHostedService<EmailQueueProcessor>();
```

### 5.3. Background Service –∑ PeriodicTimer

```csharp showLineNumbers
public class DataSyncService : BackgroundService
{
    private readonly ILogger<DataSyncService> _logger;
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly TimeSpan _period = TimeSpan.FromMinutes(5);
    
    public DataSyncService(
        ILogger<DataSyncService> logger,
        IServiceScopeFactory scopeFactory)
    {
        _logger = logger;
        _scopeFactory = scopeFactory;
    }
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        using var timer = new PeriodicTimer(_period);
        
        while (!stoppingToken.IsCancellationRequested &&
               await timer.WaitForNextTickAsync(stoppingToken))
        {
            try
            {
                _logger.LogInformation("Starting data sync at {Time}", DateTime.UtcNow);
                
                using var scope = _scopeFactory.CreateScope();
                var syncService = scope.ServiceProvider.GetRequiredService<ISyncService>();
                
                await syncService.SyncDataAsync(stoppingToken);
                
                _logger.LogInformation("Data sync completed successfully");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Data sync failed");
            }
        }
    }
}
```

### 5.4. Graceful Shutdown

```csharp showLineNumbers
public class OrderProcessorService : BackgroundService
{
    private readonly ILogger<OrderProcessorService> _logger;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("Order Processor started");
        
        // –†–µ—î—Å—Ç—Ä—É—î–º–æ callback –¥–ª—è graceful shutdown
        stoppingToken.Register(() =>
            _logger.LogInformation("Graceful shutdown initiated"));
        
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                await ProcessNextOrderAsync(stoppingToken);
            }
            catch (OperationCanceledException)
            {
                // –ù–æ—Ä–º–∞–ª—å–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
                break;
            }
        }
        
        _logger.LogInformation("Order Processor stopped gracefully");
    }
    
    public override async Task StopAsync(CancellationToken cancellationToken)
    {
        _logger.LogInformation("Stop requested, finishing current work...");
        
        // –ë–∞–∑–æ–≤–∏–π StopAsync —á–µ–∫–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è ExecuteAsync
        await base.StopAsync(cancellationToken);
        
        _logger.LogInformation("All work completed, service stopped");
    }
}
```

**–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Shutdown Timeout:**

```csharp
builder.Host.ConfigureServices(services =>
{
    services.Configure<HostOptions>(options =>
    {
        options.ShutdownTimeout = TimeSpan.FromSeconds(30); // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —á–∞—Å –Ω–∞ graceful shutdown
    });
});
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 6: –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó

### 6.1. E-Commerce Order Processing Service

–ö–æ–º–ø–ª–µ–∫—Å–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥ Worker Service –∑ DI, Configuration, Logging, Resilience —Ç–∞ Background processing.

```csharp showLineNumbers
// Program.cs
using Serilog;

var builder = Host.CreateApplicationBuilder(args);

// Serilog
builder.Host.UseSerilog((context, services, configuration) => configuration
    .ReadFrom.Configuration(context.Configuration)
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File("logs/order-processor-.txt", rollingInterval: RollingInterval.Day));

// Configuration Options
builder.Services.Configure<OrderProcessorSettings>(
    builder.Configuration.GetSection("OrderProcessor"));
builder.Services.Configure<PaymentGatewaySettings>(
    builder.Configuration.GetSection("PaymentGateway"));

// DI Services
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

builder.Services.AddScoped<IOrderRepository, OrderRepository>();
builder.Services.AddScoped<IInventoryService, InventoryService>();
builder.Services.AddScoped<IPaymentService, PaymentService>();
builder.Services.AddScoped<INotificationService, NotificationService>();

// HTTP Clients –∑ Resilience
builder.Services.AddHttpClient<IPaymentService, PaymentService>()
    .AddResilienceHandler("payment-resilience", resilienceBuilder =>
    {
        resilienceBuilder
            .AddTimeout(TimeSpan.FromSeconds(30))
            .AddRetry(new RetryStrategyOptions
            {
                MaxRetryAttempts = 3,
                Delay = TimeSpan.FromSeconds(1),
                BackoffType = DelayBackoffType.Exponential
            })
            .AddCircuitBreaker(new CircuitBreakerStrategyOptions
            {
                FailureRatio = 0.5,
                SamplingDuration = TimeSpan.FromSeconds(10),
                MinimumThroughput = 3,
                BreakDuration = TimeSpan.FromSeconds(30)
            });
    });

// Background Service
builder.Services.AddHostedService<OrderProcessorWorker>();

var host = builder.Build();
await host.RunAsync();

// OrderProcessorWorker.cs
public class OrderProcessorWorker : BackgroundService
{
    private readonly ILogger<OrderProcessorWorker> _logger;
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly IOptions<OrderProcessorSettings> _settings;
    
    public OrderProcessorWorker(
        ILogger<OrderProcessorWorker> logger,
        IServiceScopeFactory scopeFactory,
        IOptions<OrderProcessorSettings> settings)
    {
        _logger = logger;
        _scopeFactory = scopeFactory;
        _settings = settings;
    }
    
    [LoggerMessage(
        EventId = 1000,
        Level = LogLevel.Information,
        Message = "Processing order batch of {Count} orders")]
    private partial void LogProcessingBatch(int count);
    
    [LoggerMessage(
        EventId = 1001,
        Level = LogLevel.Information,
        Message = "Order {OrderId} processed successfully in {ElapsedMs}ms")]
    private partial void LogOrderProcessed(Guid orderId, long elapsedMs);
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("Order Processor started");
        
        using var timer = new PeriodicTimer(TimeSpan.FromSeconds(_settings.Value.PoolingIntervalSeconds));
        
        while (!stoppingToken.IsCancellationRequested &&
               await timer.WaitForNextTickAsync(stoppingToken))
        {
            try
            {
                await ProcessPendingOrdersAsync(stoppingToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Failed to process orders batch");
            }
        }
        
        _logger.LogInformation("Order Processor stopped");
    }
    
    private async Task ProcessPendingOrdersAsync(CancellationToken cancellationToken)
    {
        using var scope = _scopeFactory.CreateScope();
        var orderRepository = scope.ServiceProvider.GetRequiredService<IOrderRepository>();
        var inventoryService = scope.ServiceProvider.GetRequiredService<IInventoryService>();
        var paymentService = scope.ServiceProvider.GetRequiredService<IPaymentService>();
        var notificationService = scope.ServiceProvider.GetRequiredService<INotificationService>();
        
        var pendingOrders = await orderRepository.GetPendingOrdersAsync(
            _settings.Value.BatchSize,
            cancellationToken);
        
        if (pendingOrders.Count == 0)
            return;
        
        LogProcessingBatch(pendingOrders.Count);
        
        foreach (var order in pendingOrders)
        {
            var stopwatch = Stopwatch.StartNew();
            
            using (LogContext.PushProperty("OrderId", order.Id))
            using (LogContext.PushProperty("UserId", order.UserId))
            {
                try
                {
                    // 1. Reserve Inventory
                    await inventoryService.ReserveAsync(order, cancellationToken);
                    
                    // 2. Process Payment (with resilience)
                    await paymentService.ChargeAsync(order, cancellationToken);
                    
                    // 3. Update Order Status
                    order.Status = OrderStatus.Completed;
                    await orderRepository.UpdateAsync(order, cancellationToken);
                    
                    // 4. Send Notification
                    await notificationService.SendOrderConfirmationAsync(order, cancellationToken);
                    
                    stopwatch.Stop();
                    LogOrderProcessed(order.Id, stopwatch.ElapsedMilliseconds);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Failed to process order {OrderId}", order.Id);
                    
                    order.Status = OrderStatus.Failed;
                    order.FailureReason = ex.Message;
                    await orderRepository.UpdateAsync(order, cancellationToken);
                }
            }
        }
    }
}
```

---

## –†–µ–∑—é–º–µ

::card-group

:::card{title="Dependency Injection"}

**–ö–ª—é—á–æ–≤—ñ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó:**

-   IServiceCollection –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
-   –¢—Ä–∏ lifetimes: Transient, Scoped, Singleton
-   Constructor Injection preferred
-   –£–Ω–∏–∫–∞–π—Ç–µ Captive Dependency, Service Locator, Circular Dependencies

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:**

-   Transient: Stateless, lightweight —Å–µ—Ä–≤—ñ—Å–∏
-   Scoped: DbContext, per-request state
-   Singleton: Caches, Loggers, Expensive objects
    :::

:::card{title="Configuration"}

**Providers:**

-   appsettings.json (base + environment-specific)
-   Environment Variables
-   User Secrets (dev only)
-   Command Line Arguments

**Options Pattern:**

-   `IOptions<T>`: Static configuration
-   `IOptionsSnapshot<T>`: Per-request reload
-   `IOptionsMonitor<T>`: Hot reload with OnChange
    :::

:::card{title="Logging"}

**ILogger:** Standard abstraction

**Serilog:** Structured logging

-   Enrichers –¥–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
-   LogContext –¥–ª—è scoped properties
-   Multiple sinks (Console, File, Seq)

**LoggerMessage:** High-performance, zero-allocation logging –¥–ª—è hot paths
:::

:::card{title="Resilience (Polly)"}

**Patterns:**

-   **Retry**: Exponential backoff –ø—Ä–∏ transient failures
-   **Circuit Breaker**: Fail-fast –ø—Ä–∏ –±–∞–≥–∞—Ç—å–æ—Ö –ø–æ–º–∏–ª–∫–∞—Ö
-   **Timeout**: –û–±–º–µ–∂–µ–Ω–Ω—è —á–∞—Å—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

**Best Practice:** –ö–æ–º–±—ñ–Ω—É–π—Ç–µ patterns:
`Outer Timeout ‚Üí Retry ‚Üí Circuit Breaker ‚Üí Inner Timeout`
:::

:::card{title="Background Services"}

**IHostedService:** Lifecycle management

**BackgroundService:** Base class –¥–ª—è long-running tasks

**Best Practices:**

-   IServiceScopeFactory –¥–ª—è Scoped dependencies
-   PeriodicTimer –¥–ª—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–∏—Ö –∑–∞–¥–∞—á
-   Graceful Shutdown –∑ CancellationToken
-   HostOptions.ShutdownTimeout

:::

::

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

::steps

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: DI Container Setup

–°—Ç–≤–æ—Ä—ñ—Ç—å –∫–æ–Ω—Å–æ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –∑:

-   Generic Host
-   3 —Å–µ—Ä–≤—ñ—Å–∏ (Transient, Scoped, Singleton)
-   –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è —Ä—ñ–∑–Ω–∏—Ü—ñ –º—ñ–∂ lifetimes
-   –í–∞–ª—ñ–¥–∞—Ü—ñ—è Captive Dependency

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: Configuration –∑ Options Pattern

–†–µ–∞–ª—ñ–∑—É–π—Ç–µ:

-   `appsettings.json` –∑ hierarchical config
-   Environment-specific overrides
-   Options Pattern –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é
-   User Secrets –¥–ª—è API keys

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: Structured Logging

–ù–∞–ª–∞—à—Ç—É–π—Ç–µ Serilog –∑:

-   Console —Ç–∞ File sinks
-   Enrichers (Machine, Thread, Custom)
-   LogContext –¥–ª—è correlation ID
-   LoggerMessage –¥–ª—è high-performance –ª–æ–≥—É–≤–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 4: Resilient HTTP Client

–°—Ç–≤–æ—Ä—ñ—Ç—å HTTP client –∑:

-   Retry (3 —Å–ø—Ä–æ–±–∏, exponential backoff)
-   Circuit Breaker (50% failure ratio, 30s break)
-   Timeout (5s per attempt, 30s total)
-   –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö resilience events

### –ó–∞–≤–¥–∞–Ω–Ω—è 5: Background Worker Service

–†–µ–∞–ª—ñ–∑—É–π—Ç–µ Worker Service, —â–æ:

-   –û–±—Ä–æ–±–ª—è—î —á–µ—Ä–≥–∞ –∑–∞–¥–∞—á –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Scoped DbContext
-   –õ–æ–≥—É—î –≤—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ Serilog
-   Graceful shutdown –∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è–º –ø–æ—Ç–æ—á–Ω–æ—ó —Ä–æ–±–æ—Ç–∏

::

---

## –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏

-   [Microsoft.Extensions.DependencyInjection Documentation](https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection)
-   [Options Pattern in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options)
-   [Serilog Documentation](https://github.com/serilog/serilog/wiki)
-   [Polly Documentation](https://www.pollydocs.org/)
-   [.NET Background Services](https://learn.microsoft.com/en-us/dotnet/core/extensions/hosted-services)
-   [High-Performance Logging in .NET](https://learn.microsoft.com/en-us/dotnet/core/extensions/high-performance-logging)

::tip
**–ù–∞—Å—Ç—É–ø–Ω–∞ —Ç–µ–º–∞**: [Clean Architecture](/csharp/architecture-best-practices/clean-architecture)

–£ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –º–∏ —Ä–æ–∑–≥–ª—è–Ω–µ–º–æ, —è–∫ –ø–æ–±—É–¥—É–≤–∞—Ç–∏ maintainable –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É —á–µ—Ä–µ–∑ Clean Architecture principles, Domain-Driven Design —Ç–∞ CQRS pattern.
::
