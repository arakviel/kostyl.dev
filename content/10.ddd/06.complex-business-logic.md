---
title: '–û–±—Ä–æ–±–∫–∞ —Å–∫–ª–∞–¥–Ω–æ—ó –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏'
description: '–ü–∞—Ç—Ç–µ—Ä–Ω Domain Model —ñ–∑ –±—É–¥—ñ–≤–µ–ª—å–Ω–∏–º–∏ –±–ª–æ–∫–∞–º–∏: Value Objects, Entities, Aggregates, Domain Events —Ç–∞ Domain Services –≤ DDD'
---

# –û–±—Ä–æ–±–∫–∞ —Å–∫–ª–∞–¥–Ω–æ—ó –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ (Tackling Complex Business Logic)

::note{icon="fluent:brain-circuit-24-filled"}
**–ö–ª—é—á–æ–≤–∞ —ñ–¥–µ—è –≥–ª–∞–≤–∏**

–°–∫–ª–∞–¥–Ω–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –º–æ–¥–µ–ª—å–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç—ñ CRUD-–æ–ø–µ—Ä–∞—Ü—ñ—ó. –î–ª—è —Ü—å–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ **–º–æ–¥–µ–ª—å –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ (Domain Model)** ‚Äî –æ–±'—î–∫—Ç–Ω–∞ –º–æ–¥–µ–ª—å, —â–æ –ø–æ—î–¥–Ω—É—î –¥–∞–Ω—ñ **—ñ** –ø–æ–≤–µ–¥—ñ–Ω–∫—É.
::

## –ü–µ—Ä–µ–¥—ñ—Å—Ç–æ—Ä—ñ—è (Background)

–ü–∞—Ç—Ç–µ—Ä–Ω **Domain Model**, —è–∫ —ñ –ø–∞—Ç—Ç–µ—Ä–Ω–∏ Transaction Script —Ç–∞ Active Record, –±—É–≤ –≤–ø–µ—Ä—à–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π **Martin Fowler** —É –∫–Ω–∏–∑—ñ ¬´Patterns of Enterprise Application Architecture¬ª.

::tip{icon="ph:link"}
**–ó–≤'—è–∑–æ–∫ –∑ DDD**

–ó–∞–≤–µ—Ä—à—É—é—á–∏ –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è Domain Model, Fowler writes:

> ¬´–ó–∞—Ä–∞–∑ **Eric Evans** –ø–∏—à–µ –∫–Ω–∏–≥—É –ø—Ä–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ.¬ª

–ö–Ω–∏–≥–∞ **¬´Domain-Driven Design: Tackling Complexity in the Heart of Software¬ª** —Å—Ç–∞–ª–∞ –æ—Å–Ω–æ–≤–Ω–æ—é –ø—Ä–∞—Ü–µ—é Evans —ñ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ –Ω–∞–±—ñ—Ä –ø–∞—Ç—Ç–µ—Ä–Ω—ñ–≤ –¥–ª—è —Ç—ñ—Å–Ω–æ–≥–æ–≤ –∑–≤'—è–∑–∫—É –∫–æ–¥—É –∑ –±–∞–∑–æ–≤–æ—ó –º–æ–¥–µ–ª–ª—é –ø—Ä–µ–¥–º–µ—Ç–Ω–∏–π –æ–±–ª–∞—Å—Ç—ñ –±—ñ–∑–Ω–µ—Å—É.
::

### –¢–∞–∫—Ç–∏—á–Ω—ñ –ø–∞—Ç—Ç–µ—Ä–Ω–∏ DDD

Evans –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–≤ –ø–∞—Ç—Ç–µ—Ä–Ω–∏, —è–∫—ñ —î –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º —Ç–æ–≥–æ, –Ω–∞ —á–æ–º—É –∑—É–ø–∏–Ω–∏–≤—Å—è Fowler:

::card-group
::card{icon="mdi:cube"}
#title
Aggregates (–ê–≥—Ä–µ–≥–∞—Ç–∏)
#description
–ú–µ–∂—ñ —É–∑–≥–æ–¥–∂–µ–Ω–æ—Å—Ç—ñ –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –æ–±'—î–∫—Ç—ñ–≤
::

::card{icon="mdi:tag"}
#title
Value Objects (–û–±'—î–∫—Ç–∏-–∑–Ω–∞—á–µ–Ω–Ω—è)
#description
Immutable –æ–±'—î–∫—Ç–∏, —â–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—é—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏
::

::card{icon="mdi:database"}
#title
Repositories
#description
–ê–±—Å—Ç—Ä–∞–∫—Ü—ñ—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Å—Ö–æ–≤–∏—â–∞
::
::

::warning{icon="ph:info"}
**–¢–µ—Ä–º—ñ–Ω–æ–ª–æ–≥—ñ—è**

–ü–∞—Ç—Ç–µ—Ä–Ω–∏ Evans —á–∞—Å—Ç–æ –Ω–∞–∑–∏–≤–∞—é—Ç—å **¬´—Ç–∞–∫—Ç–∏—á–Ω–∏–º–∏ –∑–∞—Å–æ–±–∞–º–∏ DDD¬ª**. –ê–ª–µ —â–æ–± –Ω–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ö–∏–±–Ω–µ —É—è–≤–ª–µ–Ω–Ω—è, —â–æ DDD –Ω–µ–º–∏–Ω—É—á–µ –ø–æ—Ç—Ä–µ–±—É—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω—ñ–≤, —è –¥–æ—Ç—Ä–∏–º—É—é—Å—å **–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ—ó —Ç–µ—Ä–º—ñ–Ω–æ–ª–æ–≥—ñ—ó Fowler**:

- –ü–∞—Ç—Ç–µ—Ä–Ω: **Domain Model**
- –ë—É–¥—ñ–≤–µ–ª—å–Ω—ñ –±–ª–æ–∫–∏: **Aggregates**, **Value Objects**, **Domain Events**, **Domain Services**

::

---

## –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ (Domain Model)

::mermaid

```mermaid
graph TB
    subgraph "Active Record ~ 30 lines"
        AR[Simple CRUD Logic]
    end

    subgraph "Domain Model ~ 300-3000 lines"
        DM1[Complex State Transitions]
        DM2[Business Rules]
        DM3[Invariants]
        DM4[Entity Hierarchies]
    end

    AR -->|Evolution| DM1

    style AR fill:#ffcdd2
    style DM1 fill:#c8e6c9
    style DM2 fill:#c8e6c9
    style DM3 fill:#c8e6c9
    style DM4 fill:#c8e6c9
```

::

–ü–∞—Ç—Ç–µ—Ä–Ω Domain Model –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è **—Å–∫–ª–∞–¥–Ω–æ—ó –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏**. –ó–∞–º—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ –∑ –ø—Ä–æ—Å—Ç–∏–º–∏ CRUD-–æ–ø–µ—Ä–∞—Ü—ñ—è–º–∏, —Ç—É—Ç –≤–∏—Ä—ñ—à—É—é—Ç—å—Å—è –ø–∏—Ç–∞–Ω–Ω—è:

- üîÑ **–°–∫–ª–∞–¥–Ω–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥—ñ–≤ –º—ñ–∂ —Å—Ç–∞–Ω–∞–º–∏**
- üìè **–ë—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª —ñ —ñ–Ω–≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤**
- üß© **–í–∑–∞—î–º–æ–∑–≤'—è–∑–∫—ñ–≤ –º—ñ–∂ —Å—É—Ç–Ω–æ—Å—Ç—è–º–∏**

### –ü—Ä–∞–∫—Ç–∏—á–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥: Help Desk System

–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ –º–∏ –≤–ø—Ä–æ–≤–∞–¥–∂—É—î–º–æ **—Å–∏—Å—Ç–µ–º—É —Ç–µ—Ö–Ω—ñ—á–Ω–æ—ó –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤** (help desk). –†–æ–∑–≥–ª—è–Ω–µ–º–æ –≤–∏–º–æ–≥–∏ –¥–æ –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É –∑–∞—è–≤–æ–∫:

::steps

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞—è–≤–∫–∏

–ö–ª—ñ—î–Ω—Ç–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—é—Ç—å –∑–∞—è–≤–∫–∏ –∑ –æ–ø–∏—Å–æ–º –ø—Ä–æ–±–ª–µ–º, –∑ —è–∫–∏–º–∏ —Å—Ç–∏–∫–∞—é—Ç—å—Å—è.

### –ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è

–ö–ª—ñ—î–Ω—Ç —ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –¥–æ–¥–∞—é—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ‚Äî –ø–µ—Ä–µ–ø–∏—Å–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –≤ –∑–∞—è–≤—Ü—ñ.

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç SLA

–£ –∫–æ–∂–Ω–æ—ó –∑–∞—è–≤–∫–∏ —î –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: **–Ω–∏–∑—å–∫–∞**, **—Å–µ—Ä–µ–¥–Ω—è**, **–≤–∏—Å–æ–∫–∞** –∞–±–æ **—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞**.

–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ **–º–∞—î –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è** –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π —Ç–µ—Ä–º—ñ–Ω (SLA) –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É.

### –ï—Å–∫–∞–ª–∞—Ü—ñ—è

–Ø–∫—â–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å —É SLA-—Ç–µ—Ä–º—ñ–Ω, –∫–ª—ñ—î–Ω—Ç –º–æ–∂–µ **–ø–µ—Ä–µ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É –∫–µ—Ä—ñ–≤–Ω–∏–∫—É**.

**–ù–∞—Å–ª—ñ–¥–∫–∏ –µ—Å–∫–∞–ª–∞—Ü—ñ—ó**:

- SLA —Å–∫–æ—Ä–æ—á—É—î—Ç—å—Å—è –Ω–∞ **33%**
- –Ø–∫—â–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ –Ω–µ –≤—ñ–¥–∫—Ä–∏–≤ –µ—Å–∫–∞–ª–æ–≤–∞–Ω–∞ –∑–∞—è–≤–∫—É –∑–∞ **–ø–æ–ª–æ–≤–∏–Ω—É —á–∞—Å—É** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ–ø—Ä–∏–∑ÃÅ–Ω–∞—á–µ–Ω–Ω—è —ñ–Ω—à–æ–º—É —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—É

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–∫—Ä–∏—Ç—Ç—è

–ó–∞—è–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–∫—Ä–∏–≤–∞—é—Ç—å—Å—è, —è–∫—â–æ –∫–ª—ñ—î–Ω—Ç –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î **‚â•7 –¥–Ω—ñ–≤**.

**–í–∏–Ω—è—Ç–æ–∫**: –ï—Å–∫–∞–ª—å–æ–≤–∞–Ω—ñ –∑–∞—è–≤–∫–∏ **–Ω–µ –º–æ–∂—É—Ç—å** –±—É—Ç–∏ –∑–∞–∫—Ä–∏—Ç—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∞–±–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–æ–º ‚Äî –ª–∏—à–µ –∫–ª—ñ—î–Ω—Ç–æ–º –∞–±–æ –∫–µ—Ä—ñ–≤–Ω–∏–∫–æ–º.

### –ü–æ–≤—Ç–æ—Ä–Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è

–ö–ª—ñ—î–Ω—Ç –º–æ–∂–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∑–∞–∫—Ä–∏—Ç—É –∑–∞—è–≤–∫—É **—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ** –≤–æ–Ω–∞ –±—É–ª–∞ –∑–∞–∫—Ä–∏—Ç–∞ **–Ω–µ –±—ñ–ª—å—à–µ 7 –¥–Ω—ñ–≤** —Ç–æ–º—É.
::

::warning{icon="ph:graph"}
**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å**

–¶—ñ –≤–∏–º–æ–≥–∏ —É—Ç–≤–æ—Ä—é—é—Ç—å **–∑–∞–ø–ª—É—Ç–∞–Ω—É –º–µ—Ä–µ–∂—É –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π** –º—ñ–∂ —Ä—ñ–∑–Ω–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –π –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –∂–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –∑–∞—è–≤–∫–∏.

–¶–µ –≤–∂–µ **–Ω–µ CRUD-–µ–∫—Ä–∞–Ω** –≤–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö! –°–ø—Ä–æ–±–∞ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ü—é –ª–æ–≥—ñ–∫—É —á–µ—Ä–µ–∑ Active Records –ø—Ä–∏–∑–≤–µ–¥–µ –¥–æ:

- üîÅ –ë–∞–≥–∞—Ç–æ—Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è –∫–æ–¥—É
- ‚ùå –ù–µ—É–∑–≥–æ–¥–∂–µ–Ω–æ–≥–æ —Å—Ç–∞–Ω—É —á–µ—Ä–µ–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é –ø—Ä–∞–≤–∏–ª

::

---

## –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

**Domain Model** ‚Äî —Ü–µ –æ–±'—î–∫—Ç–Ω–∞ –º–æ–¥–µ–ª—å, —â–æ –≤–∫–ª—é—á–∞—î **—ñ –ø–æ–≤–µ–¥—ñ–Ω–∫—É, —ñ –¥–∞–Ω—ñ**.

::mermaid

```mermaid
classDiagram
    class DomainModel {
        <<pattern>>
    }
    class ValueObject {
        Immutable
        Identified by values
    }
    class Entity {
        Has ID field
        Mutable
    }
    class Aggregate {
        Consistency boundary
        Transaction boundary
    }
    class DomainEvent {
        State change notification
    }
    class DomainService {
        Stateless business logic
    }

    DomainModel *-- ValueObject
    DomainModel *-- Aggregate
    DomainModel *-- DomainEvent
    DomainModel *-- DomainService
    Aggregate *-- Entity
    Entity *-- ValueObject
```

::

–ë—É–¥—ñ–≤–µ–ª—å–Ω–∏–º–∏ –±–ª–æ–∫–∞–º–∏ —î **—Ç–∞–∫—Ç–∏—á–Ω—ñ –ø–∞—Ç—Ç–µ—Ä–Ω–∏ DDD**:

1. **Value Objects** (–û–±'—î–∫—Ç–∏-–∑–Ω–∞—á–µ–Ω–Ω—è)
2. **Entities** (–°—É—Ç–Ω–æ—Å—Ç—ñ)
3. **Aggregates** (–ê–≥—Ä–µ–≥–∞—Ç–∏)
4. **Domain Events** (–ü–æ–¥—ñ—ó –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ)
5. **Domain Services** (–î–æ–º–µ–Ω–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏)

::tip{icon="ph:target"}
**–°–ø—ñ–ª—å–Ω–∞ —Ç–µ–º–∞**

–í—Å—ñ —Ü—ñ –ø–∞—Ç—Ç–µ—Ä–Ω–∏ —Å—Ç–∞–≤–ª—è—Ç—å **–±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É –Ω–∞ –ø–µ—Ä—à–µ –º—ñ—Å—Ü–µ**.
::

### –ö–ª—é—á–æ–≤—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏

::accordion
::accordion-item{title="–ü—Ä–∏–Ω—Ü–∏–ø 1: –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ—ó —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ"}
**–ü—Ä–æ–±–ª–µ–º–∞**: –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ **–≤–∂–µ —î —Å–∫–ª–∞–¥–Ω–æ—é**.

**–†—ñ—à–µ–Ω–Ω—è**: –û–±'—î–∫—Ç–∏ –º–æ–¥–µ–ª—ñ **–Ω–µ –ø–æ–≤–∏–Ω–Ω—ñ** –≤–Ω–æ—Å–∏—Ç–∏ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω—É —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:

- ‚ùå –ù–µ —Ä–µ–∞–ª—ñ–∑—É—é—Ç—å –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –ë–î
- ‚ùå –ù–µ –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –∑–æ–≤–Ω —ñ—à–Ω—ñ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤
- ‚úÖ –ü—Ä–æ—Å—Ç—ñ –æ–±'—î–∫—Ç–∏ (POCOs/POJOs/POPOs)
- ‚úÖ –†–µ–∞–ª—ñ–∑—É—é—Ç—å —Ç—ñ–ª—å–∫–∏ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É

::

::accordion-item{title="–ü—Ä–∏–Ω—Ü–∏–ø 2: –Ñ–¥–∏–Ω–∞ –º–æ–≤–∞ (Ubiquitous Language)"}
**–ê–∫—Ü–µ–Ω—Ç –Ω–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ—Ü—ñ** –¥–æ–∑–≤–æ–ª—è—î –æ–±'—î–∫—Ç–∞–º –º–æ–¥–µ–ª—ñ **—Å–ª—ñ–¥—É–≤–∞—Ç–∏ —î–¥–∏–Ω—ñ–π –º–æ–≤—ñ** bounded context.

–ö–æ–¥ **¬´–≥–æ–≤–æ—Ä–∏—Ç—å¬ª** –Ω–∞ —î–¥–∏–Ω—ñ–π –º–æ–≤—ñ —ñ —Å–ª—ñ–¥—É—î **–º–µ–Ω—Ç–∞–ª—å–Ω–∏–º –º–æ–¥–µ–ª—è–º –µ–∫—Å–ø–µ—Ä—Ç—ñ–≤** –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ.

**–ü—Ä–∏–∫–ª–∞–¥**:

```csharp
// ‚ùå –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–¥ (–Ω–µ —Å–ª—ñ–¥—É—î UL)
ticket.Status = 3;
ticket.Save();

// ‚úÖ –ö–æ–¥, —â–æ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –±—ñ–∑–Ω–µ—Å-–º–æ–≤—É
ticket.Escalate(reason);
```

::
::

---

## –ë—É–¥—ñ–≤–µ–ª—å–Ω—ñ –±–ª–æ–∫–∏

### –û–±'—î–∫—Ç-–∑–Ω–∞—á–µ–Ω–Ω—è (Value Object)

> –û–±'—î–∫—Ç, —è–∫–∏–π –º–æ–∂–Ω–∞ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –∑–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏, —â–æ –π–æ–≥–æ —Å–∫–ª–∞–¥–∞—é—Ç—å.

::mermaid

```mermaid
classDiagram
    class Color {
        +byte Red
        +byte Green
        +byte Blue
        +Color MixWith(Color other)
        +string ToString()
    }

    note for Color "–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏\n–ë–µ–∑ —è–≤–Ω–æ–≥–æ ID\n–ù–µ–∑–º—ñ–Ω–Ω–∏–π"
```

::

#### –ü—Ä–∏–∫–ª–∞–¥: Color

```csharp
class Color
{
    private readonly byte _red;
    private readonly byte _green;
    private readonly byte _blue;

    public Color(byte r, byte g, byte b)
    {
        _red = r;
        _green = g;
        _blue = b;
    }
}
```

::tip{icon="ph:equals"}
**–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏**

–ö–æ–ª—ñ—Ä –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è **–∫–æ–º–ø–æ–∑–∏—Ü—ñ—î—é** —Ç—Ä—å–æ—Ö –∑–Ω–∞—á–µ–Ω—å: —á–µ—Ä–≤–æ–Ω–æ–≥–æ, –∑–µ–ª–µ–Ω–æ–≥–æ —Ç–∞ —Å–∏–Ω—å–æ–≥–æ.

- –ó–º—ñ–Ω–∞ –±—É–¥—å-—è–∫–æ–≥–æ –ø–æ–ª—è ‚Üí **–Ω–æ–≤–∏–π –∫–æ–ª—ñ—Ä**
- –î–≤–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–∏ –æ–¥–Ω–æ–≥–æ –∫–æ–ª—å–æ—Ä—É ‚Üí **–æ–¥–Ω–∞–∫–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è**
- ‚ùå –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ —è–≤–Ω–µ –ø–æ–ª–µ `ColorId`

::

#### –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω: Primitive Obsession

–ü–æ–∫–ª–∞–¥–∞—Ç–∏—Å—è –≤–∏–∫–ª—é—á–Ω–æ –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ñ —Ç–∏–ø–∏ –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –ø–æ–Ω—è—Ç—å –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ ‚Äî **–æ–¥–µ—Ä–∂–∏–º—ñ—Å—Ç—å –ø—Ä–∏–º—ñ—Ç–∏–≤–∞–º–∏** (Primitive Obsession).

::collapsible{title="–ü—Ä–∏–∫–ª–∞–¥ –ø—Ä–æ–±–ª–µ–º–∏"}

```csharp
// ‚ùå Primitive Obsession
class Person
{
    private int _id;
    private string _firstName;
    private string _lastName;
    private string _landlinePhone; // –ú–∞—î –±—É—Ç–∏ –≤–∞–ª—ñ–¥–Ω–∏–º —Å—Ç–∞—Ü—ñ–æ–Ω–∞—Ä–Ω–∏–º
    private string _mobilePhone;   // –ú–∞—î –±—É—Ç–∏ –≤–∞–ª—ñ–¥–Ω–∏–º –º–æ–±—ñ–ª—å–Ω–∏–º
    private string _email;         // –ú–∞—î –±—É—Ç–∏ –≤–∞–ª—ñ–¥–Ω–∏–º email
    private int _heightMetric;     // –£ —Å–º? –º–µ—Ç—Ä–∞—Ö?
    private string _countryCode;   // 2 –ª—ñ—Ç–µ—Ä–∏ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É

    public Person(...) { ... }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
var dave = new Person(
    id: 30217,
    firstName: "Dave",
    lastName: "Ancelovici",
    landlinePhone: "023745001",   //  –ù–µ–º–∞—î –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó!
    mobilePhone: "0873712503",
    email: "dave@learning-ddd.com",
    heightMetric: 180,            // –ù–µ–∑—Ä–æ–∑—É–º—ñ–ª–∞ –æ–¥–∏–Ω–∏—Ü—è
    countryCode: "BG"
);
```

**–ü—Ä–æ–±–ª–µ–º–∏**:

1. üîÅ –õ–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥—É–±–ª—é—î—Ç—å—Å—è
2. ‚ùå –í–∞–∂–∫–æ –Ω–∞–≤—è–∑–∞—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é –ø–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º
3. üìù –ü–æ—Ç—Ä—ñ–±–Ω—ñ —É–≥–æ–¥–∏ (conventions) –∑–∞–º—ñ—Å—Ç—å —Ç–∏–ø–æ–±–µ–∑–ø–µ–∫–∏

::

#### –†—ñ—à–µ–Ω–Ω—è: Value Objects

```csharp
// ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Value Objects
class Person
{
    private readonly PersonId _id;
    private readonly Name _name;
    private readonly PhoneNumber _landline;
    private readonly PhoneNumber _mobile;
    private readonly EmailAddress _email;
    private readonly Height _height;
    private readonly CountryCode _country;

    public Person(...) { ... }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
var dave = new Person(
    id: new PersonId(30217),
    name: new Name("Dave", "Ancelovici"),
    landline: PhoneNumber.Parse("023745001"),
    mobile: PhoneNumber.Parse("0873712503"),
    email: Email.Parse("dave@learning-ddd.com"),
    height: Height.FromMetric(180),
    country: CountryCode.Parse("BG")
);
```

::accordion
::accordion-item{title="–ü–µ—Ä–µ–≤–∞–≥–∏ Value Objects"}
**1. –ö—Ä–∞—â–∞ —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å**

```csharp
private readonly CountryCode _country; // ‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ: –∫–æ–¥ –∫—Ä–∞—ó–Ω–∏
vs
private readonly string _countryCode;  // ‚ùì –ö–æ–¥? –ù–∞–∑–≤–∞? –°–∫–æ—Ä–æ—á–µ–Ω–Ω—è?
```

**2. –í–±—É–¥–æ–≤–∞–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è**

–õ–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Å–∞–º–∏—Ö –æ–±'—î–∫—Ç–∞—Ö-–∑–Ω–∞—á–µ–Ω–Ω—è—Ö. –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏—Å–≤–æ—î–Ω–Ω—è–º.

**3. –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞**

–í—Å—è –ª–æ–≥—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏ –∑—ñ –∑–Ω–∞—á–µ–Ω–Ω—è–º ‚Äî –≤ –æ–¥–Ω–æ–º—É –º—ñ—Å—Ü—ñ. –õ–µ–≥–∫–æ —Ç–µ—Å—Ç—É—î–º–æ.

**4. –Ñ–¥–∏–Ω–∞ –º–æ–≤–∞**

–ö–æ–¥ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó predmet–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ.
::
::

#### –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ Value Objects

::accordion
::accordion-item{title="Height - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –æ–¥–∏–Ω–∏—Ü—å"}

```csharp
var heightMetric = Height.Metric(180);
var heightImperial = Height.Imperial(5, 11);

var string1 = heightMetric.ToString(); // "180cm"
var string2 = heightImperial.ToString(); // "5 feet 11 inches"
var string3 = heightMetric.ToImperial().ToString(); // "5 feet 11 inches"

var firstIsHigher = heightMetric > heightImperial; // false
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**:

- –ù–µ–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –≤—ñ–¥ –æ–¥–∏–Ω–∏—Ü—å –≤–∏–º—ñ—Ä—É
- –õ–µ–≥–∫–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è metric ‚Üî imperial
- –ü–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è

::

::accordion-item{title="PhoneNumber - –ê–Ω–∞–ª—ñ–∑ —Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è"}

```csharp
var phone = PhoneNumber.Parse("+359877123503");

var country = phone.Country;     // "BG"
var phoneType = phone.PhoneType; // "MOBILE"
var isValid = PhoneNumber.IsValid("+972120266680"); // false
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**:

- –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ
- Extraction metadata (–∫—Ä–∞—ó–Ω–∞, —Ç–∏–ø)
- –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ª–æ–≥—ñ–∫–∞ parsing

::

::accordion-item{title="Color - –ë—ñ–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü—ñ—ó"}

```csharp
var red = Color.FromRGB(255, 0, 0);
var green = Color.Green; // –ü—Ä–µ–¥–≤–∏–∑–Ω–∞—á–µ–Ω–∏–π –∫–æ–ª—ñ—Ä

var yellow = red.MixWith(green);
var yellowString = yellow.ToString(); // "#FFFF00"
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**:

- –Ü–Ω–∫–∞–ø—Å—É–ª—è—Ü—ñ—è –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ (mix colors)
- –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ (immutability)
- –í–∏—Ä–∞–∑–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ

::

::

### –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è Value Objects

#### Immutability (–ù–µ–∑–º—ñ–Ω–Ω—ñ—Å—Ç—å)

–ó–º—ñ–Ω–∞ –±—É–¥—å-—è–∫–æ–≥–æ –ø–æ–ª—è —Å—Ç–≤–æ—Ä—é—î **—ñ–Ω—à–µ –∑–Ω–∞—á–µ–Ω–Ω—è** ‚Üí Value Objects —î **immutable**.

```csharp
public class Color
{
    public readonly byte Red;
    public readonly byte Green;
    public readonly byte Blue;

    public Color(byte r, byte g, byte b)
    {
        this.Red = r;
        this.Green = g;
        this.Blue = b;
    }

    // ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î –ù–û–í–ò–ô –µ–∫–∑–µ–º–ø–ª—è—Ä, –Ω–µ –∑–º—ñ–Ω—é—î –ø–æ—Ç–æ—á–Ω–∏–π
    public Color MixWith(Color other)
    {
        return new Color(
            r: (byte)Math.Min(this.Red + other.Red, 255),
            g: (byte)Math.Min(this.Green + other.Green, 255),
            b: (byte)Math.Min(this.Blue + other.Blue, 255)
        );
    }
}
```

::tip{icon="ph:shield-check"}
**–ü–µ—Ä–µ–≤–∞–≥–∏ Immutability**

- ‚úÖ –ë–µ–∑–ø–µ–∫–∞ –≤—ñ–¥ –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤
- ‚úÖ –ü–æ—Ç–æ–∫–æ–±–µ–∑–ø–µ—á–Ω—ñ—Å—Ç—å (thread-safe)
- ‚úÖ –ü–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞

::

#### –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è Equality

–† Equality –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ **–∑–Ω–∞—á–µ–Ω–Ω—è—Ö**, –∞ –Ω–µ –Ω–∞ reference –∞–±–æ ID:

```csharp
public class Color
{
    // ... fields ...

    public override bool Equals(object obj)
    {
        var other = obj as Color;
        return other != null &&
               this.Red == other.Red &&
               this.Green == other.Green &&
               this.Blue == other.Blue;
    }

    public static bool operator ==(Color lhs, Color rhs)
    {
        if (Object.ReferenceEquals(lhs, null))
        {
            return Object.ReferenceEquals(rhs, null);
        }
        return lhs.Equals(rhs);
    }

    public static bool operator !=(Color lhs, Color rhs)
    {
        return !(lhs == rhs);
    }

    public override int GetHashCode()
    {
        return ToString().GetHashCode();
    }
}
```

::note{icon="ph:code"}
**–ü—Ä–∏–º—ñ—Ç–∫–∞ –¥–ª—è C# 9.0+**

C# 9.0 `record` type –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ–∞–ª—ñ–∑—É—î equality –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∑–Ω–∞—á–µ–Ω—å. –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤–∏–∑–Ω–∞—á–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∏.
::

#### –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Value Objects?

::tip{icon="ph:star"}
**–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: –ü—Ä–∏ –±—É–¥—å-—è–∫—ñ–π –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ!**

Value Objects:

- ‚úÖ –†–æ–±–ª—è—Ç—å –∫–æ–¥ –≤–∏—Ä–∞–∑–Ω—ñ—à–∏–º
- ‚úÖ –Ü–Ω–∫–∞–ø—Å—É–ª—é—é—Ç—å –ª–æ–≥—ñ–∫—É, —â–æ –¥—É–±–ª—é—î—Ç—å—Å—è
- ‚úÖ –†–æ–±–ª—è—Ç—å –∫–æ–¥ –±–µ–∑–ø–µ—á–Ω—ñ—à–∏–º (immutability)
- ‚úÖ –ü–æ—Ç–æ–∫–æ–±–µ–∑–ø–µ—á–Ω—ñ (thread-safe)

::

**–ü—Ä–∞–∫—Ç–∏—á–Ω–µ –ø—Ä–∞–≤–∏–ª–æ –∑ –±—ñ–∑–Ω–µ—Å–ø–æ–≥–ª—è–¥—É**:

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Value Objects –¥–ª—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ, —â–æ **–æ–ø–∏—Å—É—é—Ç—å –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ** —ñ–Ω—à–∏—Ö –æ–±'—î–∫—Ç—ñ–≤ (–æ—Å–æ–±–ª–∏–≤–æ —Å—É—Ç–Ω–æ—Å—Ç–µ–π).

**–ü—Ä–∏–∫–ª–∞–¥–∏**:

- –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ Person: `PersonId`, `Name`, `PhoneNumber`, `Email`
- –°—Ç–∞–Ω–∏ —Å–∏—Å—Ç–µ–º–∏: `OrderStatus`, `TicketPriority`
- –ü–∞—Ä–æ–ª—ñ —Ç–∞ credentials
- **–ì—Ä–æ—à—ñ** (–∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ!)

::warning{icon="ph:currency-dollar"}
**Money —è–∫ Value Object**

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø—Ä–∏–º—ñ—Ç–∏–≤—ñ–≤ –¥–ª—è –≥—Ä–æ—à–µ–π:

- ‚ùå –û–±–º–µ–∂—É—î —ñ–Ω–∫–∞–ø—Å—É–ª—è—Ü—ñ—é –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏
- ‚ùå –ü—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –ø–æ–º–∏–ª–æ–∫ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è
- ‚ùå –ü—Ä–æ–±–ª–µ–º–∏ –∑ —Ç–æ—á–Ω—ñ—Å—Ç—é

–ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `Money` Value Object!
::

---

### –°—É—Ç–Ω–æ—Å—Ç—ñ (Entities)

> –ü—Ä–æ—Ç–∏–ª–µ–∂–Ω—ñ—Å—Ç—å Value Object. –ü–æ—Ç—Ä—ñ–±–Ω–µ **—è–≤–Ω–µ –ø–æ–ª–µ ID** –¥–ª—è —Ä–æ–∑—Ä—ñ–∑–Ω–µ–Ω–Ω—è –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤.

#### –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ ID

```csharp
// ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
class Person
{
    public Name Name { get; set; }

    public Person(Name name)
    {
        this.Name = name;
    }
}
```

::warning{icon="ph:users"}
**–ü—Ä–æ–±–ª–µ–º–∞**

Different –ª—é–¥–∏ –º–æ–∂—É—Ç—å –º–∞—Ç–∏ **–æ–¥–Ω–∞–∫–æ–≤—ñ —ñ–º–µ–Ω–∞**. –¶–µ –Ω–µ —Ä–æ–±–∏—Ç—å —ó—Ö –æ–¥–Ω—ñ—î—é –æ—Å–æ–±–æ—é!

–ü–æ—Ç—Ä—ñ–±–Ω–µ –ø–æ–ª–µ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.
::

#### –†—ñ—à–µ–Ω–Ω—è: Explicit ID

```csharp
// ‚úÖ Entity –∑ –ø–æ–ª–µ–º —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
class Person
{
    public readonly PersonId Id; // Immutable ID
    public Name Name { get; set; } // Mutable properties

    public Person(PersonId id, Name name)
    {
        this.Id = id;
        this.Name = name;
    }
}
```

::tip{icon="ph:fingerprint"}
**–í–∏–º–æ–≥–∏ –¥–æ ID**

1. **–£–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å** –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ Entity
2. **–ù–µ–∑–º—ñ–Ω–Ω—ñ—Å—Ç—å** –ø—Ä–æ—Ç—è–≥–æ–º –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É –æ–±'—î–∫—Ç–∞ (–∑–∞ –¥—É–∂–µ —Ä—ñ–¥–∫—ñ—Å–Ω–∏–º–∏ –≤–∏–Ω—è—Ç–∫–∞–º–∏)

**–¢–∏–ø–∏ ID**: GUID, int, string, –∞–±–æ domain-specific value (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Social Security Number)
::

::mermaid

```mermaid
graph LR
    P1[Person<br/>ID: 123<br/>Name: John Smith]
    P2[Person<br/>ID: 456<br/>Name: John Smith]

    P1 -.->|"Different ID"| P2

    style P1 fill:#c8e6c9
    style P2 fill:#fff3e0
```

::

### –í—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ Entities vs Value Objects

| –ê—Å–ø–µ–∫—Ç            | Value Object              | Entity                |
| ----------------- | ------------------------- | --------------------- |
| **–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è** | –ó–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏             | –ó–∞ –ø–æ–ª–µ–º ID           |
| **Immutability**  | –ù–µ–∑–º—ñ–Ω–Ω–∏–π                 | –ó–º—ñ–Ω–Ω–∏–π (mutable)     |
| **Equality**      | –ù–∞ –æ—Å–Ω–æ–≤—ñ –∑–Ω–∞—á–µ–Ω—å         | –ù–∞ –æ—Å–Ω–æ–≤—ñ ID          |
| **–†–æ–ª—å**          | –û–ø–∏—Å—É—î –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ        | –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î –æ–±'—î–∫—Ç    |
| **–ü—Ä–∏–∫–ª–∞–¥–∏**      | Color, PhoneNumber, Money | Person, Order, Ticket |

::note{icon="ph:link-simple"}
**–ó–≤'—è–∑–æ–∫**

Value Objects **–æ–ø–∏—Å—É—é—Ç—å –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ** Entities.

–†–∞–Ω—ñ—à–µ –±–∞—á–∏–ª–∏ Entity `Person` –∑ Value Objects `PersonId` —ñ `Name`.
::

---

## –ê–≥—Ä–µ–≥–∞—Ç–∏ (Aggregates)

::note{icon="fluent:shield-checkmark-24-filled"}
**–ö–ª—é—á–æ–≤–∞ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—è**

Aggregate ‚Äî —Ü–µ —Ç–∞–∫–æ–∂ Entity (–ø–æ—Ç—Ä—ñ–±–µ–Ω ID, —Å—Ç–∞–Ω –∑–º—ñ–Ω—é—î—Ç—å—Å—è), –∞–ª–µ —Ü–µ **–Ω–∞–±–∞–≥–∞—Ç–æ —à–∏—Ä—à–µ** –ø–æ–Ω—è—Ç—Ç—è.

**–ú–µ—Ç–∞**: –ó–∞—Ö–∏—Å—Ç —É–∑–≥–æ–¥–∂–µ–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö.
::

::mermaid

```mermaid
graph TB
    External[External Code] -->|Commands| AR[Aggregate Root]
    AR -->|Validate & Execute| BL[Business Logic]
    BL -->|Modify| State[(Aggregate State)]

    State -.->|Read-only| External

    subgraph "Consistency Boundary"
        AR
        BL
        State
        E1[Entity 1]
        E2[Entity 2]
        VO[Value Objects]
    end

    style AR fill:#4caf50
    style External fill:#e3f2fd
    style BL fill:#fff3e0
```

::

### –î–æ—Ç—Ä–∏–º–∞–Ω–Ω—è —É–∑–≥–æ–¥–∂–µ–Ω–æ—Å—Ç—ñ (Consistency Enforcement)

–û—Å–∫—ñ–ª—å–∫–∏ —Å—Ç–∞–Ω aggregate –º–æ–∂–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—è, –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –º–∞—Å–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π –¥–ª—è **–ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö**.

::warning{icon="ph:shield"}
**–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —á–µ—Ä–µ–∑ –º–µ–∂—ñ**

Aggregate –ø—Ä–æ–≤–æ–¥–∏—Ç—å **—á—ñ—Ç–∫—É –º–µ–∂—É** –º—ñ–∂ —Å–æ–±–æ—é —Ç–∞ –∑–æ–≤–Ω—ñ—à–Ω—ñ–º —Å–≤—ñ—Ç–æ–º:

Aggregate —î **–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—é boundary** (consistency boundary).
::

**–ú–µ—Ö–∞–Ω—ñ–∑–º –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ**:

1. ‚úÖ –ó–º—ñ–Ω—é–≤–∞—Ç–∏ —Å—Ç–∞–Ω –º–æ–∂–µ **—Ç—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞** aggregate
2. ‚ùå –ó–æ–≤–Ω—ñ—à–Ω—ñ–º –ø—Ä–æ—Ü–µ—Å–∞–º –¥–æ–∑–≤–æ–ª–µ–Ω–æ **–ª–∏—à–µ —á–∏—Ç–∞–Ω–Ω—è** —Å—Ç–∞–Ω—É
3. ‚úÖ –ó–º—ñ–Ω–∏ –º–æ–∂–ª–∏–≤—ñ **—Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ –ø—É–±–ª—ñ—á–Ω—ñ –º–µ—Ç–æ–¥–∏** (commands)

### –ö–æ–º–∞–Ω–¥–∏ (Commands)

–ú–µ—Ç–æ–¥–∏ –∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É aggregate –Ω–∞–∑–∏–≤–∞—é—Ç—Å—è **–∫–æ–º–∞–Ω–¥–∞–º–∏**.

::mermaid

```mermaid
sequenceDiagram
    participant C as Client
    participant A as Aggregate
    participant V as Validation
    participant S as State

    C->>A: ExecuteCommand(params)
    activate A
    A->>V: Validate business rules
    alt Invalid
        V-->>A: Reject
        A-->>C: Error/Exception
    else Valid
        V-->>A: OK
        A->>S: Modify state
        S-->>A: Updated
        A-->>C: Success
    end
    deactivate A
```

::

```csharp
public class Ticket // Aggregate Root
{
    private TicketId _id;
    private Priority _priority;
    private TicketStatus _status;

    // ‚úÖ Command: Public method
    public void Escalate(EscalationReason reason)
    {
        // Validate business rules
        if (_status == TicketStatus.Closed)
        {
            throw new InvalidOperationException("Cannot escalate closed ticket");
        }

        if (!CanEscalate())
        {
            throw new InvalidOperationException("Escalation not allowed");
        }

        // Modify state
        _status = TicketStatus.Escalated;
        _priority = IncreasePriority(_priority);
        _slaDeadline = RecalculateSLA(_slaDeadline, escalationReduction: 0.33);
    }

    // ‚ùå Private properties - –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–º—ñ–Ω–µ–Ω—ñ —Ç—ñ–ª—å–∫–∏ –∑—Å–µ—Ä–µ–¥–∏–Ω–∏
    private Priority IncreasePriority(Priority current) { ... }
    private DateTime RecalculateSLA(DateTime original, double reduction) { ... }
}
```

::tip{icon="ph:code"}
**–ß–æ–º—É –∫–æ–º–∞–Ω–¥–∏?**

–Ü–º'—è ¬´–∫–æ–º–∞–Ω–¥–∞¬ª –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î —Å–ø–æ—Å—ñ–± –≤–∏–∫–ª–∏–∫—É: **¬´–∑—Ä–æ–±–∏—Ç–∏ —â–æ—Å—å¬ª**.

–ü—Ä–∏–∫–ª–∞–¥–∏:

- `ticket.Escalate(reason)`
- `order.Submit()`
- `account.Withdraw(amount)`

::

---

### Transaction Boundary (–ì—Ä–∞–Ω–∏—Ü—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó)

::warning{icon="ph:database"}
**–ó–æ–ª–æ—Ç–µ –ø—Ä–∞–≤–∏–ª–æ**

**–û–¥–∏–Ω aggregate –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é!**

–ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫—ñ–ª—å–∫–æ—Ö aggregates –≤ –æ–¥–Ω—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó ‚Äî –æ–∑–Ω–∞–∫–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –º–µ–∂ aggregate.
::

–ß–æ–º—É —Ü–µ –≤–∞–∂–ª–∏–≤–æ?

1. **Concurrency** ‚Äî –º–µ–Ω—à—ñ –º–µ–∂—ñ = –º–µ–Ω—à–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ concurrent changes
2. **Performance** ‚Äî –º–µ–Ω—à–∏–π lock scope
3. **Scalability** ‚Äî –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ aggregates –º–æ–∂–Ω–∞ –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ –æ–∫—Ä–µ–º–æ

#### –ü–æ—Å–∏–ª–∞–Ω–Ω—è –º—ñ–∂ Aggregates

Aggregates –º–æ–∂—É—Ç—å –ø–æ—Å–∏–ª–∞—Ç–∏—Å—è –æ–¥–∏–Ω –Ω–∞ –æ–¥–Ω–æ–≥–æ **—Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ ID**, –∞ –Ω–µ —á–µ—Ä–µ–∑ –ø—Ä—è–º—ñ object references:

```csharp
public class Ticket
{
    private TicketId _id;
    private AgentId _assignedAgent; // ‚úÖ Reference by ID
    //private Agent _assignedAgent; // ‚ùå Direct object reference

    public void AssignToAgent(AgentId agentId)
    {
        _assignedAgent = agentId;
    }
}
```

::accordion
::accordion-item{title="–ß–æ–º—É —Ç—ñ–ª—å–∫–∏ ID?"}
**–ü—Ä–æ–±–ª–µ–º–∞ direct references**:

```csharp
// ‚ùå –ü–æ–≥–∞–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞
ticket._assignedAgent.ActiveTickets += 1;
ticket._assignedAgent.Save();
```

–ú–∏ –º–æ–¥–∏—Ñ—ñ–∫—É—î–º–æ **–¥–≤–∞ aggregates** (Ticket —Ç–∞ Agent) ‚Üí –ø–æ—Ä—É—à–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª–∞ ¬´–æ–¥–∏–Ω aggregate –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó¬ª.

**–†—ñ—à–µ–Ω–Ω—è —á–µ—Ä–µ–∑ ID**:

```csharp
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥
var agentId = ticket.AssignedAgent; // –ü—Ä–æ—Å—Ç–æ ID
// –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ Agent ‚Äî —Ü–µ –æ–∫—Ä–µ–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
var agent = _agentRepository.Load(agentId);
agent.IncrementActiveTickets();
_agentRepository.Save(agent);
```

::
::

---

### –Ü—î—Ä–∞—Ä—Ö—ñ—ó —Å—É—Ç–Ω–æ—Å—Ç–µ–π (Entity Hierarchies)

Aggregate –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ **–∫—ñ–ª—å–∫–∞ entities** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å–µ–±–µ.

::mermaid

```mermaid
graph TB
    AR[Order<br/>Aggregate Root]
    E1[OrderLine 1<br/>Entity]
    E2[OrderLine 2<br/>Entity]
    VO1[Product ID<br/>Value Object]
    VO2[Quantity<br/>Value Object]

    AR -->|Contains| E1
    AR -->|Contains| E2
    E1 --> VO1
    E1 --> VO2

    style AR fill:#4caf50
    style E1 fill:#fff3e0
    style E2 fill:#fff3e0
    style VO1 fill:#e3f2fd
    style VO2 fill:#e3f2fd
```

::

```csharp
public class Order // Aggregate Root
{
    private readonly OrderId _id;
    private readonly List<OrderLine> _lines; // Child entities

    public void AddLine(ProductId product, int quantity)
    {
        // Business rule: –º–∞–∫—Å–∏–º—É–º 10 –ø–æ–∑–∏—Ü—ñ–π
        if (_lines.Count >= 10)
        {
            throw new InvalidOperationException("Cannot exceed 10 order lines");
        }

        // Business rule: –Ω–µ –±—ñ–ª—å—à–µ 100 —à—Ç—É–∫ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É
        if (quantity > 100)
        {
            throw new InvalidOperationException("Max quantity = 100");
        }

        _lines.Add(new OrderLine(product, quantity));
    }
}

public class OrderLine // Entity (not aggregate!)
{
    private readonly OrderLineId _id;
    private readonly ProductId _product;
    private int _quantity;

    internal OrderLine(ProductId product, int quantity)
    {
        _id = OrderLineId.New();
        _product = product;
        _quantity = quantity;
    }
}
```

::tip{icon="ph:tree-structure"}
**Aggregate Root**

–õ–∏—à–µ **–∫–æ—Ä—ñ–Ω—å —ñ—î—Ä–∞—Ä—Ö—ñ—ó** (Order) –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∑–æ–≤–Ω—ñ. Child entities (OrderLine) –¥–æ—Å—Ç—É–ø–Ω—ñ **—Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ root**.

–¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ **–≤—Å—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞** –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è.
::

---

### Concurrency Control (–ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º)

–ö–æ–ª–∏ –∫—ñ–ª—å–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –ø—Ä–∞—Ü—é—é—Ç—å –∑ –æ–¥–Ω–∏–º aggregate, –ø–æ—Ç—Ä—ñ–±–µ–Ω –º–µ—Ö–∞–Ω—ñ–∑–º —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤.

#### Optimistic Locking

```csharp
public class Ticket
{
    private –í–µ—Ä—Å—ñ—ó long _version; // –õ—ñ—á–∏–ª—å–Ω–∏–∫ –∑–º—ñ–Ω

    public void Escalate(Escalation Reason reason)
    {
        // Business logic...
        _version++; // –ó–±—ñ–ª—å—à—É—î–º–æ –≤–µ—Ä—Å—ñ—é –ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –∑–º—ñ–Ω—ñ
    }
}
```

**–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –ë–î –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –≤–µ—Ä—Å—ñ—ó**:

```sql
UPDATE Tickets
SET status = @status,
    priority = @priority,
    version = version + 1
WHERE id = @id
  AND version = @expectedVersion; -- ‚úÖ Optimistic lock

-- –Ø–∫—â–æ version –∑–º—ñ–Ω–∏–ª–∞—Å—å —ñ–Ω—à–∏–º –ø—Ä–æ—Ü–µ—Å–æ–º ‚Üí 0 rows affected ‚Üí Concurrency Exception
```

::accordion
::accordion-item{title="–Ø–∫ –ø—Ä–∞—Ü—é—î Optimistic Locking"}
**–°—Ü–µ–Ω–∞—Ä—ñ–π –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É**:

1. **User A** –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î Ticket (version = 5)
2. **User B** –∑–∞–≤–∞–Ω—Ç–∞–∂ —î Ticket (version = 5)
3. **User A** escalates ticket ‚Üí version = 6 ‚úÖ
4. **User B** –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è escalate ‚Üí –æ—á—ñ–∫—É—î version = 5, –∞–ª–µ –∑–∞—Ä–∞–∑ = 6 ‚ùå

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: User B –æ—Ç—Ä–∏–º—É—î `ConcurrencyException` —ñ –º–∞—î reload ticket.

**–ü–µ—Ä–µ–≤–∞–≥–∏**:

- –ù–µ –±–ª–æ–∫—É—î —á–∏—Ç–∞–Ω–Ω—è
- –í–∏—Å–æ–∫–∞—á–∞—Å—Ç–æ—Ç–Ω–∞ concurrency
- –Ø–≤–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏

::

::

---

## Aggregate vs Entity: –ü–æ—Å—ñ–±–Ω–∏–∫ –∑ –ø—Ä–∏–π–Ω—è—Ç—Ç—è —Ä—ñ—à–µ–Ω—å

::note{icon="ph:question"}
**–ù–∞–π—á–∞—Å—Ç—ñ—à–µ –ø–∏—Ç–∞–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤**

> ¬´–Ø–∫ –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —á–∏ —Ü–µ –æ–∫—Ä–µ–º–∏–π aggregate, —á–∏ entity –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —ñ–Ω—à–æ–≥–æ aggregate?¬ª

–¶–µ **–∫—Ä–∏—Ç–∏—á–Ω–µ** —Ä—ñ—à–µ–Ω–Ω—è, —â–æ –≤–ø–ª–∏–≤–∞—î –Ω–∞:

- Transaction boundaries
- Concurrency –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
- –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∏

::

### Decision Flowchart

::mermaid

```mermaid
flowchart TD
    Start[–ë—ñ–∑–Ω–µ—Å-–æ–±'—î–∫—Ç] --> Q1{–ß–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω\n–ø–æ–ª–µ ID?}
    Q1 -->|–ù—ñ| VO[Value Object]
    Q1 -->|–¢–∞–∫| Q2{–ß–∏ –º–∞—î –≤–ª–∞—Å–Ω—ñ\n–±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞?}

    Q2 -->|–ù—ñ| Child[Entity\n–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ aggregate]
    Q2 -->|–¢–∞–∫| Q3{–ß–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞\n–∫–æ–Ω–∑–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å\n–∑ —ñ–Ω—à–∏–º–∏ –æ–±'—î–∫—Ç–∞–º–∏?}

    Q3 -->|–ó –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–º –æ–±'—î–∫—Ç–æ–º| Child
    Q3 -->|–ù–µ–∑–∞–ª–µ–∂–Ω–∞| AggRoot[Aggregate Root]

    Q3 -->|–ó–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å—Ü–µ–Ω–∞—Ä—ñ—é| Q4{–Ø–∫—ñ –∫—ñ–ª—å–∫—ñ—Å–Ω—ñ\n—Å–ø—ñ–≤—Ä–æ–∑–º—ñ—Ä–Ω–æ—Å—Ç—ñ?}

    Q4 -->|1:Few| Child
    Q4 -->|1:Many –∞–±–æ N:M| AggRoot

    style VO fill:#e3f2fd
    style Child fill:#fff3e0
    style AggRoot fill:#c8e6c9
```

::

### –ü—Ä–∏–∫–ª–∞–¥ 1: E-commerce Order

::accordion
::accordion-item{title="Order —Ü–µ aggregate, OrderLine ‚Äî entity"}

```csharp
// ‚úÖ Order = Aggregate Root
public class Order
{
    private OrderId _id;
    private List<OrderLine> _lines; // Entities –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ
    private OrderStatus _status;
    private decimal _totalAmount;

    public void AddLine(ProductId product, int quantity, decimal price)
    {
        // Business rule: –Ω–µ –º–æ–∂–Ω–∞ –¥–æ–¥–∞–≤–∞—Ç–∏ –¥–æ shipped order
        if (_status == OrderStatus.Shipped)
        {
            throw new InvalidOperationException("Cannot modify shipped order");
        }

        // Business rule: –º–∞–∫—Å–∏–º—É–º 50 –ø–æ–∑–∏—Ü—ñ–π
        if (_lines.Count >= 50)
        {
            throw new InvalidOperationException("Max 50 lines");
        }

        _lines.Add(new OrderLine(product, quantity, price));
        RecalculateTotal(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ total
    }

    private void RecalculateTotal()
    {
        _totalAmount = _lines.Sum(line => line.SubTotal);
    }
}

// OrderLine = Entity (–ù–ï aggregate!)
public class OrderLine
{
    private OrderLineId _id;
    private ProductId _product;
    private int _quantity;
    private decimal _unitPrice;

    public decimal SubTotal => _quantity * _unitPrice;

    // internal ‚Äî –º–æ–∂–µ –±—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –∑ Order
    internal OrderLine(ProductId product, int quantity, decimal price)
    {
        _id = OrderLineId.New();
        _product = product;
        _quantity = quantity;
        _unitPrice = price;
    }
}
```

**–ß–û–ú–£ OrderLine –Ω–µ –æ–∫—Ä–µ–º–∏–π aggregate?**

1. ‚ùå **–ù–µ–º–∞—î —Å–µ–Ω—Å—É –±–µ–∑ Order** ‚Äî OrderLine –∑–∞–≤–∂–¥–∏ –Ω–∞–ª–µ–∂–∏—Ç—å Order
2. ‚ùå **–ö–æ–Ω–∑–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –∑ Order** ‚Äî total amount –º–∞—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏—Å—è
3. ‚ùå **–ñ–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª** ‚Äî —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è/–≤–∏–¥–∞–ª—è—î—Ç—å—Å—è —Ä–∞–∑–æ–º –∑ Order
4. ‚úÖ **Transaction boundary** ‚Äî –∑–º—ñ–Ω–∞ OrderLine = –∑–º—ñ–Ω–∞ Order

::

::

---

### –ü—Ä–∏–∫–ª–∞–¥ 2: —Å–∏—Å—Ç–µ–º–∞ –±–ª–æ–≥—É

::accordion
::accordion-item{title="BlogPost vs Comment ‚Äî –¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏"}
**–í–∞—Ä—ñ–∞–Ω—Ç A: Comment —è–∫ Entity –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ BlogPost**

```csharp
// –Ø–∫—â–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –ø—Ä–æ—Å—Ç—ñ –π –Ω–µ–æ–¥–º—ñ–Ω–≥—ñ
public class BlogPost // Aggregate
{
    private PostId _id;
    private List<Comment> _comments; // Entities

    public void AddComment(UserId author, string text)
    {
        // Business rule: –Ω–µ –±—ñ–ª—å—à–µ 1000 –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
        if (_comments.Count >= 1000)
        {
            throw new InvalidOperationException("Post full");
        }

        _comments.Add(new Comment(author, text));
    }
}

public class Comment // Entity
{
    private CommentId _id;
    private UserId _author;
    private string _text;
    private DateTime _createdAt;
}
```

**–í–∞—Ä—ñ–∞–Ω—Ç B: Comment —è–∫ –æ–∫—Ä–µ–º–∏–π Aggregate**

```csharp
// –Ø–∫—â–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ —Å–∫–ª–∞–¥–Ω—ñ (–º–æ–¥–µ—Ä–∞—Ü—ñ—è, —Ä–µ–π—Ç–∏–Ω–≥–∏, –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ)
public class BlogPost // Aggregate
{
    private PostId _id;
    private List<CommentId> _commentIds; // –¢—ñ–ª—å–∫–∏ ID!

    public void LinkComment(CommentId commentId)
    {
        _commentIds.Add(commentId);
    }
}

public class Comment // –û–∫—Ä–µ–º–∏–π Aggregate!
{
    private CommentId _id;
    private PostId _postId; // Back reference –ø–æ ID
    private UserId _author;
    private string _text;
    private ModerationStatus _status;
    private List<CommentId> _replies; // –ú–æ–∂–µ –º–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    private int _upvotes;
    private int _downvotes;

    public void Approve() { ... } // –í–ª–∞—Å–Ω–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
    public void addReply(Comment reply) { ... }
}
```

**–ö–æ–ª–∏ Comment ‚Äî –æ–∫—Ä–µ–º–∏–π aggregate?**

‚úÖ –ö–æ–ª–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –º–∞—é—Ç—å **–≤–ª–∞—Å–Ω—É —Å–∫–ª–∞–¥–Ω—É –ª–æ–≥—ñ–∫—É**:

- –ú–æ–¥–µ—Ä–∞—Ü—ñ—è (approve/reject)
- –†–µ–π—Ç–∏–Ω–≥–∏ (upvotes/downvotes)
- –í–ª–∞—Å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (nested comments)
- –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è comment–∞—Ä—ñ–≤ –∞–≤—Ç–æ—Ä–æ–º

‚úÖ –ö–æ–ª–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ **–≤–µ–ª–∏–∫–∞** (>100):

- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –∑ –ø–æ—Å—Ç–æ–º –Ω–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
- –ü–æ—Ç—Ä—ñ–±–Ω–∞ pagination

‚ùå –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Entity –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ BlogPost, –∫–æ–ª–∏:

- –ü—Ä–æ—Å—Ç—ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –±–µ–∑ —Å–∫–ª–∞–¥–Ω–æ—ó –ª–æ–≥—ñ–∫–∏
- –ù–µ–≤–µ–ª–∏–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (<100)
- –¢—ñ–ª—å–∫–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è

::

::

---

### –ü—Ä–∏–∫–ª–∞–¥ 3: –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å—å–∫–∞ —Å–∏—Å—Ç–µ–º–∞

::accordion
::accordion-item{title="Student, Course, Enrollment ‚Äî —Ä–æ–∑–±—ñ—Ä"}

```csharp
// ‚úÖ Student = Aggregate
public class Student
{
    private StudentId _id;
    private Name _name;
    private List<EnrollmentId> _enrollments; // –¢—ñ–ª—å–∫–∏ ID!

    public StudentId Id => _id;
}

// ‚úÖ Course = Aggregate
public class Course
{
    private CourseId _id;
    private CourseName _name;
    private int _capacity;
    private List<EnrollmentId> _enrollments;

    public CourseId Id => _id;
    public bool IsFull => _enrollments.Count >= _capacity;
}

// ‚úÖ Enrollment = —Ç–∞–∫–æ–∂ Aggregate!
public class Enrollment
{
    private EnrollmentId _id;
    private StudentId _student; // Reference –ø–æ ID
    private CourseId _course;   // Reference –ø–æ ID
    private EnrollmentStatus _status;
    private Grade _grade;

    public void Complete(Grade grade)
    {
        if (_status != EnrollmentStatus.Active)
        {
            throw new InvalidOperationException("Enrollment not active");
        }

        _grade = grade;
        _status = EnrollmentStatus.Completed;
    }

    public void Withdraw()
    {
        if (_status == EnrollmentStatus.Completed)
        {
            throw new InvalidOperationException("Cannot withdraw completed course");
        }

        _status = EnrollmentStatus.Withdrawn;
    }
}
```

**–ß–û–ú–£ Enrollment ‚Äî –æ–∫—Ä–µ–º–∏–π aggregate?**

**–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –≥—Ä–∞–Ω–∏—Ü—ñ**:

- –°—Ç—É–¥–µ–Ω—Ç –º–æ–∂–µ –∑–∞—Ä–∞—Ö—É–≤–∞—Ç–∏—Å—è –Ω–∞ –∫—É—Ä—Å ‚úÖ
- –ö—É—Ä—Å –º–æ–∂–µ –ø—Ä–∏–π–º–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ ‚úÖ
- –ê–ª–µ process —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó **–º–∞—î –≤–ª–∞—Å–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞**:
    - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥—É–º–æ–≤
    - Deadline —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
    - Payment processing

—Ü—ñ –ø—Ä–∞–≤–∏–ª–∞ –Ω–µ –Ω–∞–ª–µ–∂–∞—Ç—å –Ω—ñ Student, –Ω—ñ Course!

**N:M relationship**:

- –û–¥–∏–Ω Student ‚Üí –±–∞–≥–∞—Ç–æ Enrollments
- –û–¥–∏–Ω Course ‚Üí –±–∞–≥–∞—Ç–æ Enrollments

–Ø–∫—â–æ Enrollment –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Student ‚Üí —è–∫ Course –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤?  
–Ø–∫—â–æ Enrollment –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Course ‚Üí —è–∫ Student –∑–Ω–∞—Ö–æ–¥–∏—Ç—å –∫—É—Ä—Å–∏?

**–†—ñ—à–µ–Ω–Ω—è**: Enrollment —è–∫ –æ–∫—Ä–µ–º–∏–π aggregate –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º–∏ –ø–æ ID.
::
::

---

### –ü—Ä–∏–∫–ª–∞–¥ 4: Banking System

::accordion
::accordion-item{title="Account vs Transaction"}

```csharp
// ‚úÖ Account = Aggregate
public class Account
{
    private AccountId _id;
    private decimal _balance;
    private List<Transaction> _transactions; // Entities –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ!

    public void Deposit(decimal amount)
    {
        if (amount <= 0)
        {
            throw new ArgumentException("Amount must be positive");
        }

        _balance += amount;
        _transactions.Add(new Transaction(TransactionType.Deposit, amount));
    }

    public void Withdraw(decimal amount)
    {
        if (amount > _balance)
        {
            throw new InvalidOperationException("Insufficient funds");
        }

        _balance -= amount;
        _transactions.Add(new Transaction(TransactionType.Withdrawal, amount));
    }
}

// Transaction = Entity (–ù–ï aggregate!)
public class Transaction
{
    private TransactionId _id;
    private TransactionType _type;
    private decimal _amount;
    private DateTime _timestamp;

    internal Transaction(TransactionType type, decimal amount)
    {
        _id = TransactionId.New();
        _type = type;
        _amount = amount;
        _timestamp = DateTime.UtcNow;
    }
}
```

**–ß–û–ú–£ Transaction –ù–ï aggregate?**

1. **Consistency boundary** ‚Äî balance –º–∞—î –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—è **—Ä–∞–∑–æ–º** –∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—î—é
2. **Business rules** ‚Äî overdraft –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞–ª–µ–∂–∞—Ç—å Account, –Ω–µ Transaction
3. **Lifecycle** ‚Äî Transaction —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ Account operations
4. **Read pattern** ‚Äî —á–∏—Ç–∞—î–º–æ transactions **–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ** Account

::

::

---

### –ü—Ä–∏–∫–ª–∞–¥ 5: Project Management

::accordion
::accordion-item{title="Project, Task, Sprint ‚Äî —Ö—Ç–æ aggregate?"}

```csharp
// ‚úÖ Project = Aggregate
public class Project
{
    private ProjectId _id;
    private List<SprintId> _sprints; // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –ø–æ ID
    private List<TaskId> _backlog;   // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –ø–æ ID
}

// ‚úÖ Sprint = Aggregate
public class Sprint
{
    private SprintId _id;
    private ProjectId _project;
    private List<TaskId> _tasks; // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –ø–æ ID
    private DateTime _startDate;
    private DateTime _endDate;
    private SprintStatus _status;

    public void Start()
    {
        if (_tasks.Count == 0)
        {
            throw new InvalidOperationException("Cannot start empty sprint");
        }
        _status = SprintStatus.Active;
    }
}

// ‚úÖ Task = Aggregate!
public class Task
{
    private TaskId _id;
    private SprintId _sprint; // –ú–æ–∂–µ –±—É—Ç–∏ null (backlog)
    private UserId _assignee;
    private TaskStatus _status;
    private List<SubTask> _subTasks; // Entities –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ
    private List<Comment> _comments; // Entities –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ

    public void Start()
    {
        if (_status != TaskStatus.ToDo)
        {
            throw new InvalidOperationException("Can only start ToDo tasks");
        }
        _status = TaskStatus.InProgress;
    }

    public void AddSubTask(string description)
    {
        _subTasks.Add(new SubTask(description));
    }
}

// SubTask = Entity (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Task)
public class SubTask
{
    private SubTaskId _id;
    private string _description;
    private bool _completed;
}
```

**–ê–Ω–∞–ª—ñ–∑**: –ß–û–ú–£ Task ‚Äî aggregate?

‚úÖ **–í–ª–∞—Å–Ω–∏–π –∂–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª**:

- –ú–æ–∂–µ —ñ—Å–Ω—É–≤–∞—Ç–∏ –≤ backlog (–±–µ–∑ Sprint)
- –ú–æ–∂–µ –ø–µ—Ä–µ–º—ñ—â–∞—Ç–∏—Å—è –º—ñ–∂ Sprints
- –ú–∞—î –≤–ª–∞—Å–Ω–∏–π status workflow

‚úÖ **–í–ª–∞—Å–Ω—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞**:

- Time tracking
- Assignee management
- SubTasks management

‚úÖ **–ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å**:

- –¢–∏—Å—è—á—ñ tasks –≤ –ø—Ä–æ—î–∫—Ç—ñ
- –ù–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –≤—Å—ñ tasks –∑ Project

**SubTask –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Task**:

- ‚ùå –ù–µ–º–∞—î —Å–µ–Ω—Å—É –±–µ–∑ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ Task
- ‚úÖ –ü—Ä–æ—Å—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –ù–µ–≤–µ–ª–∏–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (–∑–∞–∑–≤–∏—á–∞–π <10)

::

::

---

### –ß–∞—Å—Ç—ñ –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—ñ Aggregates

::warning{icon="ph:warning-octagon"}
**Mistake 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–±–∞–≥–∞—Ç–æ aggregates**

```csharp
// ‚ùå –ö–æ–∂–Ω–∞ –¥—Ä—ñ–±–Ω–∏—Ü—è ‚Äî aggregate
public class Order { /* aggregate */ }
public class OrderLine { /* aggregate */ } // ‚ùå –ü–æ–º–∏–ª–∫–∞!
public class Address { /* aggregate */ }   // ‚ùå –ü–æ–º–∏–ª–∫–∞!
```

**–ù–∞—Å–ª—ñ–¥–∫–∏**:

- –ü–æ–≥–∞–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (N√óqueries)
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∏ (–∞—Ç–æ–º–∞—Ä–Ω—ñ—Å—Ç—å –ø–æ—Ä—É—à—É—î—Ç—å—Å—è)
- –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—ó

::

::warning{icon="ph:warning-diamond"}
**Mistake 2: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–∞–ª–æ aggregates**

```csharp
// ‚ùå –û–¥–∏–Ω –≥—ñ–≥–∞–Ω—Ç—Å—å–∫–∏–π aggregate
public class Enterprise
{
    List<Department> _departments;
    List<Employee> _employees; // –¢–∏—Å—è—á—ñ!
    List<Project> _projects;   // –°–æ—Ç–Ω—ñ!
    List<Task> _tasks;         // –î–µ—Å—è—Ç–∫–∏ —Ç–∏—Å—è—á!
}
```

**–ù–∞—Å–ª—ñ–¥–∫–∏**:

- Concurrency conflicts (—á–∞—Å—Çi lock conflicts)
- –ü–æ–≤—ñ–ª—å–Ω—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
- –°–∫–ª–∞–¥–Ω—É –ª–æ–≥—ñ–∫—É

::

::warning{icon="ph:prohibit"}
**Mistake 3:–∑ Everything is Aggregate Root**

```csharp
// ‚ùå –ù–∞–≤—ñ—Ç—å Value Objects —Å—Ç–∞—é—Ç—å aggregates
public class Color { /* aggregate root? */ } // ‚ùå –¶–µ Value Object!
public class PhoneNumber { /* aggregate root? */ } // ‚ùå –¶–µ Value Object!
```

**–°–∏–º–ø—Ç–æ–º–∏**:

- Aggregates –±–µ–∑ –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª
- Aggregates –±–µ–∑ state changes
- –¢—ñ–ª—å–∫–∏ getters/setters

::

---

### –ú–∞—Ç—Ä–∏—Ü—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è —Ä—ñ—à–µ–Ω—å

| –ü–∏—Ç–∞–Ω–Ω—è                                     | Entity –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ  | –û–∫—Ä–µ–º–∏–π Aggregate      |
| ------------------------------------------- | ----------------- | ---------------------- |
| –ß–∏ –º–∞—î –≤–ª–∞—Å–Ω—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞?               | –ù—ñ –∞–±–æ –ø—Ä–æ—Å—Ç—ñ     | –¢–∞–∫, —Å–∫–ª–∞–¥–Ω—ñ           |
| –ß–∏ –º–∞—î –≤–ª–∞—Å–Ω–∏–π –∂–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª?               | –ù—ñ                | –¢–∞–∫                    |
| –ß–∏ –º–æ–∂–µ —ñ—Å–Ω—É–≤–∞—Ç–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ?                 | –ù—ñ                | –¢–∞–∫                    |
| –Ø–∫–∏–π –∫—ñ–ª—å–∫—ñ—Å–Ω–∏–π –∑–≤'—è–∑–æ–∫?                    | 1:Few (<100)      | 1:Many (>100) –∞–±–æ N:M  |
| –ß–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –∑ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–º? | –¢–∞–∫ (atomic)      | Eventual OK            |
| –ß–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ concurrency performance?        | –ù—ñ (rare updates) | –¢–∞–∫ (frequent updates) |
| –ß–∏ —î —Ç–æ—á–∫–æ—é –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è?                  | –ù—ñ                | –¢–∞–∫                    |

### –ü—Ä–∞–∫—Ç–∏—á–Ω–∏–π —á–µ–∫–ª–∏—Å—Ç

::steps

### Step 1: –í–∏–∑–Ω–∞—á—Ç–µ, —á–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω ID

**–ù—ñ** ‚Üí Value Object  
**–¢–∞–∫** ‚Üí –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ

### Step 2: –ß–∏ –º–∞—î –≤–ª–∞—Å–Ω—ñ –≤–∞–∂–ª–∏–≤—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞?

**–ù—ñ** ‚Üí –ô–º–æ–≤—ñ—Ä–Ω–æ Entity –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ  
**–¢–∞–∫** ‚Üí –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ

### Step 3: –ß–∏ –º–æ–∂–µ —ñ—Å–Ω—É–≤–∞—Ç–∏ –±–µ–∑ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ –æ–±'—î–∫—Ç–∞?

**–ù—ñ** ‚Üí Entity –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ  
**–¢–∞–∫** ‚Üí –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ

### Step 4: –Ø–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤?

**1:Few (<50-100)** ‚Üí –ú–æ–∂–ª–∏–≤–æ Entity –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ  
**1:Many (>100) –∞–±–æ N:M** ‚Üí –û–∫—Ä–µ–º–∏–π Aggregate

### Step 5: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Transaction Boundary

**–ê—Ç–æ–º–∞—Ä–Ω—ñ –∑–º—ñ–Ω–∏ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ?** ‚Üí –û–¥–∏–Ω Aggregate  
**Eventual consistency –ø—Ä–∏–π–Ω—è—Ç–Ω–∞?** ‚Üí –û–∫—Ä–µ–º—ñ Aggregates
::

---

## –ü–æ–¥—ñ—ó –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ (Domain Events)

::note{icon="ph:rocket-launch"}
**–ö–æ–Ω—Ü–µ–ø—Ü—ñ—è**

Domain Events –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç—å **–∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É** –≤ lifecycle aggregate, —â–æ –º–∞—é—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –±—ñ–∑–Ω–µ—Å—É.
::

```csharp
public class Ticket
{
    private List<IDomainEvent> _domainEvents = new();

    public void Escalate(EscalationReason reason)
    {
        // Business logic...
        _status = TicketStatus.Escalated;

        // ‚úÖ –ü—É–±–ª—ñ–∫—É—î–º–æ –ø–æ–¥—ñ—é
        _domainEvents.Add(new TicketEscalated(
            ticketId: _id,
            reason: reason,
            escalatedAt: DateTime.UtcNow
        ));
    }

    public IReadOnlyList<IDomainEvent> DomainEvents => _domainEvents;
}

// Event —É –º–∏–Ω—É–ª–æ–º—É —á–∞—Å—ñ!
public class TicketEscalated : IDomainEvent
{
    public TicketId TicketId { get; }
    public EscalationReason Reason { get; }
    public DateTime EscalatedAt { get; }
}
```

::tip{icon="ph:calendar-check"}
**Naming Convention**

–ü–æ–¥—ñ—ó –∑–∞–≤–∂–¥–∏ –≤ **–º–∏–Ω—É–ª–æ–º—É —á–∞—Å—ñ** (past tense):

- ‚úÖ `TicketEscalated`
- ‚úÖ `OrderSubmitted`
- ‚úÖ `PaymentConfirmed`
- ‚ùå `EscalateTicket` (—Ü–µ –∫–æ–º–∞–Ω–¥–∞!)

::

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Domain Events

1. **–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è —ñ–Ω—à–∏—Ö —Å–∏—Å—Ç–µ–º**
2. **Trigger –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤**
3. **Audit trail** (Event Sourcing ‚Äî –ì–ª–∞–≤–∞ 7)
4. **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—è –º—ñ–∂ aggregates**

---

## –î–æ–º–µ–Ω–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏ (Domain Services)

–Ü–Ω–æ–¥—ñ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ **–Ω–µ –Ω–∞–ª–µ–∂–∏—Ç—å** –∂–æ–¥–Ω–æ–º—É aggregate.

```csharp
// –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞, —â–æ –ø—Ä–∞—Ü—é—î –∑ –ö–Ü–õ–¨–ö–û–ú–ê aggregates
public class TransferMoneyService
{
    public void Transfer(Account from, Account to, decimal amount)
    {
        // –õ–æ–≥—ñ–∫–∞ –Ω–µ –Ω–∞–ª–µ–∂–∏—Ç—å –Ω—ñ from, –Ω—ñ to
        if (amount <= 0)
        {
            throw new ArgumentException("Amount must be positive");
        }

        from.Withdraw(amount);
        to.Deposit(amount);

        // Domain Events
        from.AddEvent(new MoneyWithdrawn(from.Id, amount));
        to.AddEvent(new MoneyDeposited(to.Id, amount));
    }
}
```

::tip{icon="ph:circle-wavy-warning"}
**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Domain Service?**

‚úÖ –û–ø–µ—Ä–∞—Ü—ñ—ó –Ω–∞ –∫—ñ–ª—å–∫–æ—Ö aggregates  
‚úÖ Stateless –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞  
‚úÖ –õ–æ–≥—ñ–∫–∞, —â–æ –Ω–µ –≤–ø–∏—Å—É—î—Ç—å—Å—è –≤ –∂–æ–¥–µ–Ω aggregate

‚ùå –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è logic –≤ aggregates!
::

---

## –í–∏—Å–Ω–æ–≤–æ–∫

–£ —Ü—ñ–π –≥–ª–∞–≤—ñ —Ä–æ–∑–≥–ª—è–Ω—É–ª–∏ **Domain Model pattern** —ñ –π–æ–≥–æ –±—É–¥—ñ–≤–µ–ª—å–Ω—ñ –±–ª–æ–∫–∏:

::card-group
::card{icon="mdi:tag-outline"}
#title
Value Objects
#description
–û–±'—î–∫—Ç–∏, —â–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—é—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏. Immutable, –±–µ–∑ —è–≤–Ω–æ–≥–æ ID.

**–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏**: –∑–∞–≤–∂–¥–∏, –∫–æ–ª–∏ –º–æ–∂–ª–∏–≤–æ!
::

::card{icon="mdi:identifier"}
#title
Entities
#description
–û–±'—î–∫—Ç–∏ –∑ —è–≤–Ω–∏–º –ø–æ–ª–µ–º ID. Mutable, lifecycle-oriented.

**–†–µ–∞–ª—ñ–∑—É—é—Ç—å—Å—è**: —Ç—ñ–ª—å–∫–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ Aggregates.
::

::card{icon="mdi:shield-check"}
#title
Aggregates
#description
–ì—Ä–∞–Ω–∏—Ü—ñ —É–∑–≥–æ–¥–∂–µ–Ω–Ω–æ—Å—Ç—ñ —Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π. –ó–∞—Ö–∏—â–∞—é—Ç—å invariants.

**–û–¥–Ω–µ –ø—Ä–∞–≤–∏–ª–æ**: –û–¥–∏–Ω aggregate –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é!
::

::card{icon="mdi:bell"}
#title
Domain Events
#description
–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç—å –∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É. –ú–∏–Ω—É–ª–∏–π —á–∞—Å. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –º—ñ–∂ —Å–∏—Å—Ç–µ–º–∞–º–∏.
::

::card{icon="mdi:cog"}
#title
Domain Services
#description
Stateless –æ–ø–µ—Ä–∞—Ü—ñ—ó –Ω–∞ –∫—ñ–ª—å–∫–æ—Ö aggregates.
::
::

::tip{icon="ph:arrow-right"}
**–©–æ –¥–∞–ª—ñ?**

–£ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π –≥–ª–∞–≤—ñ —Ä–æ–∑–≥–ª—è–Ω–µ–º–æ, —è–∫ **–º–æ–¥–µ–ª—é–≤–∞—Ç–∏ —Ñ–∞–∫—Ç–æ—Ä —á–∞—Å—É** —á–µ—Ä–µ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω **Event Sourcing** ‚Äî –¥–µ –ø–æ–¥—ñ—ó —Å—Ç–∞—é—Ç—å –¥–∂–µ—Ä–µ–ª–æ–º –∏—Å—Ç–∏–Ω–∏, –∞ –Ω–µ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω.
::
