---
title: '–ú–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è —Ñ–∞–∫—Ç–æ—Ä–∞ —á–∞—Å—É'
description: 'Event Sourcing pattern –¥–ª—è –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è —Ç–µ–º–ø–æ—Ä–∞–ª—å–Ω–æ—ó dimens—ñ—ó –≤ Domain-Driven Design'
---

# –ú–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è —Ñ–∞–∫—Ç–æ—Ä–∞ —á–∞—Å—É (Modeling the Dimension of Time)

::note{icon="fluent:history-24-filled"}
**–ö–ª—é—á–æ–≤–∞ —ñ–¥–µ—è –≥–ª–∞–≤–∏**

–¢—Ä–∞–¥–∏—Ü—ñ–π–Ω—ñ –ø—ñ–¥—Ö–æ–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å **–ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω** –æ–±'—î–∫—Ç—ñ–≤. –ê–ª–µ —ñ–Ω–æ–¥—ñ –±—ñ–∑–Ω–µ—Å—É –ø–æ—Ç—Ä—ñ–±–Ω–∞ **—ñ—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω** ‚Äî —è–∫ –æ–±'—î–∫—Ç –¥–æ—Å—è–≥ —Å–≤–æ–≥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É? –°–∞–º–µ —Ç—É—Ç –¥–æ–ø–æ–º–∞–≥–∞—î **Event Sourcing**.
::

## –í–≤–µ–¥–µ–Ω–Ω—è: –©–æ –≤—ñ–¥—Å—É—Ç–Ω—î?

–†–æ–∑–≥–ª—è–Ω–µ–º–æ —Ç–∞–±–ª–∏—Ü—é —Å–∏—Å—Ç–µ–º–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–º–∏ –∫–ª—ñ—î–Ω—Ç–∞–º–∏ (leads):

::mermaid

```mermaid
erDiagram
    LEADS {
        int id PK
        string first_name
        string last_name
        string status
        string phone
        datetime followup_on
        datetime created_at
        datetime updated_at
    }
```

::

### –ü—Ä–∏–∫–ª–∞–¥ –¥–∞–Ω–∏—Ö

| ID  | First Name | Last Name | Status    | Phone    | Followup On | Created At | Updated At |
| --- | ---------- | --------- | --------- | -------- | ----------- | ---------- | ---------- |
| 1   | John       | Doe       | NEW_LEAD  | 555-1234 | NULL        | 2019-11-19 | 2019-11-19 |
| 2   | Jane       | Smith     | CONVERTED | 555-5678 | NULL        | 2019-11-20 | 2019-11-25 |
| 12  | Casey      | Davis     | CONVERTED | 555-8101 | NULL        | 2020-05-20 | 2020-05-27 |

::warning{icon="ph:question"}
**–ü–∏—Ç–∞–Ω–Ω—è –¥–ª—è —Ä–æ–∑–¥—É–º—ñ–≤**

–¢–∞–±–ª–∏—Ü—è –¥–æ–∫—É–º–µ–Ω—Ç—É—î **–ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω** –ª—ñ–¥—ñ–≤. –ê–ª–µ —á–æ–≥–æ –≤ –Ω—ñ–π **–Ω–µ –≤–∏—Å—Ç–∞—á–∞—î**?

–ú–∏ –º–æ–∂–µ–º–æ –±–∞—á–∏—Ç–∏:

- ‚úÖ –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å –∫–æ–∂–Ω–æ–≥–æ –ª—ñ–¥–∞
- ‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
- ‚úÖ –î–∞—Ç—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –π –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

–ê–ª–µ **–Ω–µ –º–æ–∂–µ–º–æ** –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏:

- ‚ùå –°–∫—ñ–ª—å–∫–∏ –¥–∑–≤—ñ–Ω–∫—ñ–≤ –±—É–ª–æ –∑—Ä–æ–±–ª–µ–Ω–æ –¥–æ –∫–æ–Ω–≤–µ—Ä—Å—ñ—ó?
- ‚ùå –ß–∏ –±—É–ª–∞ –ø–æ–∫—É–ø–∫–∞ –∑–¥—ñ–π—Å–Ω–µ–Ω–∞ –æ–¥—Ä–∞–∑—É, —á–∏ –±—É–ª–∞ –¥–æ–≤–≥–∞ –≤–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤?
- ‚ùå –ß–∏ –≤–∞—Ä—Ç–æ –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞—Ç–∏ –Ω–∞–º–∞–≥–∞—Ç–∏—Å—è –∑ –ª—ñ–¥–æ–º –ø—ñ—Å–ª—è N —Å–ø—Ä–æ–±?

::

### –ü—Ä–æ–±–ª–µ–º–∞: –í—ñ–¥—Å—É—Ç–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

–¢–∞–±–ª–∏—Ü—è –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î **snapshot** –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É, –∞–ª–µ –≤ –Ω—ñ–π **–≤—ñ–¥—Å—É—Ç–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è** –ø—Ä–æ —Ç–µ, —è–∫ –∫–æ–∂–µ–Ω –ª—ñ–¥ –¥–æ—Å—è–≥ —Å–≤–æ–≥–æ —Å—Ç–∞–Ω—É:

::mermaid

```mermaid
graph LR
    Q1[NEW_LEAD] -->|???| Q2[FOLLOWUP_SET]
    Q2 -->|???| Q3[PENDING_PAYMENT]
    Q3 -->|???| Q4[CONVERTED]

    style Q1 fill:#ffcdd2
    style Q2 fill:#fff3e0
    style Q3 fill:#e3f2fd
    style Q4 fill:#c8e6c9
```

::

::note{icon="ph:chart-line"}
**–ë—ñ–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–∏**

–ó —Ç–æ—á–∫–∏ –∑–æ—Ä—É –±—ñ–∑–Ω–µ—Å—É –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ:

- üìä –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ
- üéØ –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å –ø—Ä–æ–¥–∞–∂—ñ–≤
- üìà –í –º—á–∏—Ç–∏—Å—è –Ω–∞ –¥–æ—Å–≤—ñ–¥—ñ

–û–¥–∏–Ω —ñ–∑ —Å–ø–æ—Å–æ–±—ñ–≤ –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **Event Sourcing**.
::

---

## –ü–æ–¥—ñ—ó —è–∫ –¥–∂–µ—Ä–µ–ª–æ –¥–∞–Ω–∏—Ö (Event Sourcing)

> Event Sourcing –≤–≤–æ–¥–∏—Ç—å –≤ –º–æ–¥–µ–ª—å –¥–∞–Ω–∏—Ö **—Ñ–∞–∫—Ç–æ—Ä —á–∞—Å—É**. –ó–∞–º—ñ—Å—Ç—å —Å—Ö–µ–º–∏, —â–æ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –∞–≥—Ä–µ–≥–∞—Ç—ñ–≤, —Å–∏—Å—Ç–µ–º–∞ –∑–±–µ—Ä—ñ–≥–∞—î **–ø–æ–¥—ñ—ó**, —â–æ —Ñ—ñ–∫—Å—É—é—Ç—å –∫–æ–∂–Ω—É –∑–º—ñ–Ω—É –≤ –∂–∏—Ç—Ç—î–≤–æ–º—É —Ü–∏–∫–ª—ñ –∞–≥—Ä–µ–≥–∞—Ç–∞.

::mermaid

```mermaid
graph TB
    subgraph "Traditional State-Based"
        DB1[(Current State<br/>Database)]
        UPDATE[UPDATE operations]
        UPDATE -->|overwrite| DB1
    end

    subgraph "Event Sourcing"
        ES[(Event Store<br/>Append-Only)]
        EVENTS[Domain Events]
        EVENTS -->|append| ES
        ES -->|project| STATE[Current State]
    end

    style DB1 fill:#ffcdd2
    style UPDATE fill:#ffcdd2
    style ES fill:#c8e6c9
    style EVENTS fill:#c8e6c9
    style STATE fill:#e3f2fd
```

::

### –ü—Ä–∏–∫–ª–∞–¥: –ñ–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –ª—ñ–¥–∞ Casey Davis

–†–æ–∑–≥–ª—è–Ω–µ–º–æ **CONVERTED**-–∫–ª—ñ—î–Ω—Ç–∞ –∑ ID 12. –í Event Sourcing –π–æ–≥–æ –¥–∞–Ω—ñ –≤–∏–≥–ª—è–¥–∞—é—Ç—å —Ç–∞–∫:

```json
// Event 0: Lead initialized
{
  "lead-id": 12,
  "event-id": 0,
  "event-type": "lead-initialized",
  "first-name": "Casey",
  "last-name": "David", // –ü–æ–º–∏–ª–∫–∞ –≤ –ø—Ä—ñ–∑–≤–∏—â—ñ!
  "phone-number": "555-2951",
  "timestamp": "2020-05-20T09:52:55.95Z"
}

// Event 1: First contact
{
  "lead-id": 12,
  "event-id": 1,
  "event-type": "contacted",
  "timestamp": "2020-05-20T12:32:08.24Z"
}

// Event 2: Followup scheduled
{
  "lead-id": 12,
  "event-id": 2,
  "event-type": "followup-set",
  "followup-on": "2020-05-27T12:00:00.00Z",
  "timestamp": "2020-05-20T12:32:08.24Z"
}

// Event 3: Contact details corrected
{
  "lead-id": 12,
  "event-id": 3,
  "event-type": "contact-details-updated",
  "first-name": "Casey",
  "last-name": "Davis", // ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ
  "phone-number": "555-8101", // –ù–æ–≤–∏–π –Ω–æ–º–µ—Ä
  "timestamp": "2020-05-20T12:32:08.24Z"
}

// Event 4: Second contact
{
  "lead-id": 12,
  "event-id": 4,
  "event-type": "contacted",
  "timestamp": "2020-05-27T12:02:12.51Z"
}

// Event 5: Order submitted
{
  "lead-id": 12,
  "event-id": 5,
  "event-type": "order-submitted",
  "payment-deadline": "2020-05-30T12:02:12.51Z",
  "timestamp": "2020-05-27T12:02:12.51Z"
}

// Event 6: Payment confirmed
{
  "lead-id": 12,
  "event-id": 6,
  "event-type": "payment-confirmed",
  "status": "converted",
  "timestamp": "2020-05-27T12:38:44.12Z"
}
```

::tip{icon="ph:book-open"}
**–Ü—Å—Ç–æ—Ä—ñ—è –∫–ª—ñ—î–Ω—Ç–∞**

–ü–æ–¥—ñ—ó —Ä–æ–∑–ø–æ–≤—ñ–¥–∞—é—Ç—å **–ø–æ–≤–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é**:

1. ‚è∞ **09:52** ‚Äì –õ—ñ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—ñ
2. üìû **12:32** ‚Äì –î–∑–≤—ñ–Ω–æ–∫ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (—á–µ—Ä–µ–∑ ~2.5 –≥–æ–¥–∏–Ω–∏)
3. üìÖ **12:32** ‚Äì Followup –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å
4. ‚úèÔ∏è **12:32** ‚Äì –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–º–∏–ª–∫—É –≤ –ø—Ä—ñ–∑–≤–∏—â—ñ + –Ω–æ–≤–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω
5. üìû **27.05 12:02** ‚Äì –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –¥–∑–≤—ñ–Ω–æ–∫ (–≤ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏–π —á–∞—Å)
6. üõí **12:02** ‚Äì –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ
7. ‚úÖ **12:38** ‚Äì –û–ø–ª–∞—Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞ (~30 —Ö–≤) ‚Üí CONVERTED!

–¶–µ **–Ω–∞–±–∞–≥–∞—Ç–æ –±–∞–≥–∞—Ç—à–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è**, –Ω—ñ–∂ –ø—Ä–æ—Å—Ç–æ "status = CONVERTED"!
::

---

## –ü—Ä–æ–µ–∫—Ü—ñ—è —Å—Ç–∞–Ω—É (State Projection)

–°—Ç–∞–Ω –∫–ª—ñ—î–Ω—Ç–∞ –º–æ–∂–Ω–∞ **–ª–µ–≥–∫–æ —Å–ø—Ä–æ–µ–∫—Ç—É –≤–∞—Ç–∏** –∑—ñ –ø–æ–¥—ñ–π, –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ –¥–æ–¥–∞—é—á–∏ –ª–æ–≥—ñ–∫—É –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ –∫–æ–∂–Ω–æ—ó –ø–æ–¥—ñ—ó:

```csharp
public class LeadProjection
{
    public long LeadId { get; private set; }
    public string FirstName { get; private set; }
    public string LastName { get; private set; }
    public string PhoneNumber { get; private set; }
    public LeadStatus Status { get; private set; }
    public int Version { get; private set; } // –õ—ñ—á–∏–ª—å–Ω–∏–∫ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ–π

    public void Apply(LeadInitialized @event)
    {
        LeadId = @event.LeadId;
        FirstName = @event.FirstName;
        LastName = @event.LastName;
        PhoneNumber = @event.PhoneNumber;
        Status = LeadStatus.NEW_LEAD;
        Version = 0;
    }

    public void Apply(ContactDetailsChanged @event)
    {
        FirstName = @event.FirstName;
        LastName = @event.LastName;
        PhoneNumber = @event.PhoneNumber;
        Version += 1;
    }

    public void Apply(Contacted @event)
    {
        Version += 1;
    }

    public void Apply(FollowupSet @event)
    {
        Status = LeadStatus.FOLLOWUP_SET;
        Version += 1;
    }

    public void Apply(OrderSubmitted @event)
    {
        Status = LeadStatus.PENDING_PAYMENT;
        Version += 1;
    }

    public void Apply(PaymentConfirmed @event)
    {
        Status = LeadStatus.CONVERTED;
        Version += 1;
    }
}
```

::accordion
::accordion-item{title="–Ø–∫ –ø—Ä–∞—Ü—é—î –ø—Ä–æ–µ–∫—Ü—ñ—è"}
**–ü—Ä–æ—Ü–µ—Å**:

1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ –ø–æ–¥—ñ—ó –ª—ñ–¥–∞
2. –ü–µ—Ä–µ–¥–∞—î–º–æ –∫–æ–∂–Ω—É –ø–æ–¥—ñ—é —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –º–µ—Ç–æ–¥ `Apply()`
3. Projection accumulates state
4. –û—Ç—Ä–∏–º—É—î–º–æ **—Ç–æ—á–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è** –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É

**–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è Casey Davis**:

```
LeadId: 12
FirstName: "Casey"
LastName: "Davis"
PhoneNumber: "555-8101"
Status: CONVERTED
Version: 6
```

::
::

### –ü–æ–ª–µ Version: –õ—ñ—á–∏–ª—å–Ω–∏–∫ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ–π

::tip{icon="ph:number-circle-six"}
**Version —è–∫ audit trail**

`Version` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î **–∑–∞–≥–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ–π**, –≤–Ω–µ—Å–µ–Ω–∏—Ö —É –±—ñ–∑–Ω–µ—Å-—Å—É—Ç–Ω—ñ—Å—Ç—å.

**–ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å**: –Ø–∫—â–æ –¥–æ–¥–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ **–ø—ñ–¥m–Ω–æ–∂–∏–Ω—É –ø–æ–¥—ñ–π** ‚Üí ¬´–ø–æ–¥–æ—Ä–æ–∂ —É —á–∞—Å—ñ¬ª (time travel)!

**–ü—Ä–∏–∫–ª–∞–¥**: –©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞–Ω –æ–±'—î–∫—Ç–∞ —É –≤–µ—Ä—Å—ñ—ó 3, –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—ñ 3 –ø–æ–¥—ñ—ó.
::

---

## –ö—ñ–ª—å–∫–∞ –ø—Ä–æ–µ–∫—Ü—ñ–π –∑ –æ–¥–Ω–∏—Ö –ø–æ–¥—ñ–π

::note{icon="ph:projector-screen"}
**–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å Event Sourcing**

–ü–æ–¥—ñ—ó —î **—î–¥–∏–Ω–∏–º –¥–∂–µ—Ä–µ–ª–æ–º —ñ—Å—Ç–∏–Ω–∏**. –ó –Ω–∏—Ö –º–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ **–∫—ñ–ª—å–∫–∞ —Ä—ñ–∑–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ü—ñ–π** –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –ø–æ—Ç—Ä–µ–±!
::

### –ü—Ä–æ–µ–∫—Ü—ñ—è 1: –ü–æ—à—É–∫–æ–≤–∞ –º–æ–¥–µ–ª—å (Search Model)

**–ë—ñ–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–∞**: –¢–æ—Ä–≥–æ–≤—ñ –∞–≥–µ–Ω—Ç–∏ can –Ω–µ –∑–Ω–∞—Ç–∏ –ø—Ä–æ –∑–º—ñ–Ω–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó, –≤–Ω–µ—Å–µ–Ω—ñ —ñ–Ω—à–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏. –ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–æ—à—É–∫ –∑–∞ **—ñ—Å—Ç–æ—Ä–∏—á–Ω–∏–º–∏** –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏.

```csharp
public class LeadSearchModelProjection
{
    public long LeadId { get; private set; }
    public HashSet<string> FirstNames { get; private set; } // ‚úÖ –í—Å—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏
    public HashSet<string> LastNames { get; private set; }  // ‚úÖ –í—Å—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏
    public HashSet<PhoneNumber> PhoneNumbers { get; private set; }
    public int Version { get; private set; }

    public void Apply(LeadInitialized @event)
    {
        LeadId = @event.LeadId;
        FirstNames = new HashSet<string>();
        LastNames = new HashSet<string>();
        PhoneNumbers = new HashSet<PhoneNumber>();

        // –î–æ–¥–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
        FirstNames.Add(@event.FirstName);
        LastNames.Add(@event.LastName);
        PhoneNumbers.Add(@event.PhoneNumber);
        Version = 0;
    }

    public void Apply(ContactDetailsChanged @event)
    {
        // ‚úÖ –î–æ–¥–∞—î–º–æ –¥–æ –º–Ω–æ–∂–∏–Ω–∏, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ!
        FirstNames.Add(@event.FirstName);
        LastNames.Add(@event.LastName);
        PhoneNumbers.Add(@event.PhoneNumber);
        Version += 1;
    }

    // –Ü–Ω—à—ñ –ø–æ–¥—ñ—ó —ñ–≥–Ω–æ—Ä—É—î–º–æ (–Ω–µ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –ø–æ—à—É–∫)
    public void Apply(Contacted @event) { Version += 1; }
    public void Apply(FollowupSet @event) { Version += 1; }
    public void Apply(OrderSubmitted @event) { Version += 1; }
    public void Apply(PaymentConfirmed @event) { Version += 1; }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è Casey Davis**:

```
LeadId: 12
FirstNames: ["Casey"]
LastNames: ["David", "Davis"] // ‚úÖ –û–±–∏–¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏!
PhoneNumbers: ["555-2951", "555-8101"] // ‚úÖ –û–±–∏–¥–≤–∞ –Ω–æ–º–µ—Ä–∏!
Version: 6
```

::tip{icon="ph:magnifying-glass"}
**–ü–µ—Ä–µ–≤–∞–≥–∏ –¥–ª—è –±—ñ–∑–Ω–µ—Å—É**

–ê–≥–µ–Ω—Ç –º–æ–∂–µ –∑–Ω–∞–π—Ç–∏ –ª—ñ–¥–∞ –∑–∞ **—Å—Ç–∞—Ä–∏–º –ø—Ä—ñ–∑–≤–∏—â–µ–º** "David" –∞–±–æ **—Å—Ç–∞—Ä–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º** "555-2951", –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∏ –≤–∂–µ –∑–º—ñ–Ω–∏–ª–∏—Å—è!
::

---

### –ü—Ä–æ–µ–∫—Ü—ñ—è 2: Analytical Model

**–ë—ñ–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–∞**: –í—ñ–¥–¥—ñ–ª –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ —Ö–æ—á–µ –∫—ñ–ª—å–∫—ñ—Å—Ç—å followup calls –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –ø—Ä–æ—Ü–µ—Å—É –ø—Ä–æ–¥–∞–∂—ñ–≤.

```csharp
public class AnalysisModelProjection
{
    public long LeadId { get; private set; }
    public int Followups { get; private set; } // ‚úÖ –õ—ñ—á–∏–ª—å–Ω–∏–∫ followups
    public LeadStatus Status { get; private set; }
    public int Version { get; private set; }

    public void Apply(LeadInitialized @event)
    {
        LeadId = @event.LeadId;
        Followups = 0;
        Status = LeadStatus.NEW_LEAD;
        Version = 0;
    }

    public void Apply(FollowupSet @event)
    {
        Status = LeadStatus.FOLLOWUP_SET;
        Followups += 1; // ‚úÖ –ü—ñ–¥—Ä–∞—Ö–æ—Ä followups!
        Version += 1;
    }

    public void Apply(OrderSubmitted @event)
    {
        Status = LeadStatus.PENDING_PAYMENT;
        Version += 1;
    }

    public void Apply(PaymentConfirmed @event)
    {
        Status = LeadStatus.CONVERTED;
        Version += 1;
    }

    // –Ü–Ω—à—ñ –ò–≥—Ä–Ω–æ—Ä—É—î–º–æ
    public void Apply(Contacted @event) { Version += 1; }
    public void Apply(ContactDetailsChanged @event) { Version += 1; }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è Casey Davis**:

```
LeadId: 12
Followups: 1
Status: CONVERTED
Version: 6
```

::tip{icon="ph:chart-bar"}
**–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞**

–ê–Ω–∞–ª—ñ—Ç–∏–∫–∏ –º–æ–∂—É—Ç—å:

- –ü–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å followups –¥–ª—è CONVERTED vs CLOSED –ª—ñ–¥—ñ–≤
- –í–∏–∑–Ω–∞—á–∞—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–±
- –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –∑–∞ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –¥–ª—è ML-–º–æ–¥–µ–ª–µ–π

::

---

## –î–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏ (Source of Truth)

::warning{icon="ph:database-arrow"}
**–ó–æ–ª–æ—Ç–µ –ø—Ä–∞–≤–∏–ª–æ Event Sourcing**

–í—Å—ñ –∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É –æ–±'—î–∫—Ç–∞ **–º–∞—é—Ç—å** –±—É—Ç–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ñ —ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ —è–∫ –ø–æ–¥—ñ—ó. –ü–æ–¥—ñ—ó —Å—Ç–∞—é—Ç—å –¥–ª—è —Å–∏—Å—Ç–µ–º–∏ **–¥–∂–µ—Ä–µ–ª–æ–º —ñ—Å—Ç–∏–Ω–∏** (source of truth).
::

::mermaid

```mermaid
graph TB
    CMD[Command] -->|Execute| AR[Aggregate]
    AR -->|Generate| EVENTS[Domain Events]
    EVENTS -->|Append| ES[(Event Store<br/>SOURCE OF TRUTH)]

    ES -->|Project| PROJ1[Projection 1<br/>Read Model DB]
    ES -->|Project| PROJ2[Projection 2<br/>Elasticsearch]
    ES -->|Project| PROJ3[Projection 3<br/>Analytics DB]

    style ES fill:#4caf50
    style PROJ1 fill:#e3f2fd
    style PROJ2 fill:#e3f2fd
    style PROJ3 fill:#e3f2fd
```

::

–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö, –¥–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ø–æ–¥—ñ—ó, —î **—î–¥–∏–Ω–∏–º —Å—Ç—Ä–æ–≥–æ —É–∑–≥–æ–¥–∂–µ–Ω–∏–º —Å—Ö–æ–≤–∏—â–µ–º** (single source of truth).

::note{icon="ph:archive"}
**Event Store**

–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–¥—ñ–π –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è **event store** (—Å—Ö–æ–≤–∏—â–µ –ø–æ–¥—ñ–π).
::

---

## Event Store: –í–∏–º–æ–≥–∏

Event Store **–Ω–µ –º–∞—î** –¥–æ–∑–≤–æ–ª—è—Ç–∏ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∞–±–æ –≤–∏–¥–∞–ª—è—Ç–∏ –ø–æ–¥—ñ—ó (–∑–∞ –≤–∏–Ω—è—Ç–∫–æ–º –≤–∏–∫–ª—é—á–Ω–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤, —è–∫ –º—ñ–≥—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö).

### –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```csharp
interface IEventStore
{
    // ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –ø–æ–¥—ñ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Å—É—Ç–Ω–æ—Å—Ç—ñ
    IEnumerable<Event> Fetch(Guid instanceId);

    // ‚úÖ –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –ø–æ–¥—ñ–π
    void Append(Guid instanceId, Event[] newEvents, int expectedVersion);
}
```

::accordion
::accordion-item{title="–ü–∞—Ä–∞–º–µ—Ç—Ä expectedVersion"}
**–ú–µ—Ç–∞**: –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è **optimistic concurrency control**.

–ü—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –Ω–æ–≤–∏—Ö –ø–æ–¥—ñ–π –≤–∫–∞–∑—É—î—Ç—å—Å—è **–≤–µ—Ä—Å—ñ—è —Å—É—Ç–Ω–æ—Å—Ç—ñ**, –Ω–∞ —è–∫—ñ–π –±–∞–∑—É—é—Ç—å—Å—è —Ä—ñ—à–µ–Ω–Ω—è.

**–Ø–∫—â–æ —Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞** (–ø—ñ—Å–ª—è `expectedVersion` –±—É–ª–∏ –¥–æ–¥–∞–Ω—ñ –Ω–æ–≤—ñ –ø–æ–¥—ñ—ó —ñ–Ω—à–∏–º –ø—Ä–æ—Ü–µ—Å–æ–º) ‚Üí Event Store –º–∞—î **–ø–æ—Ä—É—à—É–≤–∞—Ç–∏ concurrency exception**.

**–ü—Ä–∏–∫–ª–∞–¥**:

```csharp
// Process A
var events = eventStore.Fetch(leadId); // version = 5
var lead = new Lead();
foreach (var e in events) lead.Apply(e);

lead.Escalate(); // –ì–µ–Ω–µ—Ä—É—î –Ω–æ–≤—É –ø–æ–¥—ñ—é
eventStore.Append(leadId, lead.NewEvents, expectedVersion: 5);
// ‚úÖ –£—Å–ø—ñ—Ö, —è–∫—â–æ version –≤—Å–µ —â–µ = 5

// Process B (concurrent)
eventStore.Append(leadId, otherEvents, expectedVersion: 5);
// ‚ùå Exception! Version –≤–∂–µ = 6 (Process A –≤–∏–ø–µ—Ä–µ–¥–∏–≤)
```

::
::

::note{icon="ph:book"}
**–ê–Ω–∞–ª–æ–≥—ñ—è: –ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å—å–∫–∏–π –æ–±–ª—ñ–∫**

–ü–æ —Å–≤–æ—ó–π —Å—É—Ç—ñ, Event Sourcing –Ω–µ —î —á–∏–º–æ—Å—å –Ω–æ–≤–∏–º. **–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ —ñ–Ω–¥—É—Å—Ç—Ä—ñ—è** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–æ–¥—ñ—ó –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –∑–º—ñ–Ω —É –±—É—Ö–≥–∞–ªt–µ—Ä—Å—å–∫–æ–º—É —Ä–µ—î—Å—Ç—Ä—ñ.

–†–µ—î—Å—Ç—Ä (ledger) ‚Äî —Ü–µ –∂—É—Ä–Ω–∞–ª, –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π **—Ç—ñ–ª—å–∫–∏ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è** –∑–∞–ø–∏—Å—ñ–≤, –≤ —è–∫–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É—é—Ç—å—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó. –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –±–∞–ª–∞–Ω—Å —Ä–∞—Ö—É–Ω–∫—É) –∑–∞–≤–∂–¥–∏ –º–æ–∂–Ω–∞ –≤–∏–≤–µ—Å—Ç–∏ —à–ª—è—Ö–æ–º ¬´–ø—Ä–æ–µ–∫—Ü—ñ—ó¬ª –∑–∞–ø–∏—Å—ñ–≤ —Ä–µ—î—Å—Ç—Ä—É.
::

---

## Event-Based Domain Model

–ú–æ–¥–µ–ª—å –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Event Sourcing, –ø—Ä–∞—Ü—é—î –∑–∞ –º–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–º —Å—Ü–µ–Ω–∞—Ä—ñ—î–º:

::steps

### –ö—Ä–æ–∫ 1: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–¥—ñ–π

–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–¥—ñ—ó –ø—Ä–µ–¥–º–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ (domain events) aggregate –∑ Event Store.

### –ö—Ä–æ–∫ 2: –†–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è —Å—Ç–∞–Ω—É

Vo—Å—Å–æ–∑–¥–∞—Ç–∏ —Å—Ç–∞–Ω ‚Äî —Å–ø—Ä–æ–µ–∫—Ç—É –≤–∞—Ç–∏ –ø–æ–¥—ñ—ó —É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –¥–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è –±—ñ–∑–Ω–µ—Å-—Ä—ñ—à–µ–Ω—å.

### –ö—Ä–æ–∫ 3: –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏

–í–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ aggregate ‚Üí –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ **–Ω–æ–≤—ñ** domain events.

### –ö—Ä–æ–∫ 4: –§—ñ–∫—Å–∞—Ü—ñ—è –ø–æ–¥—ñ–π

–ó–∞—Ñ—ñ–∫—Å–∏—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ domain events —É Event Store.
::

### –ü—Ä–∏–∫–ª–∞–¥: Ticket Aggregate (Event-Sourced)

**Application Layer** —Å–ª—ñ–¥—É—î —Å—Ü–µ–Ω–∞—Ä—ñ—é –≤–∏—â–µ:

```csharp
public class TicketAPI
{
    private IEventStore _eventStore;

    public void RequestEscalation(TicketId id, EscalationReason reason)
    {
        // ‚úÖ –ö—Ä–æ–∫ 1: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ–¥—ñ—ó
        var events = _eventStore.Fetch(id);

        // ‚úÖ –ö—Ä–æ–∫ 2: –†–µ–∫–æ–Ω—Å—Ç—Ä—É—é—î–º–æ —Å—Ç–∞–Ω
        var ticket = new Ticket();
        foreach (var @event in events)
        {
            ticket.Apply(@event);
        }

        // ‚úÖ –ö—Ä–æ–∫ 3: –í–∏–∫–æ–Ω—É—î–º–æ –∫–æ–º–∞–Ω–¥—É
        ticket.RequestEscalation(reason);

        // ‚úÖ –ö—Ä–æ–∫ 4: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–æ–≤—ñ –ø–æ–¥—ñ—ó
        var newEvents = ticket.GetUncommittedEvents();
        _eventStore.Append(id, newEvents, ticket.Version);
    }
}
```

**Ticket Aggregate (Event-Sourced)**:

```csharp
public class Ticket
{
    private TicketId _id;
    private TicketStatus _status;
    private Priority _priority;
    private List<IDomainEvent> _uncommittedEvents = new();
    public int Version { get; private set; }

    // ‚úÖ State reconstruction –≤—ñ–¥ –ø–æ–¥—ñ–π
    public void Apply(TicketInitialized @event)
    {
        _id = @event.TicketId;
        _status = TicketStatus.Open;
        _priority = @event.Priority;
        Version++;
    }

    public void Apply(TicketEscalated @event)
    {
        _status = TicketStatus.Escalated;
        _priority = IncreasePriority(_priority);
        Version++;
    }

    // ‚úÖ Command: –≥–µ–Ω–µ—Ä—É—î –ø–æ–¥—ñ—ó
    public void RequestEscalation(EscalationReason reason)
    {
        if (_status == TicketStatus.Closed)
        {
            throw new InvalidOperationException("Cannot escalate closed ticket");
        }

        // –ì–µ–Ω–µ—Ä—É—î–º–æ –ø–æ–¥—ñ—é –∑–∞–º—ñ—Å—Ç—å –ø—Ä—è–º–æ—ó –∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É
        var @event = new TicketEscalated(_id, reason, DateTime.UtcNow);
        _uncommittedEvents.Add(@event);

        // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
        Apply(@event);
    }

    public IReadOnlyList<IDomainEvent> GetUncommittedEvents()
    {
        return _uncommittedEvents;
    }
}
```

::tip{icon="ph:arrows-clockwise"}
**–ö–ª—é—á–æ–≤–∞ –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å**

–£ —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω—ñ–π Domain Model –∫–æ–º–∞–Ω–¥–∏ **–±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑–º—ñ–Ω—é—é—Ç—å —Å—Ç–∞–Ω**.

–í Event-Sourced Domain Model –∫–æ–º–∞–Ω–¥–∏ **–≥–µ–Ω–µ—Ä—É—é—Ç—å –ø–æ–¥—ñ—ó**, —è–∫—ñ:

1. –î–æ–¥–∞—é—Ç—å—Å—è –¥–æ uncommitted events
2. –ó–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –¥–æ —Å—Ç–∞–Ω—É (—á–µ—Ä–µ–∑ `Apply()`)
3. –ó–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É Event Store

::

---

## Snapshots: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ

::warning{icon="ph:hourglass"}
**–ü—Ä–æ–±–ª–µ–º–∞ –º–∞—Å—à—Ç–∞–±—É**

–Ø–∫—â–æ aggregate –º–∞—î **—Ç–∏—Å—è—á—ñ –ø–æ–¥—ñ–π** ‚Üí –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ –ø—Ä–æ–µ–∫—Ü—ñ—è —Å—Ç–∞—é—Ç—å –ø–æ–≤—ñ–ª—å–Ω–∏–º–∏.

**–†—ñ—à–µ–Ω–Ω—è**: Snaposhots (–∑–Ω—ñ–º–∫–∏ —Å—Ç–∞–Ω—É).
::

### –ú–µ—Ö–∞–Ω—ñ–∑–º Snapshots

::mermaid

```mermaid
graph LR
    E1[Event 1] --> E2[Event 2]
    E2 --> E3[...]
    E3 --> E100[Event 100]
    E100 --> SNAP[Snapshot v100]
    SNAP --> E101[Event 101]
    E101 --> E102[...]
    E102 --> E150[Event 150]

    style SNAP fill:#4caf50
```

::

**–ó–∞–º—ñ—Å—Ç—å** –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö 150 –ø–æ–¥—ñ–π:

1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ **snapshot** –≤–µ—Ä—Å—ñ—ó 100
2. –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ–¥—ñ—ó 101-150

```csharp
public void LoadAggregate(Guid aggregateId)
{
    // ‚úÖ –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ snapshot
    var snapshot = _snapshotStore.GetLatest(aggregateId);

    int fromVersion = 0;
    if (snapshot != null)
    {
        ticket.LoadFromSnapshot(snapshot);
        fromVersion = snapshot.Version;
    }

    // ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ–¥—ñ—ó –ü–Ü–°–õ–Ø snapshot
    var events = _eventStore.Fetch(aggregateId, fromVersion);
    foreach (var @event in events)
    {
        ticket.Apply(@event);
    }
}
```

::accordion
::accordion-item{title="–°—Ç—Ä–∞—Ç–µ–≥—ñ—ó —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Snapshots"}
**–ö–æ–∂–Ω—ñ N –ø–æ–¥—ñ–π**:

```csharp
if (ticket.Version % 100 == 0)
{
    _snapshotStore.Save(ticket.ToSnapshot());
}
```

**–ó–∞ —Ä–æ–∑–∫–ª–∞–¥–æ–º**:

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –ø—Ä–æ—Ü–µ—Å —Å—Ç–≤–æ—Ä—é—î snapshots —É —Ñ–æ–Ω—ñ

**On-demand**:

- –Ø–∫—â–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è > X —Å–µ–∫—É–Ω–¥ ‚Üí trigger snapshot creation

::

::

---

## –ü–µ—Ä–µ–≤–∞–≥–∏ Event Sourcing

::card-group
::card{icon="mdi:history"}
#title
Audit Trail
#description
"–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π" –ø–æ–≤–Ω–∏–π –∞—É–¥–∏—Ç —É—Å—ñ—Ö –∑–º—ñ–Ω. –ö–æ–∂–Ω–∞ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤–∞–Ω–∞ —è–∫ –ø–æ–¥—ñ—è.
::

::card{icon="mdi:clock-time-nine"}
#title
Time Travel
#description
–ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å–ø—Ä–æ–µ–∫—Ç—É–≤–∞—Ç–∏ —Å—Ç–∞–Ω –æ–±'—î–∫—Ç–∞ –≤ **–±—É–¥—å-—è–∫–∏–π –º–æ–º–µ–Ω—Ç** –π–æ–≥–æ –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É.
::

::card{icon="mdi:projector"}
#title
–ö—ñ–ª—å–∫–∞ –ø—Ä–æ–µ–∫—Ü—ñ–π
#description
–û–¥–Ω—ñ –ø–æ–¥—ñ—ó ‚Üí —Ä—ñ–∑–Ω—ñ read models –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –ø–æ—Ç—Ä–µ–± (–ø–æ—à—É–∫, –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞, –∑–≤—ñ—Ç–Ω—ñ—Å—Ç—å).
::

::card{icon="mdi:debug-step-over"}
#title
Debugging
#description
Replay –ø–æ–¥—ñ–π –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–∞–≥—ñ–≤ —ñ —Ä–æ–∑—É–º—ñ–Ω–Ω—è –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ —Å–∏—Å—Ç–µ–º–∏.
::

::card{icon="mdi:scale-balance"}
#title
–ë—ñ–∑–Ω–µ—Å-—ñ–Ω—Å–∞–π—Ç–∏
#description
–ê–Ω–∞–ª—ñ–∑ –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —ñ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ—Ü–µ—Å—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö.
::
::

---

## –ù–µ–¥–æ–ª—ñ–∫–∏ Event Sourcing

::warning{icon="ph:warning-circle"}
**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó**

‚ùå **Learning curve** ‚Äî –∫–æ–º–∞–Ω–¥–∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è  
‚ùå **Event versioning** ‚Äî –µ–≤–æ–ª—é—Ü—ñ—è —Å—Ö–µ–º–∏ –ø–æ–¥—ñ–π —Å–∫–ª–∞–¥–Ω–∞  
‚ùå **Projections** ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–∞ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏  
‚ùå **Eventual consistency** ‚Äî read models –Ω–µ –∑–∞–≤–∂–¥–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ñ  
‚ùå **Debugging** ‚Äî —Å–∫–ª–∞–¥–Ω—ñ—à–µ, –Ω—ñ–∂ traditional CRUD  
::

::warning{icon="ph:database"}
**–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏–∫–ª–∏–∫–∏**

‚ùå **Storage** ‚Äî –ø–æ–¥—ñ—ó –∑–∞–π–º–∞—é—Ç—å –±—ñ–ª—å—à–µ –º—ñ—Å—Ü—è, –Ω—ñ–∂ state-based  
‚ùå **Event Store** ‚Äî –ø–æ—Ç—Ä–µ–±—É—î —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏—Ö —Ä—ñ—à–µ–Ω—å (EventStoreDB, Kafka)  
‚ùå **Snapshots** ‚Äî –¥–æ–¥–∞—Ç–∫–æ–≤–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —ñ storage  
::

---

## –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Event Sourcing?

::card-group
::card{icon="mdi:check-circle"}
#title
–ü—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è
#description
**Audit –≤–∏–º–∞–≥–∞—î—Ç—å—Å—è** ‚Äî —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ —Å–∏—Å—Ç–µ–º–∏, healthcare

**–¢–µ–º–ø–æ—Ä–∞–ª—å–Ω—ñ –∑–∞–ø–∏—Ç–∏** ‚Äî "—Å—Ç–∞–Ω –Ω–∞ 1 —Å—ñ—á–Ω—è 2020"

**–°–∫–ª–∞–¥–Ω–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞** ‚Äî –ø–æ—Ç—Ä–µ–±—É—î –∞–Ω–∞–ª—ñ–∑—É –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É

**Event-driven –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞** ‚Äî —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –ø–æ–¥—ñ—ó

**CQRS** ‚Äî –ø—Ä–∏—Ä–æ–¥–Ω–æ –ø–æ—î–¥–Ω—É—î—Ç—å—Å—è (–ì–ª–∞–≤–∞ 8)
::

::card{icon="mdi:cancel"}
#title
–ù–ï –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è
#description
**–ü—Ä–æ—Å—Ç—ñ CRUD** ‚Äî overhead –Ω–µ –≤–∏–ø—Ä–∞–≤–¥–∞–Ω–∏–π

**–ö–æ–º–∞–Ω–¥–∞ –±–µ–∑ –¥–æ—Å–≤—ñ–¥—É** ‚Äî –≤–∏—Å–æ–∫–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å

**–°—Ç–∞—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ** ‚Äî —è–∫—â–æ –∑–º—ñ–Ω–∏ —Ä—ñ–¥–∫—ñ

**–®–≤–∏–¥–∫—ñ read-heavy –∑–∞–ø–∏—Ç–∏** ‚Äî –ø—Ä–æ–µ–∫—Ü—ñ—ó –ø–æ–≤—ñ–ª—å–Ω—ñ—à—ñ –∑–∞ –ø—Ä—è–º—ñ queries
::
::

---

## –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ CQRS

Event Sourcing –ø—Ä–∏—Ä–æ–¥–Ω–æ –ø–æ—î–¥–Ω—É—î—Ç—å—Å—è –∑ **CQRS** (Command Query Responsibility Segregation):

::mermaid

```mermaid
graph TB
    CMD[Commands] -->|Write| AG[Aggregate]
    AG -->|Generate| EV[Events]
    EV -->|Append| ES[(Event Store)]

    ES -->|Project| RM1[Read Model 1]
    ES -->|Project| RM2[Read Model 2]
    ES -->|Project| RM3[Read Model N]

    QUERY[Queries] -->|Read| RM1
    QUERY -->|Read| RM2
    QUERY -->|Read| RM3

    style ES fill:#4caf50
    style AG fill:#fff3e0
    style RM1 fill:#e3f2fd
    style RM2 fill:#e3f2fd
    style RM3 fill:#e3f2fd
```

::

::tip{icon="ph:arrow-right"}
**–ù–∞—Å—Ç—É–ø–Ω–∞ –≥–ª–∞–≤–∞**

**CQRS** (Command Query Responsibility Segregation) –±—É–¥–µ –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–æ –≤ **–ì–ª–∞–≤—ñ 8**.

Event Sourcing + CQRS = –ø–æ—Ç—É–∂–Ω–∞ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö —Å–∏—Å—Ç–µ–º!
::

---

## –í–∏—Å–Ω–æ–≤–æ–∫

–£ —Ü—ñ–π –≥–ª–∞–≤—ñ —Ä–æ–∑–≥–ª—è–Ω—É–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω **Event Sourcing** –¥–ª—è –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è —Ç–µ–º–ø–æ—Ä–∞–ª—å–Ω–æ—ó —Ä–æ–∑–º—ñ—Ä–Ω–æ—Å—Ç—ñ:

::steps

### –ü–æ–¥—ñ—ó —è–∫ –¥–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏

–ó–∞–º–æ—Å—Ç—å –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –∑–±–µ—Ä—ñ–≥–∞—î–º–æ **–≤—Å—ñ –∑–º—ñ–Ω–∏** —è–∫ –ø–æ–¥—ñ—ó.

### Projections

–ó –ø–æ–¥—ñ–π —Å—Ç–≤–æ—Ä—é—î–º–æ **–∫—ñ–ª—å–∫–∞ —Ä—ñ–∑–Ω–∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—å** –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –ø–æ—Ç—Ä–µ–±.

### Event Store

Append-only –ë–î —î **—î–¥–∏–Ω–∏–º –¥–∂–µ—Ä–µ–ª–æ–º —ñ—Å—Ç–∏–Ω–∏**.

### Event-Based Aggregates

–ö–æ–º–∞–Ω–¥–∏ –≥–µ–Ω–µ—Ä—É—é—Ç—å –ø–æ–¥—ñ—ó, —è–∫—ñ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –¥–æ —Å—Ç–∞–Ω—É.

### Snapshots

–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ –∑–Ω—ñ–º–∫–∏ —Å—Ç–∞–Ω—É.
::

::tip{icon="ph:books"}
**–ü—Ä–æ–≥—Ä–µ—Å—ñ—è –≥–ª–∞–≤ 5-7**

- **–ì–ª–∞–≤–∞ 5**: –ü—Ä–æ—Å—Ç—ñ –ø–∞—Ç—Ç–µ—Ä–Ω–∏ (Transaction Script, Active Record)
- **–ì–ª–∞–≤–∞ 6**: –°–∫–ª–∞–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞ (Domain Model, Aggregates)
- **–ì–ª–∞–≤–∞ 7**: –¢–µ–º–ø–æ—Ä–∞–ª—å–Ω—ñ—Å—Ç—å (Event Sourcing)

–†–∞–∑–æ–º —Ü—ñ –ø–∞—Ç—Ç–µ—Ä–Ω–∏ –ø–æ–∫—Ä–∏–≤–∞—é—Ç—å **–≤–µ—Å—å —Å–ø–µ–∫—Ç—Ä** —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏!
::

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –≤–ø—Ä–∞–≤–∏

::accordion
::accordion-item{title="–í–ø—Ä–∞–≤–∞ 1: –ü—Ä–æ–µ–∫—Ü—ñ—ó"}
–î–∞–Ω–æ –ø–æ–¥—ñ—ó –±–∞–Ω–∫—ñ–≤—Å—å–∫–æ–≥–æ —Ä–∞—Ö—É–Ω–∫—É:

```json
[
    { "type": "account-opened", "balance": 0 },
    { "type": "deposited", "amount": 1000 },
    { "type": "withdrawn", "amount": 200 },
    { "type": "deposited", "amount": 500 },
    { "type": "withdrawn", "amount": 300 }
]
```

**–ü–∏—Ç–∞–Ω–Ω—è**:

1. –Ø–∫–∏–π –ø–æ—Ç–æ—á–Ω–∏–π –±–∞–ª–∞–Ω—Å?
2. –°–∫—ñ–ª—å–∫–∏–æ–ø–µ—Ä–∞—Ü—Ü—ñ–π –±—É–ª–æ –≤–∏–∫–æ–Ω–∞–Ω–æ?
3. –Ø–∫–∏–π –±—É–≤ –±–∞–ª–∞–Ω—Å –º—ñ–∂ –ø–æ–¥—ñ—î—é 2 —ñ 3?

::collapsible{title="–í—ñ–¥–ø–æ–≤—ñ–¥—ñ"}

1. **–ü–æ—Ç–æ—á–Ω–∏–π –±–∞–ª–∞–Ω—Å**: 0 + 1000 - 200 + 500 - 300 = **1000**
2. **–ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ–π**: 4 (excluding account-opened)
3. **–ë–∞–ª–∞–Ω—Å –ø—ñ—Å–ª—è –ø–æ–¥—ñ—ó 2**: 0 + 1000 = **1000**

::

::

::accordion-item{title="–í–ø—Ä–∞–≤–∞ 2: Snapshot —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è"}
–£ –≤–∞—Å —î aggregate –∑ 10,000 –ø–æ–¥—ñ–π. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –ø–æ–¥—ñ–π –∑–∞–π–º–∞—î 5 —Å–µ–∫—É–Ω–¥.

**–ü–∏—Ç–∞–Ω–Ω—è**:

- –Ø–∫ —á–∞—Å—Ç–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ snapshots?
- –Ø–∫–∏–π trade-off –º—ñ–∂ —á–∞—Å—Ç–æ—Ç–æ—é snapshots —ñ storage?

::collapsible{title="–ú—ñ—Ä–∫—É–≤–∞–Ω–Ω—è"}
**–í–∞—Ä—ñ–∞–Ω—Ç–∏**:

A) –ö–æ–∂–Ω—ñ 100 –ø–æ–¥—ñ–π:

- 100 snapshots –ø–æ 10KB = 1MB
- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: snapshot + 100 –ø–æ–¥—ñ–π ‚âà 0.05s

B) –ö–æ–∂–Ω—ñ 1000 –ø–æ–¥—ñ–π:

- 10 snapshots –ø–æ 10KB = 100KB
- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: snapshot + 1000 –ø–æ–¥—ñ–π ‚âà 0.5s

C) –ö–æ–∂–Ω—ñ 5000 –ø–æ–¥—ñ–π:

- 2 snapshots –ø–æ 10KB = 20KB
- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: snapshot + 5000 –ø–æ–¥—ñ–π ‚âà 2.5s

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è**: –í–∞—Ä—ñ–∞–Ω—Ç B ‚Äî –±–∞–ª–∞–Ω—Å –º—ñ–∂ storage —ñ performance.
::
::
::
