---
title: "–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è HTTP API –∑–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏ REST"
description: "Stateless-–¥–∏–∑–∞–π–Ω, –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è –Ω–∞ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏, –∫–µ—à—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ ETag, —É–º–æ–≤–Ω—ñ –∑–∞–ø–∏—Ç–∏ (If-None-Match, If-Match), JWT-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —Ç–∞ –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º–æ–º."
---

# –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è HTTP API –∑–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏ REST

::note
–£ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —Å—Ç–∞—Ç—Ç—è—Ö –º–∏ –≤–∏–≤—á–∏–ª–∏ —Å–∫–ª–∞–¥–æ–≤—ñ HTTP-–∑–∞–ø–∏—Ç—ñ–≤. –¢–µ–ø–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ: **—è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ä–≥–∞–Ω—ñ–∑—É–≤–∞—Ç–∏ HTTP API**, –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—á–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∏ REST –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ. –ú–∞—Ç–µ—Ä—ñ–∞–ª —Ü—ñ—î—ó —Å—Ç–∞—Ç—Ç—ñ –ø–æ–∫–∞–∂–µ, —á–æ–º—É —Ü—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏ ‚Äî –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞ —Ç–µ–æ—Ä—ñ—è, –∞ —Ä–µ–∞–ª—å–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è.
::

## 1. –í—ñ–¥ –º–æ–Ω–æ–ª—ñ—Ç–Ω–æ–≥–æ API –¥–æ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å—ñ–≤

–†–æ–∑–≥–ª—è–Ω–µ–º–æ —Ç–∏–ø–æ–≤–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π: –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∫–∞–≤–∏. –ù–∞ —Å—Ç–∞—Ä—Ç—ñ –¥–æ–¥–∞—Ç–∫—É –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Ç–æ–∫–µ–Ω, –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –π–æ–≥–æ –ø–æ—Ç–æ—á–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.

### –ú–æ–Ω–æ–ª—ñ—Ç–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥

```csharp [–ú–æ–Ω–æ–ª—ñ—Ç–Ω–∏–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç ‚Äî –æ–¥–∏–Ω –∑–∞–ø–∏—Ç –Ω–∞ –≤—Å–µ]
var app = WebApplication.Create(args);

// –û–¥–∏–Ω –µ–Ω–¥–ø–æ—ñ–Ω—Ç –ø–æ–≤–µ—Ä—Ç–∞—î –≤—Å–µ
app.MapGet("/v1/state", async (HttpContext ctx) =>
{
    // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–æ–∫–µ–Ω ‚Üí –æ—Ç—Ä–∏–º–∞—Ç–∏ user_id
    var token = ctx.Request.Headers.Authorization
        .ToString();
    var userId = ValidateToken(token); // stateful!

    // 2. –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å
    var profile = await GetProfile(userId);

    // 3. –û—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    var orders = await GetOrders(userId);

    return Results.Ok(new { profile, orders });
});

app.Run();
```

–¶–µ–π API **–ø–æ—Ä—É—à—É—î –æ–¥—Ä–∞–∑—É –∫—ñ–ª—å–∫–∞ –ø—Ä–∏–Ω—Ü–∏–ø—ñ–≤ REST**:

| –ü—Ä–∏–Ω—Ü–∏–ø | –ü—Ä–æ–±–ª–µ–º–∞ |
|:---|:---|
| Stateless | –°–µ—Ä–≤–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—î —Ç–æ–∫–µ–Ω–∏ –≤ –ø–∞–º'—è—Ç—ñ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è `user_id` |
| –ö–µ—à—É–≤–∞–Ω–Ω—è | –ù–µ–º–∞—î —Å–ø–æ—Å–æ–±—É –∫–µ—à—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —á–∞—Å—Ç–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è, –ø—Ä–æ—Ñ—ñ–ª—å ‚Äî —Ä—ñ–¥–∫–æ) |
| –ë–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤—ñ—Å—Ç—å | –°–∏—Å—Ç–µ–º–∞ –æ–¥–Ω–æ—Ä—ñ–≤–Ω–µ–≤–∞, –¥–æ–¥–∞—Ç–∏ –ø—Ä–æ–∫—Å—ñ –∞–±–æ –∫–µ—à –Ω–µ–º–æ–∂–ª–∏–≤–æ |
| –£–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å | `/v1/state` ‚Äî –Ω–µ —Ä–µ—Å—É—Ä—Å, –∞ ¬´–∑—Ä–æ–±–∏ –º–µ–Ω—ñ –≤—Å–µ¬ª |

### –î–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è –Ω–∞ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏

–ó —Ä–æ—Å—Ç–æ–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∏ –¥–µ–∫–æ–º–ø–æ–∑—É—î–º–æ –º–æ–Ω–æ–ª—ñ—Ç–Ω–∏–π –±–µ–∫–µ–Ω–¥ –Ω–∞ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏:

::mermaid

```mermaid
graph TD
    Client["üì± –ö–ª—ñ—î–Ω—Ç"] --> D["Gateway D"]
    D --> A["–°–µ—Ä–≤—ñ—Å A<br/>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è"]
    D --> B["–°–µ—Ä–≤—ñ—Å B<br/>–ü—Ä–æ—Ñ—ñ–ª—ñ"]
    D --> C["–°–µ—Ä–≤—ñ—Å C<br/>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è"]

    A -.->|"user_id"| D

    style Client fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style D fill:#f59e0b,stroke:#b45309,color:#ffffff
    style A fill:#10b981,stroke:#059669,color:#ffffff
    style B fill:#10b981,stroke:#059669,color:#ffffff
    style C fill:#10b981,stroke:#059669,color:#ffffff
```

::

–ê–ª–µ –Ω–∞—ó–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ —Ç–∞–∫–æ–∂ –º–∞—î –ø—Ä–æ–±–ª–µ–º—É: —Å–µ—Ä–≤—ñ—Å–∏ B —ñ C –ø–æ–≤–∏–Ω–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ —Å–µ—Ä–≤—ñ—Å A, —Å—Ç–≤–æ—Ä—é—é—á–∏ –∑–∞–π–≤–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

### Stateless-—Ä—ñ—à–µ–Ω–Ω—è: –ø–µ—Ä–µ–¥–∞—á–∞ user_id

–ó–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ, —â–æ–± –∫–æ–∂–µ–Ω —Å–µ—Ä–≤—ñ—Å —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤—É–≤–∞–≤ —Ç–æ–∫–µ–Ω, –≥–µ–π—Ç–≤–µ–π D —Ä–æ–±–∏—Ç—å —Ü–µ _–æ–¥–∏–Ω —Ä–∞–∑_ —ñ –ø–µ—Ä–µ–¥–∞—î `user_id` –¥–∞–ª—ñ:

```csharp [Gateway D ‚Äî stateless –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è]
var app = WebApplication.Create(args);

app.MapGet("/v1/state", async (HttpContext ctx) =>
{
    // 1. –ì–µ–π—Ç–≤–µ–π –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ç–æ–∫–µ–Ω –û–î–ò–ù –†–ê–ó
    var token = ctx.Request.Headers.Authorization
        .ToString();
    var userId = await authService
        .ValidateAsync(token);

    // 2. –ó–∞–ø–∏—Ç–∏ –¥–æ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å—ñ–≤ –∑ user_id
    // —è–∫ –Ø–í–ù–ò–ú –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º (stateless!)
    var profileTask = httpClient
        .GetAsync($"/v1/profiles/{userId}");
    var ordersTask = httpClient
        .GetAsync($"/v1/orders?user_id={userId}");

    await Task.WhenAll(profileTask, ordersTask);

    var profile = await profileTask.Result.Content
        .ReadFromJsonAsync<object>();
    var orders = await ordersTask.Result.Content
        .ReadFromJsonAsync<object>();

    return Results.Ok(new { profile, orders });
});

app.Run();
```

–¢–µ–ø–µ—Ä —Å–µ—Ä–≤—ñ—Å B —ñ C –æ—Ç—Ä–∏–º—É—é—Ç—å –∑–∞–ø–∏—Ç–∏, —è–∫—ñ **–Ω–µ—Å—É—Ç—å —É —Å–æ–±—ñ –≤—Å—é –Ω–µ–æ–±—Ö—ñ–¥–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é**:

```csharp [–°–µ—Ä–≤—ñ—Å B ‚Äî –ø—Ä–æ—Ñ—ñ–ª—ñ (stateless)]
// –°–µ—Ä–≤—ñ—Å—É B –ù–ï –ø–æ—Ç—Ä—ñ–±–µ–Ω —Å–µ—Ä–≤—ñ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó!
// user_id –≤–∂–µ —î –≤ URL
app.MapGet("/v1/profiles/{userId}", (int userId) =>
{
    var profile = db.GetProfile(userId);
    return profile is not null
        ? Results.Ok(profile)
        : Results.NotFound();
});
```

```csharp [–°–µ—Ä–≤—ñ—Å C ‚Äî –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (stateless)]
// –°–µ—Ä–≤—ñ—Å—É C —Ç–µ–∂ –ù–ï –ø–æ—Ç—Ä—ñ–±–µ–Ω —Å–µ—Ä–≤—ñ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó!
app.MapGet("/v1/orders", (int user_id) =>
{
    var orders = db.GetOrdersByUser(user_id);
    return Results.Ok(orders);
});
```

::tip
**–ü—Ä–∏–Ω—Ü–∏–ø stateless (–∑ –∫–Ω–∏–≥–∏ –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–≤–∞):** –ú—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏ —Ä–æ–∑—Ä–æ–±–ª—è—é—Ç—å—Å—è —Ç–∞–∫, —â–æ–± –º–∞—Ç–∏ **—á—ñ—Ç–∫–æ –æ–∫—Ä–µ—Å–ª–µ–Ω—É –∑–æ–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ** —ñ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –¥–∞–Ω—ñ, —â–æ –Ω–∞–ª–µ–∂–∞—Ç—å —ñ–Ω—à–∏–º —Ä—ñ–≤–Ω—è–º –∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—ó. ¬´–ó–æ–≤–Ω—ñ—à–Ω—ñ¬ª –¥–∞–Ω—ñ ‚Äî —Ü–µ –ª–∏—à–µ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ–≤.
::

---

## 2. –ö–µ—à—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ ETag

–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–º—ñ–Ω—é—î—Ç—å—Å—è —Ä—ñ–¥–∫–æ ‚Äî –π–æ–≥–æ –º–æ–∂–Ω–∞ –∫–µ—à—É–≤–∞—Ç–∏. –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–º—ñ–Ω—é—é—Ç—å—Å—è —á–∞—Å—Ç–æ ‚Äî –∞–ª–µ —ñ –¥–ª—è –Ω–∏—Ö —î —Ä—ñ—à–µ–Ω–Ω—è —á–µ—Ä–µ–∑ **ETag** (Entity Tag).

### –©–æ —Ç–∞–∫–µ ETag

**ETag** ‚Äî —Ü–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ, —â–æ –º—ñ—Å—Ç–∏—Ç—å ¬´–≤—ñ–¥–±–∏—Ç–æ–∫¬ª (—Ä–µ–≤—ñ–∑—ñ—é, —Ö–µ—à) –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É —Ä–µ—Å—É—Ä—Å—É. –ö–ª—ñ—î–Ω—Ç –∞–±–æ –ø—Ä–æ–º—ñ–∂–Ω–∏–π –∞–≥–µ–Ω—Ç –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è **—É–º–æ–≤–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤**.

**–†–µ–≤—ñ–∑—ñ—è** (revision) ‚Äî —Ü–µ –º—ñ—Ç–∫–∞ –≤–µ—Ä—Å—ñ—ó —Ä–µ—Å—É—Ä—Å—É. –ö–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É, –∫–æ–ª–∏ —Ä–µ—Å—É—Ä—Å –∑–º—ñ–Ω—é—î—Ç—å—Å—è, —Ä–µ–≤—ñ–∑—ñ—è –æ—Ç—Ä–∏–º—É—î –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è. –¶–µ –º–æ–∂–µ –±—É—Ç–∏:
- **–õ—ñ—á–∏–ª—å–Ω–∏–∫** ‚Äî `"rev1"`, `"rev2"`, `"rev3"` (–∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è –ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –∑–º—ñ–Ω—ñ)
- **–•–µ—à** ‚Äî `"a3f8b2c1"` (–æ–±—á–∏—Å–ª—é—î—Ç—å—Å—è –≤—ñ–¥ –≤–º—ñ—Å—Ç—É —Ä–µ—Å—É—Ä—Å—É)
- **Timestamp** ‚Äî `"2024-02-26T12:00:00Z"` (—á–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∑–º—ñ–Ω–∏)

–°—É—Ç—å –æ–¥–Ω–∞: —è–∫—â–æ —Ä–µ–≤—ñ–∑—ñ—è –∑–±—ñ–≥–∞—î—Ç—å—Å—è ‚Äî –¥–∞–Ω—ñ **–Ω–µ –∑–º—ñ–Ω–∏–ª–∏—Å—å**. –Ø–∫—â–æ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è ‚Äî —Ö—Ç–æ—Å—å –º–æ–¥–∏—Ñ—ñ–∫—É–≤–∞–≤ —Ä–µ—Å—É—Ä—Å.

### –°—Ü–µ–Ω–∞—Ä—ñ–π: –∫–µ—à—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é

::steps

### –ü–µ—Ä—à–∏–π –∑–∞–ø–∏—Ç ‚Äî –æ—Ç—Ä–∏–º—É—î–º–æ ETag

```http
GET /v1/profiles/42 HTTP/1.1
‚Üí
HTTP/1.1 200 OK
ETag: "v1-abc123"
Cache-Control: max-age=300

{"id": 42, "name": "–û–ª–µ–∫—Å—ñ–π", "email": "alex@test.com"}
```

### –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞–∫—Ç—É–∞–ª—å–Ω—ñ—Å—Ç—å

```http
GET /v1/profiles/42 HTTP/1.1
If-None-Match: "v1-abc123"
‚Üí
HTTP/1.1 304 Not Modified
```

–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î **304 –±–µ–∑ —Ç—ñ–ª–∞** ‚Äî –¥–∞–Ω—ñ –Ω–µ –∑–º—ñ–Ω–∏–ª–∏—Å—å, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–µ—à!

### –î–∞–Ω—ñ –∑–º—ñ–Ω–∏–ª–∏—Å—å ‚Äî –æ—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é

```http
GET /v1/profiles/42 HTTP/1.1
If-None-Match: "v1-abc123"
‚Üí
HTTP/1.1 200 OK
ETag: "v1-def456"

{"id": 42, "name": "–û–ª–µ–∫—Å—ñ–π", "email": "new@test.com"}
```

::

```csharp [ETag —É Minimal API]
var app = WebApplication.Create(args);

app.MapGet("/v1/profiles/{id}", (int id, HttpContext ctx) =>
{
    var profile = db.GetProfile(id);
    if (profile is null) 
        return Results.NotFound();

    // –ì–µ–Ω–µ—Ä—É—î–º–æ ETag –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–µ—Ä—Å—ñ—ó –¥–∞–Ω–∏—Ö
    var etag = $"\"{profile.Version}\"";

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —É–º–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç
    var ifNoneMatch = ctx.Request.Headers
        .IfNoneMatch.FirstOrDefault();

    if (ifNoneMatch == etag)
    {
        // –î–∞–Ω—ñ –Ω–µ –∑–º—ñ–Ω–∏–ª–∏—Å—å ‚Äî 304 –±–µ–∑ —Ç—ñ–ª–∞
        return Results.StatusCode(304);
    }

    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –¥–∞–Ω—ñ –∑ ETag
    ctx.Response.Headers.ETag = etag;
    ctx.Response.Headers.CacheControl = "max-age=300";

    return Results.Ok(profile);
});

app.Run();
```

::mermaid

```mermaid
sequenceDiagram
    participant C as üì± –ö–ª—ñ—î–Ω—Ç
    participant G as Gateway
    participant S as –°–µ—Ä–≤—ñ—Å B

    C->>G: GET /v1/profiles/42
    G->>S: GET /v1/profiles/42
    S-->>G: 200 OK, ETag: "v1"
    G-->>C: 200 OK (–∑–±–µ—Ä—ñ–≥–∞—î –≤ –∫–µ—à)

    Note over C,G: –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç

    C->>G: GET /v1/profiles/42
    G->>S: GET /v1/profiles/42<br/>If-None-Match: "v1"
    S-->>G: 304 Not Modified
    G-->>C: 200 OK (–∑ –∫–µ—à—É)
```

::

---

## 3. –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º–æ–º

ETag –º–∞—î —â–µ –æ–¥–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–µ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è ‚Äî **–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∏—Ö –∑–º—ñ–Ω** —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `If-Match`. –Ø–∫—â–æ `If-None-Match` –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –∫–µ—à—É–≤–∞–Ω–Ω—è (—Ä–æ–∑–¥—ñ–ª –≤–∏—â–µ), —Ç–æ `If-Match` ‚Äî –∑–∞ **–±–µ–∑–ø–µ—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è**.

### –î–≤–∞ –æ–±–ª–∏—á—á—è ETag

| –ó–∞–≥–æ–ª–æ–≤–æ–∫ | –ú–µ—Ç–∞ | –ü–∏—Ç–∞–Ω–Ω—è | –í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞ |
|:---|:---|:---|:---|
| `If-None-Match` | –ö–µ—à—É–≤–∞–Ω–Ω—è | ¬´–ß–∏ –∑–º—ñ–Ω–∏–ª–∏—Å—å –¥–∞–Ω—ñ?¬ª | `304 Not Modified` ‚Äî –Ω—ñ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∫–µ—à |
| `If-Match` | –ü–∞—Ä–∞–ª–µ–ª—ñ–∑–º | ¬´–ß–∏ —è –ø—Ä–∞—Ü—é—é –∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ—é –≤–µ—Ä—Å—ñ—î—é?¬ª | `412 Precondition Failed` ‚Äî –Ω—ñ, –¥–∞–Ω—ñ –≤–∂–µ –∑–º—ñ–Ω–µ–Ω—ñ |

### –ê–Ω–∞–ª–æ–≥—ñ—è: —Å–ø—ñ–ª—å–Ω–∏–π Google Docs

–£—è–≤—ñ—Ç—å, —â–æ –≤–∏ —ñ –∫–æ–ª–µ–≥–∞ –æ–¥–Ω–æ—á–∞—Å–Ω–æ —Ä–µ–¥–∞–≥—É—î—Ç–µ –æ–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç. –í Google Docs —Ü–µ –ø—Ä–∞—Ü—é—î –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ. –ê–ª–µ HTTP API ‚Äî —Ü–µ –Ω–µ —Ä–µ–∞–ª—å–Ω–∏–π —á–∞—Å, –∞ ¬´–∑–∞–ø–∏—Ç-–≤—ñ–¥–ø–æ–≤—ñ–¥—å¬ª. –©–æ —Å—Ç–∞–Ω–µ—Ç—å—Å—è, —è–∫—â–æ **–¥–≤–æ—î** –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç—å –∑–º—ñ–Ω–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ?

**–ë–µ–∑ –∑–∞—Ö–∏—Å—Ç—É (–ø–µ—Å–∏–º—ñ—Å—Ç–∏—á–Ω–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π ¬´Lost Update¬ª):**

1. üì± –û–ª–µ–∫—Å—ñ–π –≤—ñ–¥–∫—Ä–∏–≤–∞—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Äî –±–∞—á–∏—Ç—å 2 —Ç–æ–≤–∞—Ä–∏
2. üì± –ú–∞—Ä—ñ—è –≤—ñ–¥–∫—Ä–∏–≤–∞—î —Ç–µ —Å–∞–º–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Äî –±–∞—á–∏—Ç—å —Ç—ñ –∂ 2 —Ç–æ–≤–∞—Ä–∏
3. üì± –û–ª–µ–∫—Å—ñ–π –¥–æ–¥–∞—î ‚òï –ª–∞—Ç—Ç–µ ‚Üí –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∑–∞–ø–∏—Ç —ñ–∑ 3 —Ç–æ–≤–∞—Ä–∞–º–∏
4. üì± –ú–∞—Ä—ñ—è –¥–æ–¥–∞—î üßÅ –º–∞—Ñ—Ñ—ñ–Ω ‚Üí –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∑–∞–ø–∏—Ç —ñ–∑ 3 —Ç–æ–≤–∞—Ä–∞–º–∏ (—Å–≤–æ—ó–º–∏!)
5. ‚ùå **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ 3 —Ç–æ–≤–∞—Ä–∏ (–ú–∞—Ä—ñ–Ω—ñ), –ª–∞—Ç—Ç–µ –û–ª–µ–∫—Å—ñ—è ‚Äî **–≤—Ç—Ä–∞—á–µ–Ω–æ** –Ω–∞–∑–∞–≤–∂–¥–∏

–¶–µ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è **Lost Update** ‚Äî –æ–¥–Ω–µ –∑ –Ω–∞–π–ø—ñ–¥—Å—Ç—É–ø–Ω—ñ—à–∏—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∏—Ö –ø–æ—Ä—É—à–µ–Ω—å, –±–æ –∂–æ–¥–Ω–∞ –∑—ñ —Å—Ç–æ—Ä—ñ–Ω –Ω–µ –æ—Ç—Ä–∏–º–∞–ª–∞ –ø–æ–º–∏–ª–∫—É.

### –†—ñ—à–µ–Ω–Ω—è: –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ ETag

**–û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ** –±–ª–æ–∫—É–≤–∞–Ω–Ω—è (–Ω–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ –ø–µ—Å–∏–º—ñ—Å—Ç–∏—á–Ω–æ–≥–æ) –Ω–µ ¬´–∑–∞–º–∏–∫–∞—î¬ª —Ä–µ—Å—É—Ä—Å –¥–ª—è —ñ–Ω—à–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤. –ù–∞—Ç–æ–º—ñ—Å—Ç—å –≤–æ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –≤ –º–æ–º–µ–Ω—Ç –∑–∞–ø–∏—Å—É: ¬´–ß–∏ –Ω—ñ—Ö—Ç–æ –Ω–µ –∑–º—ñ–Ω–∏–≤ —Ä–µ—Å—É—Ä—Å –∑ —Ç–æ–≥–æ —á–∞—Å—É, —è–∫ —è –π–æ–≥–æ –ø—Ä–æ—á–∏—Ç–∞–≤?¬ª

–ú–µ—Ö–∞–Ω—ñ–∑–º –ø—Ä–æ—Å—Ç–∏–π:
1. –ö–ª—ñ—î–Ω—Ç **—á–∏—Ç–∞—î** —Ä–µ—Å—É—Ä—Å ‚Üí –æ—Ç—Ä–∏–º—É—î ETag (—Ä–µ–≤—ñ–∑—ñ—é)
2. –ö–ª—ñ—î–Ω—Ç **–∑–º—ñ–Ω—é—î** —Ä–µ—Å—É—Ä—Å ‚Üí –Ω–∞–¥—Å–∏–ª–∞—î `If-Match: <—Ç–∞ —Å–∞–º–∞ —Ä–µ–≤—ñ–∑—ñ—è>`
3. –°–µ—Ä–≤–µ—Ä **–ø–æ—Ä—ñ–≤–Ω—é—î**: —è–∫—â–æ —Ä–µ–≤—ñ–∑—ñ—è –∑–±—ñ–≥–∞—î—Ç—å—Å—è ‚Üí –≤–∏–∫–æ–Ω—É—î –æ–ø–µ—Ä–∞—Ü—ñ—é. –Ø–∫—â–æ –Ω—ñ ‚Üí `412 Precondition Failed`

### –î—ñ–∞–≥—Ä–∞–º–∞: —è–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

::mermaid

```mermaid
sequenceDiagram
    participant A as üì± –û–ª–µ–∫—Å—ñ–π
    participant S as –°–µ—Ä–≤–µ—Ä
    participant B as üì± –ú–∞—Ä—ñ—è

    A->>S: GET /v1/orders?user_id=42
    S-->>A: 200 OK, ETag: "rev1"

    B->>S: GET /v1/orders?user_id=42
    S-->>B: 200 OK, ETag: "rev1"

    Note over A,B: –û–±–∏–¥–≤–∞ –±–∞—á–∞—Ç—å –æ–¥–Ω–∞–∫–æ–≤—É –≤–µ—Ä—Å—ñ—é

    A->>S: POST /v1/orders (–¥–æ–¥–∞—î –ª–∞—Ç—Ç–µ)<br/>If-Match: "rev1"
    S-->>A: 201 Created<br/>ETag: "rev2" ‚úÖ

    Note over S: –†–µ–≤—ñ–∑—ñ—è —Ç–µ–ø–µ—Ä "rev2"

    B->>S: POST /v1/orders (–¥–æ–¥–∞—î –º–∞—Ñ—Ñ—ñ–Ω)<br/>If-Match: "rev1"
    S-->>B: 412 Precondition Failed ‚ùå
    Note over B: –†–µ–≤—ñ–∑—ñ—è "rev1" –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞!<br/>–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ—á–∏—Ç–∞—Ç–∏ –¥–∞–Ω—ñ
```

::

–û–ª–µ–∫—Å—ñ–π –≤—Å—Ç–∏–≥ –ø–µ—Ä—à–∏–º ‚Äî –π–æ–≥–æ –∑–º—ñ–Ω–∞ –ø—Ä–∏–π–Ω—è—Ç–∞, —Ä–µ–≤—ñ–∑—ñ—è —Å—Ç–∞–ª–∞ `"rev2"`. –ö–æ–ª–∏ –ú–∞—Ä—ñ—è –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Å–≤–æ—ó –∑–º—ñ–Ω–∏ –∑ `If-Match: "rev1"` ‚Äî —Å–µ—Ä–≤–µ—Ä –±–∞—á–∏—Ç—å, —â–æ —Ä–µ–≤—ñ–∑—ñ—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞, —ñ –ø–æ–≤–µ—Ä—Ç–∞—î **412 Precondition Failed**. –î–∞–Ω—ñ –û–ª–µ–∫—Å—ñ—è **–Ω–µ –≤—Ç—Ä–∞—á–µ–Ω—ñ**.

### –©–æ —Ä–æ–±–∏—Ç—å –∫–ª—ñ—î–Ω—Ç –ø—ñ—Å–ª—è 412?

–ê–ª–≥–æ—Ä–∏—Ç–º –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è:

::steps

### –ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î 412

–°–µ—Ä–≤–µ—Ä –≤—ñ–¥—Ö–∏–ª–∏–≤ –∑–∞–ø–∏—Ç ‚Äî —Ä–µ–≤—ñ–∑—ñ—è –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞.

### –ö–ª—ñ—î–Ω—Ç –ø–µ—Ä–µ—á–∏—Ç—É—î –¥–∞–Ω—ñ

```http
GET /v1/orders?user_id=42 HTTP/1.1
‚Üí
HTTP/1.1 200 OK
ETag: "rev2"

[–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –û–ª–µ–∫—Å—ñ—è –≤–∂–µ –≤–∫–ª—é—á–µ–Ω–µ!]
```

### –ö–ª—ñ—î–Ω—Ç –ø–æ–≤—Ç–æ—Ä—é—î —Å–≤–æ—é –∑–º—ñ–Ω—É –∑ –Ω–æ–≤–æ—é —Ä–µ–≤—ñ–∑—ñ—î—é

```http
POST /v1/orders HTTP/1.1
If-Match: "rev2"

{"recipe": "muffin"}
‚Üí
HTTP/1.1 201 Created
ETag: "rev3" ‚úÖ
```

::

–¢–µ–ø–µ—Ä –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ —î **—ñ –ª–∞—Ç—Ç–µ, —ñ –º–∞—Ñ—Ñ—ñ–Ω** ‚Äî –Ω—ñ—á–æ–≥–æ –Ω–µ –≤—Ç—Ä–∞—á–µ–Ω–æ.

### –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —É Minimal API

```csharp [–û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º–æ–º]
app.MapPost("/v1/orders", (OrderRequest req, HttpContext ctx) =>
{
    // 1. If-Match –º—ñ—Å—Ç–∏—Ç—å –æ—á—ñ–∫—É–≤–∞–Ω—É —Ä–µ–≤—ñ–∑—ñ—é
    var ifMatch = ctx.Request.Headers
        .IfMatch.FirstOrDefault();

    // 2. –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ä–µ–≤—ñ–∑—ñ—é –∑—ñ —Å—Ö–æ–≤–∏—â–∞
    var currentRevision = db.GetOrdersRevision(
        req.UserId);

    // 3. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ: —á–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞ —Ä–µ–≤—ñ–∑—ñ—è –∫–ª—ñ—î–Ω—Ç–∞?
    if (ifMatch is not null 
        && ifMatch != $"\"{currentRevision}\"")
    {
        // 412 ‚Äî —Ä–µ–≤—ñ–∑—ñ—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞, –∫–ª—ñ—î–Ω—Ç
        // –ø–æ–≤–∏–Ω–µ–Ω –ø–µ—Ä–µ—á–∏—Ç–∞—Ç–∏ –¥–∞–Ω—ñ —ñ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏
        return Results.StatusCode(412);
    }

    // 4. –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —ñ –æ–Ω–æ–≤–ª—é—î–º–æ —Ä–µ–≤—ñ–∑—ñ—é
    var order = db.CreateOrder(req);
    var newRevision = db.GetOrdersRevision(req.UserId);

    // 5. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–∏–π ETag
    ctx.Response.Headers.ETag = $"\"{newRevision}\"";
    ctx.Response.Headers["Content-Location"] = 
        $"/v1/orders?user_id={req.UserId}";

    return Results.Created($"/v1/orders/{order.Id}", 
        order);
});
```

---

## 4. JWT: Stateless-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è

–ú–∏ –¥–æ—Å—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å–µ—Ä–≤—ñ—Å A –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–æ–∫–µ–Ω—ñ–≤ ‚Äî —Ü–µ –∑–∞–ª–∏—à–æ–∫ stateful-–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏. –†—ñ—à–µ–Ω–Ω—è ‚Äî **stateless-—Ç–æ–∫–µ–Ω–∏ (JWT)**.

### Stateful vs Stateless —Ç–æ–∫–µ–Ω–∏

::tabs

::tabs-item{label="Stateful (–Ω–µ–ø—Ä–æ–∑–æ—Ä–∏–π —Ç–æ–∫–µ–Ω)"}

```
Token: "a7f3bc91-session-id"
```

- –°–µ—Ä–≤–µ—Ä **–ø–æ–≤–∏–Ω–µ–Ω** —à—É–∫–∞—Ç–∏ —Ç–æ–∫–µ–Ω —É –±–∞–∑—ñ/–∫–µ—à—ñ
- –ü–æ—Ç—Ä—ñ–±–µ–Ω –æ–∫—Ä–µ–º–∏–π —Å–µ—Ä–≤—ñ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
- –í–∏—Ö—ñ–¥ –∑ –ª–∞–¥—É —Å–µ—Ä–≤—ñ—Å—É A ‚Üí –≤—Å–µ –ª–∞–º–∞—î—Ç—å—Å—è

::

::tabs-item{label="Stateless (JWT)"}

```
Token: "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lk..."
     ‚Üì —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–≤—à–∏:
{
  "user_id": 42,
  "user_ids": [42, 15],  // –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤
  "iat": 1708934400,     // —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
  "exp": 1709020800      // —á–∞—Å –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è
}
```

- –ö–æ–∂–µ–Ω —Å–µ—Ä–≤—ñ—Å –º–æ–∂–µ **—Å–∞–º** –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å —Ç–æ–∫–µ–Ω–∞
- –ù–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –∑–æ–≤–Ω—ñ—à–Ω—ñ–π —Å–µ—Ä–≤—ñ—Å
- –£—Å—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è ‚Äî –≤ —Å–∞–º–æ–º—É —Ç–æ–∫–µ–Ω—ñ

::

::

### –ü–æ–¥–≤—ñ–π–Ω–∏–π user_id ‚Äî –Ω–µ –¥—É–±–ª—é–≤–∞–Ω–Ω—è

::warning
**–ü–æ—à–∏—Ä–µ–Ω–∞ –ø–æ–º–∏–ª–∫–∞:** —è–∫—â–æ `user_id` –≤–∂–µ —î –≤ JWT-—Ç–æ–∫–µ–Ω—ñ, –Ω–∞–≤—ñ—â–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –π–æ–≥–æ —â–µ –π –≤ URL?

**–í—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –∫–Ω–∏–≥–∏:** –¶–µ **–Ω–µ** –¥—É–±–ª—é–≤–∞–Ω–Ω—è. –¶—ñ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –º–∞—é—Ç—å **—Ä—ñ–∑–Ω–∏–π –∑–º—ñ—Å—Ç**:
- `user_id` –≤ URL ‚Üí **–Ω–∞–¥ —è–∫–∏–º —Ä–µ—Å—É—Ä—Å–æ–º** –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ–ø–µ—Ä–∞—Ü—ñ—è
- `user_id` –≤ —Ç–æ–∫–µ–Ω—ñ ‚Üí **—Ö—Ç–æ** –≤–∏–∫–æ–Ω—É—î –æ–ø–µ—Ä–∞—Ü—ñ—é

–ó–±—ñ–≥ ‚Äî –ª–∏—à–µ —á–∞—Å—Ç–∫–æ–≤–∏–π –≤–∏–ø–∞–¥–æ–∫. –î–∏—Ä–µ–∫—Ç–æ—Ä –∫–æ–º–ø–∞–Ω—ñ—ó –º–æ–∂–µ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–≤–æ—ó—Ö —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤:
::

```csharp [JWT-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É Minimal API]
app.MapGet("/v1/profiles/{userId}", 
    (int userId, HttpContext ctx) =>
{
    // 1. –†–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ JWT (–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞/middleware)
    var claims = ctx.User;
    var tokenUserId = int.Parse(
        claims.FindFirst("user_id")!.Value);

    // 2. –û—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö user_id
    var allowedIds = claims
        .FindAll("allowed_user_id")
        .Select(c => int.Parse(c.Value))
        .ToList();

    // 3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏: —á–∏ –º–∞—î –ø—Ä–∞–≤–æ
    // –≤–ª–∞—Å–Ω–∏–∫ —Ç–æ–∫–µ–Ω–∞ –±–∞—á–∏—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ñ—ñ–ª—å?
    if (tokenUserId != userId 
        && !allowedIds.Contains(userId))
    {
        // 403 ‚Äî —Ç–æ–∫–µ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π, –∞–ª–µ
        //   –¥–æ—Å—Ç—É–ø—É –¥–æ —Ü—å–æ–≥–æ —Ä–µ—Å—É—Ä—Å—É –Ω–µ–º–∞—î
        return Results.Forbid();
    }

    var profile = db.GetProfile(userId);
    return profile is not null
        ? Results.Ok(profile)
        : Results.NotFound();
});
```

::mermaid

```mermaid
graph LR
    subgraph "Stateful (—Å—Ç–∞—Ä–∏–π –ø—ñ–¥—Ö—ñ–¥)"
        C1["–ö–ª—ñ—î–Ω—Ç"] -->|"token"| G1["Gateway"]
        G1 -->|"token"| A1["Auth Service"]
        A1 -->|"user_id"| G1
        G1 -->|"user_id"| S1["–°–µ—Ä–≤—ñ—Å"]
    end

    subgraph "Stateless (JWT)"
        C2["–ö–ª—ñ—î–Ω—Ç"] -->|"JWT"| S2["–°–µ—Ä–≤—ñ—Å"]
        S2 -->|"–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–ø–∏—Å—É<br/>–ª–æ–∫–∞–ª—å–Ω–æ"| S2
    end

    style A1 fill:#ef4444,stroke:#dc2626,color:#ffffff
    style C1 fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style C2 fill:#3b82f6,stroke:#1d4ed8,color:#ffffff
    style G1 fill:#f59e0b,stroke:#b45309,color:#ffffff
    style S1 fill:#10b981,stroke:#059669,color:#ffffff
    style S2 fill:#10b981,stroke:#059669,color:#ffffff
```

::

---

## 5. –ü—ñ–¥—Å—É–º–æ–∫: –ü–æ–≤–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å REST

–ü—ñ—Å–ª—è –≤—Å—ñ—Ö –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω—å –º–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ —Å–∏—Å—Ç–µ–º—É, —è–∫–∞ **–ø–æ–≤–Ω—ñ—Å—Ç—é –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—Ä–∏–Ω—Ü–∏–ø–∞–º REST**:

| –ü—Ä–∏–Ω—Ü–∏–ø REST | –Ø–∫ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ |
|:---|:---|
| **Stateless** | –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç –Ω–µ—Å–µ `user_id` —Ç–∞ JWT ‚Äî —Å–µ—Ä–≤—ñ—Å—É –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –∑–æ–≤–Ω—ñ—à–Ω—ñ–π —Å—Ç–∞–Ω |
| **–ö–µ—à—É–≤–∞–Ω–Ω—è** | ETag + Cache-Control –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤; If-None-Match –¥–ª—è —É–º–æ–≤–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ |
| **–£–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å** | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ HTTP-–º–µ—Ç–æ–¥–∏, URL —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—é—Ç—å —Ä–µ—Å—É—Ä—Å–∏ |
| **–ë–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤—ñ—Å—Ç—å** | –ì–µ–π—Ç–≤–µ–π –º–æ–∂–Ω–∞ –ø—Ä–∏–±—Ä–∞—Ç–∏ ‚Äî –∫–ª—ñ—î–Ω—Ç –º–æ–∂–µ –∑–≤–µ—Ä—Ç–∞—Ç–∏—Å—å –¥–æ —Å–µ—Ä–≤—ñ—Å—ñ–≤ –Ω–∞–ø—Ä—è–º—É |

::tip
**–ö–ª—é—á–æ–≤–∏–π –≤–∏—Å–Ω–æ–≤–æ–∫ –∑ –∫–Ω–∏–≥–∏ –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–≤–∞:** –ü—ñ—Å–ª—è –≤—Å—ñ—Ö –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω—å –º–∏ –º–æ–∂–µ–º–æ _–ø—Ä–∏–±—Ä–∞—Ç–∏ –≥–µ–π—Ç–≤–µ–π D_ —ñ –ø–æ–∫–ª–∞—Å—Ç–∏ –π–æ–≥–æ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –Ω–∞ –∫–ª—ñ—î–Ω—Ç–∞. –ö–ª—ñ—î–Ω—Ç –∑–±–µ—Ä—ñ–≥–∞—î `user_id` (–∞–±–æ –≤–∏—Ç—è–≥—É—î –∑ JWT), —Ä–æ–±–∏—Ç—å –¥–≤–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Ç–∏ —á–µ—Ä–µ–∑ HTTP/2 –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å—É–≤–∞–Ω–Ω—è, —ñ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∫–µ—à —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏. –ó —Ç–æ—á–∫–∏ –∑–æ—Ä—É —Å–µ—Ä–≤—ñ—Å—ñ–≤ B —ñ C –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≥–µ–π—Ç–≤–µ—è –Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω—ñ –Ω–∞ —â–æ.
::

---

## 6. –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### –†—ñ–≤–µ–Ω—å 1: –ë–∞–∑–æ–≤–∏–π

::accordion

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 5.1: Stateless-—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥" icon="i-lucide-circle-help"}
–ü–µ—Ä–µ—Ç–≤–æ—Ä—ñ—Ç—å –Ω–∞—Å—Ç—É–ø–Ω–∏–π stateful API –Ω–∞ stateless:

```csharp
// Stateful: —Å–µ—Ä–≤–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—î —Å–µ—Å—ñ—ó
app.MapPost("/api/login", (LoginRequest req) =>
{
    var sessionId = Guid.NewGuid().ToString();
    sessions[sessionId] = req.Email;
    return Results.Ok(new { session_id = sessionId });
});

app.MapGet("/api/my-orders", (HttpContext ctx) =>
{
    var sessionId = ctx.Request.Headers["X-Session-Id"];
    var email = sessions[sessionId];
    var orders = db.GetOrdersByEmail(email);
    return Results.Ok(orders);
});
```

–í–∏–º–æ–≥–∏:
1. –í–∏–¥–∞–ª—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω–µ —Å—Ö–æ–≤–∏—â–µ —Å–µ—Å—ñ–π
2. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ JWT –∞–±–æ –ø–µ—Ä–µ–¥–∞—á—É user_id –≤ URL
3. –ó—Ä–æ–±—ñ—Ç—å –∑–∞–ø–∏—Ç `/v1/orders` –ø–æ–≤–Ω—ñ—Å—Ç—é stateless
::

::

### –†—ñ–≤–µ–Ω—å 2: –ü—Ä–æ—î–∫—Ç—É–≤–∞–Ω–Ω—è

::accordion

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 5.2: ETag-–∫–µ—à—É–≤–∞–Ω–Ω—è" icon="i-lucide-circle-help"}
–†–µ–∞–ª—ñ–∑—É–π—Ç–µ Minimal API –µ–Ω–¥–ø–æ—ñ–Ω—Ç `GET /v1/products/{id}`, —â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î:

1. ETag —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Ö–µ—à –¥–∞–Ω–∏—Ö)
2. –£–º–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç `If-None-Match` ‚Üí `304 Not Modified`
3. –ó–∞–≥–æ–ª–æ–≤–æ–∫ `Cache-Control: max-age=600`

–ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ: –∑—Ä–æ–±—ñ—Ç—å –¥–≤–∞ –∑–∞–ø–∏—Ç–∏ ‚Äî –ø–µ—Ä—à–∏–π –º–∞—î –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ `200`, –¥—Ä—É–≥–∏–π –∑ `If-None-Match` ‚Äî `304`.
::

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 5.3: –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º–æ–º" icon="i-lucide-circle-help"}
–†–µ–∞–ª—ñ–∑—É–π—Ç–µ –µ–Ω–¥–ø–æ—ñ–Ω—Ç `PUT /v1/products/{id}`, —â–æ:

1. –ü—Ä–∏–π–º–∞—î `If-Match` –∑ –ø–æ—Ç–æ—á–Ω–æ—é —Ä–µ–≤—ñ–∑—ñ—î—é
2. –ü–æ–≤–µ—Ä—Ç–∞—î `412 Precondition Failed`, —è–∫—â–æ —Ä–µ–≤—ñ–∑—ñ—è –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è
3. –ü–æ–≤–µ—Ä—Ç–∞—î `200 OK` –∑ –Ω–æ–≤–∏–º `ETag` –ø—Ä–∏ —É—Å–ø—ñ—Ö—É
4. –ü–æ–≤–µ—Ä—Ç–∞—î `428 Precondition Required`, —è–∫—â–æ `If-Match` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ

–ó–º–æ–¥–µ–ª—é–π—Ç–µ —Å–∏—Ç—É–∞—Ü—ñ—é ¬´lost update¬ª –∑ –¥–≤–æ–º–∞ –∫–ª—ñ—î–Ω—Ç–∞–º–∏.
::

::

---

## 7. –†–µ–∑—é–º–µ

::card-group

::card{title="Stateless = –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è" icon="i-lucide-scaling"}
–ó–∞–ø–∏—Ç –ø–æ–≤–∏–Ω–µ–Ω –Ω–µ—Å—Ç–∏ –≤ —Å–æ–±—ñ –≤—Å—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –¥–ª—è –æ–±—Ä–æ–±–∫–∏. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –¥–æ–¥–∞–≤–∞—Ç–∏/–ø—Ä–∏–±–∏—Ä–∞—Ç–∏ –ø—Ä–æ–º—ñ–∂–Ω—ñ —à–∞—Ä–∏ –±–µ–∑ –∑–º—ñ–Ω–∏ —Å–µ—Ä–≤—ñ—Å—ñ–≤.
::

::card{title="ETag = —Ä–æ–∑—É–º–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è" icon="i-lucide-database"}
ETag + If-None-Match –¥–ª—è –∫–µ—à—É–≤–∞–Ω–Ω—è. ETag + If-Match –¥–ª—è –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º–æ–º. –û–¥–∏–Ω –º–µ—Ö–∞–Ω—ñ–∑–º ‚Äî –¥–≤–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è.
::

::card{title="JWT = stateless –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è" icon="i-lucide-key"}
Stateless-—Ç–æ–∫–µ–Ω–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –∫–æ–∂–Ω–æ–º—É —Å–µ—Ä–≤—ñ—Å—É —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –ø—Ä–∞–≤–∞. user_id –≤ URL —ñ user_id –≤ —Ç–æ–∫–µ–Ω—ñ ‚Äî —Ü–µ —Ä—ñ–∑–Ω—ñ —Ä–µ—á—ñ.
::

::card{title="REST –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ" icon="i-lucide-check-circle"}
–ü—ñ—Å–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î REST: stateless, –∫–µ—à–æ–≤–∞–Ω–∞, –±–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤–∞, –∑ —É–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–º —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.
::

::

**–î–∞–ª—ñ:** —É –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–∞—Ç—Ç—ñ –º–∏ —Ä–æ–∑–±–µ—Ä–µ–º–æ **–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É URL —Ä–µ—Å—É—Ä—Å—ñ–≤ —Ç–∞ CRUD-–æ–ø–µ—Ä–∞—Ü—ñ—ó** ‚Äî —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –±—É–¥—É–≤–∞—Ç–∏ —ñ—î—Ä–∞—Ä—Ö—ñ—é URL, –∫–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ path vs query, —ñ —è–∫ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤.
