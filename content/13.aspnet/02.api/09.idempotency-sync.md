---
title: "–Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É"
description: "–¢–æ–∫–µ–Ω–∏ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ, –ø–∞—Ç—Ç–µ—Ä–Ω —á–µ—Ä–Ω–µ—Ç–∫–∞-–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è (draft-commit), –±–µ–∑–ø–µ—á–Ω–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤, Content-Location, –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–æ–º —ñ —Å–µ—Ä–≤–µ—Ä–æ–º."
---

# –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É

::note
–ú–∏ –≤–∂–µ –∑–Ω–∞—î–º–æ, —â–æ `PUT` —ñ `DELETE` —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ, –∞ `POST` ‚Äî –Ω—ñ. –ê–ª–µ —â–æ —Ä–æ–±–∏—Ç–∏, –∫–æ–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–∏–π `POST` –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è? –Ü —è–∫ –∫–ª—ñ—î–Ω—Ç —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î —Å–≤—ñ–π —Å—Ç–∞–Ω —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–∫–∏? –¶—è —Å—Ç–∞—Ç—Ç—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –æ–±–∏–¥–≤–∞ –ø–∏—Ç–∞–Ω–Ω—è.
::

## 1. –ü—Ä–æ–±–ª–µ–º–∞: –Ω–µ—ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∏–π POST

–£—è–≤—ñ—Ç—å —Å–∏—Ç—É–∞—Ü—ñ—é: –∫–ª—ñ—î–Ω—Ç –Ω–∞–¥—Å–∏–ª–∞—î `POST /v1/orders` –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –°–µ—Ä–≤–µ—Ä —Å—Ç–≤–æ—Ä—é—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –∞–ª–µ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –º–µ—Ä–µ–∂–∞ –æ–±—Ä–∏–≤–∞—î—Ç—å—Å—è. –ö–ª—ñ—î–Ω—Ç –Ω–µ –æ—Ç—Ä–∏–º–∞–≤ –≤—ñ–¥–ø–æ–≤—ñ–¥—å.

```
üì± –ö–ª—ñ—î–Ω—Ç ‚Üí POST /v1/orders ‚Üí üåê –º–µ—Ä–µ–∂–∞ ‚Üí –°–µ—Ä–≤–µ—Ä (—Å—Ç–≤–æ—Ä–∏–≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #42)
üì± –ö–ª—ñ—î–Ω—Ç ‚Üê ??? ‚Üê üåê –æ–±—Ä–∏–≤! ‚Üê –°–µ—Ä–≤–µ—Ä (–≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—Ç—Ä–∞—á–µ–Ω–∞)
```

**–©–æ —Ä–æ–±–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É?**

| –í–∞—Ä—ñ–∞–Ω—Ç | –ü—Ä–æ–±–ª–µ–º–∞ |
|:---|:---|
| –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç | –ú–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏—Å—è **–¥—É–±–ª—ñ–∫–∞—Ç** (#43) |
| –ù–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ | –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ **–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–µ** ‚Äî –∫–ª—ñ—î–Ω—Ç –Ω–µ –∑–Ω–∞—î |
| –ó–∞–ø–∏—Ç–∞—Ç–∏ GET | –ù–µ –∑—Ä–æ–∑—É–º—ñ–ª–æ, —á–∏ —Ç–æ ¬´–π–æ–≥–æ¬ª –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, —á–∏ –∑–±—ñ–≥ |

::caution
–¶–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏—Ö —Å–∏—Å—Ç–µ–º: –∫–ª—ñ—î–Ω—Ç **–Ω–µ –º–æ–∂–µ –∑–Ω–∞—Ç–∏**, —á–∏ —Å–µ—Ä–≤–µ—Ä –æ–±—Ä–æ–±–∏–≤ –π–æ–≥–æ –∑–∞–ø–∏—Ç. –ü–æ–≤—Ç–æ—Ä–Ω–∏–π POST –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç. –ù–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ ‚Äî –º–æ–∂–Ω–∞ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.
::

---

## 2. –¢—Ä–∏ —Å–ø–æ—Å–æ–±–∏ –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å

### –°–ø–æ—Å—ñ–± 1: PUT –∑ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–º ID

–ù–∞–π–ø—Ä–æ—Å—Ç—ñ—à–∏–π —Å–ø–æ—Å—ñ–± ‚Äî –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å –∑–∞ ID –Ω–∞ –∫–ª—ñ—î–Ω—Ç–∞. `PUT` —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∏–π –∑–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º:

```csharp [PUT –∑ UUID ‚Äî —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∏–π –∑–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º]
app.MapPut("/v1/orders/{id}", (Guid id, OrderRequest req) =>
{
    // URL = –∫–ª—é—á —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ
    // –ü–æ–≤—Ç–æ—Ä–Ω–∏–π PUT –∑ —Ç–∏–º —Å–∞–º–∏–º ID ‚Üí —Ç–∞ —Å–∞–º–∞ –¥—ñ—è
    if (db.OrderExists(id))
    {
        // –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∂–µ —ñ—Å–Ω—É—î ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –π–æ–≥–æ
        return Results.Ok(db.GetOrder(id));
    }

    var order = db.CreateOrder(id, req);
    return Results.Created(
        $"/v1/orders/{order.Id}", order);
});

// –ö–ª—ñ—î–Ω—Ç –≥–µ–Ω–µ—Ä—É—î UUID:
// PUT /v1/orders/550e8400-e29b-41d4-a716-446655440000
// –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –≤–∏–∫–ª–∏–∫ ‚Äî –±–µ–∑–ø–µ—á–Ω–∏–π!
```

::warning
**–ù–µ–¥–æ–ª—ñ–∫:** –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–≤—ñ—Ä—è—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é ID. –¶–µ –ø—Ä–∞—Ü—é—î –¥–ª—è UUID, –∞–ª–µ –Ω–µ –¥–ª—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏—Ö —á–∏—Å–ª–æ–≤–∏—Ö ID. –¢–∞–∫–æ–∂ –∫–ª—ñ—î–Ω—Ç –º–æ–∂–µ –Ω–∞–≤–º–∏—Å–Ω–æ –≤–∏–±—Ä–∞—Ç–∏ ID, —â–æ –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π.
::

### –°–ø–æ—Å—ñ–± 2: POST + —Ç–æ–∫–µ–Ω —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ

–ö–ª—ñ—î–Ω—Ç –≥–µ–Ω–µ—Ä—É—î **—É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á –∑–∞–ø–∏—Ç—É** —ñ –ø–µ—Ä–µ–¥–∞—î –π–æ–≥–æ —É –∑–∞–≥–æ–ª–æ–≤–∫—É:

```csharp [POST –∑ —Ç–æ–∫–µ–Ω–æ–º —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ]
app.MapPost("/v1/orders", 
    (OrderRequest req, HttpContext ctx) =>
{
    // –ö–ª—ñ—î–Ω—Ç –ø–µ—Ä–µ–¥–∞—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á
    var idempotencyKey = ctx.Request.Headers[
        "X-Idempotency-Key"].FirstOrDefault();

    if (string.IsNullOrEmpty(idempotencyKey))
        return Results.Json(
            new { error = "X-Idempotency-Key required" },
            statusCode: 428);

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ: —á–∏ –≤–∂–µ –æ–±—Ä–æ–±–ª–µ–Ω–∏–π —Ü–µ–π –∫–ª—é—á?
    var existing = db.GetByIdempotencyKey(
        idempotencyKey);
    if (existing is not null)
    {
        // –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        return Results.Ok(existing);
    }

    // –ü–µ—Ä—à–∏–π —Ä–∞–∑ ‚Äî —Å—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    var order = db.CreateOrder(req, idempotencyKey);
    return Results.Created(
        $"/v1/orders/{order.Id}", order);
});
```

```http [–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞]
POST /v1/orders HTTP/1.1
X-Idempotency-Key: "req-abc-12345"
Content-Type: application/json

{"recipe": "lungo", "coffee_machine_id": 42}
‚Üí
HTTP/1.1 201 Created

// –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç –∑ —Ç–∏–º —Å–∞–º–∏–º –∫–ª—é—á–µ–º:
POST /v1/orders HTTP/1.1
X-Idempotency-Key: "req-abc-12345"
‚Üí
HTTP/1.1 200 OK (–ø–æ–≤–µ—Ä—Ç–∞—î —Ç–µ —Å–∞–º–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è)
```

### –°–ø–æ—Å—ñ–± 3: –ß–µ—Ä–Ω–µ—Ç–∫–∞ + –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è (draft-commit)

–ù–∞–π–Ω–∞–¥—ñ–π–Ω—ñ—à–∏–π –ø—ñ–¥—Ö—ñ–¥ –∑ –∫–Ω–∏–≥–∏ –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–≤–∞:

::steps

### POST ‚Äî —Å—Ç–≤–æ—Ä—é—î–º–æ —á–µ—Ä–Ω–µ—Ç–∫—É (–Ω–µ—ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ, –∞–ª–µ ¬´–ª–µ–≥–∫–æ¬ª)

```csharp
app.MapPost("/v1/orders/drafts", 
    (DraftRequest req) =>
{
    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ—Ä–Ω–µ—Ç–∫–∏ ‚Äî ¬´–ª–µ–≥–∫–∞¬ª –æ–ø–µ—Ä–∞—Ü—ñ—è
    // –ù–∞–≤—ñ—Ç—å —è–∫—â–æ —Å—Ç–≤–æ—Ä—è—Ç—å—Å—è –¥—É–±–ª—ñ–∫–∞—Ç–∏ ‚Äî
    // —Ü–µ –ª–∏—à–µ —á–µ—Ä–Ω–µ—Ç–∫–∏, –Ω–µ —Ä–µ–∞–ª—å–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    var draft = db.CreateDraft(req);
    return Results.Created(
        $"/v1/orders/drafts/{draft.Id}", draft);
});
```

### PUT ‚Äî –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ —á–µ—Ä–Ω–µ—Ç–∫—É (—ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ!)

```csharp
app.MapPut("/v1/orders/drafts/{id}/commit", 
    (Guid id) =>
{
    var draft = db.GetDraft(id);
    if (draft is null)
        return Results.NotFound();

    if (draft.CommittedOrderId is not null)
    {
        // –í–∂–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        // –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –≤–∏–∫–ª–∏–∫ –±–µ–∑–ø–µ—á–Ω–∏–π!
        return Results.Ok(
            db.GetOrder(draft.CommittedOrderId.Value));
    }

    // –ü–µ—Ä—à–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
    var order = db.CommitDraft(id);
    return Results.Created(
        $"/v1/orders/{order.Id}", order);
});
```

::

::tip
**–ü–µ—Ä–µ–≤–∞–≥–∞ draft-commit**: `POST` —Å—Ç–≤–æ—Ä—é—î ¬´–ª–µ–≥–∫—É¬ª —á–µ—Ä–Ω–µ—Ç–∫—É ‚Äî –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –º–µ—Ä–µ–∂–∞ –æ–±—ñ—Ä–≤–µ—Ç—å—Å—è —ñ —Å—Ç–≤–æ—Ä—è—Ç—å—Å—è –¥—É–±–ª—ñ–∫–∞—Ç–∏ —á–µ—Ä–Ω–µ—Ç–æ–∫, —Ä–µ–∞–ª—å–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –±—É–¥–µ –ª–∏—à–µ –æ–¥–Ω–µ (—á–µ—Ä–µ–∑ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∏–π `PUT`). –ù–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —á–µ—Ä–Ω–µ—Ç–∫–∏ –º–æ–∂–Ω–∞ –æ—á–∏—Å—Ç–∏—Ç–∏ —á–µ—Ä–µ–∑ TTL.
::

---

## 3. Content-Location: ¬´–¥–µ —Ç–µ–ø–µ—Ä –¥–∞–Ω—ñ?¬ª

–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏ –¥–≤—ñ —Ä–µ—á—ñ:
1. **–î–µ** –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —Ä–µ—Å—É—Ä—Å ‚Üí –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Location`
2. **–î–µ** –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –æ–Ω–æ–≤–ª–µ–Ω–∏–π —Å–ø–∏—Å–æ–∫ ‚Üí –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Content-Location`

```csharp [Location —Ç–∞ Content-Location]
app.MapPost("/v1/orders", 
    (OrderRequest req, HttpContext ctx) =>
{
    var order = db.CreateOrder(req);
    var newRevision = db.GetOrdersRevision(req.UserId);

    // Location ‚Äî URL –Ω–æ–≤–æ–≥–æ —Ä–µ—Å—É—Ä—Å—É
    // –ö–ª—ñ—î–Ω—Ç –º–æ–∂–µ –∑—Ä–æ–±–∏—Ç–∏ GET –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
    ctx.Response.Headers.Location = 
        $"/v1/orders/{order.Id}";

    // Content-Location ‚Äî URL, –¥–µ –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏
    // –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –∫–æ–ª–µ–∫—Ü—ñ—ó (—ñ–∑ –Ω–æ–≤–æ—é —Ä–µ–≤—ñ–∑—ñ—î—é)
    ctx.Response.Headers["Content-Location"] = 
        $"/v1/orders?user_id={req.UserId}";

    // ETag ‚Äî –Ω–æ–≤–∞ —Ä–µ–≤—ñ–∑—ñ—è –∫–æ–ª–µ–∫—Ü—ñ—ó
    ctx.Response.Headers.ETag = $"\"{newRevision}\"";

    return Results.Created(
        $"/v1/orders/{order.Id}", order);
});
```

---

## 4. –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É –∫–ª—ñ—î–Ω—Ç–∞

### –ü–æ–≤–Ω–∏–π —Ü–∏–∫–ª –≤–∑–∞—î–º–æ–¥—ñ—ó

–ó—ñ–±—Ä–∞–≤—à–∏ –≤—Å–µ —Ä–∞–∑–æ–º, –æ—Å—å —è–∫ –≤–∏–≥–ª—è–¥–∞—î –ø–æ–≤–Ω–∏–π —Ü–∏–∫–ª –±–µ–∑–ø–µ—á–Ω–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞ –∑ API:

::mermaid

```mermaid
sequenceDiagram
    participant C as üì± –ö–ª—ñ—î–Ω—Ç
    participant S as –°–µ—Ä–≤–µ—Ä

    C->>S: GET /v1/orders?user_id=42
    S-->>C: 200 OK, ETag: "rev1"
    Note over C: –ó–±–µ—Ä—ñ–≥–∞—î —Ä–µ–≤—ñ–∑—ñ—é "rev1"

    C->>S: POST /v1/orders<br/>If-Match: "rev1"<br/>X-Idempotency-Key: "abc"
    S-->>C: 201 Created<br/>ETag: "rev2"<br/>Location: /v1/orders/42<br/>Content-Location: /v1/orders?user_id=42
    Note over C: –û–Ω–æ–≤–ª—é—î —Ä–µ–≤—ñ–∑—ñ—é –Ω–∞ "rev2"

    Note over C,S: –ú–µ—Ä–µ–∂–µ–≤–∏–π –∑–±—ñ–π!

    C->>S: POST /v1/orders<br/>If-Match: "rev1"<br/>X-Idempotency-Key: "abc"
    S-->>C: 200 OK (–ø–æ–≤–µ—Ä—Ç–∞—î —ñ—Å–Ω—É—é—á–µ)<br/>ETag: "rev2"
    Note over C: –ë–µ–∑–ø–µ—á–Ω–∏–π –ø–æ–≤—Ç–æ—Ä ‚Äî<br/>–¥—É–±–ª—ñ–∫–∞—Ç –ù–ï —Å—Ç–≤–æ—Ä–µ–Ω–æ
```

::

### –©–æ —Ä–æ–±–∏—Ç–∏ –ø—ñ—Å–ª—è —Ä—ñ–∑–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫

| –ü–æ–º–∏–ª–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –î—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ |
|:---|:---|:---|
| `412 Precondition Failed` | –†–µ–≤—ñ–∑—ñ—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞ | –ü–µ—Ä–µ—á–∏—Ç–∞—Ç–∏ –¥–∞–Ω—ñ (GET), –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∑ –Ω–æ–≤–æ—é —Ä–µ–≤—ñ–∑—ñ—î—é |
| `428 Precondition Required` | If-Match –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ | –î–æ–¥–∞—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ If-Match |
| `409 Conflict` | –î—É–±–ª—ñ–∫–∞—Ç (–±–µ–∑ —Ç–æ–∫–µ–Ω–∞ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ) | –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –≤–∂–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ (GET) |
| `429 Too Many Requests` | Rate limit | –ó–∞—á–µ–∫–∞—Ç–∏ Retry-After —Å–µ–∫—É–Ω–¥, –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ |
| `500 / 503` | –°–µ—Ä–≤–µ—Ä–Ω–∞ –ø–æ–º–∏–ª–∫–∞ | –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ —á–µ—Ä–µ–∑ Retry-After (—è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ) |
| –¢–∞–π–º–∞—É—Ç / –æ–±—Ä–∏–≤ | –ú–µ—Ä–µ–∂–µ–≤–∏–π –∑–±—ñ–π | –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∑ —Ç–∏–º —Å–∞–º–∏–º X-Idempotency-Key |

---

## 5. Retry-—Å—Ç—Ä–∞—Ç–µ–≥—ñ—è: Exponential Backoff

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏—Ö –ø–æ–≤—Ç–æ—Ä—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è **–µ–∫—Å–ø–æ–Ω–µ–Ω—Ç–Ω–µ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É**:

```csharp [Retry –∑ exponential backoff]
async Task<HttpResponseMessage> SendWithRetry(
    HttpClient client,
    HttpRequestMessage request,
    int maxRetries = 3)
{
    for (int attempt = 0; attempt <= maxRetries; attempt++)
    {
        var response = await client.SendAsync(request);

        // –£—Å–ø—ñ—Ö –∞–±–æ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∞ –ø–æ–º–∏–ª–∫–∞ ‚Äî –Ω–µ –ø–æ–≤—Ç–æ—Ä—é—î–º–æ
        if ((int)response.StatusCode < 500 
            && response.StatusCode != 
                System.Net.HttpStatusCode.TooManyRequests)
        {
            return response;
        }

        if (attempt == maxRetries)
            return response; // –í–∏—á–µ—Ä–ø–∞–Ω–æ —Å–ø—Ä–æ–±–∏

        // Retry-After –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ –∞–±–æ backoff
        var retryAfter = response.Headers.RetryAfter;
        var delay = retryAfter?.Delta 
            ?? TimeSpan.FromSeconds(
                Math.Pow(2, attempt)); // 1, 2, 4 —Å–µ–∫

        await Task.Delay(delay);
    }

    throw new UnreachableException();
}
```

::tip
**–í–∞–∂–ª–∏–≤–µ –ø—Ä–∞–≤–∏–ª–æ:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–≤—Ç–æ—Ä—é—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ **–±–µ–∑–ø–µ—á–Ω—ñ** (`GET`) —Ç–∞ **—ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ** (`PUT`, `DELETE`) –∑–∞–ø–∏—Ç–∏. `POST` –ø–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è **—Ç—ñ–ª—å–∫–∏** —è–∫—â–æ —î —Ç–æ–∫–µ–Ω —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ –∞–±–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è API —è–≤–Ω–æ —Ü–µ –¥–æ–∑–≤–æ–ª—è—î.
::

---

## 6. –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### –†—ñ–≤–µ–Ω—å 1: –ë–∞–∑–æ–≤–∏–π

::accordion

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 10.1: –¢–æ–∫–µ–Ω —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ" icon="i-lucide-circle-help"}
–†–µ–∞–ª—ñ–∑—É–π—Ç–µ `POST /v1/payments` –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é `X-Idempotency-Key`:

1. –ë–µ–∑ –∫–ª—é—á–∞ ‚Üí `428 Precondition Required`
2. –ü–µ—Ä—à–∏–π –∑–∞–ø–∏—Ç —ñ–∑ –∫–ª—é—á–µ–º ‚Üí `201 Created`
3. –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç —ñ–∑ —Ç–∏–º —Å–∞–º–∏–º –∫–ª—é—á–µ–º ‚Üí `200 OK` (—Ç–∞ —Å–∞–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å)
4. –ó–∞–ø–∏—Ç —ñ–∑ —ñ–Ω—à–∏–º –∫–ª—é—á–µ–º ‚Üí `201 Created` (–Ω–æ–≤–∞ –æ–ø–ª–∞—Ç–∞)

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ `Dictionary<string, Payment>` —è–∫ —Å—Ö–æ–≤–∏—â–µ.
::

::

### –†—ñ–≤–µ–Ω—å 2: –ü—Ä–æ—î–∫—Ç—É–≤–∞–Ω–Ω—è

::accordion

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 10.2: Draft-commit —Ü–∏–∫–ª" icon="i-lucide-circle-help"}
–†–µ–∞–ª—ñ–∑—É–π—Ç–µ –ø–æ–≤–Ω–∏–π draft-commit —Ü–∏–∫–ª –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:

1. `POST /v1/orders/drafts` ‚Äî —Å—Ç–≤–æ—Ä–∏—Ç–∏ —á–µ—Ä–Ω–µ—Ç–∫—É
2. `GET /v1/orders/drafts/{id}` ‚Äî –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —á–µ—Ä–Ω–µ—Ç–∫—É
3. `PUT /v1/orders/drafts/{id}/commit` ‚Äî –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ (—ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
4. `GET /v1/orders/{id}` ‚Äî –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

–ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ: –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –æ–¥–Ω—É —á–µ—Ä–Ω–µ—Ç–∫—É –¥–≤—ñ—á—ñ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—î –±—É—Ç–∏ –æ–¥–Ω–∞–∫–æ–≤–∏–º.
::

::accordion-item{label="–ó–∞–≤–¥–∞–Ω–Ω—è 10.3: –ü–æ–≤–Ω–∏–π —Ü–∏–∫–ª —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó" icon="i-lucide-circle-help"}
–†–µ–∞–ª—ñ–∑—É–π—Ç–µ API –∑ –ø–æ–≤–Ω–æ—é —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—î—é:

1. `GET /v1/tasks?user_id=‚Ä¶` ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ –∑ ETag
2. `POST /v1/tasks` –∑ `If-Match` —ñ `X-Idempotency-Key`
3. `Location` —Ç–∞ `Content-Location` —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
4. –û–±—Ä–æ–±–∫–∞ `412`, `428`, `409`
5. Retry-–ª–æ–≥—ñ–∫–∞ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ –∑ exponential backoff
::

::

---

## 7. –†–µ–∑—é–º–µ

::card-group

::card{title="POST –Ω–µ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∏–π" icon="i-lucide-alert-triangle"}
–ü–æ–≤—Ç–æ—Ä–Ω–∏–π POST –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç. –¢—Ä–∏ —Ä—ñ—à–µ–Ω–Ω—è: PUT –∑ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–º ID, —Ç–æ–∫–µ–Ω —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ (X-Idempotency-Key), –∞–±–æ draft-commit.
::

::card{title="Draft-commit ‚Äî –Ω–∞–π–Ω–∞–¥—ñ–π–Ω—ñ—à–µ" icon="i-lucide-file-check"}
POST —Å—Ç–≤–æ—Ä—é—î ¬´–ª–µ–≥–∫—É¬ª —á–µ—Ä–Ω–µ—Ç–∫—É, PUT –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î —ó—ó —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ. –ù–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —á–µ—Ä–Ω–µ—Ç–∫–∏ –æ—á–∏—â—É—é—Ç—å—Å—è –ø–æ TTL.
::

::card{title="Location + Content-Location" icon="i-lucide-map-pin"}
Location ‚Äî URL –Ω–æ–≤–æ–≥–æ —Ä–µ—Å—É—Ä—Å—É. Content-Location ‚Äî URL –æ–Ω–æ–≤–ª–µ–Ω–æ—ó –∫–æ–ª–µ–∫—Ü—ñ—ó. ETag ‚Äî –Ω–æ–≤–∞ —Ä–µ–≤—ñ–∑—ñ—è.
::

::card{title="Exponential backoff" icon="i-lucide-timer"}
–ê–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä —Ç—ñ–ª—å–∫–∏ –¥–ª—è GET, PUT, DELETE. POST ‚Äî —Ç—ñ–ª—å–∫–∏ –∑ —Ç–æ–∫–µ–Ω–æ–º —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ. –Ü–Ω—Ç–µ—Ä–≤–∞–ª: 1, 2, 4, 8‚Ä¶ —Å–µ–∫—É–Ω–¥.
::

::

**–î–∞–ª—ñ:** —É –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–∞—Ç—Ç—ñ –º–∏ —Ä–æ–∑–±–µ—Ä–µ–º–æ **—Å–ø–∏—Å–∫–∏, –ø–∞–≥—ñ–Ω–∞—Ü—ñ—é —Ç–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é –¥–æ—Å—Ç—É–ø—É** ‚Äî limit/offset, –∫—É—Ä—Å–æ—Ä–∏, —ñ–º–º—É—Ç–∞–±–µ–ª—å–Ω—ñ —Ç–∞ –º—É—Ç–∞–±–µ–ª—å–Ω—ñ —Å–ø–∏—Å–∫–∏.
